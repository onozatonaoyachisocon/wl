<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Link Navi</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
    <!-- Leaflet.fullscreen plugin -->
    <!-- Leaflet.markercluster plugin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js" defer></script>
    <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js" defer></script>
    <!-- GPX/KML Importer Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js" defer></script>
    
    <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„É©„Ç§„Éñ„É©„É™„ÇíÂãïÁöÑË™≠„ÅøËæº„Åø„Å´Â§âÊõ¥„Åô„Çã„Åü„ÇÅ„ÄÅscript„Çø„Ç∞„ÇíÂâäÈô§„Åó„ÄÅDOMPurify„ÇíËøΩÂä† ‚ñº‚ñº‚ñº -->
    <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„É©„Ç§„Éñ„É©„É™ (ÂãïÁöÑË™≠„ÅøËæº„Åø„Å´Â§âÊõ¥) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script> -->
    <!-- CSVËß£Êûê„É©„Ç§„Éñ„É©„É™ (PapaParse) (ÂãïÁöÑË™≠„ÅøËæº„Åø„Å´Â§âÊõ¥) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script> -->

    <!-- XSSÂØæÁ≠ñ„É©„Ç§„Éñ„É©„É™ (DOMPurify) „ÇíËøΩÂä† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" defer></script>
    <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->

<style>
:root {
/* „É©„Ç§„Éà„É¢„Éº„ÉâÂ§âÊï∞ */
--primary-color: #667eea;
--secondary-color: #764ba2;
--bg-light: #ffffff;
--bg-page: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
--bg-container: white;
--text-dark: #333;
--text-medium: #666;
--border-color: #e0e0e0;
--card-bg: white;
--shadow-base: 0 20px 60px rgba(0,0,0,0.3);
--shadow-hover: 0 8px 24px rgba(0,0,0,0.12);

/* ÂÖ±ÈÄö */
--radius-base: 10px;
--red-alert: #E64A19;
--btn-bulk: #90CAF9;
--btn-bulk-hover: #42A5F5;
--btn-toggle-all: #80CBC4;
--btn-toggle-all-hover: #26A69A;
--success-color: #1a621c;
--error-color: #E64A19;
--bookmark-color: #FFC107;

/* „Éú„Çø„É≥„Ç´„É©„ÉºÂ§âÊï∞ */
--btn-current-location-bg: #A1C9FA;
--btn-current-location-hover-bg: #2563EB;
--btn-googlemap-bg: #98D7B1;
--btn-googlemap-hover-bg: #2d8e47;
--btn-paste-bg: #B1B9F5;
--btn-paste-hover-bg: #5568d3;
--btn-save-bookmark-bg: #FFE082;
--btn-save-bookmark-hover-bg: #e6b000;
--btn-address-search-bg: #607D8B;
--btn-address-search-hover-bg: #455A64;
--btn-export-kml-bg: #FBC02D;
--btn-export-kml-hover-bg: #F9A825;
--btn-format-toggle-bg: #d1c4e9;
--btn-format-toggle-hover-bg: #9575cd;

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥Áî®„ÅÆËâ≤ ‚ñº‚ñº‚ñº */
--btn-import-bg: #81C784;
--btn-import-hover-bg: #4CAF50;
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* „Éî„É≥Áïô„ÇÅ„Éú„Çø„É≥Áî®„ÅÆÊ∑°„ÅÑËÉåÊôØËâ≤ */
--btn-pin-bg: rgba(102, 126, 234, 0.7);
--btn-pin-pinned-bg: rgba(118, 75, 162, 0.7);
--btn-pin-hover-bg: rgba(118, 75, 162, 0.9);

/* „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà„É™„Çπ„Éà„ÅÆÂ§âÊï∞ */
--autocomplete-bg: var(--card-bg);
--autocomplete-border: var(--border-color);
--autocomplete-item-hover-bg: var(--bg-light);

/* ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„ÉâÁî®„ÅÆÂ§âÊï∞ */
--usage-guide-bg: rgba(248, 249, 250, 0.97);
--usage-guide-color: var(--text-dark);


/* „Ç´„ÉÜ„Ç¥„É™Âà•„Ç∑„É£„Éâ„Ç¶„Ç´„É©„ÉºÂ§âÊï∞ („É©„Ç§„Éà„É¢„Éº„Éâ) */
--shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.3);
--shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.4);
--shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.3);
--shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.3);
--shadow-weather: 0 8px 24px rgba(0, 188, 212, 0.3);
--shadow-other: 0 8px 24px rgba(156, 39, 176, 0.4);
--shadow-mylink: 0 8px 24px rgba(255, 193, 7, 0.4);
}

/* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂ§âÊï∞ */
body.dark-mode {
--primary-color: #4f46e5;
--secondary-color: #a855f7;
--bg-light: #1f2937;
--bg-page: #111827;
--bg-container: #1f2937;
--text-dark: #f3f4f6;
--text-medium: #d1d5db;
--border-color: #374151;
--card-bg: #374151;
--shadow-base: 0 10px 30px rgba(0,0,0,0.6);
--shadow-hover: 0 8px 24px rgba(255,255,255,0.1);

--btn-bulk: #448AFF;
--btn-bulk-hover: #2962FF;
--btn-toggle-all: #26A69A;
--btn-toggle-all-hover: #00897B;

/* „Éú„Çø„É≥„Ç´„É©„ÉºÂ§âÊï∞ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) */
--btn-current-location-bg: #3B82F6;
--btn-current-location-hover-bg: #2563EB;
--btn-googlemap-bg: #34A853;
--btn-googlemap-hover-bg: #2d8e47;
--btn-paste-bg: var(--primary-color);
--btn-paste-hover-bg: #5568d3;
--btn-save-bookmark-bg: var(--bookmark-color);
--btn-save-bookmark-hover-bg: #e6b000;
--btn-address-search-bg: #607D8B;
--btn-address-search-hover-bg: #455A64;
--btn-export-kml-bg: #FFC107;
--btn-export-kml-hover-bg: #E6B300;
--btn-format-toggle-bg: #5e35b1;
--btn-format-toggle-hover-bg: #4527a0;

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥Áî®„ÅÆËâ≤ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) ‚ñº‚ñº‚ñº */
--btn-import-bg: #66BB6A;
--btn-import-hover-bg: #43A047;
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* „Éî„É≥Áïô„ÇÅ„Éú„Çø„É≥Áî®„ÅÆÊ∑°„ÅÑËÉåÊôØËâ≤ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) */
--btn-pin-bg: rgba(79, 70, 229, 0.6);
--btn-pin-pinned-bg: rgba(168, 85, 247, 0.6);
--btn-pin-hover-bg: rgba(168, 85, 247, 0.8);

/* „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà„É™„Çπ„Éà„ÅÆÂ§âÊï∞ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) */
--autocomplete-bg: var(--card-bg);
--autocomplete-border: var(--border-color);
--autocomplete-item-hover-bg: #2d3748;

/* ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„ÉâÁî®„ÅÆÂ§âÊï∞ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) */
--usage-guide-bg: rgba(31, 41, 55, 0.97);
--usage-guide-color: var(--text-dark);

/* „Ç´„ÉÜ„Ç¥„É™Âà•„Ç∑„É£„Éâ„Ç¶„Ç´„É©„ÉºÂ§âÊï∞ („ÉÄ„Éº„ÇØ„É¢„Éº„Éâ) */
--shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.4);
--shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.4);
--shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.4);
--shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.4);
--shadow-weather: 0 8px 24px rgba(0, 188, 212, 0.4);
--shadow-other: 0 8px 24px rgba(156, 39, 176, 0.4);
--shadow-mylink: 0 8px 24px rgba(255, 193, 7, 0.4);
}

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Éá„Éº„ÇøÊ∂àÂ§±„É™„Çπ„ÇØË≠¶Âëä„Éê„Éä„Éº„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.data-warning-banner {
    background-color: #fff3cd;
    color: #856404;
    padding: 15px 20px;
    text-align: center;
    font-size: 14px;
    position: sticky;
    top: 0;
    z-index: 9999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ffeeba;
}
.data-warning-banner p {
    margin: 0;
    padding-right: 20px;
}
.data-warning-banner button {
    background: transparent;
    border: none;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #856404;
    padding: 0 10px;
    line-height: 1;
}
body.dark-mode .data-warning-banner {
    background-color: #4d431c;
    color: #fffacd;
    border-bottom-color: #6c5e25;
}
body.dark-mode .data-warning-banner button {
    color: #fffacd;
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
background: var(--bg-page);
padding: 0;
min-height: 100vh;
color: var(--text-dark);
transition: background 0.5s, color 0.5s;
display: flex;
flex-direction: column;
}

.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.container {
max-width: 100%;
margin: 0;
width: 100vw;
background: var(--bg-container);
border-radius: 0;
box-shadow: var(--shadow-base);
transition: background 0.5s, box-shadow 0.5s;
display: flex;
flex-direction: column;
flex-grow: 1;
}

.header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1px 15px;
    position: relative;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 1010;
    }

.header-left { display: flex; align-items: center; gap: 15px; flex-shrink: 1; min-width: 0; }
.header h1 { font-size: 24px; margin-bottom: 0; flex-shrink: 0; white-space: nowrap; }
.header-buttons { display: flex; gap: 10px; align-items: center; }
.header-button-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; position: relative; }
.header-button-label { font-size: 10px; color: white; white-space: nowrap; opacity: 0.9; }

.mode-toggle, .history-button, .bookmark-button, .share-button, .nav-button, .settings-button, .usage-button, .qr-button, .header-button {
background: rgba(255, 255, 255, 0.2);
border: none;
color: white;
width: 40px; height: 40px;
border-radius: 50%;
cursor: pointer;
font-size: 20px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s;
}

.mode-toggle:hover, .history-button:hover, .bookmark-button:hover, .share-button:hover, .nav-button:hover:not(:disabled), .settings-button:hover, .usage-button:hover, .qr-button:hover, .header-button:hover {
background: rgba(255, 255, 255, 0.4);
transform: scale(1.05);
}

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ‚ñº‚ñº‚ñº */
.mode-toggle:active:not(:disabled), .history-button:active:not(:disabled), .bookmark-button:active:not(:disabled),
.share-button:active:not(:disabled), .nav-button:active:not(:disabled), .settings-button:active:not(:disabled),
.usage-button:active:not(:disabled), .qr-button:active:not(:disabled), .header-button:active:not(:disabled),
.btn-base:active:not(:disabled) {
    transform: translateY(1px) scale(0.97);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
    filter: brightness(0.95);
    transition-duration: 0.1s;
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

.nav-button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}


.history-popup, .bookmark-popup, #csvPopup {
position: absolute;
background: var(--bg-container);
border: 1px solid var(--border-color);
border-radius: var(--radius-base);
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
width: 400px; /* ‚Üê ÂπÖ„ÇíÂ∫É„Åí„Åæ„Åó„Åü */
max-height: 450px;
padding: 10px;
z-index: 1050;
display: none;
color: var(--text-dark);
top: calc(100% + 10px);
right: 0;
}

#csvPopup {
    width: 250px;
}

.history-popup h4, .bookmark-popup h4, #csvPopup h4 { margin-bottom: 10px; padding: 5px; border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-size: 14px; }
.popup-buttons { display: flex; gap: 5px; margin: 0 5px 10px; }
.popup-buttons button { flex: 1; min-width: 90px; padding: 8px 5px; font-size: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; border: none; color: white; white-space: nowrap; /* ‚Üê „ÉÜ„Ç≠„Çπ„Éà„ÅÆÊäò„ÇäËøî„Åó„ÇíÈò≤„ÅêË®≠ÂÆö„ÇíËøΩÂä† */ }
.btn-clear-history, .btn-clear-bookmarks { background-color: var(--error-color); }
.btn-clear-history:hover, .btn-clear-bookmarks:hover { background-color: #C62828; }
.btn-export-csv { background-color: var(--primary-color); }
.btn-export-csv:hover { background-color: #5568d3; }
.btn-export-kml { background-color: var(--btn-export-kml-bg); }
.btn-export-kml:hover { background-color: var(--btn-export-kml-hover-bg); }

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.btn-import-csv {
    background-color: var(--btn-import-bg);
}
.btn-import-csv:hover {
    background-color: var(--btn-import-hover-bg);
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

#historyList, #bookmarkList { max-height: 340px; overflow-y: auto; }

.history-item, .bookmark-item { padding: 8px 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: background-color: 0.2s; border: 1px solid transparent; }
.history-item:hover, .bookmark-item:hover { background-color: var(--bg-light); border-color: var(--primary-color); }
.bookmark-actions { margin-top: 5px; display: flex; gap: 5px; }
.bookmark-actions button { flex: 1; padding: 6px 8px; font-size: 11px; font-weight: 700; border-radius: 6px; border: none; transition: opacity: 0.2s; color: white; }
.btn-bookmark-load { background-color: var(--primary-color); }
.btn-bookmark-open { background-color: var(--success-color); }
.btn-bookmark-delete { background-color: var(--error-color); }
.btn-bookmark-load:hover, .btn-bookmark-open:hover, .btn-bookmark-delete:hover { opacity: 0.8; }
.history-item strong, .bookmark-item strong { display: block; font-weight: 600; color: var(--text-dark); }
.history-item span, .bookmark-item span { color: var(--text-medium); font-size: 12px; display: block; margin-top: 3px; }

/* ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ„ÅÆ„Çπ„Çø„Ç§„É´ */
.usage-guide {
    background: var(--usage-guide-bg);
    color: var(--usage-guide-color);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-base);
    border-radius: 10px;
    padding: 20px 25px;
    font-size: 13px;
    display: none;
    animation: slideDown 0.3s ease;
    position: absolute;
    top: 65px;
    right: 15px;
    width: 1400px;
    max-width: 95vw;
    z-index: 1100;
    max-height: 70vh;
    overflow-y: auto;
}
.usage-guide.show { display: block; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.popup-warning { color: #FFF3CD; background-color: var(--red-alert); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 13px; font-weight: 700; }
.usage-guide ul { list-style: disc inside; padding-left: 20px; margin-top: 10px; }
.usage-guide li { margin-bottom: 5px; line-height: 1.5; }

.project-switcher {
    position: relative;
    flex-grow: 1;
    max-width: 300px;
    min-width: 200px;
}
#projectSwitcherBtn {
    width: 100%;
    background-color: rgba(255,255,255, 0.2);
    color: white;
    border: 1px solid rgba(255,255,255, 0.5);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background-color 0.2s;
}
#projectSwitcherBtn:hover {
    background-color: rgba(255,255,255, 0.4);
}
.project-dropdown {
    display: none;
    position: absolute;
    top: 110%;
    left: 0;
    width: 100%;
    background-color: var(--bg-container);
    border-radius: var(--radius-base);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1100;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
}
.project-dropdown-item {
    display: block;
    padding: 10px 15px;
    color: var(--text-dark);
    text-decoration: none;
    cursor: pointer;
    font-size: 13px;
}
.project-dropdown-item:hover {
    background-color: var(--bg-light);
}
.project-dropdown-item.active {
    font-weight: 700;
    color: var(--primary-color);
    background-color: var(--bg-light);
}
.project-dropdown hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 5px 0;
}
.project-dropdown-manage {
    font-weight: 600;
    color: var(--secondary-color) !important;
}

#project-modal .modal-content {
    max-width: 420px;
    padding: 15px;
}
#project-modal h3 {
    margin-bottom: 12px;
    font-size: 1.1em;
}
.project-list-container {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
    margin-bottom: 12px;
}
#projectManagementList {
    list-style: none;
    padding: 5px;
}
#projectManagementList li {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    margin-bottom: 3px;
    transition: background-color 0.2s;
    font-size: 13px;
}
#projectManagementList li:hover {
    background-color: var(--bg-light);
}
#projectManagementList li.selected {
    background-color: var(--primary-color);
    color: white;
    font-weight: 700;
}
.project-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    border-top: 1px solid var(--border-color);
    padding-top: 12px;
}
.project-actions button {
    padding: 6px 12px;
    font-size: 12px;
    transition: all 0.3s ease;
    color: white;
    border: none;
}
#project-modal .modal-buttons {
    margin-top: 15px;
}
.project-actions.project-actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
}
#project-modal .project-actions button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}
#btn-new-project {
    background-color: #03A9F4;
}
#btn-new-project:hover:not(:disabled) {
    background-color: #0288D1;
}
#btn-duplicate-project {
    background-color: #2962FF;
}
#btn-duplicate-project:hover:not(:disabled) {
    background-color: #0039cb;
}
#btn-rename-project {
    background-color: var(--btn-export-kml-hover-bg);
}
#btn-rename-project:hover:not(:disabled) {
    background-color: #F57F17;
}
#btn-delete-project {
    background-color: var(--error-color);
}
#btn-delete-project:hover:not(:disabled) {
    background-color: #C62828;
}
#btn-export-project {
    background-color: var(--primary-color);
}
#btn-export-project:hover:not(:disabled) {
    background-color: var(--secondary-color);
}
#btn-import-project {
    background-color: var(--success-color);
}
#btn-import-project:hover:not(:disabled) {
    background-color: #145315;
}


.main-layout {
    display: flex;
    flex-grow: 1;
    background: var(--bg-light);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease-in-out;
}

.left-panel {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    transition: width 0.4s ease-in-out;
    overflow-y: auto;
}

.right-panel {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: var(--panel-width, 500px); 
    min-width: 320px;
    max-width: 80vw;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-container);
    border-radius: var(--radius-base);
    box-shadow: var(--shadow-base);
    border-left: 1px solid var(--border-color);
    transition: transform 0.4s ease-in-out, width 0.4s ease-in-out;
    z-index: 1002;
    will-change: transform;
}

/* --- ÊèêÊ°àAÔºö„Ç∞„É™„ÉÉ„Éó„Éè„É≥„Éâ„É´Ê°à --- */
#resizer {
    position: absolute;
    top: 0;
    right: var(--panel-width, 500px);
    width: 14px; /* Â∞ë„ÅóÂ§™„Åè„Åó„Å¶Êé¥„Åø„ÇÑ„Åô„Åè */
    height: 100%;
    cursor: ew-resize;
    z-index: 1003;
    transform: translateX(50%);
    user-select: none;
    display: flex; /* „Ç¢„Ç§„Ç≥„É≥„Çí‰∏≠Â§Æ„Å´ÈÖçÁΩÆ„Åô„Çã„Åü„ÇÅ„Å´ËøΩÂä† */
    align-items: center; /* „Ç¢„Ç§„Ç≥„É≥„Çí‰∏≠Â§Æ„Å´ÈÖçÁΩÆ„Åô„Çã„Åü„ÇÅ„Å´ËøΩÂä† */
    justify-content: center; /* „Ç¢„Ç§„Ç≥„É≥„Çí‰∏≠Â§Æ„Å´ÈÖçÁΩÆ„Åô„Çã„Åü„ÇÅ„Å´ËøΩÂä† */
    transition: background-color 0.2s;
}

/* „Éû„Ç¶„Çπ„Åå‰πó„Å£„ÅüÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´ */
#resizer:hover {
    background-color: rgba(102, 126, 234, 0.25); /* Â∞ë„ÅóÊøÉ„Åè„Åô„Çã */
}

/* „Ç∞„É™„ÉÉ„Éó„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
#resizer::before {
    content: '‚ãÆ';
    color: var(--primary-color);
    font-size: 24px;
    opacity: 0.6; /* Â∏∏„Å´Â∞ë„ÅóËñÑ„ÇÅ„Å´Ë°®Á§∫ */
    transition: opacity 0.2s;
    text-shadow: 0 0 5px rgba(255,255,255,0.7); /* Ë¶ã„ÇÑ„Åô„Åè„Åô„Çã„Åü„ÇÅ„ÅÆÂΩ± */
}

/* „Éû„Ç¶„Çπ„Åå‰πó„Å£„ÅüÊôÇ„Å´„Ç¢„Ç§„Ç≥„É≥„ÇíÊøÉ„Åè„Åô„Çã */
#resizer:hover::before {
    opacity: 1;
}
.main-layout:not(.pinned) #resizer {
    display: none;
}

#osmClickMap {
width: 100%;
/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÂú∞Âõ≥„ÅÆÈ´ò„Åï„ÇíÊã°Â§ß ‚ñº‚ñº‚ñº */
height: 80vh;
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */
border: 2px solid var(--secondary-color);
border-radius: 0;
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
flex-shrink: 0;
position: relative; /* ‚Üê „Åì„ÅÆË°å„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ */
}

.input-section {
background: var(--bg-container);
padding: 0 15px; /* ‚Üê „Åì„ÅÆË°å„ÇíÂ§âÊõ¥ */
border-radius: var(--radius-base);
box-shadow: var(--shadow-hover);
border: 1px solid var(--border-color);
margin-top: 0;
}

.input-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
}
.input-buttons-group {
    display: flex;
    gap: 8px;
}
.input-button-wrapper, .input-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.input-button-label, .input-field-label {
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    color: var(--text-medium);
}
.input-group label {
    display: none;
}
.input-group.lat-group { flex: 2.5; min-width: 140px; }
.input-group.lon-group { flex: 2.5; min-width: 140px; }
.input-group.address-group { flex: 3; min-width: 220px; }
.input-row-bottom-buttons { display: contents; }

.input-group input, .input-group select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); color: var(--text-dark); height: 42px; }
.input-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
#latitude, #longitude { font-size: 14px; }
#addressInput { font-size: 15px; }

.input-wrapper {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
}
.btn-copy {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-medium);
    padding: 0 8px;
    height: 100%;
    position: absolute;
    right: 0;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-copy:hover {
    color: var(--primary-color);
}
.input-wrapper input {
    padding-right: 35px;
}

.btn-base { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 13px; color: white; min-width: 85px; height: 42px; display: inline-flex; align-items: center; justify-content: center; }
.btn-icon { min-width: 0; width: 42px; padding: 0; font-size: 22px; }

.btn-base:disabled, .bulk-toggle-container button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
    box-shadow: none;
    background-color: var(--border-color) !important;
    color: var(--text-medium) !important;
}

.btn-toggle-panel { background-color: var(--primary-color); }
.btn-toggle-panel:hover:not(:disabled) {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
}


.btn-current-location { background-color: var(--btn-current-location-bg); }
.btn-current-location:hover { background-color: var(--btn-current-location-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
.btn-paste { background-color: var(--btn-paste-bg); }
.btn-paste:hover { background-color: var(--btn-paste-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
.btn-googlemap { background-color: var(--btn-googlemap-bg); }
.btn-googlemap:hover { background-color: var(--btn-googlemap-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4); }
.btn-save-bookmark { color: var(--text-dark); background-color: var(--btn-save-bookmark-bg); }
.btn-save-bookmark:hover { background-color: var(--btn-save-bookmark-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4); }
.btn-address-search { font-size: 22px; color: white; background-color: var(--btn-address-search-bg); min-width: 0; width: 42px; padding: 0; height: 42px; border-radius: 8px; }
.btn-address-search:hover { background-color: var(--btn-address-search-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(96, 125, 139, 0.4); }
.btn-format-toggle { background-color: var(--btn-format-toggle-bg); color: var(--text-dark); font-size: 20px; }
.btn-format-toggle:hover { background-color: var(--btn-format-toggle-hover-bg); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(149, 117, 205, 0.4); }

#btn-route-google { background-color: #4A89F3; }
#btn-route-google:hover {
    background-color: #3C6ED9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 137, 243, 0.4);
}


.zoom-slider-overlay { position: absolute; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; }
body.dark-mode .zoom-slider-overlay { background: rgba(31, 41, 55, 0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.6); }
.zoom-slider-overlay label { font-size: 13px; font-weight: 600; white-space: nowrap; }
.zoom-slider-overlay input[type="range"] { width: 120px; height: 8px; -webkit-appearance: none; appearance: none; background: var(--border-color); border-radius: 4px; outline: none; padding: 0; margin: 0; cursor: pointer; }
.zoom-slider-overlay input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 2px solid var(--bg-container); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.zoom-slider-overlay input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 2px solid var(--bg-container); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.zoom-slider-overlay input[type="range"]:hover::-webkit-slider-thumb, .zoom-slider-overlay input[type="range"]:active::-webkit-slider-thumb { background: var(--secondary-color); transform: scale(1.1); }
.zoom-slider-overlay input[type="range"]:hover::-moz-range-thumb, .zoom-slider-overlay input[type="range"]:active::-moz-range-thumb { background: var(--secondary-color); transform: scale(1.1); }
.zoom-slider-overlay #zoomLevelDisplay { font-weight: 700; color: var(--primary-color); width: 25px; text-align: center; font-size: 14px; }
body.dark-mode .zoom-slider-overlay #zoomLevelDisplay { color: var(--text-dark); }

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂâäÈô§„Åó„ÄÅÂú∞Âõ≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíË™øÊï¥ ‚ñº‚ñº‚ñº */
.osm-map-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 5px;
    padding-top: 0;
    padding-bottom: 0;
    justify-content: space-between;
}

.osm-map-wrapper {
    /* Êäò„Çä„Åü„Åü„ÅøÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂâäÈô§ */
    overflow: visible;
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

.right-panel-header {
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 11;
    background: var(--bg-container);
    padding: 8px 8px 0 8px;
    margin: 0 -8px;
    flex-shrink: 0;
}

.panel-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin: 0px -8px 0 -8px;
    padding: 0 8px;
}
.panel-tab {
    flex: 1;
    padding: 8px 15px;
    font-size: 14px;
    font-weight: 600;
    cursor: grab;
    border: 2px solid transparent;
    border-bottom: none;
    background-color: var(--bg-light);
    color: var(--text-medium);
    transition: all 0.2s;
    text-align: center;
    border-top-left-radius: var(--radius-base);
    border-top-right-radius: var(--radius-base);
    margin-bottom: -2px;
    position: relative;
    user-select: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.panel-tab:active {
    cursor: grabbing;
}
.panel-tab.dragging {
    opacity: 0.5;
    background: var(--primary-color);
}
.panel-tab:hover {
    color: var(--text-dark);
}
.panel-tab.active {
    background-color: var(--bg-container);
    color: var(--secondary-color);
    border-color: var(--border-color);
    border-bottom-color: var(--bg-container);
    z-index: 1;
}
.panel-content-wrapper {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
    display: flex;
}
.panel-content {
    display: none;
    height: 100%;
    width: 100%;
    overflow: hidden;
    flex-direction: column;
    flex-shrink: 0;
}
#map-links-content {
    max-height: 85vh;
    overflow-y: auto;
    padding: 8px;
}
#history-content, #bookmarks-content {
    padding: 8px 8px 0 8px;
}
.panel-content.active {
    display: flex;
}

.category { margin-bottom: 6px; }
.category.dragging {
    opacity: 0.4;
    background: var(--primary-color);
}
.category.drag-over {
    border-top: 3px dashed var(--secondary-color);
}

.category-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 8px;
padding: 5px 0;
border-bottom: 2px solid var(--border-color);
cursor: grab;
flex-wrap: wrap;
gap: 8px;
}
.category-header:active {
    cursor: grabbing;
}


.category-header:hover { border-bottom-color: var(--primary-color); }
.category-title-group { display: flex; align-items: center; flex-grow: 1; cursor: pointer; } /* title-group„Å´cursor„ÇíËøΩÂä† */
.category-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.category-icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 8px; color: white; flex-shrink: 0; }
.accordion-icon { font-size: 18px; font-weight: 900; margin-left: 10px; transition: transform 0.3s; }
.category-header.collapsed .accordion-icon { transform: rotate(-90deg); }

.btn-bulk-open, .btn-toggle-all-checks {
color: white;
border: none;
padding: 0;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
width: 40px; height: 40px;
display: flex;
align-items: center;
justify-content: center;
white-space: nowrap;
overflow: hidden;
position: relative;
transition: background 0.3s, box-shadow 0.3s;
}

.btn-bulk-open { background: var(--btn-bulk); }
.btn-bulk-open:hover { background: var(--btn-bulk-hover); box-shadow: 0 4px 8px rgba(66, 165, 245, 0.4); }
.btn-toggle-all-checks { background: var(--btn-toggle-all); }
.btn-toggle-all-checks:hover { background: var(--btn-toggle-all-hover); box-shadow: 0 4px 8px rgba(38, 166, 154, 0.4); }


.btn-bulk-open::before {
content: '‚ñ∂Ô∏è';
font-size: 18px;
position: absolute;
color: white;
}
.btn-toggle-all-checks::before {
content: '‚úÖ';
font-size: 18px;
position: absolute;
color: white;
}
.btn-toggle-all-checks.checked::before {
content: '‚ùå';
}

.map-grid.hidden { display: none; }
.terrain-icon { background: linear-gradient(135deg, #4CAF50, #45a049); }
.disaster-icon { background: linear-gradient(135deg, #FF5722, #E64A19); }
.geology-icon { background: linear-gradient(135deg, #FF9800, #F57C00); }
.survey-icon { background: linear-gradient(135deg, #2196F3, #1976D2); }
.weather-icon { background: linear-gradient(135deg, #00BCD4, #0097A7); }
.other-icon { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
.mylink-icon { background: linear-gradient(135deg, #FFC107, #FFA000); }

.map-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
gap: 6px;
}

.map-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
    padding: 2px 8px;
    transition: all 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    cursor: grab;
    min-height: 38px;
    justify-content: center;
}
.map-card:active {
    cursor: grabbing;
}
.map-card:hover { transform: translateY(-4px); border-color: transparent; }
.map-card[data-category="terrain"]:hover { box-shadow: var(--shadow-terrain); }
.map-card[data-category="disaster"]:hover { box-shadow: var(--shadow-disaster); }
.map-card[data-category="geology"]:hover { box-shadow: var(--shadow-geology); }
.map-card[data-category="survey"]:hover { box-shadow: var(--shadow-survey); }
.map-card[data-category="weather"]:hover { box-shadow: var(--shadow-weather); }
.map-card[data-category="other"]:hover { box-shadow: var(--shadow-other); }
.map-card[data-category="mylink"]:hover { box-shadow: var(--shadow-mylink); }
.map-card[data-category="terrain"] { border-left: 3px solid #4CAF50; }
.map-card[data-category="disaster"] { border-left: 3px solid #FF5722; }
.map-card[data-category="geology"] { border-left: 3px solid #FF9800; }
.map-card[data-category="survey"] { border-left: 3px solid #2196F3; }
.map-card[data-category="weather"] { border-left: 3px solid #00BCD4; }
.map-card[data-category="other"] { border-left: 3px solid #9C27B0; }
.map-card[data-category="mylink"] { border-left: 3px solid #FFC107; }
.map-card.dragging {
    opacity: 0.4;
    transform: scale(0.95);
}
.category.drag-over .map-grid {
    background-color: var(--bg-light);
    border: 2px dashed var(--secondary-color);
    border-radius: var(--radius-base);
}
.map-card.drop-indicator-before::before {
    content: '';
    position: absolute;
    top: -5px;
    left: 5%;
    width: 90%;
    height: 4px;
    background-color: var(--secondary-color);
    border-radius: 2px;
    z-index: 1;
}

.map-header-with-check { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding-right: 5px; }
.map-title {
font-weight: 600;
font-size: 13px;
display: flex;
align-items: center;
gap: 5px;
margin-bottom: 0;
flex-grow: 1;
}
.map-title .map-icon-in-title {
font-size: 16px;
}

.map-checkbox { width: 16px; height: 16px; flex-shrink: 0; cursor: pointer; margin-left: 10px; z-index: 10; }
.map-description { display: none; }
.manual-input-warning { color: var(--red-alert); font-size: 11px; margin-top: 5px; font-weight: 600; }

.notification { position: fixed; top: 20px; right: 20px; background: var(--success-color); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; animation: slideIn 0.3s ease; z-index: 2000; font-weight: 600; }
.notification.error { background: var(--error-color); }
.notification.warning { background: #FFA000; color: white; }
@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

#autocompleteList { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--autocomplete-bg); border: 1px solid var(--autocomplete-border); border-radius: var(--radius-base); box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 1001; list-style: none; padding: 5px 0; margin-top: 5px; display: none; }
#autocompleteList.show { display: block; }
.autocomplete-item { padding: 10px 15px; cursor: pointer; font-size: 14px; transition: background-color: 0.2s; }
.autocomplete-item:hover, .autocomplete-item.selected { background-color: var(--autocomplete-item-hover-bg); }
.autocomplete-item span { display: block; font-size: 12px; color: var(--text-medium); margin-top: 2px; }

.footer-copyright { text-align: center; color: var(--text-medium); font-size: 12px; padding: 10px 0; flex-shrink: 0; }
body.dark-mode .footer-copyright { color: var(--text-medium); }

.coord-conversion-section { padding: 15px; margin-top: 20px; border: 1px solid var(--border-color); border-radius: var(--radius-base); background-color: var(--card-bg); }
.coord-conversion-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
.coord-display-group { font-size: 13px; }
.coord-display-group label { font-weight: 700; color: var(--primary-color); display: block; margin-bottom: 5px; }
.coord-display-group p { font-family: 'Courier New', Courier, monospace; font-size: 14px; font-weight: 600; background-color: var(--bg-light); padding: 8px 12px; border-radius: 8px; word-wrap: break-word; min-height: 38px; }

.analysis-tools-overlay {
position: absolute;
bottom: 30px;
left: 10px;
z-index: 1000;
background: rgba(255, 255, 255, 0.8);
border-radius: 10px;
padding: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
body.dark-mode .analysis-tools-overlay { background: rgba(31, 41, 55, 0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.6); }
.analysis-tools-overlay h3 { font-size: 14px; margin: 0 0 8px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; }
.analysis-tools-overlay.collapsed h3 { margin-bottom: 0; border-bottom: none; }
.analysis-tools-overlay h3 .toggle-icon { display: inline-block; transition: transform 0.3s; }
.analysis-tools-overlay:not(.collapsed) h3 .toggle-icon { transform: rotate(90deg); }
.analysis-tools-controls { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; overflow: hidden; transition: max-height 0.3s ease-in-out; max-height: 250px; }
.analysis-tools-overlay.collapsed .analysis-tools-controls { max-height: 0; }
.analysis-tool-row { display: flex; gap: 5px; align-items: center; }
.analysis-tools-controls .btn-base { height: 32px; width: 110px; padding: 0 10px; font-size: 12px; }
.analysis-tools-controls input[type="number"] { height: 32px; width: 60px; padding: 5px 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px; background-color: var(--card-bg); color: var(--text-dark); }

.btn-measure { background-color: #2962FF; }
.btn-measure:hover { background-color: #0039cb; }
.btn-buffer { background-color: #03A9F4; }
.btn-buffer:hover { background-color: #0288D1; }
.btn-clear-analysis { background-color: var(--error-color); }
.btn-clear-analysis:hover { background-color: #C62828; }
.btn-measure.active { background-color: #004D40; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }

.btn-area { background-color: #9C27B0; }
.btn-area:hover { background-color: #7B1FA2; }
.btn-area.active { background-color: #4A148C; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }

.btn-export-analysis { background-color: var(--btn-export-kml-bg); }
.btn-export-analysis:hover { background-color: var(--btn-export-kml-hover-bg); }

.area-display-label {
font-size: 13px;
font-weight: 700;
color: var(--primary-color);
margin-left: 10px;
display: none;
white-space: nowrap;
background-color: var(--bg-light);
padding: 6px 10px;
border-radius: 6px;
}
body.dark-mode .area-display-label {
color: var(--text-dark);
}

.btn-add-mylink { width: 100%; padding: 10px; font-size: 14px; font-weight: bold; background-color: var(--btn-save-bookmark-bg); color: var(--text-dark); border: 2px dashed var(--bookmark-color); border-radius: var(--radius-base); cursor: pointer; }
.btn-add-mylink:hover { background-color: var(--btn-save-bookmark-hover-bg); border-color: var(--btn-save-bookmark-hover-bg); }
.map-card-actions { display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; }
.map-card-actions button { flex: 1; padding: 8px; font-size: 12px; font-weight: 700; border-radius: 8px; border: none; color: white; cursor: pointer; }
.btn-mylink-edit { background-color: var(--primary-color); }
.btn-mylink-delete { background-color: var(--error-color); }
.btn-mylink-edit:hover, .btn-mylink-delete:hover { opacity: 0.8; }
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.2);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    z-index: 2000;
    display: none;
    padding-top: 5vh;
    padding-bottom: 5vh;
    overflow-y: auto;
pointer-events: none;
}
.modal-content { background: var(--bg-container); padding: 25px; border-radius: var(--radius-base); width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
pointer-events: auto;
}
.modal-content h3 { margin-top: 0; color: var(--primary-color); margin-bottom: 20px; }
.modal-form-group { margin-bottom: 15px; }
.modal-form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
.modal-form-group input, .modal-form-group textarea, .modal-form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-light); color: var(--text-dark); font-size: 14px; }
.modal-form-group small { font-size: 12px; color: var(--text-medium); }
.modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
.modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
.btn-modal-save { background-color: var(--success-color); color: white; }
.btn-modal-cancel { background-color: var(--border-color); color: var(--text-dark); }
.url-converter-group { display: flex; gap: 10px; align-items: center; }
.url-converter-group input { flex-grow: 1; }
.url-converter-group button { padding: 8px 12px; height: auto; min-width: 0; background-color: var(--btn-paste-bg); flex-shrink: 0; white-space: nowrap; }

.bulk-toggle-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.bulk-toggle-container button {
    flex: 1;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
}
.bulk-toggle-container button:hover:not(:disabled) {
    background-color: var(--border-color);
}
#pinPanelBtn, #closePanelBtnMobile {
    background-color: var(--btn-pin-bg);
    color: white;
    border-color: transparent;
    flex-grow: 0.5;
}
#pinPanelBtn:hover:not(:disabled), #closePanelBtnMobile:hover:not(:disabled) {
    background-color: var(--btn-pin-hover-bg);
}
#pinPanelBtn.pinned {
    background-color: var(--btn-pin-pinned-bg);
    color: white;
    border-color: var(--secondary-color);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.favorite-sets-container {
    position: -webkit-sticky;
    position: sticky;
    top: -8px;
    z-index: 20;
    background: var(--bg-container);
    padding-bottom: 8px;
}
.favorite-set-row {
    display: flex;
    flex-basis: 100%;
    align-items: center;
    gap: 5px;
}
.favorite-set-row.button-row button {
    flex: 1;
}
.favorite-sets-container label {
    margin-right: 5px;
    flex-shrink: 0;
}
.favorite-sets-container select {
    flex-grow: 1;
    min-width: 120px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background-color: var(--card-bg);
    color: var(--text-dark);
    font-size: 12px;
}
.favorite-sets-container button {
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    font-size: 12px;
    flex-shrink: 0;
}
.btn-save-set {
    background-color: var(--btn-save-bookmark-bg);
    color: var(--text-dark);
}
.btn-save-set:hover {
    background-color: var(--btn-save-bookmark-hover-bg);
}
.btn-delete-set {
    background-color: var(--error-color);
    color: white;
}
.btn-delete-set:hover {
    background-color: #C62828;
}
.btn-open-set {
    background-color: var(--btn-bulk);
    color: white;
}
.btn-open-set:hover {
    background-color: var(--btn-bulk-hover);
}
.btn-clear-checks {
    background-color: #B0BEC5;
    color: var(--text-dark);
}
.btn-clear-checks:hover {
    background-color: #78909C;
    color: white;
}
body.dark-mode .btn-clear-checks {
    background-color: #455A64;
    color: var(--text-dark);
}
body.dark-mode .btn-clear-checks:hover {
    background-color: #607D8B;
}

#qr-modal .modal-content { max-width: 320px; }
#qrcode {
    padding: 20px;
    background: white;
    border-radius: var(--radius-base);
    display: flex;
    justify-content: center;
    align-items: center;
}
#qrcode img {
    max-width: 100%;
    height: auto;
}

.desktop-hidden {
    display: none !important;
}

.modal-content {
    max-height: 90vh; 
    display: flex;
    flex-direction: column;
    position: relative;
}

.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: transparent;
    border: none;
    font-size: 28px;
    font-weight: bold;
    color: var(--text-medium);
    cursor: pointer;
    padding: 0 5px;
    line-height: 1;
    transition: color 0.2s;
    z-index: 10;
}
.modal-close-btn:hover {
    color: var(--text-dark);
}

#settings-form {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 15px;
}
.modal-content h3, .modal-buttons {
    flex-shrink: 0;
}

.data-sync-section h4 {
    margin-bottom: 5px;
}
.data-sync-section small {
    display: block;
    margin-bottom: 15px;
}
.data-sync-checklist {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-color: var(--bg-light);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
.data-sync-checklist label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}
.data-sync-checklist input[type="checkbox"] {
    margin-right: 10px;
    width: 16px;
    height: 16px;
}
.data-sync-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}
.data-sync-controls button {
    flex: 1;
    padding: 8px 10px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}
.data-sync-controls button:hover {
    opacity: 0.85;
    transform: translateY(-2px);
}

#btn-check-all {
    background-color: var(--btn-toggle-all);
}
#btn-uncheck-all {
    background-color: #B0BEC5;
    color: var(--text-dark);
}
body.dark-mode #btn-uncheck-all {
    background-color: #455A64;
    color: var(--text-dark);
}
#btn-export-data {
    background-color: var(--primary-color);
}
#btn-import-data {
    background-color: var(--success-color);
}

.map-visibility-controls {
    display: flex;
    gap: 8px;
    margin: 10px 0;
}
.map-visibility-controls button {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background-color: var(--bg-light);
    color: var(--text-dark);
}
#settings-map-visibility-list, #settings-category-names {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    background-color: var(--bg-light);
}

.visibility-category h5, .category-name-group h5 {
    font-size: 13px;
    font-weight: 700;
    margin: 10px 0 5px 0;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
    color: var(--secondary-color);
}
.visibility-category label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 4px 0;
    font-size: 13px;
    font-weight: 500;
}
.visibility-category input[type="checkbox"] {
    margin-right: 10px;
    width: 15px;
    height: 15px;
}
.category-name-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}
.category-name-item label {
    flex-shrink: 0;
    width: 150px;
    font-size: 13px;
    font-weight: 600;
}
.category-name-item input {
    width: 100%;
    padding: 6px 10px;
    font-size: 13px;
}

.table-container {
    background: var(--bg-container);
    display: flex;
    flex-direction: column;
    height: 100%; 
    overflow: hidden;
}
.table-container h3 {
    font-size: 16px;
    margin-bottom: 10px;
    color: var(--text-dark);
}
.table-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    align-items: center;
    flex-shrink: 0; 
}
.table-controls input[type="search"] {
    flex-grow: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-bg);
    color: var(--text-dark);
    min-width: 85px;
}
.table-controls button {
    padding: 8px 12px;
    font-size: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    border: 1px solid transparent;
    transition: all 0.2s;
    background-color: var(--bg-light);
    color: var(--text-dark);
    border-color: var(--border-color);
}
.table-controls button:hover:not(:disabled) {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
.btn-delete-selected {
    background-color: var(--error-color);
    color: white;
    border-color: transparent;
}
.btn-delete-selected:hover:not(:disabled) {
    background-color: #C62828;
}
.table-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.map-toggle-wrapper {
    display: flex; align-items: center; gap: 8px; margin-left: auto;
}
.map-toggle-wrapper label {
    font-size: 13px; font-weight: 600; cursor: pointer;
}
.map-toggle-wrapper input {
    width: 18px; height: 18px; cursor: pointer;
}

.table-wrapper {
  height: 70vh; 
  overflow-y: scroll; 
}
.data-table {
    border-collapse: collapse;
    font-size: 12px;
}
.data-table th, .data-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
}
.data-table th {
    font-weight: 700;
    background-color: var(--bg-light);
    position: sticky;
    top: 0;
    z-index: 1;
}
.data-table th.sortable {
    cursor: pointer;
    user-select: none;
}
.data-table th.sortable:hover {
    background-color: var(--border-color);
}
.data-table th .sort-icon {
    margin-left: 5px;
    opacity: 0.5;
}
.data-table th.sorted .sort-icon {
    opacity: 1;
}
.data-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}
.data-table tbody tr:hover {
    background-color: var(--bg-light);
}
.data-table td.actions-cell {
    text-align: center;
}
.data-table .btn-action {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    margin: 0 2px;
    color: var(--text-medium);
}
.data-table .btn-action:hover {
    color: var(--primary-color);
}
.data-table .btn-action.delete:hover {
    color: var(--error-color);
}

#coord-converter-modal .modal-content {
    max-width: 700px;
    padding: 15px;
}
#coord-converter-modal h3 {
    margin-bottom: 12px;
    font-size: 1.1em;
}
.converter-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 12px;
    align-items: center;
}
.converter-panel {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
    padding: 12px;
    background-color: var(--bg-light);
}
.converter-panel h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--secondary-color);
    font-size: 1em;
}
.converter-arrows {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.converter-arrows button {
    width: 50px;
    height: 50px;
    font-size: 24px;
    border-radius: 50%;
    background-color: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
}
.converter-arrows button:hover {
    background-color: var(--primary-color);
    color: white;
}
.converter-actions {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}
.converter-actions .btn-base {
    padding: 8px 10px;
    font-size: 12px;
    flex: 1 1 auto;
}
#coord-converter-modal .modal-form-group {
    margin-bottom: 10px;
}
#coord-converter-modal .modal-form-group label {
    font-size: 13px;
    margin-bottom: 3px;
}
#coord-converter-modal .modal-form-group input, #coord-converter-modal .modal-form-group select {
    padding: 8px;
    font-size: 13px;
}
#coord-converter-modal .btn-base:hover:not(:disabled), #coord-converter-modal .converter-arrows button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}
#btn-convert-to-xy, #btn-convert-to-latlon {
    background-color: var(--secondary-color);
    color: white;
}
#btn-convert-to-xy:hover, #btn-convert-to-latlon:hover {
    background-color: var(--primary-color);
}
#btn-get-main-coords {
    background-color: var(--btn-paste-bg);
}
#btn-get-main-coords:hover {
    background-color: var(--btn-paste-hover-bg);
}
#btn-apply-coords {
    background-color: var(--success-color);
}
#btn-apply-coords:hover {
    background-color: #145315;
}
#btn-open-gsi-bl2xy, #btn-open-gsi-xy2bl {
     background-color: var(--btn-googlemap-bg);
}
#btn-open-gsi-bl2xy:hover, #btn-open-gsi-xy2bl:hover {
    background-color: var(--btn-googlemap-hover-bg);
}
#btn-conv-to-dec, #btn-conv-to-dms {
    background-color: var(--btn-format-toggle-bg);
    color: var(--text-dark);
}
#btn-conv-to-dec:hover, #btn-conv-to-dms:hover {
    background-color: var(--btn-format-toggle-hover-bg);
    color: white;
}
#btn-copy-conv-result {
    background-color: var(--btn-paste-bg);
}
#btn-copy-conv-result:hover {
     background-color: var(--btn-paste-hover-bg);
}
#coord-converter-modal .modal-form-group input[type="text"], #coord-converter-modal .modal-form-group select {
    background-color: #ffffff;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #c8cdd3;
}
#coord-converter-modal .modal-form-group input[type="text"]:focus, #coord-converter-modal .modal-form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}
body.dark-mode #coord-converter-modal .modal-form-group input[type="text"], body.dark-mode #coord-converter-modal .modal-form-group select {
    background-color: #4b5563;
    border-color: #6b7280;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}
#coord-converter-modal .converter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
#coord-converter-modal .converter-row .modal-form-group {
    flex: 1;
    margin-bottom: 0;
}

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑ö„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.crosshair {
    position: absolute;
    background-color: #333;
    pointer-events: none; /* „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„ÇíÈÄèÈÅé„Åï„Åõ„Çã */
    display: none; /* ÂàùÊúüÁä∂ÊÖã„ÅØÈùûË°®Á§∫ */
    z-index: 999;
}
#crosshair-v, #crosshair-v-right { /* ‚Üê „Çª„É¨„ÇØ„Çø„ÇíËøΩÂä† */
    width: 1px;
    height: 100%;
    top: 0;
}
#crosshair-h, #crosshair-h-right { /* ‚Üê „Çª„É¨„ÇØ„Çø„ÇíËøΩÂä† */
    height: 1px;
    width: 100%;
    left: 0;
}
body.dark-mode .crosshair {
    background-color: #eee;
}
#toggle-crosshair-btn.active {
    background-color: #004D40; /* Ë∑ùÈõ¢Ë®àÊ∏¨„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„Å®Âêå„Åò„Çπ„Çø„Ç§„É´ */
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÈÄ£Áµ°‰ΩìÂà∂Âõ≥„Ç´„ÉÜ„Ç¥„É™Áî®„ÅÆ„Çπ„Çø„Ç§„É´Â§âÊõ¥ ‚ñº‚ñº‚ñº */
:root {
    --shadow-liaison: 0 8px 24px rgba(236, 64, 122, 0.4);
}
body.dark-mode {
    --shadow-liaison: 0 8px 24px rgba(236, 64, 122, 0.4);
}
.liaison-icon {
    background: linear-gradient(135deg, #F8BBD0, #F48FB1);
}
.map-card[data-category="liaison"]:hover {
    box-shadow: var(--shadow-liaison);
}
.map-card[data-category="liaison"] {
    border-left: 3px solid #EC407A;
}

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë‰ªªÊÑè„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢Áî®„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.btn-add-emergency-search {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    font-weight: bold;
    background-color: #F8BBD0;
    color: #880E4F;
    border: 2px dashed #EC407A;
    border-radius: var(--radius-base);
    cursor: pointer;
}
.btn-add-emergency-search:hover {
    background-color: #F48FB1;
    border-color: #EC407A;
}
.map-card-actions .btn-emergency-search-edit { background-color: var(--primary-color); }
.map-card-actions .btn-emergency-search-delete { background-color: var(--error-color); }
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */


@media (min-width: 1800px) {
    .left-panel {
        flex: 5;
    }
}
.mobile-address-row {
    display: contents;
}
@media (max-width: 1400px) {
    .input-row {
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        flex-direction: row !important;
        flex-wrap: wrap !important;
        align-items: flex-end !important;
    }
    .input-buttons-group {
        justify-content: space-around;
    }
    .input-group {
        align-items: stretch;
    }
    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 12px;
    }
    .input-field-label {
        display: none;
    }
}

@media (max-width: 1024px) {
    .header { flex-wrap: wrap; }
    .header-left { order: 1; width: 100%; justify-content: center; margin-bottom: 1px; }
    .header-buttons { order: 2; width: 100%; justify-content: center; }
    .project-switcher { max-width: 400px; }
    
    #osmClickMap {
        /* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÂú∞Âõ≥„ÅÆÈ´ò„Åï„ÇíË™øÊï¥ ‚ñº‚ñº‚ñº */
        height: 75vh;
        /* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */
    }

    /* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë‚ñº‚ñº‚ñº */
    /* 2ÁîªÈù¢Ë°®Á§∫„Éú„Çø„É≥„Å®ÂçÅÂ≠óÁ∑ö„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã */
    #toggleDualViewBtn,
    #toggle-crosshair-btn {
        display: none !important;
    }

    /* 2ÁîªÈù¢„É¢„Éº„Éâ„ÅåÊúâÂäπ„Åß„ÇÇ„ÄÅ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂº∑Âà∂ÁöÑ„Å´1ÁîªÈù¢„Å´‰øù„Å§ */
    #osmClickMap.dual-view-mode #mapLeft {
        width: 100% !important;
    }
    #osmClickMap.dual-view-mode #mapRight {
        width: 0 !important;
        border-left: none !important;
    }

    /* ÂçÅÂ≠óÁ∑ö„ÇíÈùûË°®Á§∫„Å´„Åô„Çã */
    .crosshair {
        display: none !important;
    }
    /* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */
}

@media (max-width: 768px) {
    .mobile-hidden {
        display: none !important;
    }
    .desktop-hidden {
        display: flex !important;
    }
    .zoom-preview-display {
        display: none;
    }
    .zoom-slider-overlay {
        display: none;
    }
    .header-left { 
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

    .mode-toggle, .history-button, .bookmark-button, .share-button, .settings-button, .usage-button, .qr-button, .header-button { width: 35px; height: 35px; font-size: 16px; }
    .header-button-label { font-size: 9px; }
    /* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„É¢„Éê„Ç§„É´„Åß„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥„ÅÆ„ÅØ„ÅøÂá∫„ÅóÂØæÁ≠ñ ‚ñº‚ñº‚ñº */
    .button-group {
        border-left: none; /* ‰ªïÂàá„ÇäÁ∑ö„ÇíÈùûË°®Á§∫ */
        padding: 0;        /* ‰ªïÂàá„ÇäÁ∑ö„ÅÆÂ∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíÂâäÈô§ */
        gap: 5px;          /* ‚Üê „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅÆÈöôÈñì„ÇíÁã≠„Åè„Åô„ÇãÔºà‰æã: 10px -> 5pxÔºâ */
    }
    .header-buttons {
        gap: 0;
        /* justify-content: space-around; „Åã„Çâ space-between „Å´Â§âÊõ¥„Åó„Å¶Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíË©∞„ÇÅ„Çã */
        justify-content: space-between;
    }
    /* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

    .history-popup, .bookmark-popup, .project-dropdown, #csvPopup {
        left: 50%;
        transform: translateX(-50%);
        right: auto;
        width: 95vw;
        max-width: 320px;
        top: 105%;
    }
    .analysis-tools-overlay { bottom: 10px; }
    
    .input-row {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
            "buttons buttons"
            "lat lon"
            "address address";
    }
    .input-buttons-group {
        grid-area: buttons;
        width: 100%;
        justify-content: space-between;
    }
    .input-group.lat-group { grid-area: lat; }
    .input-group.lon-group { grid-area: lon; }
    .input-group.address-group { grid-area: address; }
    
    #osmClickMap {
        /* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÂú∞Âõ≥„ÅÆÈ´ò„Åï„ÇíË™øÊï¥ ‚ñº‚ñº‚ñº */
        height: 65vh;
        /* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */
    }
    .converter-grid {
        grid-template-columns: 1fr;
    }
    .converter-arrows {
        flex-direction: row;
        justify-content: center;
        transform: rotate(90deg);
        margin: 10px 0;
    }
}

.right-panel.hidden {
    transform: translateX(100%);
    pointer-events: none;
}

#panelOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    display: block;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease-in-out;
}
#panelOverlay.show {
    opacity: 1;
    pointer-events: auto;
}

.main-layout.pinned {
    overflow-x: auto;
}

.main-layout.pinned .left-panel {
    width: calc(100% - var(--panel-width, 500px));
}

.main-layout.pinned .right-panel {
    position: relative;
    transform: translateX(0) !important;
    height: auto;
    pointer-events: auto;
}

.main-layout.pinned #panelOverlay {
    display: none !important;
}

.right-panel.narrow-tabs .tab-text {
    font-size: 0;
}
.right-panel.narrow-tabs .tab-text::after {
    font-size: 14px;
}

.right-panel.narrow-tabs .panel-tab[data-tab="map-links"] .tab-text::after {
    content: '„É™„É≥„ÇØ';
}
.right-panel.narrow-tabs .panel-tab[data-tab="history"] .tab-text::after {
    content: 'Â±•Ê≠¥';
}
.right-panel.narrow-tabs .panel-tab[data-tab="bookmarks"] .tab-text::after {
    content: 'BM';
}

.table-wrapper {
    overflow-x: auto;
}

.data-table {
    table-layout: fixed;
    width: auto;
}

.data-table th,
.data-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#historyTable th:nth-child(1), #historyTable td:nth-child(1) { width: 40px; }
#historyTable th:nth-child(2), #historyTable td:nth-child(2) { width: 45px; }
#historyTable th:nth-child(3), #historyTable td:nth-child(3) { width: 80px; }
#historyTable th:nth-child(4), #historyTable td:nth-child(4) { width: 110px; }
#historyTable th:nth-child(5), #historyTable td:nth-child(5) { width: 110px; }
#historyTable th:nth-child(6), #historyTable td:nth-child(6) { width: 110px; }
#historyTable th:nth-child(7), #historyTable td:nth-child(7) { width: 70px; }
#historyTable th:nth-child(8), #historyTable td:nth-child(8) { width: 110px; }
#historyTable th:nth-child(9), #historyTable td:nth-child(9) { width: 110px; }
#historyTable th:nth-child(10),#historyTable td:nth-child(10){ width: 60px; }
#historyTable th:nth-child(11),#historyTable td:nth-child(11){ width: 140px; }
#historyTable th:nth-child(12),#historyTable td:nth-child(12){ width: 70px; }


#bookmarkTable th:nth-child(1), #bookmarkTable td:nth-child(1) { width: 40px; }
#bookmarkTable th:nth-child(2), #bookmarkTable td:nth-child(2) { width: 45px; }
#bookmarkTable th:nth-child(3), #bookmarkTable td:nth-child(3) { width: 120px; }
#bookmarkTable th:nth-child(4), #bookmarkTable td:nth-child(4) { width: 80px; }
#bookmarkTable th:nth-child(5), #bookmarkTable td:nth-child(5) { width: 110px; }
#bookmarkTable th:nth-child(6), #bookmarkTable td:nth-child(6) { width: 110px; }
#bookmarkTable th:nth-child(7), #bookmarkTable td:nth-child(7) { width: 110px; }
#bookmarkTable th:nth-child(8), #bookmarkTable td:nth-child(8) { width: 70px; }
#bookmarkTable th:nth-child(9), #bookmarkTable td:nth-child(9) { width: 110px; }
#bookmarkTable th:nth-child(10),#bookmarkTable td:nth-child(10){ width: 110px; }
#bookmarkTable th:nth-child(11),#bookmarkTable td:nth-child(11){ width: 60px; }
#bookmarkTable th:nth-child(12),#bookmarkTable td:nth-child(12){ width: 140px; }
#bookmarkTable th:nth-child(13),#bookmarkTable td:nth-child(13){ width: 70px; }

.input-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
}

.input-row .input-group label,
.input-row .input-button-wrapper .input-button-label {
    font-size: 11px;
    font-weight: 600;
    margin-top: 4px;
    color: var(--text-medium);
    display: block;
    text-align: center;
    white-space: nowrap;
}
.input-row .input-button-wrapper .input-button-label {
    font-size: 10px;
}


.input-row .input-group.latlon-group {
    flex: 0 1 250px;
    min-width: 120px;
}
.input-row .input-group.zone-group {
    flex: 0 0 70px;
}
.input-row .input-group.xy-group {
    flex: 1 1 100px;
    min-width: 100px;
}
.input-row .input-group.address-group {
    flex: 3 1 100px;
    min-width: 100px;
}

.input-row .input-group.zone-group select {
    width: 100%;
    padding: 10px 8px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-bg);
    color: var(--text-dark);
    height: 42px;
}

.btn-convert {
    background-color: var(--secondary-color);
    color: white;
}
.btn-convert:hover {
    background-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

#btn-open-coord-converter {
    background-color: var(--btn-googlemap-bg);
    color: white;
    min-width: 85px;
}

#btn-open-coord-converter:hover {
    background-color: var(--btn-googlemap-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
}

@media (max-width: 768px) {
    .input-row {
        display: grid;
        gap: 8px;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        grid-template-areas:
            "geo      bkmk     fmt      route    panel"
            "lat      lat      lon      lon      conv"
            "addr-row addr-row addr-row addr-row addr-row";
    }

    /* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩË®ò„Äë‚ñº‚ñº‚ñº */
    /* ID„ÅßÁõ¥Êé•ÊåáÂÆö„Åó„Å¶„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã */
    #csvButton,
    .usage-button {
        display: none;
    }

    /* „É©„Éô„É´„ÇÇÈùûË°®Á§∫„Å´„Åô„Çã */
    #csvButton + .header-button-label,
    .usage-button + .header-button-label {
        display: none;
    }
    /* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩË®ò„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */
}

    .mobile-grid-item-addr,
    .mobile-grid-item-search {
        grid-area: auto;
    }

    .mobile-address-row {
        grid-area: addr-row;
        display: flex;
        gap: 8px;
        flex-grow: 1; 
    }

    .mobile-address-row .input-group.address-group {
        flex-grow: 1;
        width: 0;
    }
    
    .mobile-address-row .input-button-wrapper {
        flex-shrink: 0;
    }
    .mobile-grid-item-geo { grid-area: geo; }
    .mobile-grid-item-bkmk { grid-area: bkmk; }
    .mobile-grid-item-fmt { grid-area: fmt; }
    .mobile-grid-item-route { grid-area: route; }
    .mobile-grid-item-panel { grid-area: panel; }

    .mobile-grid-item-lat { grid-area: lat; }
    .mobile-grid-item-lon { grid-area: lon; }
    .mobile-grid-item-conv { grid-area: conv; }
    
    .mobile-grid-item-addr { grid-area: addr; }
    .mobile-grid-item-search { grid-area: search; }

    .input-buttons-group { display: contents; }
    .input-group.lat-group,
    .input-group.lon-group,
    .input-group.address-group { grid-area: auto; }

}
.btn-convert {
    width: 70px;
}

.input-row .input-group #latitude,
.input-row .input-group #longitude,
.input-row .input-group #addressInput {
    background-color: #ffffff;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #c8cdd3;
}

body.dark-mode .input-row .input-group #latitude,
body.dark-mode .input-row .input-group #longitude,
body.dark-mode .input-row .input-group #addressInput {
    background-color: #4b5563; 
    border-color: #6b7280;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.input-row .input-wrapper {
    position: relative;
    width: 100%;
    display: flex;
}

.btn-copy-input {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 40px;
    border: none;
    background-color: transparent;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-medium);
    transition: color 0.2s;
}

.btn-copy-input:hover {
    color: var(--primary-color);
}

.input-row .input-wrapper input {
    padding-right: 40px;
}

#settings-modal .modal-buttons {
    position: absolute;
    top: 10px;
    right: 55px;
    margin-top: 0;
    gap: 8px;
}

#settings-modal .modal-buttons button {
    padding: 6px 12px;
    font-size: 13px;
    transition: all 0.3s ease;
}

#settings-modal h3 {
    padding-right: 250px;
}

#settings-modal .btn-modal-save {
    background-color: var(--primary-color);
}
#settings-modal .btn-modal-save:hover {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

#settings-modal .btn-modal-cancel:hover {
    background-color: #cccccc;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

body.dark-mode #settings-modal .btn-modal-cancel:hover {
    background-color: #4B5563;
}

.settings-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin: 0 -15px 15px -15px;
    padding: 0 15px;
}

.settings-tab {
    padding: 10px 18px;
    cursor: pointer;
    background-color: var(--bg-light);
    border: 2px solid var(--border-color);
    border-bottom: none;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-medium);
    transition: all 0.2s ease;
    margin-bottom: -2px;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}

.settings-tab:hover {
    color: var(--text-dark);
    background-color: var(--border-color);
}

.settings-tab.active {
    color: var(--primary-color);
    background-color: var(--bg-container);
    border-bottom-color: var(--bg-container);
    z-index: 1;
}

.settings-tab-content {
    display: none;
    animation: fadeIn 0.3s;
}

.settings-tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

#settings-form {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.settings-tab-content-wrapper {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 10px;
    margin-right: -10px;
}

@media (min-width: 1025px) {
    #project-modal {
        justify-content: flex-start;
        padding-left: 140px; 
    }
}
/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëCSVÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */

/* --- CSV„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ --- */
#csv-import-modal .modal-content {
    max-width: 90vw;
    width: 800px;
}
.csv-import-stepper {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}
.csv-import-step {
    font-weight: 600;
    color: var(--text-medium);
}
.csv-import-step.active {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
}
#csv-column-mapping, #csv-import-confirm {
    display: none; /* Initially hidden */
}
#csv-preview-container {
    max-height: 250px;
    overflow: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
}
#csv-preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
#csv-preview-table th, #csv-preview-table td {
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}
#csv-preview-table thead {
    position: sticky;
    top: 0;
    background-color: var(--bg-light);
}
.column-mapper-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
}
.column-mapper-item label {
    font-weight: 700;
}
.column-mapper-item select {
    width: 100%;
    padding: 8px;
}
.column-mapper-item .required::after {
    content: ' *';
    color: var(--error-color);
}
.csv-import-info {
    font-size: 13px;
    background-color: var(--bg-light);
    padding: 10px;
    border-radius: 8px;
}

/* --- CSV„Éó„É≠„ÉÉ„ÉàÁî®„ÅÆÂú∞Âõ≥„Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ (ÂâäÈô§) --- */


/* --- CSV„Éä„Éì„Ç≤„Éº„Çø„Éº (Â∑°Âõû) „Éë„Éç„É´ --- */
#csv-navigator-content { /* ‚òÖ‚òÖ‚òÖ #csv-navigator-container „Åã„ÇâÂ§âÊõ¥ ‚òÖ‚òÖ‚òÖ */
    padding: 8px;
    /* border-top „ÅØ‰∏çË¶Å */
}
#csv-navigator-content.hidden { /* ‚òÖ‚òÖ‚òÖ .hidden „Çí .active „Åß„ÅØ„Å™„ÅÑÂ†¥Âêà„Å´ÈÅ©Áî® ‚òÖ‚òÖ‚òÖ */
    display: none;
}
.csv-nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}
.csv-nav-header h4 {
    margin: 0;
    font-size: 14px;
}
.csv-nav-header button {
    padding: 6px 12px; /* ‚òÖ‚òÖ‚òÖ „Çµ„Ç§„Ç∫„ÇíÂ∞ë„ÅóË™øÊï¥ ‚òÖ‚òÖ‚òÖ */
    font-size: 12px;
    height: auto; /* ‚òÖ‚òÖ‚òÖ È´ò„Åï„ÇíËá™Âãï„Å´ ‚òÖ‚òÖ‚òÖ */
    min-width: auto; /* ‚òÖ‚òÖ‚òÖ ÊúÄÂ∞èÂπÖ„ÇíËá™Âãï„Å´ ‚òÖ‚òÖ‚òÖ */
}
#csv-nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
}
.csv-nav-item {
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.csv-nav-item:last-child {
    border-bottom: none;
}
.csv-nav-item:hover {
    background-color: var(--bg-light);
}
.csv-nav-item.active {
    background-color: var(--primary-color);
    color: white;
    font-weight: bold;
}
.csv-nav-controls {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}
/* ‚ñº‚ñº‚ñº„Äê‰ª•‰∏ã„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†„Äë‚ñº‚ñº‚ñº */
.csv-nav-controls button {
    flex: 1;
    padding: 8px;
    font-size: 14px;
    /* „Éú„Çø„É≥„ÅÆË¶ñË™çÊÄßÂêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆ„Çπ„Çø„Ç§„É´ */
    background-color: var(--primary-color);
    color: white;
    border: none;
    transition: background-color 0.2s;
}
.csv-nav-controls button:hover:not(:disabled) {
    background-color: var(--secondary-color);
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº„ÅÆ„É™„Çπ„ÉàË°®Á§∫ÊîπÂñÑÁî®CSS ‚ñº‚ñº‚ñº */
.csv-nav-item-title {
    font-weight: bold;
    margin-bottom: 5px;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
.csv-nav-item.active .csv-nav-item-title {
    border-bottom-color: rgba(255,255,255,0.5);
}
.csv-nav-detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    line-height: 1.5;
}
.csv-nav-detail-key {
    font-weight: 600;
    color: var(--text-medium);
    margin-right: 10px;
    flex-shrink: 0;
}
.csv-nav-item.active .csv-nav-detail-key {
    color: rgba(255,255,255,0.7);
}
.csv-nav-detail-value {
    word-break: break-all;
    text-align: right;
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Éú„Çø„É≥„ÅÆ„Ç∞„É´„Éº„ÉóÂåñÁî®CSS ‚ñº‚ñº‚ñº */
.button-group {
    display: flex;
    gap: 10px; /* „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅÆÈöôÈñì */
    align-items: center;
    padding: 0 10px;
    border-left: 1px solid rgba(255, 255, 255, 0.3);
}

.button-group:first-child {
    border-left: none;
    padding-left: 0;
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Çø„Éñ„É¨„ÉÉ„ÉàÁ≠â„ÅÆÈ´òËß£ÂÉèÂ∫¶„É¢„Éê„Ç§„É´Âêë„ÅëË™øÊï¥ ‚ñº‚ñº‚ñº */
@media (min-width: 769px) and (max-width: 1280px) {
    .header {
        /* „Éò„ÉÉ„ÉÄ„ÉºÂÖ®‰Ωì„ÅÆÂ∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíÂ∞ë„ÅóË©∞„ÇÅ„Çã */
        padding: 1px 10px;
        /* ÂêÑË¶ÅÁ¥†„ÅÆÈñì„ÅÆÈöôÈñì„ÇíÂ∞ë„ÅóË©∞„ÇÅ„Çã */
        gap: 10px;
    }

    .button-group {
        border-left: none; /* ‰ªïÂàá„ÇäÁ∑ö„ÇíÈùûË°®Á§∫„Å´„Åô„Çã */
        padding: 0;        /* ‰ªïÂàá„ÇäÁ∑ö„ÅÆ‰ΩôÁôΩ„ÇíÂâäÈô§ */
        gap: 8px;          /* „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅÆÈöôÈñì„ÇíÂ∞ë„ÅóÁã≠„Åè„Åô„Çã */
    }

    .header-buttons {
        gap: 0;
        /* „Ç∞„É´„Éº„ÉóÈñì„ÅÆÈöôÈñì„ÇíÂùáÁ≠â„Å´ÈÖçÁΩÆ„Åó„Å¶Ë©∞„ÇÅ„Çã */
        justify-content: space-between;
    }
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë2ÁîªÈù¢Ë°®Á§∫„É¢„Éº„ÉâÁî®„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÊîπË®ÇÁâàÔºâ ‚ñº‚ñº‚ñº */

/* --- Âú∞Âõ≥„ÅÆË¶™„Ç≥„É≥„ÉÜ„Éä(#osmClickMap)„ÅÆÂü∫Êú¨Ë®≠ÂÆö --- */
#osmClickMap {
    display: flex; /* Â≠êË¶ÅÁ¥†„ÇíÊ®™‰∏¶„Å≥„Å´„Åô„Çã„Åü„ÇÅ */
    overflow: hidden; /* „ÅØ„ÅøÂá∫„Åó„ÇíÈö†„Åô */
}

/* --- Â∑¶Âè≥„ÅÆÂú∞Âõ≥„Ç≥„É≥„ÉÜ„Éä„ÅÆÂÖ±ÈÄöË®≠ÂÆö --- */
#mapLeft, #mapRight {
    height: 100%; /* Ë¶™„Ç≥„É≥„ÉÜ„Éä„ÅÆÈ´ò„Åï‰∏ÄÊùØ„Å´Â∫É„Åå„Çã */
    transition: width 0.4s ease-in-out; /* ÂπÖ„ÅÆÂ§âÊõ¥„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    background-color: #f0f0f0; /* Âú∞Âõ≥Ë™≠„ÅøËæº„Åø‰∏≠„ÅÆËÉåÊôØËâ≤ */
}

/* --- ÈÄöÂ∏∏ÊôÇÔºà1ÁîªÈù¢„É¢„Éº„ÉâÔºâ„ÅÆ„Çπ„Çø„Ç§„É´ --- */
#mapLeft {
    width: 100%;
}
#mapRight {
    width: 0;
    /* display:none; „ÅÆ‰ª£„Çè„Çä„Å´ÂπÖ0„ÅßË¶ã„Åà„Å™„Åè„Åô„Çã„Åì„Å®„Åß„ÄÅ„Çµ„Ç§„Ç∫Ë®àÁÆó„ÅÆÂïèÈ°å„ÇíÂõûÈÅø */
    border-left: none;
}

/* --- 2ÁîªÈù¢Ë°®Á§∫„É¢„Éº„ÉâÊúâÂäπÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´ --- */
#osmClickMap.dual-view-mode #mapLeft {
    width: 50%;
}
#osmClickMap.dual-view-mode #mapRight {
    width: 50%;
    border-left: 2px solid var(--primary-color);
}

/* --- 2ÁîªÈù¢Ë°®Á§∫„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã --- */
#toggleDualViewBtn.active {
    background-color: var(--primary-color);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

/* --- „É¢„Éê„Ç§„É´ÂØæÂøú --- */
@media (max-width: 1024px) {
    #toggleDualViewBtn,
    #toggleDualViewBtn + .header-button-label {
        display: none !important;
    }
}

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂú∞Âõ≥„Éò„ÉÉ„ÉÄ„ÉºÂÜÖ„ÅÆ2ÁîªÈù¢Ë°®Á§∫„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.osm-map-header .header-button-wrapper {
    margin-left: auto; /* „Éú„Çø„É≥„ÇíÂè≥Á´Ø„Å´ÈÖçÁΩÆ */
}

.osm-map-header #toggleDualViewBtn {
    width: auto;
    height: auto;
    min-width: 100px;
    padding: 6px 12px;
    border-radius: var(--radius-base);
    background-color: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    font-size: 14px;
    font-weight: 600;
}

.osm-map-header #toggleDualViewBtn:hover {
    background-color: var(--border-color);
    transform: none; /* „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥„ÅÆ„Éõ„Éê„ÉºÂäπÊûú„ÇíÊâì„Å°Ê∂à„Åó */
}

.osm-map-header #toggleDualViewBtn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.osm-map-header .header-button-label {
    display: none; /* „Éú„Çø„É≥ÂÜÖ„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•„Çå„Çã„ÅÆ„Åß„É©„Éô„É´„ÅØ‰∏çË¶Å */
}

/* „Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíJS„ÅßÂ§âÊõ¥„Åô„Çã„Åü„ÇÅ„ÄÅ„Ç¢„Ç§„Ç≥„É≥„ÅØCSS„ÅßË°®Á§∫ */
.osm-map-header #toggleDualViewBtn::before {
    content: 'üî≤ 2ÁîªÈù¢Ë°®Á§∫';
}
.osm-map-header #toggleDualViewBtn.active::before {
    content: 'üî≥ 1ÁîªÈù¢Ë°®Á§∫';
}
.osm-map-header #toggleDualV-iewBtn {
    font-size: 0; /* ÂÖÉ„ÅÆÁµµÊñáÂ≠ó„Ç¢„Ç§„Ç≥„É≥„ÇíÈö†„Åô */
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* Êó¢Â≠ò„ÅÆ .header-button „ÅÆ„Çπ„Çø„Ç§„É´„Å´ËøΩÂæì„Åó„Å§„Å§„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂÆöÁæ© */
.osm-map-header #toggle-crosshair-btn {
    width: auto;
    height: auto;
    min-width: 35px;
    padding: 6px;
    border-radius: var(--radius-base);
    background-color: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    font-size: 13px;
    font-weight: 600;
}

.osm-map-header #toggle-crosshair-btn:hover {
    background-color: var(--border-color);
    transform: none;
}

.osm-map-header #toggle-crosshair-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëJS„Å®ÈÄ£Êê∫„Åô„ÇãÂÖ®ÁîªÈù¢Ë°®Á§∫ÂØæÁ≠ñÁî®„ÅÆCSS ‚ñº‚ñº‚ñº */

/* JS„Å´„Çà„Å£„Å¶body„Å´„ÇØ„É©„Çπ„Åå‰ªò‰∏é„Åï„Çå„Å¶„ÅÑ„ÇãÈñì„Å†„Åë„ÄÅ‰ª•‰∏ã„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî® */

/* 1. „Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂº∑Âà∂ÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åô„Çã */
body.left-map-is-fullscreen #mapLeft,
body.left-map-is-fullscreen #mapRight {
    /* „Åì„Çå„ÅåÊúÄ„ÇÇÈáçË¶ÅÔºÅ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÊ≠¢„ÇÅ„Å¶ÊèèÁîª„ÅÆÁ´∂Âêà„ÇíÈò≤„Åê */
    transition: none !important;
}

/* 2. Âè≥ÂÅ¥„ÅÆÂú∞Âõ≥„ÇíÂÆåÂÖ®„Å´ÈùûË°®Á§∫„Å´„Åô„Çã */
body.left-map-is-fullscreen #mapRight {
    /* ÁôΩ„ÅÑÈ†òÂüü„ÅåÊÆã„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÅ„É¨„Ç§„Ç¢„Ç¶„Éà„Åã„ÇâÂÆåÂÖ®„Å´Âèñ„ÇäÈô§„Åè */
    display: none;
}

/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Çπ„Éî„Éä„Éº„ÅÆ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
.input-spinner {
    display: none; /* ÂàùÊúüÁä∂ÊÖã„ÅØÈùûË°®Á§∫ */
    box-sizing: border-box;
    position: absolute;
    top: 50%;
    right: 40px; /* „Ç≥„Éî„Éº„Éú„Çø„É≥„ÅÆÂ∑¶ÂÅ¥ */
    width: 18px;
    height: 18px;
    margin-top: -9px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.input-wrapper.loading .input-spinner {
    display: block; /* loading„ÇØ„É©„Çπ„Åå‰ªò„ÅÑ„Åü„ÇâË°®Á§∫ */
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑öÊúâÂäπÊôÇ„ÅÆ„Ç´„Éº„ÇΩ„É´Âà∂Âæ°„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
#osmClickMap .leaflet-container.crosshair-active {
    cursor: grab; /* ÂçÅÂ≠óÁ∑öÊúâÂäπ„ÉªÈùôÊ≠¢ÊôÇ„ÅØÊâã„ÅÆ„Å≤„Çâ„Ç´„Éº„ÇΩ„É´ */
}
#osmClickMap .leaflet-container.crosshair-active.leaflet-dragging {
    cursor: none; /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ„Ç´„Éº„ÇΩ„É´„ÇíÊ∂à„Åô */
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëË®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆË¶ã„ÇÑ„Åô„ÅïÊîπÂñÑ„Çπ„Çø„Ç§„É´ ‚ñº‚ñº‚ñº */
#settings-map-visibility-list, #settings-category-names {
    /* „Çπ„ÇØ„É≠„Éº„É´„Çí„Å™„Åè„Åô„Åü„ÇÅ„ÄÅmax-height„ÇíÂâäÈô§„Åó„ÄÅoverflow„Çívisible„Å´ */
    max-height: none;
    overflow-y: visible;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    background-color: var(--bg-light);
}
.settings-tab-content[data-tab-content="basic"] .modal-form-group {
    padding: 15px 10px;
    margin-bottom: 0;
    border-radius: var(--radius-base);
    transition: background-color 0.2s ease-in-out;
}
.settings-tab-content[data-tab-content="basic"] .modal-form-group + .modal-form-group {
    border-top: 1px solid var(--border-color);
}
/* „Éõ„Éê„ÉºÊôÇ„ÅÆËÉåÊôØËâ≤„Çí„ÄÅ„Ç≥„É≥„ÉÜ„Éä„ÅÆËÉåÊôØ„Å®„ÅØÁï∞„Å™„ÇãËâ≤„Å´Â§âÊõ¥ */
.settings-tab-content[data-tab-content="basic"] .modal-form-group:hover {
    background-color: #f8f9fa;
}
body.dark-mode .settings-tab-content[data-tab-content="basic"] .modal-form-group:hover {
    background-color: #2d3748; /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÁî®„ÅÆÊøÉ„ÅÑ„Ç∞„É¨„Éº */
}
/* ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ */

</style>
</head>
<body>
<!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Éá„Éº„ÇøÊ∂àÂ§±„É™„Çπ„ÇØË≠¶Âëä„Éê„Éä„Éº ‚ñº‚ñº‚ñº -->
<div id="data-loss-warning-banner" class="data-warning-banner" style="display: none;">
    <p>‚ö†Ô∏è <strong>ÈáçË¶Å:</strong> „Åì„ÅÆ„Ç¢„Éó„É™„ÅÆ„Éá„Éº„Çø(„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÄÅÂ±•Ê≠¥Á≠â)„ÅØ„ÄÅ„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇÑÂ±•Ê≠¥„ÇíÊ∂àÂéª„Åô„Çã„Å®„ÄÅ„Éá„Éº„Çø„ÅåÂÖ®„Å¶Â§±„Çè„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂ§ßÂàá„Å™„Éá„Éº„Çø„ÅØÂÆöÊúüÁöÑ„Å´„ÄåË®≠ÂÆö ‚Üí „Éá„Éº„ÇøÁÆ°ÁêÜ„Äç„Åã„Çâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó(Êõ∏„ÅçÂá∫„Åó)„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    <button id="dismiss-warning-btn" title="Èñâ„Åò„Çã">&times;</button>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
<div class="notification" id="notification"></div>
<div class="container">
<header class="header">
    <div class="header-left">
        <h1>üó∫Ô∏è Geo Link Navi</h1>
        <div class="project-switcher">
            <button id="projectSwitcherBtn" aria-haspopup="true" aria-expanded="false" aria-label="ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂàá„ÇäÊõø„Åà">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠Ëæº‰∏≠...</button>
            <div class="project-dropdown" id="projectSwitcherDropdown">
                <a href="#" class="project-dropdown-item project-dropdown-manage" id="manageProjectsBtn">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁÆ°ÁêÜ...</a>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éú„Çø„É≥„ÅÆ„Ç∞„É´„Éº„ÉóÂåñ ‚ñº‚ñº‚ñº -->
<nav class="header-buttons" aria-label="‰∏ªË¶ÅÊ©üËÉΩ">
    <!-- Êàª„Çã/ÈÄ≤„ÇÄ „Ç∞„É´„Éº„Éó -->
    <div class="button-group">
        <div class="header-button-wrapper">
            <button class="nav-button" id="navBack" title="Ââç„ÅÆÂ∫ßÊ®ô„Å´Êàª„Çã" aria-label="Ââç„ÅÆÂ∫ßÊ®ô„Å´Êàª„Çã" disabled>‚óÄ</button>
            <span class="header-button-label">Êàª„Çã</span>
        </div>
        <div class="header-button-wrapper">
            <button class="nav-button" id="navForward" title="Ê¨°„ÅÆÂ∫ßÊ®ô„Å´ÈÄ≤„ÇÄ" aria-label="Ê¨°„ÅÆÂ∫ßÊ®ô„Å´ÈÄ≤„ÇÄ" disabled>‚ñ∂</button>
            <span class="header-button-label">ÈÄ≤„ÇÄ</span>
        </div>
    </div>

    <!-- ÂÖ±Êúâ „Ç∞„É´„Éº„Éó -->
    <div class="button-group">
        <div class="header-button-wrapper">
            <button class="qr-button" onclick="openQrModal()" aria-label="QR„Ç≥„Éº„Éâ„Å®„É™„É≥„ÇØ„ÅßÂÖ±Êúâ" title="QR„Ç≥„Éº„Éâ„Å®„É™„É≥„ÇØ„ÅßÂÖ±Êúâ">üì±</button>
            <span class="header-button-label">ÂÖ±Êúâ</span>
        </div>
    </div>

    <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ „Ç∞„É´„Éº„Éó -->
    <div class="button-group">
        <div class="header-button-wrapper">
            <button class="bookmark-button" id="bookmarkButton" onclick="toggleBookmarkPopup()" aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíË°®Á§∫">‚≠ê</button>
            <span class="header-button-label">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</span>
            <div class="bookmark-popup" id="bookmarkPopup">
                <h4>‚≠ê Âú∞ÁÇπ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</h4>
                <div class="popup-buttons">
                    <button class="btn-clear-bookmarks" onclick="clearBookmarks()">üóëÔ∏è ÂÖ®ÂâäÈô§</button>
                    <button class="btn-export-csv" onclick="exportBookmarksToCSV()">üíæ CSV</button>
                    <button class="btn-import-csv" onclick="openCsvImportModal('bookmark')">üì• „Ç§„É≥„Éù„Éº„Éà</button>
                    <button class="btn-export-kml" onclick="exportBookmarksToKML()">üåê KML</button>
                </div>
                <div id="bookmarkList"></div>
            </div>
        </div>
        <div class="header-button-wrapper">
            <button class="history-button" id="historyButton" onclick="toggleHistoryPopup()" aria-label="Â±•Ê≠¥" title="Â±•Ê≠¥„ÇíË°®Á§∫">‚è±Ô∏è</button>
            <span class="header-button-label">Â±•Ê≠¥</span>
            <div class="history-popup" id="historyPopup">
                <h4>Â∫ßÊ®ôÂ±•Ê≠¥</h4>
                <div class="popup-buttons">
                    <button class="btn-clear-history" onclick="clearHistory()">üóëÔ∏è Â±•Ê≠¥„ÇØ„É™„Ç¢</button>
                    <button class="btn-export-csv" onclick="exportHistoryToCSV()">üíæ CSV</button>
                    <button class="btn-export-kml" onclick="exportHistoryToKML()">üåê KML</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëCSV„Éá„Éº„ÇøÁÆ°ÁêÜ„Éú„Çø„É≥ ‚ñº‚ñº‚ñº -->
        <div class="header-button-wrapper">
            <button class="header-button" id="csvButton" aria-label="CSV„Éá„Éº„Çø" title="CSV„Éá„Éº„Çø„ÇíÁÆ°ÁêÜ">üìÑ</button>
            <span class="header-button-label">CSV„Éá„Éº„Çø</span>
            <div class="popup-buttons" id="csvPopup">
                <h4>CSV„Éá„Éº„ÇøÁÆ°ÁêÜ</h4>
                <div class="popup-buttons" style="flex-direction: column; align-items: stretch;">
                    <button id="csv-plot-btn-header" class="btn-base" style="background-color: var(--primary-color);">üó∫Ô∏è Âú∞Âõ≥„Å´„Éó„É≠„ÉÉ„Éà</button>
                    <button id="csv-navigate-btn-header" class="btn-base" style="background-color: var(--secondary-color); margin-top: 5px;">‚ñ∂Ô∏è Â∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº</button>
                    <button id="csv-clear-plot-btn-header" class="btn-base" style="background-color: var(--error-color); margin-top: 10px;" disabled>üóëÔ∏è „Éó„É≠„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢</button>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
    </div>
    <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ „Ç∞„É´„Éº„Éó -->


    <!-- Ë®≠ÂÆö „Ç∞„É´„Éº„Éó -->
    <div class="button-group">
        <div class="header-button-wrapper">
            <button class="settings-button" id="settingsButton" aria-label="Ë®≠ÂÆö" title="Ë®≠ÂÆö">‚öôÔ∏è</button>
            <span class="header-button-label">Ë®≠ÂÆö</span>
        </div>
        <div class="header-button-wrapper">
            <button class="mode-toggle" id="modeToggle" aria-label="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà" title="„ÉÄ„Éº„ÇØ/„É©„Ç§„Éà„É¢„Éº„ÉâÂàáÊõø">üåô</button>
            <span class="header-button-label">„É¢„Éº„ÉâÂàáÊõø</span>
        </div>
        <div class="header-button-wrapper">
            <button class="usage-button" onclick="toggleUsage()" aria-label="‰Ωø„ÅÑÊñπ" title="‰Ωø„ÅÑÊñπ„ÇíË°®Á§∫">Ôºü</button>
            <span class="header-button-label">‰Ωø„ÅÑÊñπ</span>
        </div>
    </div>
</nav>
<!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
<div class="usage-guide" id="usageGuide">
    <p>‚òÖÁü•„Çä„Åü„ÅÑÂ†¥ÊâÄ„ÅÆÁ∑ØÂ∫¶„ÉªÁµåÂ∫¶„Åã„Çâ„ÄÅË§áÊï∞„ÅÆ„Ç™„É≥„É©„Ç§„É≥Âú∞Âõ≥„ÇÑÂ∞ÇÈñÄÂõ≥Èù¢„Çµ„Ç§„Éà„Å∏Áû¨ÊôÇ„Å´„Ç¢„ÇØ„Çª„Çπ„ÄÇÊÉÖÂ†±ÂèéÈõÜ„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ‚òÖ</p>
    <p class="popup-warning">‚ö†Ô∏è <strong>Ê≥®ÊÑè:</strong> Ë§áÊï∞„ÅÆÂú∞Âõ≥„Çí‰∏ÄÊã¨„ÅßÈñã„Åè„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§Ôºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË®±ÂèØÔºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

<h4>‚ñ† Âü∫Êú¨ÁöÑ„Å™‰Ωø„ÅÑÊñπ„ÉªÂ∫ßÊ®ô„ÅÆÊåáÂÆö</h4>
<ul> 
    <li><strong>Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ:</strong> Â∑¶ÂÅ¥„ÅÆ„Äåüó∫Ô∏è„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ∫ßÊ®ôÂèñÂæó„ÄçÂú∞Âõ≥‰∏ä„ÅßÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÂú∞ÁÇπ„ÅÆÁ∑ØÂ∫¶„ÉªÁµåÂ∫¶„ÅåËá™Âãï„ÅßÂÖ•Âäõ„Åï„Çå„Åæ„Åô„ÄÇ</li>
    <li><strong>„Éó„É¨„Éì„É•„ÉºÂú∞Âõ≥„ÅÆÊìç‰Ωú:</strong>
        <ul>          
            <li>Âú∞Âõ≥„ÅÆÂÖ®ÁîªÈù¢Ë°®Á§∫„Å®Ëß£Èô§„ÅØ„ÄÅÂú∞Âõ≥Â∑¶‰∏ä„ÅÆ„Éú„Çø„É≥„Åæ„Åü„ÅØ `ESC` „Ç≠„Éº„ÅßË°å„ÅÑ„Åæ„Åô„ÄÇ</li>
            <li>Âú∞Âõ≥Â∑¶‰∏ä„ÅÆ„ÄåüéØ„Äç„Éú„Çø„É≥„Åß„ÄÅÁèæÂú®Âú∞„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ</li>
            <li>Âú∞Âõ≥Âè≥‰∏ä„ÅÆ„É¨„Ç§„É§„ÉºÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„Åß„ÄÅOpenStreetMap„Å®Âú∞ÁêÜÈô¢Âú∞Âõ≥„ÇíÂàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô„ÄÇ</li>
            <li>Âú∞Âõ≥„ÅÆÂè≥‰∏ã„Å´„ÅÇ„Çã„Çπ„É©„Ç§„ÉÄ„Éº„Åß„ÄÅ„Ç∫„Éº„É†„É¨„Éô„É´„ÇíÁõ¥ÊÑüÁöÑ„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</li> 
        </ul>
    </li>
    <li><strong>ÁèæÂú®Âú∞ÂèñÂæó:</strong> „ÄåüéØÁèæÂú®Âú∞„Äç„Éú„Çø„É≥„Åß„ÄÅ„Åä‰Ωø„ÅÑ„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂà©Áî®„Åó„Å¶Â∫ßÊ®ô„ÇíÂèñÂæó„Åó„Åæ„Åô„ÄÇÔºà„Éñ„É©„Ç¶„Ç∂„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ</li>
    <li><strong>Google„Éû„ÉÉ„Éó„ÅßÊé¢„Åô:</strong> „ÄåüåçGoogle„Éû„ÉÉ„Éó„ÅßÊé¢„Åô„Äç„Éú„Çø„É≥„ÅßÈñã„ÅÑ„ÅüÂú∞Âõ≥‰∏ä„ÅßË™ø„Åπ„Åü„ÅÑÂ†¥ÊâÄ„ÇíÂè≥„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅÂ∫ßÊ®ô„Çí„Ç≥„Éî„Éº„Åó„Å¶Âà©Áî®„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</li> 
    <li><strong>Â∫ßÊ®ô„ÅÆË≤º„Çä‰ªò„Åë:</strong> „ÄåüìÑ Ë≤º„Çä‰ªò„Åë„Äç„Éú„Çø„É≥„Åß„ÄÅ„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„ÅüÂ∫ßÊ®ôÔºà‰æã: <code>35.681, 139.767</code>Ôºâ„ÇíË≤º„Çä‰ªò„Åë„Çâ„Çå„Åæ„Åô„ÄÇ</li>
    <li><strong>ÂΩ¢Âºè„ÅÆÂàá„ÇäÊõø„Åà:</strong>„Äå‚öôÔ∏èÂΩ¢ÂºèÂàáÊõø„Äç„Éú„Çø„É≥„Åß„ÄÅÁ∑ØÂ∫¶ÁµåÂ∫¶„ÅÆË°®Á§∫„Çí„ÄåÂçÅÈÄ≤Êï∞ÂΩ¢Âºè„Äç„Å®„ÄåÂ∫¶ÂàÜÁßíÂΩ¢Âºè„Äç„ÅßÂàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô„ÄÇ</li>
    <li><strong>‰ΩèÊâÄ„ÇÑÂêçÁß∞„ÅßÊ§úÁ¥¢:</strong> ‰ΩèÊâÄ„ÇÑ„É©„É≥„Éâ„Éû„Éº„ÇØ„Å™„Å©„ÇíÂÖ•Âäõ„Åó„ÄåüîéÊ§úÁ¥¢„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅ„Åù„ÅÆÂ†¥ÊâÄ„ÅÆÂ∫ßÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åô„ÄÇÂÖ•Âäõ‰∏≠„Å´ÂÄôË£ú„ÇÇË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</li>
    <li><strong>„É´„Éº„ÉàÊ§úÁ¥¢:</strong> „Äåüöó „É´„Éº„ÉàÊ§úÁ¥¢„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂêÑ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÁèæÂú®„ÅÆÂ∫ßÊ®ô„ÇíÁõÆÁöÑÂú∞„Å®„Åó„Åü„É´„Éº„ÉàÊ°àÂÜÖ„Éö„Éº„Ç∏ÔºàGoogle„Éû„ÉÉ„Éó„Å™„Å©Ôºâ„ÇíÁõ¥Êé•Èñã„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
    <li><strong>Âπ≥Èù¢Áõ¥ËßíÂ∫ßÊ®ô (XY) „Å∏„ÅÆÂ§âÊèõ:</strong> „ÄåXYÂ§âÊèõ„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÁ∑ØÂ∫¶ÁµåÂ∫¶„Å®Âπ≥Èù¢Áõ¥ËßíÂ∫ßÊ®ôÁ≥ªÔºàXYÂ∫ßÊ®ôÔºâ„ÇíÁõ∏‰∫í„Å´Â§âÊèõ„Åô„ÇãÂ∞ÇÁî®„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈñã„Åç„Åæ„Åô„ÄÇ
        <ul>
             <li><strong>Á∑ØÂ∫¶ÁµåÂ∫¶ ‚Üí XYÂ∫ßÊ®ô:</strong> Â§âÊèõ„Åó„Åü„ÅÑÁ∑ØÂ∫¶ÁµåÂ∫¶„ÇíÂÖ•Âäõ„Åó„ÄÅÂØæË±°„Å®„Å™„ÇãÂ∫ßÊ®ôÁ≥ªÔºà‰æã: 9Á≥ªÔºâ„ÇíÈÅ∏Êäû„Åó„Å¶„Äå‚ñ∂„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅXYÂ∫ßÊ®ô„ÅåË®àÁÆó„Åï„Çå„Åæ„Åô„ÄÇ</li>
             <li><strong>XYÂ∫ßÊ®ô ‚Üí Á∑ØÂ∫¶ÁµåÂ∫¶:</strong> ÈÄÜ„Å´„ÄÅXÂ∫ßÊ®ô„ÉªYÂ∫ßÊ®ô„Å®Â∫ßÊ®ôÁ≥ª„ÇíÂÖ•Âäõ„Åó„Å¶„Äå‚óÄ„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÁ∑ØÂ∫¶ÁµåÂ∫¶„Å´Â§âÊèõ„Åß„Åç„Åæ„Åô„ÄÇ</li>
             <li style="list-style: none; text-indent: 1em;">„ÄåÈÉΩÈÅìÂ∫úÁúå„Äç„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÂú∞Âüü„Åß‰Ωø„Çè„Çå„ÇãÂ∫ßÊ®ôÁ≥ª„Å´Ëá™Âãï„ÅßÁµû„ÇäËæº„Åæ„Çå„Åæ„Åô„ÄÇ</li>
             <li>Â§âÊèõÁµêÊûú„ÅØ„Äå‚úî ÁµêÊûú„Çí„É°„Ç§„É≥ÁîªÈù¢„Å´ÂèçÊò†„Äç„Éú„Çø„É≥„ÅßÂÖ•ÂäõÊ¨Ñ„Å´ÈÅ©Áî®„Åó„Åü„Çä„ÄÅ„Äåüìã ÁµêÊûú„Çí„Ç≥„Éî„Éº„Äç„Éú„Çø„É≥„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´‰øùÂ≠ò„Åó„Åü„Çä„Åß„Åç„Åæ„Åô„ÄÇ</li>
        </ul>
    </li>
</ul>

    <h4>‚ñ† ‰øùÂ≠ò„ÉªÂÖ±Êúâ„ÉªË®≠ÂÆöÊ©üËÉΩ</h4>
    <ul>
       <li><strong>ÂÖ±Êúâ„ÉªQR„Ç≥„Éº„Éâ:</strong> „Äåüîó „É™„É≥„ÇØÂÖ±Êúâ„Äç„Äåüì± QR„Ç≥„Éº„Éâ„ÅßÂÖ±Êúâ„Äç„Éú„Çø„É≥„Åß„ÄÅÁèæÂú®„ÅÆÂ∫ßÊ®ô„ÇÑ„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÂú∞Âõ≥„ÅÆÁä∂ÊÖã„ÇíÂê´„ÇÄURL„ÇíÂÖ±Êúâ„ÇÑÁîüÊàê„Åå„Åß„Åç„Åæ„Åô„ÄÇ‰ªñ„ÅÆ‰∫∫„Å´Âêå„ÅòÁä∂ÊÖã„ÇíÂÖ±Êúâ„Åô„ÇãÈöõ„Å´‰æøÂà©„Åß„Åô„ÄÇ</li><li><strong>„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ:</strong> „Äå‚≠ê „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰øùÂ≠ò„Äç„Éú„Çø„É≥„Åß„ÄÅÂêçÂâç„Çí„Å§„Åë„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚≠ê„Äç„Éú„Çø„É≥„Åã„Çâ„ÅÑ„Å§„Åß„ÇÇÂëº„Å≥Âá∫„Åõ„Åæ„Åô„ÄÇ„Åæ„Åü„ÄÅCSV„Éï„Ç°„Ç§„É´„Å´Ë®òËºâ„Åï„Çå„ÅüÊÉÖÂ†±„ÇÇ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ</li>
        <li><strong>Â±•Ê≠¥:</strong> „ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂú∞ÁÇπ„ÅÆÂ∫ßÊ®ô„ÅØËá™Âãï„ÅßÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚è±Ô∏è„Äç„Éú„Çø„É≥„Åã„ÇâÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å®Â±•Ê≠¥„ÅØ„ÄÅCSV„Åæ„Åü„ÅØKMLÂΩ¢Âºè„ÅßÊõ∏„ÅçÂá∫„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
               <li><strong>CSV„Éá„Éº„ÇøÁÆ°ÁêÜ:</strong> „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„ÄåüìÑ CSV„Éá„Éº„Çø„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅCSV„Éï„Ç°„Ç§„É´„Å´Ë®òËºâ„Åï„Çå„ÅüÂú∞ÁÇπÊÉÖÂ†±„ÇíÂú∞Âõ≥‰∏ä„Å´‰∏ÄÊã¨Ë°®Á§∫Ôºà„Éó„É≠„ÉÉ„ÉàÔºâ„Åó„Åü„Çä„ÄÅÂú∞ÁÇπ„ÇíÈ†ÜÁï™„Å´Á¢∫Ë™ç„Åß„Åç„Çã„ÄåÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº„ÄçÊ©üËÉΩ„ÇíÂà©Áî®„Åó„Åü„Çä„Åß„Åç„Åæ„Åô„ÄÇ</li>
               <li><strong>Ë®≠ÂÆö„Å®„Ç´„Çπ„Çø„Éû„Ç§„Ç∫:</strong> „Äå‚öôÔ∏èË®≠ÂÆö„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅËµ∑ÂãïÊôÇ„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÄÅ„ÉÜ„Éº„Éû„Ç´„É©„Éº„ÄÅ„Éë„Éç„É´„ÅÆË°®Á§∫„Å™„Å©„ÄÅËµ∑ÂãïÊôÇ„ÅÆÁä∂ÊÖã„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åß„Åç„Åæ„Åô„ÄÇ</li>
        <li><strong>„ÉÄ„Éº„ÇØ„Éª„É©„Ç§„Éà„É¢„Éº„Éâ:</strong> „Äåüåô„É¢„Éº„ÉâÂàáÊõø„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅ„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Å®„É©„Ç§„Éà„É¢„Éº„Éâ„ÇíÂàá„ÇäÊõø„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
„ÄÄ„ÄÄ</ul>
    <h4>‚ñ† „Éë„Éç„É´Â±ïÈñã„ÉªÂú∞Âõ≥„É™„É≥„ÇØ„Å®Â§ñÈÉ®Âú∞Âõ≥ÈÄ£Êê∫ÔºèÂ±•Ê≠¥‰∏ÄË¶ßÁÆ°ÁêÜ</h4>
    <ul>
        <li><strong>„Éë„Éç„É´„ÅÆÈñãÈñâ„Å®Âõ∫ÂÆö:</strong>
            <ul>
                <li>„Äå‚óÄ „Éë„Éç„É´„Äç„Éú„Çø„É≥„Åß„ÄÅÁîªÈù¢Âè≥ÂÅ¥„ÅÆÂú∞Âõ≥ÈÅ∏Êäû„Éë„Éç„É´„ÇíÈñã„Åç„Åæ„Åô„ÄÇ</li>
                <li>„Äåüìå „Éî„É≥Áïô„ÇÅ„Äç„Éú„Çø„É≥„Åß„Éë„Éç„É´„ÇíÁîªÈù¢„Å´Âõ∫ÂÆö„Åß„Åç„Åæ„Åô„ÄÇÂ∫É„ÅÑÁîªÈù¢„ÅßÂú∞Âõ≥„Å®ÊÉÖÂ†±„ÇíÂêåÊôÇ„Å´Ë¶ã„Åü„ÅÑÂ†¥Âêà„Å´‰æøÂà©„Åß„Åô„ÄÇ</li>
                <li>„Éî„É≥Áïô„ÇÅÊôÇ„ÄÅ„Éë„Éç„É´„ÅÆÂ∑¶Á´Ø„Çí„Éâ„É©„ÉÉ„Ç∞„Åô„Çã„Å®ÂπÖ„ÇíË™øÊï¥„Åß„Åç„Åæ„Åô„ÄÇ</li>
            </ul>
        </li>
<li><strong>„Éë„Éç„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫:</strong>
    <ul>
        <li><strong>‰∏¶„ÅπÊõø„Åà:</strong> ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜÔºà‰æã: <code>üóª Âú∞Âõ≥„ÉªÂú∞ÁêÜÊÉÖÂ†±</code>Ôºâ„ÇÑ„ÄÅÂÄãÂà•„ÅÆÂú∞Âõ≥„É™„É≥„ÇØ„Ç´„Éº„Éâ„ÅØ„ÄÅ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅßÊé¥„Çì„ÅßËá™Áî±„Å´ÂÖ•„ÇåÊõø„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Çà„Åè‰Ωø„ÅÜÈ†ÖÁõÆ„Çí‰∏ä„Å´ÁßªÂãï„Åï„Åõ„Çã„Å®‰æøÂà©„Åß„Åô„ÄÇ</li>
        <li><strong>Ë°®Á§∫ÔºèÈùûË°®Á§∫:</strong> „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚öôÔ∏èË®≠ÂÆö„Äç„Éú„Çø„É≥„Åã„ÇâË®≠ÂÆöÁîªÈù¢„ÇíÈñã„Åç„ÄÅ„ÄåÂú∞Âõ≥„É™„É≥„ÇØ„ÅÆË°®Á§∫Ë®≠ÂÆö„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÄÅÊôÆÊÆµ‰Ωø„Çè„Å™„ÅÑÂú∞Âõ≥„É™„É≥„ÇØ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Å¶ÈùûË°®Á§∫„Å´„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
        <li><strong>Ë®≠ÂÆö„ÅÆ„É™„Çª„ÉÉ„Éà:</strong> „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åó„Åü‰∏¶„Å≥È†Ü„ÇÑË°®Á§∫Ë®≠ÂÆö„ÅØ„ÄÅ„Äå‚öôÔ∏èË®≠ÂÆö„ÄçÁîªÈù¢„ÅÆ‰∏ãÈÉ®„Å´„ÅÇ„Çã„Äå„Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Äç„Éú„Çø„É≥„Åß„ÄÅ„ÅÑ„Å§„Åß„ÇÇÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
    </ul>
</li>
        <li><strong>Âú∞Âõ≥„ÅÆÈÅ∏Êäû„Å®Ë°®Á§∫:</strong>
            <ul>
                <li>„Äåüó∫Ô∏èÂú∞Âõ≥„É™„É≥„ÇØ„Äç„Çø„ÉñÔºöÂà©Áî®„Åó„Åü„ÅÑÂú∞Âõ≥„Çµ„Éº„Éì„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅÂÖ•ÂäõÂ∫ßÊ®ô„Çí‰∏≠ÂøÉ„Å®„Åó„ÅüÂú∞Âõ≥„ÅåÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åç„Åæ„Åô„ÄÇ</li>
                <li>ÂêÑ„Ç´„ÉÜ„Ç¥„É™„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚úÖ ÂÖ®ÈÅ∏Êäû/Ëß£Èô§„Äç„Éú„Çø„É≥„Åß„ÄÅ„Åù„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„ÅÆÂú∞Âõ≥„Çí‰∏ÄÊã¨„Åß„ÉÅ„Çß„ÉÉ„ÇØ„Åß„Åç„Åæ„Åô„ÄÇ</li>
                <li>„Äå‚ñ∂Ô∏è „ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÈ†ÖÁõÆ„Çí‰∏ÄÊã¨„ÅßÈñã„Åè„Äç„Éú„Çø„É≥„Åß„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Çí‰ªò„Åë„ÅüË§áÊï∞„ÅÆÂú∞Âõ≥„Çí‰∏ÄÂ∫¶„Å´Èñã„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
                <li>‰ªªÊÑè„ÅÆÂú∞Âõ≥„Çµ„Éº„Éì„Çπ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Å§„Åë„Å¶„Äå„ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÉÉ„Éà„Äç„Å®„Åó„Å¶ÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ</li>
                <li>„Äå‚≠ê „Éû„Ç§„É™„É≥„ÇØ„Äç„Ç´„ÉÜ„Ç¥„É™„Åß„ÅØ„ÄÅËá™ÂàÜÂ∞ÇÁî®„ÅÆWebÂú∞Âõ≥„Å∏„ÅÆ„É™„É≥„ÇØ„ÇíËá™Áî±„Å´ËøΩÂä†„ÉªÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</li>
                 <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„ÅÆË™¨Êòé„ÇíËøΩÂä† ‚ñº‚ñº‚ñº -->
                <li>„Äåüìû Á∑äÊÄ•ÊôÇÈÄ£Áµ°„Äç„Ç´„ÉÜ„Ç¥„É™„Åß„ÅØ„ÄÅ„Çà„Åè‰Ωø„ÅÜÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊúÄÂ§ß5„Å§„Åæ„ÅßÁôªÈå≤„Åó„ÄÅ„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÂë®Ëæ∫„ÅÆÊñΩË®≠„ÇíÊ§úÁ¥¢„Åß„Åç„Åæ„Åô„ÄÇ</li>
                <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
 <li>„Äå‚è±Ô∏èÂ±•Ê≠¥‰∏ÄË¶ß„Äç„Äå‚≠ê„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äç„Çø„ÉñÔºöÂ±•Ê≠¥„ÇÑ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅÆ‰∏ÄË¶ß„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇüìã „ÉÜ„Éº„Éñ„É´„Ç≥„Éî„Éº„ÇÑÈÅ∏Êäû„Çí„Ç≥„Éî„Éº„Åô„Çã„Åì„Å®„Åß„ÄÅExcel„Å™„Å©„Å´Ë≤º„Çä‰ªò„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
 <li>„ÄåÂú∞Âõ≥„Å´Â±•Ê≠¥Ôºà„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÔºâ„ÇíË°®Á§∫„Äç„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Åì„Å®„Åß„ÄÅÂ±•Ê≠¥Ôºà„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÔºâ„ÅåÂú∞Âõ≥‰∏ä„Å´„Éó„É≠„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ„Å™„Åä„ÄÅÂêÑÈ†ÖÁõÆ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅßÈÅ∏Êäû„Åó„Å¶Ë°®Á§∫„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</li>
 <li>„Äåüìã „ÉÜ„Éº„Éñ„É´„Ç≥„Éî„Éº„ÄÅÈÅ∏Êäû„Çí„Ç≥„Éî„Éº„ÄçÔºö„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Å¶Excel„Å´Ë≤º„Çä‰ªò„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
            </ul>
        </li>
    </ul>     

    <h4>‚ñ† È´òÂ∫¶„Å™Âú∞Âõ≥„ÉÑ„Éº„É´</h4>
    <ul>
        <li>Âú∞Âõ≥Â∑¶‰∏ã„ÅÆ„Äåüõ†Ô∏èÊ∏¨Èáè„ÉªËß£Êûê„ÉÑ„Éº„É´„Äç„Åã„Çâ„ÄÅ„Äåüìè Ë∑ùÈõ¢Ë®àÊ∏¨„ÉªÊñ≠Èù¢‰ΩúÊàê„Äç„Äåüìê Èù¢Á©çË®àÊ∏¨„Äç„Äå‚≠ï ÂÜÜ‰ΩúÊàê„Äç„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇË∑ùÈõ¢„ÅØ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÄÅÈù¢Á©ç„ÅØEnter„ÅßË®àÊ∏¨„ÅåÂÆå‰∫Ü„Åó„Åæ„Åô„ÄÇ</li>
        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëCSVÈñ¢ÈÄ£Ê©üËÉΩ„ÅÆË™¨Êòé„Çí„Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥„Å´Âêà„Çè„Åõ„Å¶‰øÆÊ≠£ ‚ñº‚ñº‚ñº -->
        <li>„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„ÄåüìÑ CSV„Éá„Éº„Çø„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅCSV„Éï„Ç°„Ç§„É´„ÅÆÂú∞ÁÇπ„Éá„Éº„Çø„ÇíÂú∞Âõ≥‰∏ä„Å´‰∏ÄÊã¨„ÅßË°®Á§∫Ôºà„Éó„É≠„ÉÉ„ÉàÔºâ„Åó„Åü„Çä„ÄÅÂú∞ÁÇπ„ÇíÈ†ÜÁï™„Å´Á¢∫Ë™ç„Åô„Çã„ÄåÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº„ÄçÊ©üËÉΩ„ÇíÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ</li>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        <li>„Äåüåê KML‰øùÂ≠ò„Äç„Éú„Çø„É≥„Åß„ÄÅ‰ΩúÊàê„Åó„ÅüÂõ≥ÂΩ¢„ÇíKML„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ</li>
        <li> Ê∏¨ÂÆö‰∏≠„Å´ `BS` „Åæ„Åü„ÅØ `DEL` „Ç≠„Éº„ÇíÊäº„Åô„Å®„ÄÅÊúÄÂæå„Å´ËøΩÂä†„Åó„ÅüÁÇπ„ÇíÂèñ„ÇäÊ∂à„Åõ„Åæ„Åô„ÄÇ</li>
    </ul>
<h4>‚ñ† „Éá„Éº„Çø„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å®ÁßªË°åÔºàÊõ∏„ÅçÂá∫„ÅóÔºèË™≠„ÅøËæº„ÅøÔºâ</h4>
<p>„Åì„ÅÆÊ©üËÉΩ„Çí‰Ωø„ÅÜ„Å®„ÄÅ„Ç¢„Éó„É™ÂÜÖ„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÄÅÂ±•Ê≠¥„ÄÅ„Éû„Ç§„É™„É≥„ÇØ„ÄÅÂêÑÁ®ÆË®≠ÂÆö„Çí‰∏Ä„Å§„ÅÆ„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Êõ∏„ÅçÂá∫„ÅôÔºà„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºâ„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Åì„ÅÆ„Éï„Ç°„Ç§„É´„Çí‰øùÁÆ°„Åó„Å¶„Åä„Åë„Å∞„ÄÅPC„ÅÆË≤∑„ÅÑÊõø„ÅàÊôÇ„ÇÑ„ÄÅÂà•„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅßÂêå„ÅòÁí∞Â¢É„ÇíÂæ©ÂÖÉ„Åó„Åü„ÅÑÂ†¥Âêà„Å´‰æøÂà©„Åß„Åô„ÄÇ„Åæ„Åü„ÄÅ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Å®Ë®≠ÂÆö„ÇíÂÖ±Êúâ„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</p>
<ul>
    <li><strong>„Éá„Éº„Çø„ÅÆÊõ∏„ÅçÂá∫„Åó („Ç®„ÇØ„Çπ„Éù„Éº„Éà):</strong>
        <ol style="list-style: decimal inside; padding-left: 20px; margin-top: 5px;">
            <li>„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚öôÔ∏èË®≠ÂÆö„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Åæ„Åô„ÄÇ</li>
            <li>„É¢„Éº„ÉÄ„É´‰∏ãÈÉ®„ÅÆ„Äåüíæ „Éá„Éº„Çø„ÅÆÊõ∏„ÅçÂá∫„Åó„Å®Ë™≠„ÅøËæº„Åø„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Å´ÈÄ≤„Åø„Åæ„Åô„ÄÇ</li>
            <li>Êõ∏„ÅçÂá∫„Åó„Åü„ÅÑ„Éá„Éº„Çø„ÅÆÁ®ÆÈ°ûÔºà„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÄÅÂ±•Ê≠¥„Å™„Å©Ôºâ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Åæ„Åô„ÄÇ„Äå‚úÖ „Åô„Åπ„Å¶ÈÅ∏Êäû„Äç„ÇÇÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ</li>
            <li>„Äåüì§ Êõ∏„ÅçÂá∫„Åó„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅ<code>GeoLinkNavi_backup_Êó•‰ªò.json</code> „Å®„ÅÑ„ÅÜ„Éï„Ç°„Ç§„É´„Åå„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åô„ÄÇ</li>
            <li>„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÁÆ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
        </ol>
    </li>
    <li style="margin-top: 10px;"><strong>„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø („Ç§„É≥„Éù„Éº„Éà):</strong>
        <ol style="list-style: decimal inside; padding-left: 20px; margin-top: 5px;">
            <li>ÂêåÊßò„Å´„Äå‚öôÔ∏èË®≠ÂÆö„Äç„ÇíÈñã„Åç„ÄÅ„Éá„Éº„ÇøÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„Å´ÈÄ≤„Åø„Åæ„Åô„ÄÇ</li>
            <li>„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø„Åü„ÅÑ„Éá„Éº„Çø„ÅÆÁ®ÆÈ°û„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Åæ„Åô„ÄÇÔºà„Éï„Ç°„Ç§„É´ÂÜÖ„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éá„Éº„Çø„ÅØÁÑ°Ë¶ñ„Åï„Çå„Åæ„ÅôÔºâ</li>
            <li>„Äåüì• Ë™≠„ÅøËæº„Åø„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„ÄÅ‰ª•ÂâçÊõ∏„ÅçÂá∫„Åó„Åü<code>.json</code>„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</li>
            <li style="font-weight: bold;">‚ö†Ô∏è <span style="color: var(--error-color);">Ê≥®ÊÑè:</span> Ë™≠„ÅøËæº„Åø„ÇíË°å„ÅÜ„Å®„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„ÅüÈ†ÖÁõÆ„ÅÆÊó¢Â≠ò„Éá„Éº„Çø„ÅØ„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„Åß<strong>‰∏äÊõ∏„Åç</strong>„Åï„Çå„Åæ„Åô„ÄÇ</li>
            <li>Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„ÅüÂæå„ÄÅ„Éá„Éº„Çø„ÅåÂæ©ÂÖÉ„Åï„Çå„ÄÅ„Éö„Éº„Ç∏„ÅåËá™Âãï„ÅßÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„Åæ„Åô„ÄÇ</li>
        </ol>
    </li>
    <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëCSV„Ç§„É≥„Éù„Éº„Éà„ÅÆË™¨Êòé ‚ñº‚ñº‚ñº -->
    <li style="margin-top: 10px;"><strong>„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅÆCSV„Ç§„É≥„Éù„Éº„Éà:</strong>
        <ol style="list-style: decimal inside; padding-left: 20px; margin-top: 5px;">
            <li>„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Äå‚≠ê„Äç„Éú„Çø„É≥„ÄÅ„Åæ„Åü„ÅØÂè≥„Éë„Éç„É´„ÅÆ„Äå‚≠ê„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äç„Çø„Éñ„Åã„Çâ„ÄÅ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁÆ°ÁêÜÁîªÈù¢„ÇíÈñã„Åç„Åæ„Åô„ÄÇ</li>
            <li>„Äåüì• „Ç§„É≥„Éù„Éº„Éà„Äç„Åæ„Åü„ÅØ„Äåüì• CSV„Ç§„É≥„Éù„Éº„Éà„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Åæ„Åô„ÄÇ</li>
            <li>„Åä‰Ωø„ÅÑ„ÅÆPC„Åã„Çâ„ÄÅÂú∞ÁÇπÊÉÖÂ†±„ÅåË®òËºâ„Åï„Çå„ÅüCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</li>
            <li>„Éó„É¨„Éì„É•„ÉºÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Çã„ÅÆ„Åß„ÄÅCSV„ÅÆÂêÑÂàó„Åå„ÄåÂêçÂâç„Äç„ÄåÁ∑ØÂ∫¶„Äç„ÄåÁµåÂ∫¶„Äç„Å™„Å©„ÅÆ„Å©„ÅÆÊÉÖÂ†±„Å´ÂØæÂøú„Åô„Çã„Åã„Çí„ÄÅ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„É™„Çπ„Éà„Åã„ÇâÈÅ∏ÊäûÔºà„Éû„ÉÉ„Éî„É≥„Ç∞Ôºâ„Åó„Åæ„Åô„ÄÇ</li>
            <li>„Äå„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅCSV„ÅÆÂÜÖÂÆπ„Åå„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰∏ÄÊã¨„ÅßÁôªÈå≤„Åï„Çå„Åæ„Åô„ÄÇ</li>
        </ol>
    </li>
    <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
</ul>
</div>
</header>

<div id="panelOverlay" onclick="toggleRightPanel()"></div>

<main class="main-layout" id="mainLayout">
    <div class="left-panel">
<section class="input-section" aria-labelledby="input-section-title">
    <h2 id="input-section-title" class="visually-hidden">Â∫ßÊ®ôÂÖ•Âäõ„Å®Êìç‰Ωú</h2>
    <div class="input-row">
    <div class="input-button-wrapper mobile-grid-item-geo">
        <button class="btn-base btn-icon btn-current-location" 
        onclick="initGeolocation()" 
        aria-label="ÁèæÂú®Âú∞„ÇíÂèñÂæó" 
        title="ÁèæÂú®Âú∞„ÇíÂèñÂæó">
    <span aria-hidden="true">üéØ</span>
</button>
        <span class="input-button-label">ÁèæÂú®Âú∞</span>
    </div>
    <div class="input-button-wrapper mobile-hidden">
        <button class="btn-base btn-icon btn-googlemap" onclick="openGoogleMap()" aria-label="Google„Éû„ÉÉ„Éó„ÅßÊé¢„Åô" title="Google„Éû„ÉÉ„Éó„ÅßÊé¢„Åô">üåç</button>
        <span class="input-button-label">Google„Éû„ÉÉ„Éó</span>
    </div>
    <div class="input-button-wrapper mobile-hidden">
        <button class="btn-base btn-icon btn-paste" onclick="pasteCoordinates()" aria-label="„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º„Çä‰ªò„Åë" title="„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º„Çä‰ªò„Åë">üìÑ</button>
        <span class="input-button-label">Ë≤º„Çä‰ªò„Åë</span>
    </div>
    <div class="input-button-wrapper mobile-grid-item-bkmk">
        <button class="btn-base btn-icon btn-save-bookmark" onclick="saveCurrentAsBookmark()" aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰øùÂ≠ò" title="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰øùÂ≠ò">‚≠ê</button>
        <span class="input-button-label">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</span>
    </div>
<div class="input-button-wrapper mobile-grid-item-fmt">
    <button class="btn-base btn-icon btn-format-toggle" id="coord-format-toggle" aria-label="Ë°®Á§∫ÂΩ¢ÂºèÂàáÊõø" title="Ë°®Á§∫ÂΩ¢ÂºèÂàáÊõø">‚öôÔ∏è</button>
    <span class="input-button-label" id="coord-format-label">ÂΩ¢ÂºèÂàáÊõø</span>
</div>

<div class="input-group latlon-group mobile-grid-item-lat" title="‰∏ñÁïåÊ∏¨Âú∞Á≥ªÁ∑ØÂ∫¶">
        <div class="input-wrapper">
            <input type="text" id="latitude" value="35.72985474" placeholder="‰æã: 35.681074">
            <button type="button" class="btn-copy-input" title="Á∑ØÂ∫¶„Çí„Ç≥„Éî„Éº" onclick="copyInputToClipboard('latitude')">üìã</button>
            <div class="input-spinner"></div>
        </div>
        <label for="latitude">üìçÁ∑ØÂ∫¶ (Latitude)</label>
    </div>

    <div class="input-group latlon-group mobile-grid-item-lon" title="‰∏ñÁïåÊ∏¨Âú∞Á≥ªÁµåÂ∫¶">
        <div class="input-wrapper">
            <input type="text" id="longitude" value="139.77110828" placeholder="‰æã: 139.767843">
            <button type="button" class="btn-copy-input" title="ÁµåÂ∫¶„Çí„Ç≥„Éî„Éº" onclick="copyInputToClipboard('longitude')">üìã</button>
            <div class="input-spinner"></div>
        </div>
        <label for="longitude">üìçÁµåÂ∫¶ (Longitude)</label>
    </div>

    <div class="input-button-wrapper mobile-grid-item-conv">
        <button id="btn-open-coord-converter" class="btn-base">XYÂ§âÊèõ</button>
        <span class="input-button-label">Âπ≥Èù¢Áõ¥ËßíÂ∫ßÊ®ô</span>
    </div>

    <div class="mobile-address-row">
        <div class="input-group address-group mobile-grid-item-addr">
            <div class="input-wrapper">
                <input type="text" id="addressInput" placeholder="‰æã: Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫ÂçÉ‰ª£Áî∞1-1">
                <div id="autocompleteList" class="autocomplete-list"></div>
                <div class="input-spinner"></div>
            </div>
            <label for="addressInput">üè†‰ΩèÊâÄ„ÉªÊñΩË®≠Âêç</label>
        </div>
        <div class="input-button-wrapper mobile-grid-item-search">
            <button class="btn-base btn-icon btn-address-search" onclick="searchAddress()" aria-label="‰ΩèÊâÄ„ÇíÊ§úÁ¥¢" title="‰ΩèÊâÄ„ÇíÊ§úÁ¥¢">üîé</button>
            <span class="input-button-label">Ê§úÁ¥¢</span>
        </div>
    </div>
    <div class="input-button-wrapper mobile-grid-item-route">
        <button class="btn-base btn-icon" id="btn-route-google" aria-label="Google„Éû„ÉÉ„Éó„Åß„É´„Éº„ÉàÊ§úÁ¥¢" title="Google„Éû„ÉÉ„Éó„Åß„É´„Éº„ÉàÊ§úÁ¥¢">üöó</button>
        <span class="input-button-label">„É´„Éº„ÉàÊ§úÁ¥¢</span>
    </div>
<div class="input-button-wrapper mobile-grid-item-panel" id="main-toggle-panel-btn-wrapper">
    <button class="btn-base btn-icon js-toggle-panel-btn btn-toggle-panel" onclick="toggleRightPanel()" aria-label="„Éë„Éç„É´„ÇíÈñã„Åè" title="„Éë„Éç„É´„ÇíÈñã„Åè">‚óÄ</button>
    <span class="input-button-label">„Éë„Éç„É´</span>
</div>
</div>

</section>
        <section class="osm-map-container" id="mainMapContainer" aria-labelledby="main-map-title">
            <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äëonclick„ÇíÂâäÈô§„ÄÅ„Ç¢„Ç§„Ç≥„É≥„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº -->
            <div class="osm-map-header">
                <h3 id="main-map-title">üó∫Ô∏è „ÇØ„É™„ÉÉ„ÇØ„ÅßÂ∫ßÊ®ôÂèñÂæó / Âú∞Âõ≥„Éó„É¨„Éì„É•„Éº</h3>
    <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Å´ÁßªÂãï„ÄëË°®Á§∫„É¢„Éº„Éâ „Ç∞„É´„Éº„Éó ‚ñº‚ñº‚ñº -->
    <div class="button-group">
        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Å´ËøΩÂä†„Äë‚ñº‚ñº‚ñº -->
        <div class="header-button-wrapper">
            <button class="header-button" id="toggle-crosshair-btn" aria-label="ÂçÅÂ≠óÁ∑öË°®Á§∫Âàá„ÇäÊõø„Åà" title="ÂçÅÂ≠óÁ∑ö ON/OFF">‚ïã</button>
            <span class="header-button-label">ÂçÅÂ≠óÁ∑ö</span>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        <div class="header-button-wrapper">
            <button class="header-button" id="toggleDualViewBtn" aria-label="2ÁîªÈù¢Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà" title="2ÁîªÈù¢Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà">üî≤</button>
            <span class="header-button-label">2ÁîªÈù¢Ë°®Á§∫</span>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÁßªÂãï„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
            <div class="osm-map-wrapper">
                <div id="osmClickMap">
                           <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÂ∑¶Âè≥„ÅÆÂú∞Âõ≥„Ç≥„É≥„ÉÜ„Éä„ÇíËøΩÂä† ‚ñº‚ñº‚ñº -->
        <div id="mapLeft">
            <!-- Êó¢Â≠ò„ÅÆ„ÉÑ„Éº„É´È°û„ÅØÂ∑¶„ÅÆÂú∞Âõ≥„Å´Â±û„Åô„Çã„ÅÆ„Åß„ÄÅ„Åì„ÅÆ‰∏≠„Å´ÁßªÂãï„Åó„Åæ„Åô -->
            <div class="analysis-tools-overlay collapsed" id="analysis-tools">



                        <h3 id="analysis-tools-header">üõ†Ô∏è Ê∏¨Èáè„ÉªËß£Êûê„ÉÑ„Éº„É´ <span class="toggle-icon">‚ñ∂</span></h3>
                        <div class="analysis-tools-controls">
<div class="analysis-tool-row">
    <button class="btn-base btn-measure" id="measure-tool-btn">üìè Ë∑ùÈõ¢„ÉªÊñ≠Èù¢</button>
    <label for="profile-division-input" style="font-size: 13px; font-weight: 600; margin: 0 5px;">ÂàÜÂâ≤Êï∞</label>
    <input type="number" id="profile-division-input" value="100" min="10" max="200" aria-label="Êñ≠Èù¢Âõ≥„ÅÆÂàÜÂâ≤Êï∞">
</div>
<div class="analysis-tool-row">
    <button class="btn-base btn-area" id="area-tool-btn">üìê Èù¢Á©çË®àÊ∏¨</button>
                                <span id="area-display" class="area-display-label"></span>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-buffer" id="buffer-tool-btn">‚≠ï ÂÜÜ‰ΩúÊàê</button>
                                <label for="buffer-radius-input" style="font-size: 13px; font-weight: 600; margin: 0 5px;">ÂçäÂæÑ</label>
                                <input type="number" id="buffer-radius-input" value="500" min="1" aria-label="ÂÜÜ„ÅÆÂçäÂæÑ(„É°„Éº„Éà„É´)">
                                <label for="buffer-radius-input" style="font-size: 13px; font-weight: 600;">m</label>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-clear-analysis" id="clear-analysis-btn">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-export-analysis" id="export-analysis-btn">üåê KML‰øùÂ≠ò</button>
                            </div>
                        </div>
                    </div>
                    <div class="zoom-slider-overlay">
                        <label for="zoomLevel">„Ç∫„Éº„É†:</label>
                        <input type="range" id="zoomLevel" value="16" min="1" max="20" aria-label="Âú∞Âõ≥„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´">
                        <span id="zoomLevelDisplay">16</span>

        </div>
    <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑öÁî®„ÅÆHTMLË¶ÅÁ¥† ‚ñº‚ñº‚ñº -->
    <div id="crosshair-v" class="crosshair"></div>
    <div id="crosshair-h" class="crosshair"></div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
    </div>
    <div id="mapRight">
        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Å´ËøΩÂä†„Äë‚ñº‚ñº‚ñº -->
        <div id="crosshair-v-right" class="crosshair"></div>
        <div id="crosshair-h-right" class="crosshair"></div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
</div>
        </section>

        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„Éº„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº -->
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
    </div>
    
    <div id="resizer"></div>

    <aside class="right-panel hidden">
        <div class="right-panel-header">
            <div class="bulk-toggle-container">
                <button id="toggleAllCategoriesBtn">‚ûï „Åô„Åπ„Å¶Â±ïÈñã</button>
                <button id="pinPanelBtn" onclick="togglePinPanel()" class="mobile-hidden">üìå „Éî„É≥Áïô„ÇÅ</button>
                <button id="closePanelBtnMobile" onclick="toggleRightPanel()" class="desktop-hidden">‚ñ∂ Èñâ„Åò„Çã</button>
            </div>
        </div>
        
        <div class="panel-tabs" id="panelTabs">
<button class="panel-tab active" data-tab="map-links" draggable="true">üó∫Ô∏è <span class="tab-text">Âú∞Âõ≥„É™„É≥„ÇØ</span></button>
<button class="panel-tab" data-tab="history" draggable="true">‚è±Ô∏è <span class="tab-text">Â±•Ê≠¥‰∏ÄË¶ß</span></button>
<button class="panel-tab" data-tab="bookmarks" draggable="true">‚≠ê <span class="tab-text">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</span></button>
            <button class="panel-tab" data-tab="csv-navigator" id="csv-navigator-tab" style="display: none;">‚ñ∂Ô∏è <span class="tab-text">Â∑°ÂõûCSV</span></button>
            <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        </div>

        <div class="panel-content-wrapper" id="panelContentWrapper">
            <div id="map-links-content" class="panel-content active" data-tab-content="map-links">

                <div class="favorite-sets-container">
                    <div class="favorite-set-row">
                        <label for="favorite-sets">„ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÉÉ„Éà:</label>
                        <select id="favorite-sets"></select>
                    </div>
                    <div class="favorite-set-row button-row">
                        <button id="open-set" class="btn-open-set">‚ñ∂Ô∏è Èñã„Åè</button>
                        <button id="clear-all-checks" class="btn-clear-checks">‚ùå Ëß£Èô§</button>
                        <button id="save-set" class="btn-save-set">üíæ‰øùÂ≠ò</button>
                        <button id="delete-set" class="btn-delete-set">üóëÔ∏èÂâäÈô§</button>
                    </div>
                </div>
                <div id="map-categories-container"></div>
            </div>

            <div id="history-content" class="panel-content" data-tab-content="history">
                <div class="table-container">
                    <div class="table-controls">
                        <input type="search" id="historySearchInput" placeholder="‰ΩèÊâÄ„Å™„Å©„ÅßÂ±•Ê≠¥„ÇíÊ§úÁ¥¢..." aria-label="Â±•Ê≠¥„ÇíÊ§úÁ¥¢">
                        <button id="btn-copy-table-history" title="Ë°®Á§∫‰∏≠„ÅÆ„ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„ÇíExcelÁ≠â„Å´Ë≤º„Çä‰ªò„Åë„Çâ„Çå„ÇãÂΩ¢Âºè„Åß„Ç≥„Éî„Éº„Åó„Åæ„Åô">üìã „ÉÜ„Éº„Éñ„É´„Ç≥„Éî„Éº</button>
                        <button id="btn-copy-selected-history" disabled>üìã ÈÅ∏Êäû„Çí„Ç≥„Éî„Éº</button>
                        <button id="btn-delete-selected-history" class="btn-delete-selected" disabled>üóëÔ∏è ÈÅ∏Êäû„ÇíÂâäÈô§</button>
                        <div class="map-toggle-wrapper">
                            <label for="history-map-toggle">Âú∞Âõ≥„Å´Ë°®Á§∫</label>
                            <input type="checkbox" id="history-map-toggle">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="historyTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="history-select-all" aria-label="„Åô„Åπ„Å¶„ÅÆÂ±•Ê≠¥„ÇíÈÅ∏Êäû"></th>
                                    <th class="sortable" data-sort="no">No. <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="postcode">ÈÉµ‰æøÁï™Âè∑ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="address">‰ΩèÊâÄ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="lat">Á∑ØÂ∫¶ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="lon">ÁµåÂ∫¶ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="elevation">Ê®ôÈ´ò(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_x">XÂ∫ßÊ®ô(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_y">YÂ∫ßÊ®ô(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_system">Â∫ßÊ®ôÁ≥ª <span class="sort-icon"></span></th>
                                    <th class="sortable sorted" data-sort="timestamp">ÂèñÂæóÊó•ÊôÇ <span class="sort-icon">‚ñº</span></th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="bookmarks-content" class="panel-content" data-tab-content="bookmarks">
                <div class="table-container">
                    <div class="table-controls">
                        <input type="search" id="bookmarkSearchInput" placeholder="ÂêçÂâç„ÇÑ‰ΩèÊâÄ„ÅßÊ§úÁ¥¢..." aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÊ§úÁ¥¢">
                        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥„ÇíËøΩÂä† ‚ñº‚ñº‚ñº -->
                        <button id="btn-import-bookmarks-csv" class="btn-import-csv">üì• CSV„Ç§„É≥„Éù„Éº„Éà</button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
                        <button id="btn-copy-table-bookmarks" title="Ë°®Á§∫‰∏≠„ÅÆ„ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„ÇíExcelÁ≠â„Å´Ë≤º„Çä‰ªò„Åë„Çâ„Çå„ÇãÂΩ¢Âºè„Åß„Ç≥„Éî„Éº„Åó„Åæ„Åô">üìã „ÉÜ„Éº„Éñ„É´„Ç≥„Éî„Éº</button>
                        <button id="btn-copy-selected-bookmarks" disabled>üìã ÈÅ∏Êäû„Çí„Ç≥„Éî„Éº</button>
                        <button id="btn-delete-selected-bookmarks" class="btn-delete-selected" disabled>üóëÔ∏è ÈÅ∏Êäû„ÇíÂâäÈô§</button>
                        <div class="map-toggle-wrapper">
                            <label for="bookmark-map-toggle">Âú∞Âõ≥„Å´Ë°®Á§∫</label>
                            <input type="checkbox" id="bookmark-map-toggle">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="bookmarkTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="bookmark-select-all" aria-label="„Åô„Åπ„Å¶„ÅÆ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÈÅ∏Êäû"></th>
                                    <th class="sortable" data-sort="no">No. <span class="sort-icon"></span></th>
                                    <th class="sortable sorted" data-sort="name">ÂêçÂâç <span class="sort-icon">‚ñ≤</span></th>
                                    <th class="sortable" data-sort="postcode">ÈÉµ‰æøÁï™Âè∑ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="address">‰ΩèÊâÄ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="lat">Á∑ØÂ∫¶ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="lon">ÁµåÂ∫¶ <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="elevation">Ê®ôÈ´ò(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_x">XÂ∫ßÊ®ô(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_y">YÂ∫ßÊ®ô(m) <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="xy_system">Â∫ßÊ®ôÁ≥ª <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="timestamp">ÁôªÈå≤Êó•ÊôÇ <span class="sort-icon"></span></th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="bookmarkTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂ∑°Âõû„Éä„ÉìÁî®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ ‚ñº‚ñº‚ñº -->
            <div id="csv-navigator-content" class="panel-content" data-tab-content="csv-navigator">
                <div id="csv-navigator-container"> <!-- class="hidden"„ÅØ‰∏çË¶Å„Å™„ÅÆ„ÅßÂâäÈô§ -->
                    <div class="csv-nav-header">
                        <h4 id="csv-nav-title">CSVÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº</h4>
                        <button id="csv-nav-close" class="btn-base" style="background-color: var(--error-color); min-width: 0; width: 60px;">Èñâ„Åò„Çã</button>
                    </div>
                    <ul id="csv-nav-list"></ul>
                    <div class="csv-nav-controls">
                        <button id="csv-nav-prev" class="btn-base">‚óÄ Ââç„Å∏</button>
                        <button id="csv-nav-next" class="btn-base">Ê¨°„Å∏ ‚ñ∂</button>
                    </div>
                    <p id="csv-nav-progress"></p>
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        </div>
    </aside>
</main>

</div>

<style>
  .legal-notice p {
    margin-top: 0;
    margin-bottom: 3px;
  }
  .legal-notice .copyright,
  .legal-notice .developer {
    margin-bottom: 2px;
  }
</style>

<footer class="legal-notice" style="font-size: 11px; text-align: center; padding: 5px 0; color: var(--text-medium); background: var(--bg-container);">
  <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë‚ñº‚ñº‚ñº -->
  <div style="display: flex; justify-content: center; align-items: center; gap: 2em;">
    <span id="lastUpdated"></span>
    <div id="legal-toggle" style="cursor: pointer; font-weight: bold; padding: 5px;">
      ÂÖçË≤¨‰∫ãÈ†Ö („ÇØ„É™„ÉÉ„ÇØ„ÅßË°®Á§∫)
    </div>
  </div>
  <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->


  <div id="legal-details" style="display: none; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
    <p class="copyright" style="font-weight: bold;">
      Copyright &copy; 2025 (Ê†™)Âú∞ÂúèÁ∑èÂêà„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà All Rights Reserved.
    </p>
    <p class="developer" style="font-size: 11px; color: var(--text-medium);">
      Developed by: Naoya.Onozato
    </p>
    <p>
      Êú¨„Çµ„Éº„Éì„Çπ„ÅÆÂà©Áî®„Å´„Çà„Å£„Å¶Áîü„Åò„Åü„ÅÑ„Åã„Å™„ÇãÊêçÂÆ≥„Å´„Å§„ÅÑ„Å¶„ÇÇ„ÄÅ‰ΩúÊàêËÄÖ„ÅØ‰∏ÄÂàá„ÅÆË≤¨‰ªª„ÇíË≤†„ÅÑ„Åæ„Åõ„Çì„ÄÇ
    </p>
    <p>
      Êú¨„Çµ„Éº„Éì„Çπ„ÅØ‰ª•‰∏ã„ÅÆ„Ç™„Éº„Éó„É≥„ÇΩ„Éº„Çπ„É©„Ç§„Éñ„É©„É™„Åä„Çà„Å≥ÂÖ¨ÁöÑÊ©üÈñ¢„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô:<br>
      - Âú∞Âõ≥„Éá„Éº„Çø: ¬© ÂõΩÂúüÂú∞ÁêÜÈô¢, ¬© OpenStreetMap contributors<br>
      - „É©„Ç§„Éñ„É©„É™: Leaflet (BSD-2), QRCode.js (MIT), proj4js (MIT), PapaParse (MIT), DOMPurify (MPL-2.0)
    </p>
  </div>
</footer>

<div class="modal-overlay" id="mylink-modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeMyLinkModal()" title="Èñâ„Åò„Çã" aria-label="„É™„É≥„ÇØÁ∑®ÈõÜ„ÇíÈñâ„Åò„Çã">&times;</button>
<h3 id="modal-title"></h3>
<form id="mylink-form">
<input type="hidden" id="mylink-id">
<div class="modal-form-group">
<label for="mylink-name">ÂêçÂâç</label>
<input type="text" id="mylink-name" required placeholder="‰æã: My Favorite Map">
</div>

<div class="modal-form-group">
    <label for="mylink-example-url">‚ë† ÂÆüURL„Åã„ÇâÂ§âÊèõ</label>
    <div class="url-converter-group">
        <input type="text" id="mylink-example-url" placeholder="Â∫ßÊ®ô„ÇíÂê´„ÇÄURL„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë">
        <button type="button" id="btn-convert-url" class="btn-base">Â§âÊèõ</button>
    </div>
    <small>‰æã: https://maps.app.goo.gl/xxxxx „ÅÆ„Çà„ÅÜ„Å™URL</small>
</div>

<div class="modal-form-group">
<label for="mylink-url">‚ë° URL„ÉÜ„É≥„Éó„É¨„Éº„Éà</label>
<input type="text" id="mylink-url" required placeholder="https://example.com/?lat={lat}&lon={lon}&z={z}">
<small>„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ: {lat}, {lon}, {z} „Åå‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ</small>
</div>
<div class="modal-form-group">
    <label for="mylink-category">ÊâÄÂ±û„Ç´„ÉÜ„Ç¥„É™</label>
    <select id="mylink-category"></select>
    <small>„Åì„ÅÆ„É™„É≥„ÇØ„ÇíË°®Á§∫„Åô„Çã„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</small>
</div>
<div class="modal-form-group">
<label for="mylink-desc">Ë™¨Êòé (‰ªªÊÑè)</label>
<textarea id="mylink-desc" rows="2" placeholder="„Åì„ÅÆ„É™„É≥„ÇØ„Å´„Å§„ÅÑ„Å¶„ÅÆÁ∞°Âçò„Å™Ë™¨Êòé"></textarea>
</div>
<div class="modal-buttons">
<button type="button" class="btn-modal-cancel" id="btn-mylink-modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
<button type="submit" class="btn-modal-save">‰øùÂ≠ò</button>
</div>
</form>
</div>
</div>

<!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„ÅÆ„Ç´„Çπ„Çø„É†Ê§úÁ¥¢Áî®„É¢„Éº„ÉÄ„É´ ‚ñº‚ñº‚ñº -->
<div class="modal-overlay" id="emergency-search-modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeEmergencySearchModal()" title="Èñâ„Åò„Çã" aria-label="„Ç´„Çπ„Çø„É†Ê§úÁ¥¢Á∑®ÈõÜ„ÇíÈñâ„Åò„Çã">&times;</button>
        <h3 id="emergency-search-modal-title">Á∑äÊÄ•ÊôÇÈÄ£Áµ°„Ç´„Çπ„Çø„É†Ê§úÁ¥¢</h3>
        <form id="emergency-search-form">
            <input type="hidden" id="emergency-search-id">
            <div class="modal-form-group">
                <label for="emergency-search-keyword">Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ</label>
                <input type="text" id="emergency-search-keyword" required placeholder="‰æã: Âª∫Ë®≠‰ºöÁ§æ, Èò≤ÁÅΩÂÄâÂ∫´">
                <small>Google„Éû„ÉÉ„Éó„ÅßÊ§úÁ¥¢„Åô„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ</small>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-modal-cancel" id="btn-emergency-search-modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="submit" class="btn-modal-save">‰øùÂ≠ò</button>
            </div>
        </form>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->

<div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeSettingsModal()" title="Èñâ„Åò„Çã" aria-label="Ë®≠ÂÆö„ÇíÈñâ„Åò„Çã">&times;</button>
        <h3>‚öôÔ∏è Ë®≠ÂÆö</h3>
        <form id="settings-form">
    <div class="modal-buttons">
        <button type="button" class="btn-modal-cancel" id="btn-settings-modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
        <button type="submit" class="btn-modal-save">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
    </div>

    <div class="settings-tabs">
        <button type="button" class="settings-tab active" data-tab="basic">‚öôÔ∏è Âü∫Êú¨Ë®≠ÂÆö</button>
        <button type="button" class="settings-tab" data-tab="customize">üé® „Ç´„Çπ„Çø„Éû„Ç§„Ç∫</button>
        <button type="button" class="settings-tab" data-tab="data">üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</button>
    </div>

    <div class="settings-tab-content-wrapper">
        <div class="settings-tab-content active" data-tab-content="basic">
            <div class="modal-form-group">
                <label for="settings-default-layer">„Éá„Éï„Ç©„É´„Éà„ÅÆÂú∞Âõ≥„É¨„Ç§„É§„Éº (Â∑¶ÂÅ¥)</label>
                <select id="settings-default-layer"></select>
                <small>Ëµ∑ÂãïÊôÇ„Å´ÊúÄÂàù„Å´Ë°®Á§∫„Åï„Çå„ÇãÂ∑¶ÂÅ¥Âú∞Âõ≥„ÅÆ„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</small>
            </div>
            <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë2ÁîªÈù¢ÁõÆ„ÅÆ„Éá„Éï„Ç©„É´„Éà„É¨„Ç§„É§„ÉºË®≠ÂÆö ‚ñº‚ñº‚ñº -->
            <div class="modal-form-group">
                <label for="settings-default-layer-right">2ÁîªÈù¢Ë°®Á§∫ÊôÇ„ÅÆÂè≥ÂÅ¥Âú∞Âõ≥„É¨„Ç§„É§„Éº</label>
                <select id="settings-default-layer-right"></select>
                <small>2ÁîªÈù¢Ë°®Á§∫„ÇíON„Å´„Åó„ÅüÈöõ„Å´„ÄÅÂè≥ÂÅ¥„Å´Ë°®Á§∫„Åï„Çå„Çã„Éá„Éï„Ç©„É´„Éà„ÅÆÂú∞Âõ≥„É¨„Ç§„É§„Éº„Åß„Åô„ÄÇ</small>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
            <div class="modal-form-group">
                <label for="settings-coord-format">Â∫ßÊ®ô„ÅÆË°®Á§∫ÂΩ¢Âºè</label>
                <select id="settings-coord-format">
                    <option value="decimal">ÂçÅÈÄ≤Êï∞ (‰æã: 35.123456)</option>
                    <option value="dms">Â∫¶ÂàÜÁßí (‰æã: 35¬∞07'24.4" N)</option>
                </select>
                <small>Á∑ØÂ∫¶ÁµåÂ∫¶„ÅÆË°®Á§∫„ÉªÂÖ•ÂäõÂΩ¢Âºè„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-history-size">Â±•Ê≠¥„ÅÆ‰øùÊåÅÊï∞</label>
                <input type="number" id="settings-history-size" min="10" max="500" step="10">
                <small>Â∫ßÊ®ô„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂ±•Ê≠¥„ÇíÊúÄÂ§ß‰Ωï‰ª∂„Åæ„Åß‰øùÊåÅ„Åô„Çã„ÅãË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-panel-state">Ëµ∑ÂãïÊôÇ„ÅÆ„Éë„Éç„É´Ë°®Á§∫</label>
                <select id="settings-panel-state">
                    <option value="closed">Èñâ„Åò„Çã</option>
                    <option value="open">Èñã„Åè</option>
                    <option value="pinned">„Éî„É≥Áïô„ÇÅ„Åó„Å¶Èñã„Åè</option>
                </select>
                <small>„Ç¢„Éó„É™Ëµ∑ÂãïÊôÇ„ÅÆÂè≥ÂÅ¥„Éë„Éç„É´„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇÔºàPCË°®Á§∫„ÅÆ„ÅøÔºâ</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-theme">„Ç´„É©„Éº„ÉÜ„Éº„Éû</label>
                <select id="settings-theme">
                    <option value="light">„É©„Ç§„Éà„É¢„Éº„Éâ</option>
                    <option value="dark">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</option>
                </select>
                <small>„Ç¢„Éó„É™ÂÖ®‰Ωì„ÅÆË¶ã„ÅüÁõÆ„ÇíÂ§âÊõ¥„Åó„Åæ„Åô„ÄÇ</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-panel-width">„Éá„Éï„Ç©„É´„Éà„ÅÆ„Éë„Éç„É´ÂπÖ (px): <span id="settings-panel-width-value">500</span></label>
                <div style="display: flex; gap: 10px;">
                    <input type="range" id="settings-panel-width" min="320" max="1000" step="10" style="flex-grow: 1;">
                    <button type="button" id="reset-panel-width" style="padding: 0 10px; font-size: 12px; white-space: nowrap;">„É™„Çª„ÉÉ„Éà</button>
                </div>
                <small>„Éî„É≥Áïô„ÇÅÊôÇ„ÅÆÂè≥ÂÅ¥„Éë„Éç„É´„ÅÆÂπÖ„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ„Éî„É≥Áïô„ÇÅÂõ∫ÂÆö„Åó„Å¶„Éâ„É©„ÉÉ„Ç∞„ÅßÂ§âÊõ¥„Åó„ÅüÂπÖ„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-zoom">„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´: <span id="settings-zoom-value">16</span></label>
                <input type="range" id="settings-zoom" min="1" max="20" step="1">
                <small>Ëµ∑ÂãïÊôÇ„ÅÆÂú∞Âõ≥„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ</small>
            </div>
        </div>

        <div class="settings-tab-content" data-tab-content="customize">
            <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
            <div class="modal-form-group">
                <h4>üó∫Ô∏è Âú∞Âõ≥„É™„É≥„ÇØ„Éë„Éç„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h4>
                <small>„Ç´„ÉÜ„Ç¥„É™Âêç„ÅÆÂ§âÊõ¥„ÄÅË°®Á§∫„Åô„ÇãÂú∞Âõ≥„ÅÆÈÅ∏Êäû„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰∏¶„ÅπÊõø„Åà„ÅØ„ÄÅ„Éë„Éç„É´„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„ÇíÁõ¥Êé•„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</small>
                
                <div class="modal-form-group" id="category-name-section">
                    <h5>üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™Âêç„ÅÆË®≠ÂÆö</h5>
                    <div id="settings-category-names">
                    </div>
                </div>

                <div class="modal-form-group" id="map-visibility-section">
                    <h5>üëÅÔ∏è Âú∞Âõ≥„É™„É≥„ÇØ„ÅÆË°®Á§∫Ë®≠ÂÆö</h5>
                    <div class="map-visibility-controls">
                        <button type="button" id="btn-show-all-maps">„Åô„Åπ„Å¶Ë°®Á§∫</button>
                        <button type="button" id="btn-hide-all-maps">„Åô„Åπ„Å¶ÈùûË°®Á§∫</button>
                    </div>
                    <div id="settings-map-visibility-list" class="map-visibility-list">
                    </div>
                    <div class="map-visibility-controls" style="margin-top: 15px;">
                         <button type="button" id="btn-reset-map-categories">„Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà</button>
                    </div>
                    <small>„Ç´„Éº„Éâ„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÈÖçÁΩÆ„Å®„ÄÅ„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰∏¶„Å≥È†Ü„ÇíÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„ÄÇ</small>
                </div>
                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
                <div class="modal-form-group" id="panel-width-section">
                    <h4>üìê „Çµ„Ç§„Éâ„Éë„Éç„É´ÂπÖ„ÅÆË®≠ÂÆö (ÈùûÂõ∫ÂÆöÊôÇ)</h4>
                    <small>„Éî„É≥Áïô„ÇÅ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÁä∂ÊÖã„ÅßÂêÑ„Çø„Éñ„ÇíÈñã„ÅÑ„Åü„Å®„Åç„ÅÆ„Éë„Éç„É´„ÅÆÂπÖ„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ(PCË°®Á§∫„ÅÆ„Åø)</small>
                    
                    <div class="modal-form-group">
                        <label for="settings-panel-width-map-links">üó∫Ô∏è Âú∞Âõ≥„É™„É≥„ÇØ: <span id="settings-panel-width-map-links-value">500</span>px</label>
                        <input type="range" id="settings-panel-width-map-links" min="320" max="1200" step="10">
                    </div>
                    
                    <div class="modal-form-group">
                        <label for="settings-panel-width-history">‚è±Ô∏è Â±•Ê≠¥‰∏ÄË¶ß: <span id="settings-panel-width-history-value">1200</span>px</label>
                        <input type="range" id="settings-panel-width-history" min="320" max="1400" step="10">
                    </div>
            
                    <div class="modal-form-group">
                        <label for="settings-panel-width-bookmarks">‚≠ê „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ: <span id="settings-panel-width-bookmarks-value">1300</span>px</label>
                        <input type="range" id="settings-panel-width-bookmarks" min="320" max="1500" step="10">
                    </div>
                    
                    <div style="margin-top: 10px;">
                         <button type="button" id="reset-panel-widths-unpinned" style="padding: 6px 10px; font-size: 12px;">„Éá„Éï„Ç©„É´„ÉàÂπÖ„Å´„É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-tab-content" data-tab-content="data">
            <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
            <div class="data-sync-section">
                <h4>üíæ „Éá„Éº„Çø„ÅÆÊõ∏„ÅçÂá∫„Åó„Å®Ë™≠„ÅøËæº„Åø</h4>
                <small>ÁèæÂú®„ÅÆË®≠ÂÆö„ÇÑ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å™„Å©„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò„Åó„Åü„Çä„ÄÅ„Éï„Ç°„Ç§„É´„Åã„ÇâÂæ©ÂÖÉ„Åó„Åü„Çä„Åó„Åæ„Åô„ÄÇ</small>
                <div class="modal-form-group">
                    <label>ÂØæË±°„Éá„Éº„Çø„ÇíÈÅ∏Êäû</label>
                    <div class="data-sync-checklist" id="data-sync-checklist">
                        <label><input type="checkbox" value="coordinateBookmarks"> ‚≠ê„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</label>
                        <label><input type="checkbox" value="coordinateHistory"> ‚è±Ô∏èÂ∫ßÊ®ôÂ±•Ê≠¥</label>
                        <label><input type="checkbox" value="favoriteSets"> „ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÉÉ„Éà</label>
                        <label><input type="checkbox" value="myCustomLinks"> ‚≠ê„Éû„Ç§„É™„É≥„ÇØ„Éû„ÉÉ„Éó</label>
                        <label><input type="checkbox" value="geoLinkNaviTabOrder"> üìë„Çø„Éñ„ÅÆ‰∏¶„Å≥È†Ü</label>
                        <label><input type="checkbox" value="geoLinkNaviSettings"> ‚öôÔ∏èÂêÑÁ®ÆË®≠ÂÆö</label>
                    </div>
                    <div class="data-sync-controls">
                        <button type="button" id="btn-check-all">‚úÖ ÂÖ®ÈÅ∏Êäû</button>
                        <button type="button" id="btn-uncheck-all">‚ùå ÂÖ®Ëß£Èô§</button>
                        <button type="button" id="btn-export-data">üì§ Êõ∏„ÅçÂá∫„Åó</button>
                        <button type="button" id="btn-import-data">üì• Ë™≠„ÅøËæº„Åø</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
    </div>
</div>
<div class="modal-overlay" id="qr-modal" onclick="closeQrModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button type="button" class="modal-close-btn" onclick="closeQrModal()" title="Èñâ„Åò„Çã" aria-label="QR„Ç≥„Éº„Éâ„ÇíÈñâ„Åò„Çã">&times;</button>
        <h3>üì± ÂÖ±Êúâ</h3>
        <div id="qrcode"></div>
        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂÖ±Êúâ„É™„É≥„ÇØË°®Á§∫Ê¨Ñ ‚ñº‚ñº‚ñº -->
        <div class="modal-form-group" style="margin-top: 15px;">
            <label for="share-url-input">ÂÖ±Êúâ„É™„É≥„ÇØ</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="share-url-input" readonly style="flex-grow: 1;">
                <button type="button" class="btn-base" id="copy-url-btn" style="min-width: 80px; background-color: var(--primary-color);">„Ç≥„Éî„Éº</button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        <div class="modal-buttons">
            <button type="button" class="btn-modal-cancel" onclick="closeQrModal()">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="profile-modal">
    <div class="modal-content" style="max-width: 90vw; width: 600px; height: auto;">
        <button type="button" class="modal-close-btn" id="btn-profile-modal-close" title="Èñâ„Åò„Çã" aria-label="Êñ≠Èù¢Âõ≥„ÇíÈñâ„Åò„Çã">&times;</button>
        <h3 id="profile-modal-header" style="cursor: move;">Ê®ôÈ´òÊñ≠Èù¢Âõ≥</h3>
        <div style="position: relative; width: 100%; height: 300px; margin-bottom: 10px; background: var(--bg-container); border-radius: 8px; border: 1px solid var(--border-color);">
            <canvas id="profileChart"></canvas>
        </div>
        <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 10px; padding: 0 10px;">
            <input type="checkbox" id="y-axis-toggle" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
            <label for="y-axis-toggle" style="font-size: 14px; cursor: pointer; user-select: none;">YËª∏„Çí0„Åã„ÇâÂßã„ÇÅ„Çã</label>
        </div>
        
        <div id="profile-data-source" style="font-size: 11px; color: var(--text-medium); text-align: right; padding: 0 10px 10px 10px; margin-top: auto;">
        </div>
        
        <div class="modal-buttons" style="margin-top: 0;">
            <button type="button" class="btn-base" id="btn-export-profile-csv" style="background-color: var(--success-color);">üíæ „Éá„Éº„Çø„ÇíCSV„ÅßÊõ∏„ÅçÂá∫„Åô</button>
            <button type="button" class="btn-modal-cancel" id="btn-profile-modal-cancel">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="project-modal">
    <div class="modal-content">
<button type="button" class="modal-close-btn" id="project-modal-close-btn-x" title="Èñâ„Åò„Çã" aria-label="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ„ÇíÈñâ„Åò„Çã">&times;</button>
        <h3>üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ</h3>
        <div class="project-list-container">
            <ul id="projectManagementList">
            </ul>
        </div>
        <div class="project-actions project-actions-grid">
            <button id="btn-new-project" class="btn-base">‚ûï Êñ∞Ë¶è‰ΩúÊàê</button>
            <button id="btn-duplicate-project" class="btn-base" disabled>üìã Ë§áË£Ω</button>
            <button id="btn-rename-project" class="btn-base" disabled>‚úèÔ∏è ÂêçÂâç„ÅÆÂ§âÊõ¥</button>
            <button id="btn-delete-project" class="btn-base" disabled>üóëÔ∏è ÂâäÈô§</button>
        </div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
        <div class="project-actions">
            <button id="btn-export-project" class="btn-base" disabled>üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            <button id="btn-import-project" class="btn-base">üì• „Ç§„É≥„Éù„Éº„Éà</button>
            <input type="file" id="import-project-file-input" accept=".json" style="display: none;">
        </div>
        <div class="modal-buttons">
           <button type="button" class="btn-modal-cancel" id="project-modal-close-btn-bottom">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="coord-converter-modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" id="coord-converter-close-btn" title="Èñâ„Åò„Çã">&times;</button>
        <h3>üß≠Á∑ØÂ∫¶ÁµåÂ∫¶ ‚áî Âπ≥Èù¢Áõ¥ËßíÂ∫ßÊ®ô Â§âÊèõ</h3>

        <!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂú∞ÊÆªÂ§âÂãï„ÅÆË≠¶ÂëäË°®Á§∫„Ç®„É™„Ç¢ ‚ñº‚ñº‚ñº -->
        <div id="crustal-deformation-warning" style="display: none; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #FFD54F; background-color: #FFF8E1; color: #8D6E63;">
            <p style="margin: 0; font-weight: bold; font-size: 14px;">‚ö†Ô∏è Âú∞ÊÆªÂ§âÂãï„Å´„Çà„ÇãÂ∫ßÊ®ôË£úÊ≠£„ÅÆÊ≥®ÊÑè</p>
            <p id="deformation-details" style="margin: 5px 0 0; font-size: 13px;"></p>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
        
        <div class="converter-grid">
            <div class="converter-panel">
                <h4>üåêÁ∑ØÂ∫¶„ÉªÁµåÂ∫¶(‰∏ñÁïåÊ∏¨Âú∞Á≥ª)</h4>
                <div class="converter-row">
                    <div class="modal-form-group">
                        <label for="conv-lat">Á∑ØÂ∫¶</label>
                        <input type="text" id="conv-lat" placeholder="‰æã: 35.681074">
                    </div>
                    <div class="modal-form-group">
                        <label for="conv-lon">ÁµåÂ∫¶</label>
                        <input type="text" id="conv-lon" placeholder="‰æã: 139.767843">
                    </div>
                </div>
                <div class="modal-form-group" style="display: flex; gap: 10px;">
                    <button type="button" class="btn-base" id="btn-conv-to-dec" style="flex: 1;">ÂçÅÈÄ≤Êï∞„Å´Â§âÊèõ</button>
                    <button type="button" class="btn-base" id="btn-conv-to-dms" style="flex: 1;">Â∫¶ÂàÜÁßí„Å´Â§âÊèõ</button>
                </div>
                 <button type="button" class="btn-base" id="btn-get-main-coords" style="width:100%;">„É°„Ç§„É≥ÁîªÈù¢„ÅÆÂ∫ßÊ®ô„ÇíÂèñÂæó</button>
            </div>

            <div class="converter-arrows">
                <button type="button" id="btn-convert-to-xy" title="XYÂ∫ßÊ®ô„Å∏Â§âÊèõ">‚ñ∂</button>
                <button type="button" id="btn-convert-to-latlon" title="Á∑ØÂ∫¶ÁµåÂ∫¶„Å∏Â§âÊèõ">‚óÄ</button>
            </div>

            <div class="converter-panel">
                <h4>üìêÂπ≥Èù¢Áõ¥ËßíÂ∫ßÊ®ô(‰∏ñÁïåÊ∏¨Âú∞Á≥ª)</h4>
                <div class="converter-row">
                    <div class="modal-form-group">
                        <label for="conv-pref">ÈÉΩÈÅìÂ∫úÁúå</label>
                        <select id="conv-pref">
                            <option value="">Ëá™ÂãïÂà§Âà•</option>
                        </select>
                    </div>
                    <div class="modal-form-group">
                        <label for="conv-zone">Â∫ßÊ®ôÁ≥ª</label>
                        <select id="conv-zone"></select>
                    </div>
                </div>
                <div class="converter-row">
                    <div class="modal-form-group">
                        <label for="conv-x">XÂ∫ßÊ®ô (m)</label>
                        <input type="text" id="conv-x" placeholder="ÂåóÊñπÂêë„ÅÆÂ∫ßÊ®ô">
                    </div>
                    <div class="modal-form-group">
                        <label for="conv-y">YÂ∫ßÊ®ô (m)</label>
                        <input type="text" id="conv-y" placeholder="Êù±ÊñπÂêë„ÅÆÂ∫ßÊ®ô">
                    </div>
                </div>
            </div>
        </div>

        <div class="converter-actions">
            <button type="button" class="btn-base" id="btn-apply-coords">‚úî ÁµêÊûú„Çí„É°„Ç§„É≥ÁîªÈù¢„Å´ÂèçÊò†</button>
            <button type="button" class="btn-base" id="btn-copy-conv-result">üìã ÁµêÊûú„Çí„Ç≥„Éî„Éº</button>
            <button type="button" class="btn-base" id="btn-open-gsi-bl2xy" title="Á∑ØÂ∫¶„ÉªÁµåÂ∫¶„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Å¶„Çµ„Ç§„Éà„ÇíÈñã„Åç„Åæ„Åô">üåè Âú∞ÁêÜÈô¢(Á∑ØÁµå‚ÜíXY)</button>
            <button type="button" class="btn-base" id="btn-open-gsi-xy2bl" title="XYÂ∫ßÊ®ô„ÉªÁ≥ªÁï™Âè∑„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Å¶„Çµ„Ç§„Éà„ÇíÈñã„Åç„Åæ„Åô">üåè Âú∞ÁêÜÈô¢(XY‚ÜíÁ∑ØÁµå)</button>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëCSV„Ç§„É≥„Éù„Éº„ÉàÁî®„ÅÆ„É¢„Éº„ÉÄ„É´ ‚ñº‚ñº‚ñº -->
<div class="modal-overlay" id="csv-import-modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" id="csv-import-close-btn" title="Èñâ„Åò„Çã">&times;</button>
        <h3 id="csv-import-title">CSV„Ç§„É≥„Éù„Éº„Éà</h3>
        <input type="file" id="csv-file-input" accept=".csv, text/csv" style="display: none;">

        <!-- Step 1: File Selection -->
<div id="csv-file-selection">
    <div class="modal-form-group">
        <p id="csv-import-description">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰∏ÄÊã¨ÁôªÈå≤„Åô„ÇãCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        <button type="button" id="csv-select-file-btn" class="btn-base btn-import-csv" style="width: 100%; padding: 15px; font-size: 16px;">üìÇ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
        <small>„Éò„ÉÉ„ÉÄ„ÉºË°åÔºà1Ë°åÁõÆÔºâ„ÇíÂê´„ÇÄCSV„Éï„Ç°„Ç§„É´„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ</small>
    </div>
</div>

        <!-- Step 2: Column Mapping -->
        <div id="csv-column-mapping">
            <p>CSV„ÅÆÂêÑÂàó„Åå„Å©„ÅÆÊÉÖÂ†±„Å´ÂØæÂøú„Åô„Çã„Åã„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <div id="csv-preview-container">
                <table id="csv-preview-table"></table>
            </div>
            <div class="column-mapper-grid" id="csv-mapper-grid">
                <!-- JS„ÅßÁîüÊàê -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-modal-cancel" id="csv-back-to-file-select-btn">Êàª„Çã</button>
                <button type="button" class="btn-base" id="csv-goto-confirm-btn" style="background-color: var(--primary-color);">Ê¨°„Å∏</button>
            </div>
        </div>
        
        <!-- Step 3: Confirmation -->
        <div id="csv-import-confirm">
             <div class="csv-import-info">
                <p><strong id="csv-import-count">0</strong> ‰ª∂„ÅÆ„Éá„Éº„Çø„Çí„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ</p>
                <p><strong>Ê≥®ÊÑè:</strong> „Ç§„É≥„Éù„Éº„Éà„Å´„ÅØÊôÇÈñì„Åå„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åô„Çã„Åæ„Åß„Åì„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-modal-cancel" id="csv-back-to-mapping-btn">Êàª„Çã</button>
                <button type="button" class="btn-modal-save" id="csv-execute-import-btn">„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
            </div>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤ -->
<script>
/**
 * ‰∏ñÁïåÊ∏¨Âú∞Á≥ª(WGS84)„Åã„ÇâÊó•Êú¨Ê∏¨Âú∞Á≥ª(Tokyo Datum)„Å∏Â∫ßÊ®ô„ÇíÂ§âÊèõ„Åô„ÇãÈñ¢Êï∞
 */
function convertWgs84ToTokyo(lat, lon) {
  try {
    const sourceProj = 'EPSG:4326';
    const destProj = 'EPSG:4301';
    if (proj4.defs(destProj) === undefined) {
      proj4.defs(destProj, "+proj=longlat +ellps=bessel +towgs84=-146.414,507.337,680.507,0,0,0,0 +no_defs");
    }
    const [newLon, newLat] = proj4(sourceProj, destProj, [lon, lat]);
    return { lat: newLat, lon: newLon };
  } catch (e) {
    console.error("Â∫ßÊ®ôÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
    showNotification('Êó•Êú¨Ê∏¨Âú∞Á≥ª„Å∏„ÅÆÂ∫ßÊ®ôÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'warning');
    return { lat: lat, lon: lon };
  }
}

/**
 * 10ÈÄ≤Êï∞„ÅÆÁ∑ØÂ∫¶ÁµåÂ∫¶„ÇíÂõΩÂúüÂú∞ÁêÜÈô¢„ÅÆË®àÁÆó„Çµ„Ç§„ÉàÂΩ¢Âºè (dddmmss.s) „Å´Â§âÊèõ„Åô„Çã
 * @param {number} dd 10ÈÄ≤Êï∞„ÅÆÂ∫ßÊ®ôÂÄ§
 * @returns {string} Â§âÊèõÂæå„ÅÆÊñáÂ≠óÂàó
 */
function decimalToGsiDms(dd) {
    const absDd = Math.abs(dd);
    const d = Math.floor(absDd);
    const m = Math.floor((absDd - d) * 60);
    const s = (((absDd - d) * 60) - m) * 60;
    
    const resultValue = d * 10000 + m * 100 + s;
    
    return resultValue.toFixed(5);
}

// ‚ñº‚ñº‚ñº„ÄêÂ§âÊõ¥„Äë„Ç´„ÉÜ„Ç¥„É™Âêç„Çí„ÄåÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„Äç„Å´Â§âÊõ¥ ‚ñº‚ñº‚ñº
const CATEGORY_META = { 'all': { title: '„Åô„Åπ„Å¶„ÅÆÂú∞Âõ≥', icon: 'üåê', class: '' }, 'terrain': { title: 'Âú∞Âõ≥„ÉªÂú∞ÁêÜÊÉÖÂ†±', icon: 'üóª', class: 'terrain-icon' }, 'geology': { title: 'Âú∞Ë≥™„ÉªÂú∞Áõ§ÊÉÖÂ†±', icon: 'üèîÔ∏è', class: 'geology-icon' }, 'weather': { title: 'Â§©Ê∞ó„ÉªÊ∞óË±°ÊÉÖÂ†±', icon: 'üå¶Ô∏è', class: 'weather-icon' }, 'disaster': { title: 'Èò≤ÁÅΩ„Éª„Éè„Ç∂„Éº„ÉâÊÉÖÂ†±', icon: '‚ö†Ô∏è', class: 'disaster-icon' }, 'survey': { title: 'Ê∏¨Èáè„ÉªËß£Êûê„ÉÑ„Éº„É´', icon: 'üìê', class: 'survey-icon' }, 'other': { title: '„Åù„ÅÆ‰ªñ„ÅÆÊÉÖÂ†±', icon: 'üí°', class: 'other-icon' }, 'liaison': { title: 'Á∑äÊÄ•ÊôÇÈÄ£Áµ°', icon: 'üìû', class: 'liaison-icon' }, 'mylink': { title: '‚≠ê „Éû„Ç§„É™„É≥„ÇØ', icon: '‚≠ê', class: 'mylink-icon'} };

const BASE_LAYERS = {
    'osm': { name: 'OpenStreetMap', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: '¬© OpenStreetMap contributors', layer: null, maxZoom: 19 },
    'gsi_std': { name: 'Âú∞ÁêÜÈô¢Âú∞Âõ≥ÔºàÊ®ôÊ∫ñÔºâ', url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', attribution: '¬© ÂõΩÂúüÂú∞ÁêÜÈô¢', layer: null, maxZoom: 18 },
    'gsi_pale': { name: 'Âú∞ÁêÜÈô¢Âú∞Âõ≥ÔºàÊ∑°Ëâ≤Ôºâ', url: 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', attribution: '¬© ÂõΩÂúüÂú∞ÁêÜÈô¢', layer: null, maxZoom: 18 },
    'gsi_seamlessphoto': { name: 'Âú∞ÁêÜÈô¢Âú∞Âõ≥ÔºàÂÜôÁúüÔºâ', url: 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', attribution: '¬© ÂõΩÂúüÂú∞ÁêÜÈô¢', layer: null, maxZoom: 18 },
    'gsi_relief': { name: 'Âú∞ÁêÜÈô¢Âú∞Âõ≥ÔºàËâ≤Âà•Ê®ôÈ´òÂõ≥Ôºâ', url: 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', attribution: '¬© ÂõΩÂúüÂú∞ÁêÜÈô¢', layer: null, maxZoom: 15 }
};

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂú∞ÊÆªÂ§âÂãï„Ç®„É™„Ç¢„ÅÆ„Éá„Éº„Çø„Å®Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ ‚ñº‚ñº‚ñº

/**
 * Âú∞ÊÆªÂ§âÂãï„Å´„Çà„ÇãÂ∫ßÊ®ôË£úÊ≠£„ÅåÂøÖË¶Å„Å™„Ç®„É™„Ç¢„ÅÆ„Éá„Éº„Çø
 * Ê≥®ÊÑèÔºöÂ∏ÇÁî∫ÊùëÂêç„ÅØ„ÄÅÂêà‰Ωµ„Å™„Å©„Å´„Çà„ÇäÁèæÂú®„ÅÆÂêçÁß∞„Å®Áï∞„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
 *       „Çà„ÇäÂ∫É„ÅÑÁØÑÂõ≤„Çí„Ç´„Éê„Éº„Åô„Çã„Åü„ÇÅ„ÄÅÈÉΩÈÅìÂ∫úÁúåÂçò‰Ωç„Åß„ÅÆÊåáÂÆö„ÇÇÊ¥ªÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
 */
const DEFORMATION_AREAS = [
    {
        name: "Âπ≥Êàê15Âπ¥(2003Âπ¥)ÂçÅÂãùÊ≤ñÂú∞Èúá",
        municipalities: [
            // tokachi2003.par
            "Â§ïÂºµÂ∏Ç", "ÂØåËâØÈáéÂ∏Ç", "Áî±‰ªÅÁî∫", "Ê†óÂ±±Áî∫", "‰∏äÂØåËâØÈáéÁî∫", "‰∏≠ÂØåËâØÈáéÁî∫", "ÂçóÂØåËâØÈáéÁî∫", "Âç†ÂÜ†Êùë", "ÂéöÁúüÁî∫", "Èµ°Â∑ùÁî∫", "Á©ÇÂà•Áî∫", "Êó•È´òÁî∫", "Âπ≥ÂèñÁî∫", "ÈñÄÂà•Áî∫", "Êñ∞ÂÜ†Áî∫", "ÈùôÂÜÖÁî∫", "‰∏âÁü≥Áî∫", "Êµ¶Ê≤≥Áî∫", "Êßò‰ººÁî∫", "„Åà„Çä„ÇÇÁî∫",
            "ÈáßË∑ØÂ∏Ç", "Â∏ØÂ∫ÉÂ∏Ç", "Ê†πÂÆ§Â∏Ç", "Ê¥•Âà•Áî∫", "Ë®ìÂ≠êÂ∫úÁî∫", "ÁΩÆÊà∏Áî∫", "ÁïôËæ∫ËòÇÁî∫", "Èü≥Êõ¥Áî∫", "Â£´ÂπåÁî∫", "‰∏äÂ£´ÂπåÁî∫", "ÈπøËøΩÁî∫", "Êñ∞ÂæóÁî∫", "Ê∏ÖÊ∞¥Áî∫", "ËäΩÂÆ§Áî∫", "‰∏≠Êú≠ÂÜÖÊùë", "Êõ¥Âà•Êùë", "Âø†È°ûÊùë", "Â§ßÊ®πÁî∫", "Â∫ÉÂ∞æÁî∫", "ÂπïÂà•Áî∫", "Ê±†Áî∞Áî∫", "Ë±äÈ†ÉÁî∫", "Êú¨Âà•Áî∫", "Ë∂≥ÂØÑÁî∫", "Èô∏Âà•Áî∫", "Êµ¶ÂπåÁî∫", "ÈáßË∑ØÁî∫", "ÂéöÂ≤∏Áî∫", "Êµú‰∏≠Áî∫", "Ê®ôËå∂Áî∫", "ÈòøÂØíÁî∫", "È∂¥Â±ÖÊùë", "ÁôΩÁ≥†Áî∫", "Èü≥Âà•Áî∫", "Âà•Êµ∑Áî∫",
            // tokachi2003b.par
            "ÂåóË¶ãÂ∏Ç", "Á∂≤Ëµ∞Â∏Ç", "Êù±ËóªÁê¥Êùë", "Â•≥Ê∫ÄÂà•Áî∫", "ÁæéÂπåÁî∫", "ÊñúÈáåÁî∫", "Ê∏ÖÈáåÁî∫", "Â∞èÊ∏ÖÊ∞¥Áî∫", "Á´ØÈáéÁî∫", "‰ΩêÂëÇÈñìÁî∫", "Â∏∏ÂëÇÁî∫", "ÂºüÂ≠êÂ±àÁî∫", "‰∏≠Ê®ôÊ¥•Áî∫", "Ê®ôÊ¥•Áî∫", "ÁæÖËáºÁî∫"
        ],
        prefectures: ["ÂåóÊµ∑ÈÅì"] // Á∂≤ÁæÖÊÄß„ÇíÈ´ò„ÇÅ„Çã„Åü„ÇÅÂ∫É„ÇÅ„Å´Ë®≠ÂÆö
    },
    {
        name: "Âπ≥Êàê17Âπ¥(2005Âπ¥)Á¶èÂ≤°ÁúåË•øÊñπÊ≤ñÂú∞Èúá",
        municipalities: [ "Á¶èÂ≤°Â∏Ç", "Êò•Êó•Â∏Ç", "Â§ßÈáéÂüéÂ∏Ç", "ÂâçÂéüÂ∏Ç", "Âè§Ë≥ÄÂ∏Ç", "Êñ∞ÂÆÆÁî∫", "ÂøóÊë©Áî∫" ],
        prefectures: ["Á¶èÂ≤°Áúå"]
    },
    {
        name: "Âπ≥Êàê19Âπ¥(2007Âπ¥)ËÉΩÁôªÂçäÂ≥∂Âú∞Èúá",
        municipalities: [ "Ëº™Â≥∂Â∏Ç", "‰∏ÉÂ∞æÂ∏Ç", "ÂøóË≥ÄÁî∫", "Á©¥Ê∞¥Áî∫", "ËÉΩÁôªÁî∫" ],
        prefectures: ["Áü≥Â∑ùÁúå"]
    },
    {
        name: "Âπ≥Êàê19Âπ¥(2007Âπ¥)‰∏≠Ë∂äÊ≤ñÂú∞Èúá",
        municipalities: [ "ÊüèÂ¥éÂ∏Ç", "‰∏äË∂äÂ∏Ç", "Âá∫Èõ≤Â¥éÁî∫", "ÂààÁæΩÊùë" ],
        prefectures: ["Êñ∞ÊΩüÁúå"]
    },
    {
        name: "Âπ≥Êàê20Âπ¥(2008Âπ¥)Â≤©Êâã„ÉªÂÆÆÂüéÂÜÖÈô∏Âú∞Èúá",
        municipalities: [ "‰∏ÄÈñ¢Â∏Ç", "Â••Â∑ûÂ∏Ç", "Ë•øÂíåË≥ÄÁî∫", "Âπ≥Ê≥âÁî∫", "Ëó§Ê≤¢Áî∫", "ÁôªÁ±≥Â∏Ç", "Ê†óÂéüÂ∏Ç", "Â§ßÂ¥éÂ∏Ç", "Âä†ÁæéÁî∫", "Ê®™ÊâãÂ∏Ç", "ÊπØÊ≤¢Â∏Ç", "Áî±Âà©Êú¨ËçòÂ∏Ç", "ÁæΩÂæåÁî∫", "Êù±ÊàêÁÄ¨Êùë", "Êñ∞Â∫ÑÂ∏Ç", "ÈáëÂ±±Áî∫", "ÊúÄ‰∏äÁî∫", "ÁúüÂÆ§Â∑ùÁî∫", "ÈÆ≠Â∑ùÊùë" ],
        prefectures: ["Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå"]
    },
    {
        name: "Âπ≥Êàê23Âπ¥(2011Âπ¥)Êù±ÂåóÂú∞ÊñπÂ§™Âπ≥Ê¥ãÊ≤ñÂú∞Èúá",
        municipalities: [], // ÁØÑÂõ≤„ÅåÂ∫É„Åô„Åé„Çã„Åü„ÇÅÈÉΩÈÅìÂ∫úÁúå„ÅßÂà§ÂÆö
        prefectures: [
            "ÈùíÊ£ÆÁúå", "Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå", "Á¶èÂ≥∂Áúå", "Ëå®ÂüéÁúå", "Ê†ÉÊú®Áúå", "Áæ§È¶¨Áúå", "ÂüºÁéâÁúå", "ÂçÉËëâÁúå", "Êù±‰∫¨ÈÉΩ", "Á•ûÂ•àÂ∑ùÁúå", "Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Á¶è‰∫ïÁúå", "Â±±Ê¢®Áúå", "Èï∑ÈáéÁúå", "Â≤êÈòúÁúå"
        ]
    },
    {
        name: "Âπ≥Êàê28Âπ¥(2016Âπ¥)ÁÜäÊú¨Âú∞Èúá",
        municipalities: [
            "‰πÖÁïôÁ±≥Â∏Ç", "ÂÖ´Â•≥Â∏Ç", "„ÅÜ„Åç„ÅØÂ∏Ç", "Â∫ÉÂ∑ùÁî∫", "Â≥∂ÂéüÂ∏Ç", "Èõ≤‰ªôÂ∏Ç", "ÂçóÂ≥∂ÂéüÂ∏Ç", "Êó•Áî∞Â∏Ç", "Á´πÁî∞Â∏Ç", "Ë±äÂæåÂ§ßÈáéÂ∏Ç", "‰πùÈáçÁî∫", "ÁéñÁè†Áî∫", "Ê§éËëâÊùë",
            // ÁÜäÊú¨Áúå„ÅÆÂ§ßÈÉ®ÂàÜ
            "ÁÜäÊú¨Â∏Ç", "ÂÖ´‰ª£Â∏Ç", "‰∫∫ÂêâÂ∏Ç", "ËçíÂ∞æÂ∏Ç", "Ê∞¥‰ø£Â∏Ç", "ÁéâÂêçÂ∏Ç", "Â±±ÈπøÂ∏Ç", "ËèäÊ±†Â∏Ç", "ÂÆáÂúüÂ∏Ç", "‰∏äÂ§©ËçâÂ∏Ç", "ÂÆáÂüéÂ∏Ç", "ÈòøËòáÂ∏Ç", "ÂêàÂøóÂ∏Ç", "ÁæéÈáåÁî∫", "ÁéâÊù±Áî∫", "ÂçóÈñ¢Áî∫", "Èï∑Ê¥≤Áî∫", "ÂíåÊ∞¥Áî∫", "Â§ßÊ¥•Áî∫", "ËèäÈôΩÁî∫", "ÂçóÂ∞èÂõΩÁî∫", "Â∞èÂõΩÁî∫", "Áî£Â±±Êùë", "È´òÊ£ÆÁî∫", "Ë•øÂéüÊùë", "ÂçóÈòøËòáÊùë", "Âæ°ËàπÁî∫", "ÂòâÂ≥∂Áî∫", "ÁõäÂüéÁî∫", "Áî≤‰ΩêÁî∫", "Â±±ÈÉΩÁî∫", "Ê∞∑Â∑ùÁî∫", "Ëä¶ÂåóÁî∫", "Ê¥•Â•àÊú®Áî∫", "Èå¶Áî∫", "Â§öËâØÊú®Áî∫", "ÊπØÂâçÁî∫", "Ê∞¥‰∏äÊùë", "Áõ∏ËâØÊùë", "‰∫îÊú®Êùë", "Â±±Ê±üÊùë", "ÁêÉÁ£®Êùë", "„ÅÇ„Åï„Åé„ÇäÁî∫"
        ],
        prefectures: ["ÁÜäÊú¨Áúå", "Á¶èÂ≤°Áúå", "Èï∑Â¥éÁúå", "Â§ßÂàÜÁúå", "ÂÆÆÂ¥éÁúå"]
    },
    {
        name: "‰ª§Âíå6Âπ¥ËÉΩÁôªÂçäÂ≥∂Âú∞Èúá",
        municipalities: [
            // noto2024_BL.par
            "Èï∑ÈáéÂéüÁî∫", "Â¨¨ÊÅãÊùë", "ËçâÊ¥•Áî∫", "Èï∑Â≤°Â∏Ç", "ÊüèÂ¥éÂ∏Ç", "Â∞èÂçÉË∞∑Â∏Ç", "ÂçÅÊó•Áî∫Â∏Ç", "Á≥∏È≠öÂ∑ùÂ∏Ç", "Â¶ôÈ´òÂ∏Ç", "‰∏äË∂äÂ∏Ç", "‰ΩêÊ∏°Â∏Ç", "ÂçóÈ≠öÊ≤ºÂ∏Ç", "Âá∫Èõ≤Â¥éÁî∫", "ÊπØÊ≤¢Áî∫", "Ê¥•ÂçóÁî∫", "ÂààÁæΩÊùë", "ÂØåÂ±±Â∏Ç", "È´òÂ≤°Â∏Ç", "È≠öÊ¥•Â∏Ç", "ÊªëÂ∑ùÂ∏Ç", "ÈªíÈÉ®Â∏Ç", "Á†∫Ê≥¢Â∏Ç", "Â∞èÁü¢ÈÉ®Â∏Ç", "Â∞ÑÊ∞¥Â∏Ç", "ËàüÊ©ãÊùë", "‰∏äÂ∏ÇÁî∫", "Á´ãÂ±±Áî∫", "ÂÖ•ÂñÑÁî∫", "ÊúùÊó•Áî∫", "Èï∑ÈáéÂ∏Ç", "‰∏äÁî∞Â∏Ç", "È†àÂùÇÂ∏Ç", "Â∞èË´∏Â∏Ç", "‰∏≠ÈáéÂ∏Ç", "Â§ßÁî∫Â∏Ç", "È£ØÂ±±Â∏Ç", "ÂçÉÊõ≤Â∏Ç", "Êù±Âæ°Â∏Ç", "ÂÆâÊõáÈáéÂ∏Ç", "È∫ªÁ∏æÊùë", "ÁîüÂùÇÊùë", "Á≠ëÂåóÊùë", "Ê±†Áî∞Áî∫", "ÊùæÂ∑ùÊùë", "ÁôΩÈ¶¨Êùë", "Â∞èË∞∑Êùë", "ÂùÇÂüéÁî∫", "Â∞èÂ∏ÉÊñΩÁî∫", "È´òÂ±±Êùë", "Â±±„ÉéÂÜÖÁî∫", "Êú®Â≥∂Âπ≥Êùë", "ÈáéÊ≤¢Ê∏©Ê≥âÊùë", "‰ø°ÊøÉÁî∫", "Â∞èÂ∑ùÊùë", "È£ØÁ∂±Áî∫", "Ê†ÑÊùë",
            // noto2024_02BL.par
            "Ê∞∑Ë¶ãÂ∏Ç", "‰∏ÉÂ∞æÂ∏Ç", "Ëº™Â≥∂Â∏Ç", "Áè†Ê¥≤Â∏Ç", "ÁæΩÂíãÂ∏Ç", "„Åã„Åª„ÅèÂ∏Ç", "Ê¥•Âπ°Áî∫", "ÂÜÖÁÅòÁî∫", "ÂøóË≥ÄÁî∫", "ÂÆùÈÅîÂøóÊ∞¥Áî∫", "‰∏≠ËÉΩÁôªÁî∫", "Á©¥Ê∞¥Áî∫", "ËÉΩÁôªÁî∫"
        ],
        prefectures: ["Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Áæ§È¶¨Áúå", "Èï∑ÈáéÁúå"]
    },
    {
        name: "‰ª§Âíå6Âπ¥Êó•ÂêëÁÅò„ÇíÈúáÊ∫ê„Å®„Åô„ÇãÂú∞Èúá",
        municipalities: [ "ÂÆÆÂ¥éÂ∏Ç", "ÈÉΩÂüéÂ∏Ç", "Êó•ÂçóÂ∏Ç", "Â∞èÊûóÂ∏Ç", "Ë•øÈÉΩÂ∏Ç", "‰∏âËÇ°Áî∫", "È´òÂéüÁî∫", "ÂõΩÂØåÁî∫", "Á∂æÁî∫", "È´òÈçãÁî∫", "Êñ∞ÂØåÁî∫", "Êú®ÂüéÁî∫", "Â∑ùÂçóÁî∫" ],
        prefectures: ["ÂÆÆÂ¥éÁúå"]
    }
];

/**
 * ÊåáÂÆö„Åï„Çå„ÅüÂ∫ßÊ®ô„ÅåÂú∞ÊÆªÂ§âÂãï„Ç®„É™„Ç¢„Å´Âê´„Åæ„Çå„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅË©≤ÂΩì„Åô„Çã„Åô„Åπ„Å¶„ÅÆÂú∞ÈúáÂêç„ÇíÈÖçÂàó„ÅßËøî„Åô
 * @param {number} lat Á∑ØÂ∫¶
 * @param {number} lon ÁµåÂ∫¶
 * @returns {Promise<string[]>} Ë©≤ÂΩì„Åô„ÇãÂú∞Èúá„ÅÆÂêçÁß∞„ÅÆÈÖçÂàó„ÄÅ„Åæ„Åü„ÅØÁ©∫„ÅÆÈÖçÂàó
 */
async function checkCrustalDeformation(lat, lon) {
    try {
        const addressInfo = await getAddressFromCoords(lat, lon);
        if (!addressInfo || !addressInfo.structured || addressInfo.structured === '---') {
            return []; // Âà§ÂÆö‰∏çËÉΩÊôÇ„ÅØÁ©∫„ÅÆÈÖçÂàó„ÇíËøî„Åô
        }
        
        const address = addressInfo.structured;
        const foundEvents = []; // Ë¶ã„Å§„Åã„Å£„ÅüÂú∞ÈúáÂêç„ÇíÊ†ºÁ¥ç„Åô„ÇãÈÖçÂàó

        for (const area of DEFORMATION_AREAS) {
            // 1. ÈÉΩÈÅìÂ∫úÁúå„Åß„ÉÅ„Çß„ÉÉ„ÇØ
            const prefecturesMatch = area.prefectures.some(pref => address.startsWith(pref));
            if (prefecturesMatch) {
                // 2. Â∏ÇÂå∫Áî∫Êùë„Åß„Çà„ÇäË©≥Á¥∞„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                const municipalitiesMatch = area.municipalities.some(muni => address.includes(muni));
                // Â∏ÇÂå∫Áî∫Êùë„É™„Çπ„Éà„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÈÉΩÈÅìÂ∫úÁúå„ÅÆ‰∏ÄËá¥„Å†„Åë„ÅßÂà§ÂÆö
                if (municipalitiesMatch || area.municipalities.length === 0) {
                    foundEvents.push(area.name); // ÈÖçÂàó„Å´ËøΩÂä†Ôºà„Åì„Åì„Åßreturn„Åó„Å™„ÅÑÔºâ
                }
            }
        }
        return foundEvents; // „Åô„Åπ„Å¶„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÅåÁµÇ„Çè„Å£„ÅüÂæå„ÅßÈÖçÂàó„ÇíËøî„Åô
    } catch (e) {
        console.error("Âú∞ÊÆªÂ§âÂãï„Ç®„É™„Ç¢„ÅÆÂà§ÂÆö‰∏≠„Å´„Ç®„É©„Éº:", e);
        return []; // „Ç®„É©„ÉºÊôÇ„ÇÇÁ©∫„ÅÆÈÖçÂàó„ÇíËøî„Åô
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„ÄêÂ§âÊõ¥„Äë„É™„É≥„ÇØ„ÅÆËøΩÂä†„Å®‰∏¶„ÅπÊõø„Åà„ÄÅ‰ªªÊÑèÊ§úÁ¥¢Ê¨Ñ„ÅÆÂâäÈô§ ‚ñº‚ñº‚ñº
const MAP_DEFINITIONS = [ { id: 'gsi_std', name: 'Âú∞ÁêÜÈô¢Âú∞Âõ≥', desc: 'ÂõΩÂúüÂú∞ÁêÜÈô¢„ÅÆÂü∫Êú¨Âú∞Âõ≥„ÄÇÊ®ôÈ´ò„ÄÅÂú∞ÂΩ¢„ÄÅÂúüÂú∞Âà©Áî®„Å™„Å©', category: 'terrain', icon: 'üó∫Ô∏è', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c0g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'gsi_time', name: 'Âú∞ÁêÜÈô¢ÊôÇÁ≥ªÂàó', desc: 'ÈÅéÂéª„Åã„ÇâÁèæÂú®„Åæ„Åß„ÅÆÂú∞Âõ≥„ÇíÊôÇÁ≥ªÂàó„ÅßÊØîËºÉ', category: 'terrain', icon: '‚è≥', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&ls=gsi-compare-photo&lcd=gsi-compare-photo&vs=c0j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'gsi_flood', name: 'Ê≤ªÊ∞¥Âú∞ÂΩ¢ÂàÜÈ°ûÂõ≥', desc: 'Ê≤≥Â∑ùÂë®Ëæ∫„ÅÆÂú∞ÂΩ¢ÁâπÊÄß„Å®Ê¥™Ê∞¥„É™„Çπ„ÇØ„ÇíÊääÊè°', category: 'terrain', icon: 'üñºÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=lcmfc2%2C0.8%7Chillshademap&blend=01&disp=111&lcd=hillshademap&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'google_maps', name: 'Google„Éû„ÉÉ„Éó', desc: '„Çπ„Éà„É™„Éº„Éà„Éì„É•„Éº„ÇÑÁµåË∑ØÊ§úÁ¥¢„ÇÇÂèØËÉΩ', category: 'terrain', icon: 'üìç', noCoords: false, url: (lat, lon) => `https://maps.google.co.jp/maps?q=${lat},${lon}` }, { id: 'google_earth', name: 'Google Earth', desc: '3DÂú∞ÂΩ¢„Å®Ë°õÊòüÁîªÂÉè„ÅßÂú∞Ë°®„ÇíË©≥Á¥∞„Å´Á¢∫Ë™ç', category: 'terrain', icon: 'üåç', noCoords: false, url: (lat, lon, zoom) => `https://earth.google.com/web/@${lat},${lon},0a,${Math.round(300000*Math.pow(0.5,(parseInt(zoom,10)-1)/3))}d,0y,0h` }, { id: 'konjaku', name: '‰ªäÊòî„Éû„ÉÉ„Éó', desc: 'ÊòéÊ≤ª„Åã„ÇâÁèæ‰ª£„Åæ„Åß„ÅÆÂú∞ÂΩ¢Âõ≥„Çí‰∏¶„Åπ„Å¶Ë°®Á§∫', category: 'terrain', icon: 'üìú', noCoords: false, url: (lat, lon, zoom) => `https://ktgis.net/kjmapw/kjmapw.html?lat=${lat}&lng=${lon}&zoom=${zoom}&dataset=&age=3&screen=2&scr1tile=k_cj4&scr2tile=k_cj4&scr3tile=k_cj4&mapOpacity=10&overGSItile=no&altitudeOpacity=2` }, { id: 'gsi_photos', name: 'Âú∞Âõ≥„ÉªÁ©∫‰∏≠ÂÜôÁúüÈñ≤Ë¶ß', desc: 'ÈÅéÂéª„ÅÆÁ©∫‰∏≠ÂÜôÁúü„ÇíÈñ≤Ë¶ß', category: 'terrain', icon: 'üì∑', noCoords: false, url: (lat, lon, zoom) => `https://service.gsi.go.jp/map-photos/app/map?search=photo#${zoom}/${lat}/${lon}` }, { id: 'geonavi', name: 'Âú∞Ë≥™Âõ≥Navi', desc: 'Êó•Êú¨ÂÖ®ÂõΩ„ÅÆÂú∞Ë≥™ÊÉÖÂ†±„ÇíË©≥Á¥∞„Å´Ë°®Á§∫', category: 'geology', icon: '‚õèÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://gbank.gsj.jp/geonavi/geonavi.php#${zoom},${lat},${lon}` }, { id: 'gsi_landslide', name: 'Âú∞„Åô„Åπ„ÇäÂú∞ÂΩ¢ÂàÜÂ∏ÉÂõ≥', desc: 'ÂõΩÂúüÂú∞ÁêÜÈô¢„ÅåÊèê‰æõ„Åô„ÇãÂú∞„Åô„Åπ„ÇäÂú∞ÂΩ¢„ÅÆÂàÜÂ∏ÉÂõ≥', category: 'geology', icon: '‚õ∞Ô∏è', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=std%7Clandslide%2C0.75&blend=0&disp=11&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'qchizu_pond', name: 'Ëæ≤Ê•≠Áî®„Åü„ÇÅÊ±†„Éû„ÉÉ„Éó', desc: 'ÂÖ®ÂõΩ„ÅÆËæ≤Ê•≠Áî®„Åü„ÇÅÊ±†„ÅÆ‰ΩçÁΩÆ„ÇíË°®Á§∫ÔºàQÂú∞Âõ≥Ôºâ', category: 'geology', icon: 'üíß', noCoords: false, url: (lat, lon, zoom) => `https://maps.qchizu.xyz/#${zoom}/${lat}/${lon}/&base=pale&ls=pale%7Cmaff-pond20200925-6%7Cmaff-pond20200925-5%7Cmaff-pond20200925-4%7Cmaff-pond20200925-1&disp=11111&lcd=maff-pond20200925-1&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'kunijiban', name: 'ÂõΩÂúüÂú∞Áõ§ÊÉÖÂ†± KuniJiban', desc: '„Éú„Éº„É™„É≥„Ç∞„Éá„Éº„Çø„Å™„Å©Âú∞Áõ§ÊÉÖÂ†±„ÇíÊ§úÁ¥¢', category: 'geology', icon: 'üìä', noCoords: true, url: () => `https://www.kunijiban.pwri.go.jp/viewer/` }, { id: 'ngic', name: 'ÂõΩÂúüÂú∞Áõ§ÊÉÖÂ†±„Çª„É≥„Çø„Éº', desc: 'ÂÖ®ÂõΩ„ÅÆÂú∞Áõ§ÊÉÖÂ†±„Éá„Éº„Çø„Éô„Éº„Çπ', category: 'geology', icon: 'üìà', noCoords: true, url: () => `https://publicweb.ngic.or.jp/viewer/` }, { id: 'geo_station', name: '„Ç∏„Ç™„Éª„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥', desc: 'Âú∞Ë≥™„ÉªÂú∞Áõ§ÊÉÖÂ†±„ÅÆÁµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„ÄÇÈñã„ÅÑ„ÅüÂæå„Å´‰ΩçÁΩÆ„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ', category: 'geology', icon: 'üß≠', noCoords: true, url: () => `https://www.geo-stn.bosai.go.jp/mapping_page.html` }, { id: 'gsj_activefault', name: 'Ê¥ªÊñ≠Â±§„Éá„Éº„Çø„Éô„Éº„Çπ', desc: 'Áî£Ê•≠ÊäÄË°ìÁ∑èÂêàÁ†îÁ©∂ÊâÄ„ÅåÊèê‰æõ„Åô„ÇãÊ¥ªÊñ≠Â±§„ÅÆÊÉÖÂ†±„ÄÇÈñã„ÅÑ„ÅüÂæå„Å´‰ΩçÁΩÆ„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ', category: 'geology', icon: '„Ä∞Ô∏è', noCoords: true, url: () => `https://gbank.gsj.jp/activefault/cgi/tyousati` }, { id: 'tokyo_jiban', name: 'Êù±‰∫¨„ÅÆÂú∞Áõ§ÔºàGISÔºâ', desc: 'Êù±‰∫¨ÈÉΩÂÜÖ„ÅÆË©≥Á¥∞„Å™Âú∞Áõ§„Éá„Éº„Çø„ÄÇÈñã„ÅÑ„ÅüÂæå„Å´‰ΩçÁΩÆ„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ', category: 'geology', icon: 'üè¢', noCoords: true, url: () => `https://doboku.metro.tokyo.lg.jp/start/03-jyouhou/geo-web/geo-webmap.aspx` }, { id: 'hazard_map', name: 'Èáç„Å≠„Çã„Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„Éó', desc: 'Ê¥™Ê∞¥„ÄÅÂúüÁ†ÇÁÅΩÂÆ≥„ÄÅÊ¥•Ê≥¢„Å™„Å©„ÅÆÂç±Èô∫Âå∫Âüü„ÇíË°®Á§∫', category: 'disaster', icon: 'üö®', noCoords: false, url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=tameike_raster%2C0.75%7Cflood_list_l2%2C0.75%7Cdisaster1&disp=110&vs=c1j0l0u0` }, { id: 'hazard_flood_topo', name: '„Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„ÉóÔºàÊ≤ªÊ∞¥Âú∞ÂΩ¢ÂàÜÈ°ûÂõ≥Ôºâ', desc: 'Ê≤ªÊ∞¥Âú∞ÂΩ¢ÂàÜÈ°ûÂõ≥„Å®„Éè„Ç∂„Éº„ÉâÊÉÖÂ†±„ÅÆÈáç„Å≠Âêà„Çè„Åõ', category: 'disaster', icon: 'üö´', noCoords: false, url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=hillshademap%7CLCMFC02&disp=11&vs=c1j0l0u0t0h0z0` }, { id: 'river_bousai', name: 'Â∑ù„ÅÆÈò≤ÁÅΩÊÉÖÂ†±', desc: '„É™„Ç¢„É´„Çø„Ç§„É†„ÅÆÊ≤≥Â∑ùÊ∞¥‰Ωç„Å®Èõ®ÈáèÊÉÖÂ†±', category: 'disaster', icon: 'üíß', noCoords: false, url: (lat, lon, zoom) => { let s=4; if(zoom>=18)s=3; if(zoom<=15)s=5; if(zoom<=13)s=6; return `https://www.river.go.jp/kawabou/pc/ov?zm=${zoom}&fld=0&clat=${lat}&clon=${lon}&mapType=0&viewGrpStg=0&viewRd=1&viewRW=1&viewRiver=1&viewPoint=1`;} }, { id: 'jma_warnings', name: 'Ê∞óË±°Ë≠¶Â†±„ÉªÊ≥®ÊÑèÂ†±', desc: 'Ê∞óË±°Â∫Å„ÅåÁô∫Ë°®„Åô„ÇãË≠¶Â†±„ÉªÊ≥®ÊÑèÂ†±„ÇíÂú∞Âõ≥„ÅßÁ¢∫Ë™ç', category: 'disaster', icon: 'üì¢', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/map.html#${zoom}/${lat}/${lon}/&elem=all&contents=warning` }, { id: 'kikikuru', name: '„Ç≠„Ç≠„ÇØ„É´ÔºàÂç±Èô∫Â∫¶ÂàÜÂ∏ÉÔºâ', desc: 'ÂúüÁ†ÇÁÅΩÂÆ≥„ÉªÊµ∏Ê∞¥„ÉªÊ¥™Ê∞¥„ÅÆÂç±Èô∫Â∫¶„Çí„É™„Ç¢„É´„Çø„Ç§„É†Ë°®Á§∫', category: 'weather', icon: '‚õàÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/risk/#zoom:${zoom}/lat:${lat}/lon:${lon}/colordepth:deep/elements:land` }, { id: 'jma_nowcast', name: 'È´òËß£ÂÉèÂ∫¶ÈôçÊ∞¥„Éä„Ç¶„Ç≠„É£„Çπ„Éà', desc: 'Ê∞óË±°Â∫Å„ÅåÊèê‰æõ„Åô„Çã„É™„Ç¢„É´„Çø„Ç§„É†„ÅÆÈôçÊ∞¥‰∫àÂ†±', category: 'weather', icon: 'üåßÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/nowc/#lat:${lat}/lon:${lon}/zoom:${zoom}/colordepth:normal/elements:hrpns&slmcs&slmcs_fcst` }, { id: 'windy', name: 'Windy', desc: 'È¢®„ÄÅÊ≥¢„ÄÅÊ∞óÊ∏©„Å™„Å©„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Á§∫„Åô„ÇãÊ∞óË±°‰∫àÂ†±„Çµ„Ç§„Éà', category: 'weather', icon: 'üí®', noCoords: false, url: (lat, lon, zoom) => `https://www.windy.com/?${lat},${lon},${zoom}` }, { id: 'kijunten', name: 'Âü∫Ê∫ñÁÇπÈñ≤Ë¶ß„Çµ„Éº„Éì„Çπ', desc: '‰∏âËßíÁÇπ„ÉªÊ∞¥Ê∫ñÁÇπ„Å™„Å©„ÅÆÂü∫Ê∫ñÁÇπÊÉÖÂ†±', category: 'survey', icon: 'üìè', noCoords: false, url: (lat, lon, zoom) => `https://service.gsi.go.jp/kijunten/app/map/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c1z0f0` }, { id: 'suimon_suisitsu', name: 'Ê∞¥ÊñáÊ∞¥Ë≥™„Éá„Éº„Çø„Éô„Éº„Çπ', desc: 'Ê≤≥Â∑ù„ÅÆÊ∞¥‰Ωç„ÉªÊµÅÈáè„ÉªÊ∞¥Ë≥™„Éá„Éº„Çø', category: 'survey', icon: 'üî¨', noCoords: false, url: (lat, lon, zoom) => { let s=4; if(zoom>=18)s=3; if(zoom<=15)s=5; if(zoom<=13)s=6; return `http://www1.river.go.jp/cgi-bin/SelectMap.do?cntX=${lon}&cntY=${lat}&scaleCd=${s}`;} }, { id: 'qchizu_moj', name: 'Ê≥ïÂãôÂ±ÄÂú∞Âõ≥', desc: 'Ê≥ïÂãôÂ±Ä„ÅÆÂú∞Âõ≥„Éá„Éº„Çø„ÇíË°®Á§∫ÔºàQÂú∞Âõ≥Ôºâ', category: 'survey', icon: '‚öñÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://maps.qchizu.xyz/#${zoom}/${lat}/${lon}/&base=pale&base_grayscale=1&ls=pale%7C60_moj_chiban_2022_01&disp=11&vs=c1g1j0h0k0l0u0t0z0r0s0m0f0&d=m` }, { id: 'eadas', name: 'Áí∞Â¢É„Ç¢„Çª„Çπ„Éá„Éº„Çø„Éô„Éº„Çπ', desc: 'Áí∞Â¢ÉÁúÅ„ÅåÊèê‰æõ„Åô„ÇãÁí∞Â¢É„Ç¢„Çª„Çπ„É°„É≥„Éà„Éá„Éº„Çø„Éô„Éº„Çπ', category: 'survey', icon: 'üåø', noCoords: true, url: () => 'https://eadas.env.go.jp/eiadb/ebidbs/' }, { id: 'topo_profile', name: 'WebÂú∞ÂΩ¢Êñ≠Èù¢„É°„Éº„Ç´„Éº', desc: '2ÁÇπÈñì„ÅÆÂú∞ÂΩ¢Êñ≠Èù¢Âõ≥„ÇíËá™Âãï‰ΩúÊàê„ÄÇÈñã„ÅÑ„ÅüÂæå„Å´‰ΩçÁΩÆ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', category: 'survey', icon: '„ÄΩÔ∏è', noCoords: true, url: () => `https://ktgis.net/service/topoprofile/` }, { id: 'web_contour', name: 'WebÁ≠âÈ´òÁ∑ö„É°„Éº„Ç´„Éº', desc: 'ÊåáÂÆöÁØÑÂõ≤„ÅÆÁ≠âÈ´òÁ∑öÂõ≥„Çí‰ΩúÊàê„ÄÇÈñã„ÅÑ„ÅüÂæå„Å´‰ΩçÁΩÆ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', category: 'survey', icon: 'üèîÔ∏è', noCoords: true, url: () => `https://ktgis.net/service/webcontour/index.html` }, { id: 'yahoo_map', name: 'YahooÂú∞Âõ≥', desc: 'Èõ®Èõ≤„É¨„Éº„ÉÄ„Éº„ÇÑÊ∑∑ÈõëÊÉÖÂ†±„ÇÇË°®Á§∫ÂèØËÉΩ', category: 'other', icon: '‚òÅÔ∏è', noCoords: false, url: (lat, lon, zoom) => `https://map.yahoo.co.jp/?lat=${lat}&lon=${lon}&zoom=${zoom}&maptype=satellite` }, { id: 'mapion', name: 'MapionÔºà„Éû„ÉÉ„Éó„Ç≥„Éº„ÉâÔºâ', desc: '„Ç´„Éº„Éä„ÉìÁî®„ÅÆ„Éû„ÉÉ„Éó„Ç≥„Éº„Éâ„ÇíÂèñÂæó„ÄÇÂè≥„ÇØ„É™„ÉÉ„ÇØ‚ÜíÂú∞Âõ≥URL„Åß„Éû„ÉÉ„Éó„Ç≥„Éº„Éâ„ÇíË°®Á§∫', category: 'other', icon: 'üìç', noCoords: false, url: (lat, lon, zoom) => `https://www.mapion.co.jp/m2/${lat},${lon},${zoom}` }, { id: 'itsmo_navi', name: '„ÅÑ„Å§„ÇÇNAVI', desc: '„Çº„É≥„É™„É≥„Éá„Éº„Çø„Ç≥„É†„ÅåÊèê‰æõ„Åô„ÇãË©≥Á¥∞„Å™Âú∞Âõ≥', category: 'other', icon: 'üöó', noCoords: false, url: (lat, lon, zoom) => { const tokyoCoords = convertWgs84ToTokyo(lat, lon);return `https://www.its-mo.com/maps/?lat=${tokyoCoords.lat}&lon=${tokyoCoords.lon}&z=${zoom}`; } }, { id: 'qchizu_bridge', name: 'Ê©ãÊ¢Å„Éû„ÉÉ„Éó', desc: 'ÂÖ®ÂõΩ„ÅÆÊ©ãÊ¢Å„ÅÆ‰ΩçÁΩÆ„Å®ÊÉÖÂ†±„ÇíË°®Á§∫ÔºàQÂú∞Âõ≥Ôºâ', category: 'disaster', icon: 'üåâ', noCoords: false, url: (lat, lon, zoom) => `https://maps.qchizu.xyz/#${zoom}/${lat}/${lon}/&base=std&ls=std%7C04_thematic_55_mlit_road_structures_bridge_2024&disp=11&vs=c1g1j0h0k0l0u0t0z0r0s0m0f2&d=m` }, { id: 'qchizu_footbridge', name: 'Ê≠©ÈÅìÊ©ã„Éû„ÉÉ„Éó', desc: 'ÂÖ®ÂõΩ„ÅÆÊ≠©ÈÅìÊ©ã„ÅÆ‰ΩçÁΩÆ„Å®ÊÉÖÂ†±„ÇíË°®Á§∫ÔºàQÂú∞Âõ≥Ôºâ', category: 'disaster', icon: 'üö∂', noCoords: false, url: (lat, lon, zoom) => `https://maps.qchizu.xyz/#${zoom}/${lat}/${lon}/&base=std&ls=std%7C04_thematic_55_mlit_road_structures_footbridge_2024&disp=11&lcd=04_thematic_55_mlit_road_structures_footbridge_2024&vs=c1g1j0h0k0l0u0t0z0r0s0m0f2&d=m` }, { id: 'chika_map', name: 'Âú∞‰æ°„Éû„ÉÉ„Éó', desc: 'ÂÖ¨Á§∫Âú∞‰æ°„ÉªÂü∫Ê∫ñÂú∞‰æ°„ÇíÂú∞Âõ≥‰∏ä„Å´Ë°®Á§∫', category: 'other', icon: 'üíµ', noCoords: false, url: (lat, lon) => `https://www.chikamap.jp/chikamap/Map?mid=220&mps=2500&mpx=${parseFloat(lon)+0.002365}&mpy=${parseFloat(lat)-0.00328}&mtl=47,37,77,27,67,57&mcl=3,30,30,30;2,20,312,312;7,70,310,310;1,10,312,312;1,10,310,310;5,50,50,50;4,40,40,40&gprj=1&flgInit=1&vpc=0` },
{ id: 'gmap_search_hospital', name: 'ÊïëÊÄ•ÊåáÂÆöÁóÖÈô¢', desc: 'Âë®Ëæ∫„ÅÆÊïëÊÄ•ÊåáÂÆöÁóÖÈô¢„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'üè•', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('ÊïëÊÄ•ÊåáÂÆöÁóÖÈô¢')}/@${lat},${lon},${zoom}z` },
{ id: 'gmap_search_police', name: 'Ë≠¶ÂØüÁΩ≤', desc: 'Âë®Ëæ∫„ÅÆË≠¶ÂØüÁΩ≤„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'üöì', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('Ë≠¶ÂØüÁΩ≤')}/@${lat},${lon},${zoom}z` },
{ id: 'gmap_search_fire', name: 'Ê∂àÈò≤ÁΩ≤', desc: 'Âë®Ëæ∫„ÅÆÊ∂àÈò≤ÁΩ≤„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'üöí', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('Ê∂àÈò≤ÁΩ≤')}/@${lat},${lon},${zoom}z` },
{ id: 'gmap_search_cityhall', name: 'ÂΩπÊâÄ', desc: 'Âë®Ëæ∫„ÅÆÂ∏ÇÂΩπÊâÄ„ÉªÂå∫ÂΩπÊâÄ„ÉªÁî∫ÊùëÂΩπÂ†¥„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'üè¢', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('Â∏ÇÂΩπÊâÄ OR Âå∫ÂΩπÊâÄ OR Áî∫ÂΩπÂ†¥ OR ÊùëÂΩπÂ†¥')}/@${lat},${lon},${zoom}z` },
{ id: 'gmap_search_shelter', name: 'ÈÅøÈõ£ÊâÄ', desc: 'Âë®Ëæ∫„ÅÆÊåáÂÆöÈÅøÈõ£ÊâÄ„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'ÈÅø', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('ÊåáÂÆöÈÅøÈõ£ÊâÄ')}/@${lat},${lon},${zoom}z` },
{ id: 'gmap_search_kankatsusho', name: 'Âä¥ÂÉçÂü∫Ê∫ñÁõ£Áù£ÁΩ≤', desc: 'Âë®Ëæ∫„ÅÆÂä¥ÂÉçÂü∫Ê∫ñÁõ£Áù£ÁΩ≤„ÇíÊ§úÁ¥¢', category: 'liaison', icon: 'üè¢', noCoords: false, url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent('Âä¥ÂÉçÂü∫Ê∫ñÁõ£Áù£ÁΩ≤')}/@${lat},${lon},${zoom}z` }
];

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£„ÅÆDOMÂèÇÁÖß„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
const $lat = document.getElementById('latitude'), $lon = document.getElementById('longitude'), $zoom = document.getElementById('zoomLevel'), $zoomDisplay = document.getElementById('zoomLevelDisplay'), $container = document.getElementById('map-categories-container'), $notification = document.getElementById('notification'), $historyPopup = document.getElementById('historyPopup'), $historyList = document.getElementById('historyList'), $bookmarkPopup = document.getElementById('bookmarkPopup'), $bookmarkList = document.getElementById('bookmarkList'), $addressInput = document.getElementById('addressInput'), $autocompleteList = document.getElementById('autocompleteList'), $coordFormatToggle = document.getElementById('coord-format-toggle'), $areaDisplay = document.getElementById('area-display'), $mainMapContainer = document.getElementById('mainMapContainer');
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

const PROJECTS_KEY = 'geoLinkNaviProjects';
let projectsData = {};
let activeProjectId = null;
const LEGACY_KEYS = ['coordinateBookmarks', 'myCustomLinks', 'favoriteSets', 'geoLinkNaviSettings', 'geoLinkNaviTabOrder', 'coordinateHistory'];
const DATA_KEYS = ['coordinateBookmarks', 'coordinateHistory', 'myCustomLinks', 'favoriteSets', 'geoLinkNaviSettings', 'geoLinkNaviTabOrder'];

const defaultProjectData = {
    coordinateBookmarks: [],
    coordinateHistory: [],
    myCustomLinks: [],
    favoriteSets: {},
    geoLinkNaviSettings: { 
        theme: 'light', 
        defaultZoom: 16, 
        coordFormat: 'decimal', 
        historySize: 100, 
        defaultLayer: 'gsi_std',
        defaultLayerRight: 'gsi_seamlessphoto',
        panelState: 'pinned',
        panelWidth: 500, 
        hiddenMapIds: [],
        categoryOrder: ['terrain', 'geology', 'weather', 'disaster', 'survey', 'liaison', 'other', 'mylink'],
        categoryNameOverrides: {},
        mapCategoryOverrides: {},
        mapOrderInCategory: {},
        unpinnedPanelWidths: {
            'map-links': 500,
            'history': 1200,
            'bookmarks': 1300
        },
        crosshairEnabled: false,
        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„ÅÆ„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åô„ÇãÂ†¥ÊâÄ„ÇíËøΩÂä† ‚ñº‚ñº‚ñº
        emergencySearches: []
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
    },
    geoLinkNaviTabOrder: ['map-links', 'history', 'bookmarks']
};


let MAX_HISTORY = 100;
const BOOKMARK_KEY = 'coordinateBookmarks', MYLINK_KEY = 'myCustomLinks', FAVORITE_SETS_KEY = 'favoriteSets', SETTINGS_KEY = 'geoLinkNaviSettings', TAB_ORDER_KEY = 'geoLinkNaviTabOrder';
// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë2ÁîªÈù¢Ë°®Á§∫Áî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíËøΩÂä†„Åó„ÄÅÊóßÂ§âÊï∞„Å®„ÅÆ‰∫íÊèõÊÄß„ÇíÁ∂≠ÊåÅ ‚ñº‚ñº‚ñº
let mapLeft = null, mapRight = null, markerLeft = null, markerRight = null, isDualView = false, isSyncing = false;
// Êó¢Â≠ò„Ç≥„Éº„Éâ„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅosmMap„Å®osmMarker„ÇímapLeft„Å®markerLeft„ÅÆÂà•Âêç„Å®„Åó„Å¶Á∂≠ÊåÅ
let osmMap, osmMarker; 
let autocompleteTimer = null, currentAutocompleteResults = [], selectedAutocompleteIndex = -1, isDMSFormat = false, currentLatLon = { lat: 35.72985474, lon: 139.77110828 };
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
let navigationHistory = [], historyIndex = -1, MAX_NAV_HISTORY = 100;
let currentCoordsRequestId = 0;
let currentAbortController = null;
let profileChartInstance = null;
let lastProfileData = null;
let rolloverMarker = null;
let isFirstMapLoad = true;
// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£„ÅÆÂ§âÊï∞„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
// let googleMapType = 'k';
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

let historyLayer = null, bookmarkLayer = null; 
let isHistoryVisibleOnMap = false;
let isBookmarksVisibleOnMap = false;

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëCSV„Éó„É≠„ÉÉ„ÉàÁî®„É¨„Ç§„É§„Éº„Å®Â∑°Âõû„Éá„Éº„ÇøÁî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ‚ñº‚ñº‚ñº
let csvPlotLayer = null;
let csvNavigatorData = {
    points: [],
    currentIndex: -1,
    fileName: ''
};
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑öÁî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ‚ñº‚ñº‚ñº
let isCrosshairEnabled = false;
let $crosshairV, $crosshairH;
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤


let startIcon, endIcon;

const defaultSettings = { 
    theme: 'light', 
    defaultZoom: 16, 
    coordFormat: 'decimal', 
    historySize: 100, 
    defaultLayer: 'gsi_std',
    defaultLayerRight: 'gsi_seamlessphoto',
    panelState: 'closed', 
    panelWidth: 500, 
    hiddenMapIds: [],
    categoryOrder: ['terrain', 'geology', 'weather', 'disaster', 'survey', 'liaison', 'other', 'mylink'],
    categoryNameOverrides: {},
    mapCategoryOverrides: {},
    mapOrderInCategory: {},
    unpinnedPanelWidths: {
        'map-links': 500,
        'history': 1200,
        'bookmarks': 1300
    },
    crosshairEnabled: false,
    // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„ÅÆ„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åô„ÇãÂ†¥ÊâÄ„ÇíËøΩÂä† ‚ñº‚ñº‚ñº
    emergencySearches: []
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
};
let currentSettings = {};

let historySortState = { column: 'timestamp', order: 'desc' };
const $historyTableBody = document.getElementById('historyTableBody');
let bookmarkSortState = { column: 'name', order: 'asc' };
const $bookmarkTableBody = document.getElementById('bookmarkTableBody');

const coordinateSystems = [
  {num:1, lat0:33, lon0:129.5, epsg:6669}, {num:2, lat0:33, lon0:131, epsg:6670},
  {num:3, lat0:36, lon0:132.1666667, epsg:6671}, {num:4, lat0:33, lon0:133.5, epsg:6672},
  {num:5, lat0:36, lon0:134.3333333, epsg:6673}, {num:6, lat0:36, lon0:136, epsg:6674},
  {num:7, lat0:36, lon0:137.1666667, epsg:6675}, {num:8, lat0:36, lon0:138.5, epsg:6676},
  {num:9, lat0:36, lon0:139.8333333, epsg:6677}, {num:10, lat0:40, lon0:140.8333333, epsg:6678},
  {num:11, lat0:44, lon0:140.25, epsg:6679}, {num:12, lat0:44, lon0:142.25, epsg:6680},
  {num:13, lat0:44, lon0:144.25, epsg:6681}, {num:14, lat0:26, lon0:142, epsg:6682},
  {num:15, lat0:26, lon0:127.5, epsg:6683}, {num:16, lat0:26, lon0:124, epsg:6684},
  {num:17, lat0:26, lon0:131, epsg:6685}, {num:18, lat0:20, lon0:136, epsg:6686},
  {num:19, lat0:26, lon0:154, epsg:6687}
];
const prefectureToSystem = {
  "ÂåóÊµ∑ÈÅì":[11,12,13],"ÈùíÊ£ÆÁúå":[10],"Â≤©ÊâãÁúå":[10],"ÂÆÆÂüéÁúå":[10],"ÁßãÁî∞Áúå":[10],"Â±±ÂΩ¢Áúå":[10],
  "Á¶èÂ≥∂Áúå":[9],"Ëå®ÂüéÁúå":[9],"Ê†ÉÊú®Áúå":[9],"Áæ§È¶¨Áúå":[9],"ÂüºÁéâÁúå":[9],"ÂçÉËëâÁúå":[9],"Êù±‰∫¨ÈÉΩ":[9,14,18,19],
  "Á•ûÂ•àÂ∑ùÁúå":[9],"Êñ∞ÊΩüÁúå":[8],"ÂØåÂ±±Áúå":[7],"Áü≥Â∑ùÁúå":[7],"Á¶è‰∫ïÁúå":[6],"Â±±Ê¢®Áúå":[8],"Èï∑ÈáéÁúå":[8],
  "Â≤êÈòúÁúå":[7],"ÈùôÂ≤°Áúå":[8],"ÊÑõÁü•Áúå":[7],"‰∏âÈáçÁúå":[6],"ÊªãË≥ÄÁúå":[6],"‰∫¨ÈÉΩÂ∫ú":[6],"Â§ßÈò™Â∫ú":[6],
  "ÂÖµÂ∫´Áúå":[5],"Â•àËâØÁúå":[6],"ÂíåÊ≠åÂ±±Áúå":[6],"È≥•ÂèñÁúå":[5],"Â≥∂Ê†πÁúå":[3],"Â≤°Â±±Áúå":[5],"Â∫ÉÂ≥∂Áúå":[3],
  "Â±±Âè£Áúå":[3],"Âæ≥Â≥∂Áúå":[4],"È¶ôÂ∑ùÁúå":[4],"ÊÑõÂ™õÁúå":[4],"È´òÁü•Áúå":[4],"Á¶èÂ≤°Áúå":[2],"‰ΩêË≥ÄÁúå":[2],
  "Èï∑Â¥éÁúå":[1],"ÁÜäÊú¨Áúå":[2],"Â§ßÂàÜÁúå":[2],"ÂÆÆÂ¥éÁúå":[2],"ÈπøÂÖêÂ≥∂Áúå":[1,2],"Ê≤ñÁ∏ÑÁúå":[15,16,17]
};
const PREFECTURE_ORDER = [
  "ÂåóÊµ∑ÈÅì", "ÈùíÊ£ÆÁúå", "Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå", "Á¶èÂ≥∂Áúå",
  "Ëå®ÂüéÁúå", "Ê†ÉÊú®Áúå", "Áæ§È¶¨Áúå", "ÂüºÁéâÁúå", "ÂçÉËëâÁúå", "Êù±‰∫¨ÈÉΩ", "Á•ûÂ•àÂ∑ùÁúå",
  "Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Á¶è‰∫ïÁúå", "Â±±Ê¢®Áúå", "Èï∑ÈáéÁúå", "Â≤êÈòúÁúå",
  "ÈùôÂ≤°Áúå", "ÊÑõÁü•Áúå", "‰∏âÈáçÁúå", "ÊªãË≥ÄÁúå", "‰∫¨ÈÉΩÂ∫ú", "Â§ßÈò™Â∫ú", "ÂÖµÂ∫´Áúå",
  "Â•àËâØÁúå", "ÂíåÊ≠åÂ±±Áúå", "È≥•ÂèñÁúå", "Â≥∂Ê†πÁúå", "Â≤°Â±±Áúå", "Â∫ÉÂ≥∂Áúå", "Â±±Âè£Áúå",
  "Âæ≥Â≥∂Áúå", "È¶ôÂ∑ùÁúå", "ÊÑõÂ™õÁúå", "È´òÁü•Áúå", "Á¶èÂ≤°Áúå", "‰ΩêË≥ÄÁúå", "Èï∑Â¥éÁúå",
  "ÁÜäÊú¨Áúå", "Â§ßÂàÜÁúå", "ÂÆÆÂ¥éÁúå", "ÈπøÂÖêÂ≥∂Áúå", "Ê≤ñÁ∏ÑÁúå"
];

function loadProjects() {
    try {
        const storedProjects = JSON.parse(localStorage.getItem(PROJECTS_KEY));
        if (storedProjects && storedProjects.projects && Object.keys(storedProjects.projects).length > 0) {
            projectsData = storedProjects;
            activeProjectId = storedProjects.activeProjectId;
            if (!projectsData.projects[activeProjectId]) {
                activeProjectId = Object.keys(projectsData.projects)[0];
                projectsData.activeProjectId = activeProjectId;
            }
        } else {
            const newId = `proj_${Date.now()}`;
            projectsData = {
                activeProjectId: newId,
                projects: {
                    [newId]: {
                        name: '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                        data: JSON.parse(JSON.stringify(defaultProjectData))
                    }
                }
            };
            activeProjectId = newId;
            saveProjects();
        }
    } catch (e) {
        console.error("„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", e);
        const newId = `proj_${Date.now()}`;
        projectsData = {
            activeProjectId: newId,
            projects: {
                [newId]: { name: '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„Ç∏„Çß„ÇØ„Éà', data: JSON.parse(JSON.stringify(defaultProjectData)) }
            }
        };
        activeProjectId = newId;
        saveProjects();
    }
}

function saveProjects() {
    try {
        const dataStr = JSON.stringify(projectsData);
        // UTF-16ÊñáÂ≠ó„ÇíËÄÉÊÖÆ„Åó„Å¶Ê≠£Á¢∫„Å™„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó
        const sizeInBytes = new Blob([dataStr]).size;
        const sizeInMB = sizeInBytes / (1024 * 1024);

        // 4.5MB„ÇíË∂Ö„Åà„Åü„ÇâË≠¶ÂëäÔºà‰∏äÈôê„ÅØ5MB„ÅåÂ§ö„ÅÑ„Åå„ÄÅÂÆâÂÖ®„Éû„Éº„Ç∏„É≥„Çí„Å®„ÇãÔºâ
        if (sizeInMB > 4.5) {
            showNotification(
                `„Éá„Éº„ÇøÂÆπÈáè„Åå${sizeInMB.toFixed(1)}MB„Åß„Åô„ÄÇ‰∏äÈôê„Å´Ëøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂè§„ÅÑ„Éá„Éº„Çø„ÅÆÂâäÈô§„ÇÑ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                'warning',
                8000 // Ë≠¶Âëä„ÅØÂ∞ë„ÅóÈï∑„ÇÅ„Å´8ÁßíË°®Á§∫
            );
        }

        localStorage.setItem(PROJECTS_KEY, dataStr);

    } catch (e) {
        // QuotaExceededError„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´„Çà„Å£„Å¶ÂêçÂâç„ÅåËã•Âπ≤ÈÅï„ÅÜÂ†¥Âêà„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅË§áÊï∞„ÅÆÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED' || e.message.toLowerCase().includes('quota')) {
            showNotification(
                '„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÈáçË¶Å„Å™„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ',
                'error',
                10000 // „Ç®„É©„Éº„ÅØ10ÁßíË°®Á§∫
            );
            // Á∑äÊÄ•„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            emergencyBackup();
        } else {
            console.error("„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò‰∏≠„Å´‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ", e);
            showNotification("„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "error");
        }
    }
}

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Å´ËøΩÂä†„Äë‚ñº‚ñº‚ñº
/**
 * Á∑äÊÄ•ÊôÇ„Å´ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Åõ„ÇãÈñ¢Êï∞
 */
function emergencyBackup() {
    try {
        const dataStr = JSON.stringify(projectsData);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.href = url;
        a.download = `GeoLinkNavi_EMERGENCY_BACKUP_${date}.json`;
        
        document.body.appendChild(a);
        a.click();
        
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // „É¶„Éº„Ç∂„Éº„Å´ËøΩÂä†„ÅÆÊåáÁ§∫„ÇíÂá∫„Åô
        alert("„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè„Åå‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ\n\nÁèæÂú®„ÅÆÂÖ®„Éá„Éº„Çø„Çí 'GeoLinkNavi_EMERGENCY_BACKUP.json' „Å®„ÅÑ„ÅÜ„Éï„Ç°„Ç§„É´Âêç„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÁÆ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n‰ªäÂæå„Ç¢„Éó„É™„ÇíÊ≠£Â∏∏„Å´Âà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ‰∏çË¶Å„Å™Â±•Ê≠¥„ÇÑ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂâäÈô§„Åó„Å¶ÂÆπÈáè„ÇíÁ¢∫‰øù„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");

    } catch (e) {
        console.error("Á∑äÊÄ•„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
        alert("„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè„Åå‰∏äÈôê„Å´ÈÅî„Åó„Å¶„Åä„Çä„ÄÅÁ∑äÊÄ•„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„ÅÆ‰ΩúÊàê„Å´„ÇÇÂ§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function getActiveProjectData() {
    return projectsData.projects[activeProjectId]?.data || JSON.parse(JSON.stringify(defaultProjectData));
}

function getProjectData(key) {
    const data = getActiveProjectData();
    return data[key];
}

function setProjectData(key, value) {
    if (projectsData.projects[activeProjectId]) {
        projectsData.projects[activeProjectId].data[key] = value;
        saveProjects();
    }
}

function migrateOldData() {
    const needsMigration = LEGACY_KEYS.some(key => localStorage.getItem(key) !== null);
    
    if (!needsMigration || localStorage.getItem(PROJECTS_KEY) !== null) {
        return;
    }

    console.log("Âè§„ÅÑ„Éá„Éº„Çø„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂΩ¢Âºè„Å´ÁßªË°å„Åó„Åæ„Åô„ÄÇ");
    showNotification("„Éá„Éº„Çø„ÇíÊñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂΩ¢Âºè„Å´ÁßªË°å‰∏≠...", "warning");

    const migratedData = JSON.parse(JSON.stringify(defaultProjectData));
    
    LEGACY_KEYS.forEach(key => {
        const oldData = localStorage.getItem(key);
        if (oldData !== null) {
            try {
                migratedData[key] = JSON.parse(oldData);
            } catch (e) {
                console.warn(`„Ç≠„Éº "${key}" „ÅÆ„Éá„Éº„ÇøËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ`, e);
            }
        }
    });

    const newId = `proj_${Date.now()}`;
    projectsData = {
        activeProjectId: newId,
        projects: {
            [newId]: {
                name: '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                data: migratedData
            }
        }
    };
    activeProjectId = newId;
    saveProjects();

    LEGACY_KEYS.forEach(key => {
        localStorage.removeItem(key);
    });

    showNotification("„Éá„Éº„ÇøÁßªË°å„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ");
}

function switchProject(projectId) {
    if (projectId && projectsData.projects[projectId]) {
        projectsData.activeProjectId = projectId;
        saveProjects();
        location.reload();
    }
}


function loadSettings() {
    const savedSettings = getProjectData(SETTINGS_KEY) || {};
    
    currentSettings = { ...defaultSettings, ...savedSettings };

    if (savedSettings.categoryOrder && Array.isArray(savedSettings.categoryOrder)) {
        const savedOrder = savedSettings.categoryOrder;
        const defaultOrder = defaultSettings.categoryOrder;
        
        const missingCategories = defaultOrder.filter(cat => !savedOrder.includes(cat));
        
        if (missingCategories.length > 0) {
            currentSettings.categoryOrder = [...savedOrder, ...missingCategories];
        }
    }

    applySettings();
}

function applySettings() {
    document.body.classList.toggle('dark-mode', currentSettings.theme === 'dark');
    document.getElementById('modeToggle').textContent = currentSettings.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    isDMSFormat = (currentSettings.coordFormat === 'dms');
    
    const labelElement = document.getElementById('coord-format-label');
    if (labelElement) {
        labelElement.textContent = isDMSFormat ? 'Â∫¶ÂàÜÁßí' : 'ÂçÅÈÄ≤Êï∞';
    }

    updateLatLonInputs(currentLatLon.lat, currentLatLon.lon);
    MAX_HISTORY = parseInt(currentSettings.historySize, 10);
    const historyHeader = $historyPopup.querySelector('h4');
    if(historyHeader) historyHeader.textContent = `Â∫ßÊ®ôÂ±•Ê≠¥ (ÊúÄÊñ∞${MAX_HISTORY}‰ª∂)`;

    updatePanelWidth(currentSettings.panelWidth);
    
    // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑ö„ÅÆË®≠ÂÆö„ÇíÈÅ©Áî® ‚ñº‚ñº‚ñº
    isCrosshairEnabled = !!currentSettings.crosshairEnabled;
    const toggleBtn = document.getElementById('toggle-crosshair-btn');
    if (toggleBtn) {
        toggleBtn.classList.toggle('active', isCrosshairEnabled);
        toggleBtn.textContent = isCrosshairEnabled ? '‚ïã' : '‚ïã';
    }
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

    if (!location.search) {
        setZoomLevel(currentSettings.defaultZoom);
    }
}

function populateLayerSettings(selectId, currentValue) {
    const select = document.getElementById(selectId);
    if (!select) return;
    select.innerHTML = '';
    for (const key in BASE_LAYERS) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = BASE_LAYERS[key].name;
        select.appendChild(option);
    }
    select.value = currentValue;
}


function openSettingsModal() {
    document.getElementById('settings-zoom').value = currentSettings.defaultZoom;
    document.getElementById('settings-zoom-value').textContent = currentSettings.defaultZoom;
    document.getElementById('settings-panel-width').value = currentSettings.panelWidth;
    document.getElementById('settings-panel-width-value').textContent = currentSettings.panelWidth;
    
    populateLayerSettings('settings-default-layer', currentSettings.defaultLayer);
    populateLayerSettings('settings-default-layer-right', currentSettings.defaultLayerRight);

    document.getElementById('settings-theme').value = currentSettings.theme;
    document.getElementById('settings-coord-format').value = currentSettings.coordFormat;
    document.getElementById('settings-history-size').value = currentSettings.historySize;
    document.getElementById('settings-panel-state').value = currentSettings.panelState;

    const widths = currentSettings.unpinnedPanelWidths || defaultSettings.unpinnedPanelWidths;
    document.getElementById('settings-panel-width-map-links').value = widths['map-links'];
    document.getElementById('settings-panel-width-map-links-value').textContent = widths['map-links'];
    document.getElementById('settings-panel-width-history').value = widths['history'];
    document.getElementById('settings-panel-width-history-value').textContent = widths['history'];
    document.getElementById('settings-panel-width-bookmarks').value = widths['bookmarks'];
    document.getElementById('settings-panel-width-bookmarks-value').textContent = widths['bookmarks'];

    populateMapVisibilitySettings();
    populateCategoryNameSettings();
    document.getElementById('settings-modal').style.display = 'flex';
}

function closeSettingsModal() {
    document.getElementById('settings-modal').style.display = 'none';
}

function saveSettings(e) {
    e.preventDefault();
    currentSettings.defaultZoom = document.getElementById('settings-zoom').value;
    currentSettings.panelWidth = document.getElementById('settings-panel-width').value;
    currentSettings.defaultLayer = document.getElementById('settings-default-layer').value;
    currentSettings.defaultLayerRight = document.getElementById('settings-default-layer-right').value;
    currentSettings.theme = document.getElementById('settings-theme').value;
    currentSettings.coordFormat = document.getElementById('settings-coord-format').value;
    currentSettings.historySize = document.getElementById('settings-history-size').value;
    currentSettings.panelState = document.getElementById('settings-panel-state').value;

    currentSettings.unpinnedPanelWidths = {
        'map-links': document.getElementById('settings-panel-width-map-links').value,
        'history': document.getElementById('settings-panel-width-history').value,
        'bookmarks': document.getElementById('settings-panel-width-bookmarks').value
    };

    const hiddenMaps = [];
    document.querySelectorAll('#settings-map-visibility-list input[type="checkbox"]:checked').forEach(cb => {
        hiddenMaps.push(cb.dataset.mapId);
    });
    currentSettings.hiddenMapIds = hiddenMaps;

    const nameOverrides = {};
    document.querySelectorAll('#settings-category-names .category-name-item input').forEach(input => {
        const key = input.dataset.catKey;
        const defaultValue = CATEGORY_META[key].title;
        if (input.value && input.value.trim() !== defaultValue) {
            nameOverrides[key] = input.value.trim();
        }
    });
    currentSettings.categoryNameOverrides = nameOverrides;

    setProjectData(SETTINGS_KEY, currentSettings);
    applySettings();
    closeSettingsModal();
    showNotification('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
    renderMapCards();
}

function populateMapVisibilitySettings() {
    const listContainer = document.getElementById('settings-map-visibility-list');
    listContainer.innerHTML = '';
    const allMaps = getCombinedMapDefinitions();
    const mapsByCategory = allMaps.reduce((acc, map) => {
        const cat = map.category || 'mylink';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(map);
        return acc;
    }, {});

    const categoryOrder = ['terrain', 'geology', 'weather', 'disaster', 'liaison', 'survey', 'other', 'mylink'];
    const hiddenSet = new Set(currentSettings.hiddenMapIds || []);

    categoryOrder.forEach(catKey => {
        if (mapsByCategory[catKey]) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'visibility-category';
            const categoryMeta = CATEGORY_META[catKey];
            categoryDiv.innerHTML = `<h5>${categoryMeta.icon} ${categoryMeta.title}</h5>`;

            mapsByCategory[catKey].forEach(map => {
                const label = document.createElement('label');
                const isHidden = hiddenSet.has(map.id);
label.innerHTML = `
    <input type="checkbox" data-map-id="${map.id}" ${isHidden ? 'checked' : ''}>
    <span>${sanitizeForHtml(map.name)}</span>
                `;
                categoryDiv.appendChild(label);
            });
            listContainer.appendChild(categoryDiv);
        }
    });
}

function populateCategoryNameSettings() {
    const container = document.getElementById('settings-category-names');
    container.innerHTML = '';
    const categoryOrder = currentSettings.categoryOrder || defaultSettings.categoryOrder;
    const overrides = currentSettings.categoryNameOverrides || {};

    categoryOrder.forEach(catKey => {
        if (catKey === 'mylink') return;
        const meta = CATEGORY_META[catKey];
        const currentName = overrides[catKey] || meta.title;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'category-name-item';
itemDiv.innerHTML = `<label for="cat-name-${catKey}">${meta.icon} ${meta.title}</label> <input type="text" id="cat-name-${catKey}" data-cat-key="${catKey}" value="${sanitizeForHtml(currentName)}" placeholder="${sanitizeForHtml(meta.title)}">
        `;
        container.appendChild(itemDiv);
    });
}
function showNotification(message, type = 'success') { $notification.textContent = message; $notification.className = `notification ${type}`; $notification.style.display = 'block'; setTimeout(() => $notification.style.display = 'none', 3000); }

async function updateCurrentCoords(newCoords = null, skipHistorySave = false, fromNav = false) {
    if (currentAbortController) {
        currentAbortController.abort();
    }
    currentAbortController = new AbortController();
    const { signal } = currentAbortController;

    const spinners = document.querySelectorAll('.input-wrapper');
    spinners.forEach(s => s.classList.add('loading'));

    try {
        let latNum, lonNum;
        try {
            if (newCoords && typeof newCoords.lat === 'number' && typeof newCoords.lon === 'number') {
                latNum = newCoords.lat;
                lonNum = newCoords.lon;
            } else {
                latNum = isDMSFormat ? dmsToDecimal($lat.value) : parseFloat($lat.value);
                lonNum = isDMSFormat ? dmsToDecimal($lon.value) : parseFloat($lon.value);
            }
            if (isNaN(latNum) || isNaN(lonNum)) throw new Error("Invalid number");
        } catch (e) {
            console.error("Â∫ßÊ®ô„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
            spinners.forEach(s => s.classList.remove('loading'));
            return;
        }

        const zoomNum = parseInt($zoom.value, 10);
        if (latNum < -90 || latNum > 90 || lonNum < -180 || lonNum > 180) {
            spinners.forEach(s => s.classList.remove('loading'));
            return;
        }

        currentLatLon = { lat: latNum, lon: lonNum };
        initLeftMap(latNum, lonNum, zoomNum);

        if (!fromNav) {
            if (historyIndex < navigationHistory.length - 1) {
                navigationHistory = navigationHistory.slice(0, historyIndex + 1);
            }
            navigationHistory.push({ lat: latNum, lon: lonNum, zoom: zoomNum });
            if (navigationHistory.length > MAX_NAV_HISTORY) navigationHistory.shift();
            historyIndex = navigationHistory.length - 1;
        }

        const [addressInfo, elevation] = await Promise.all([
            getAddressFromCoords(latNum, lonNum, signal),
            getElevationFromCoords(latNum, lonNum, signal)
        ]);

        if (signal.aborted) {
            console.log("Âè§„ÅÑÂ∫ßÊ®ôÊõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„Éà„ÅØ„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
            return;
        }

        const popupContent = `
            <div style="font-size: 13px; line-height: 1.6;">
                <strong>ÈÉµ‰æøÁï™Âè∑:</strong> ${sanitizeForHtml(addressInfo.postcode || '---')}<br>
                <strong>‰ΩèÊâÄ:</strong> ${sanitizeForHtml(addressInfo.structured || '---')}<br>
                <strong>Á∑ØÂ∫¶:</strong> ${latNum.toFixed(6)}<br>
                <strong>ÁµåÂ∫¶:</strong> ${lonNum.toFixed(6)}<br>
                <strong>Ê®ôÈ´ò:</strong> ${elevation !== '---' ? `${elevation} m` : '---'}
            </div>
        `;
        if (markerLeft) {
            markerLeft.setPopupContent(popupContent).openPopup();
        }
        if (isDualView && markerRight) {
            markerRight.setLatLng([latNum, lonNum]);
        }

        if (!skipHistorySave) {
            await addCoordinateToHistory(latNum, lonNum, zoomNum, addressInfo, elevation);
        } else {
            showNotification('Â∫ßÊ®ô„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
        }
        
        renderHistoryOnMap();
        renderBookmarksOnMap();
        updateNavButtons();

    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error("Â∫ßÊ®ôÊÉÖÂ†±„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:", error);
            showNotification('‰ΩèÊâÄ„Åæ„Åü„ÅØÊ®ôÈ´ò„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
        }
    } finally {
        if (!signal.aborted) {
            spinners.forEach(s => s.classList.remove('loading'));
        }
    }
}


async function fetchWithRetry(url, signal, maxRetries = 3, delay = 1000) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, { signal }); //  signal„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
            if (response.status === 429) {
                console.warn(`Rate limit hit for ${url}. Retrying in ${delay * (i + 1)}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                continue;
            }
            if (response.status >= 500 && response.status < 600) {
                 console.warn(`Server error (${response.status}) for ${url}. Retrying in ${delay * (i + 1)}ms...`);
                 await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                 continue;
            }
            return response;
        } catch (error) {
            console.error(`Fetch error for ${url}:`, error);
            if (i === maxRetries - 1) {
                showNotification('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                throw error;
            }
            await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
        }
    }
    throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts.`);
}

async function initGeolocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            showNotification('‰ΩçÁΩÆÊÉÖÂ†±„Çµ„Éº„Éì„ÇπÈùûÂØæÂøú„Åß„Åô', 'error');
            return reject(new Error('Geolocation not supported'));
        }

        showNotification('ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠„Åß„Åô...');
        navigator.geolocation.getCurrentPosition(
            async position => {
                updateLatLonInputs(position.coords.latitude, position.coords.longitude);
                await updateCurrentCoords(); 
                showNotification('ÁèæÂú®Âú∞„ÇíËá™ÂãïË®≠ÂÆö„Åó„Åæ„Åó„Åü');
                resolve(position.coords);
            },
            () => {
                showNotification('ÁèæÂú®Âú∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                reject(new Error('Geolocation permission denied or failed'));
            },
            { enableHighAccuracy: true }
        );
    });
}

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
// function updateMapPreview(lat, lon, zoom) { ... }
// function togglePreview(event) { ... }
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëtoggleMainMap„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
// function toggleMainMap() { ... }
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÈñ¢Êï∞Âêç„Çí initLeftMap „Å´Â§âÊõ¥„Åó„ÄÅÂ∑¶Âú∞Âõ≥Â∞ÇÁî®„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ„Å´‰øÆÊ≠£ ‚ñº‚ñº‚ñº
function initLeftMap(lat, lon, zoom) {
    const latlng = [lat, lon];
    if (mapLeft === null) {
        // Âú∞Âõ≥„Çí #osmClickMap „Åß„ÅØ„Å™„Åè„ÄÅ#mapLeft „Ç≥„É≥„ÉÜ„Éä„Å´ÁîüÊàê„Åô„Çã
        mapLeft = L.map('mapLeft', { fullscreenControl: { title: { 'false': 'ÂÖ®ÁîªÈù¢', 'true': 'ÈÄöÂ∏∏Ë°®Á§∫' } } }).setView(latlng, zoom);

        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÊóßÂ§âÊï∞„Å®„ÅÆ‰∫íÊèõÊÄß„ÇíÁ¢∫‰øù ‚ñº‚ñº‚ñº
        osmMap = mapLeft;
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑ö„ÅÆÂàùÊúüÂåñ„Å®„Ç§„Éô„É≥„ÉàË®≠ÂÆö ‚ñº‚ñº‚ñº
        initCrosshair();
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤


        if (L.control.currentLocation) {
            L.control.currentLocation({ position: 'topleft' }).addTo(mapLeft);
        }
        L.control.scale({ imperial: false }).addTo(mapLeft);
        
        setupAnalysisTools(); // Ëß£Êûê„ÉÑ„Éº„É´„ÅØÂ∑¶Âú∞Âõ≥„Å´Á¥ê‰ªò„Åë
        const baseMaps = {};
        for(const key in BASE_LAYERS) {
            const config = BASE_LAYERS[key];
            config.layer = L.tileLayer(config.url, { maxZoom: config.maxZoom || 19, attribution: config.attribution });
            baseMaps[config.name] = config.layer;
        }
        L.control.layers(baseMaps).addTo(mapLeft);

        const defaultLayerKey = currentSettings.defaultLayer || 'gsi_std';
        BASE_LAYERS[defaultLayerKey].layer.addTo(mapLeft);
        mapLeft.setMaxZoom(BASE_LAYERS[defaultLayerKey].maxZoom);

        mapLeft.on('baselayerchange', e => {
            for (const key in BASE_LAYERS) {
                if (BASE_LAYERS[key].name === e.name) {
                    const newMaxZoom = BASE_LAYERS[key].maxZoom;
                    mapLeft.setMaxZoom(newMaxZoom);
                    if (mapLeft.getZoom() > newMaxZoom) {
                        mapLeft.setZoom(newMaxZoom);
                    }
                    break;
                }
            }
        });

        mapLeft.on('zoomend', () => {
            const newZoom = mapLeft.getZoom();
            if (newZoom !== parseInt($zoom.value, 10)) {
                setZoomLevel(newZoom);
            }
        });
        mapLeft.on('click', async e => {
            if (isMeasuring) return handleMeasureClick(e);
            if (isMeasuringArea) return handleAreaMeasureClick(e);
            updateLatLonInputs(e.latlng.lat, e.latlng.lng);
            await updateCurrentCoords();
        });
        mapLeft.on('dblclick', e => {
            if (isMeasuring) return handleMeasureDoubleClick(e);
            if (isMeasuringArea) return handleAreaMeasureDoubleClick(e);
        });
        mapLeft.on('mousemove', e => { if (isMeasuring) handleMeasureMouseMove(e); });

        const clusterOptions = {
            removeOutsideVisibleBounds: true,
            chunkedLoading: true,
            maxClusterRadius: 80,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        };

        historyLayer = L.markerClusterGroup(clusterOptions).addTo(mapLeft);
        bookmarkLayer = L.markerClusterGroup(clusterOptions).addTo(mapLeft);
        csvPlotLayer = L.markerClusterGroup(clusterOptions).addTo(mapLeft);

        markerLeft = L.marker(latlng).addTo(mapLeft)
                       .bindPopup("ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...");

        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÊóßÂ§âÊï∞„Å®„ÅÆ‰∫íÊèõÊÄß„ÇíÁ¢∫‰øù ‚ñº‚ñº‚ñº
        osmMarker = markerLeft;
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

        markerLeft.on('mousedown', (e) => {
            L.DomEvent.stopPropagation(e);
        });

        const zoomSliderOverlay = document.querySelector('.zoom-slider-overlay');
        if (zoomSliderOverlay) {
            L.DomEvent.disableClickPropagation(zoomSliderOverlay);
            L.DomEvent.disableScrollPropagation(zoomSliderOverlay);
        }
        if (typeof L.Control.Gpx === 'function') {
            new L.Control.Gpx(null, {
                async: true,
                marker_options: {
                    startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
                    endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png'
                }
            }).on('loaded', function(e) {
                mapLeft.fitBounds(e.target.getBounds());
                analysisLayer.addLayer(e.target);
            }).addTo(mapLeft);
        }
    }
    mapLeft.setView(latlng, zoom);
    if(markerLeft) markerLeft.setLatLng(latlng); // markerLeft„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
    mapLeft.invalidateSize();

    if (isFirstMapLoad) {
        isFirstMapLoad = false;
        applyInitialPanelState();
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤


function applyInitialPanelState() {
    if (window.innerWidth <= 1024) return;

const mainToggleBtnWrapper = document.getElementById('main-toggle-panel-btn-wrapper');
    
    if (currentSettings.panelState === 'open') {
        const rightPanel = document.querySelector('.right-panel');
        if (rightPanel.classList.contains('hidden')) {
            toggleRightPanel();
        }
    } else if (currentSettings.panelState === 'pinned') {
        const mainLayout = document.querySelector('.main-layout');
        if (!mainLayout.classList.contains('pinned')) {
            togglePinPanel();
        }
        if (mainToggleBtnWrapper) {
             mainToggleBtnWrapper.style.display = 'none';
        }
    }
}

async function getAddressFromCoords(lat, lon, signal) {
    try {
        const response = await fetchWithRetry(`https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&x=${lon}&y=${lat}`, signal);
        const data = await response.json();

        if (!data.response || !data.response.location || data.response.location.length === 0) {
            console.error("HeartRails API„Åã„Çâ„ÅÆ‰ΩèÊâÄÂèñÂæó„Å´Â§±Êïó:", data);
            return { full: `(‰ΩèÊâÄÂèñÂæóÂ§±Êïó)`, postcode: '---', structured: '---' };
        }

        const loc = data.response.location[0];
        
        const postcode = loc.postal ? `${loc.postal.slice(0, 3)}-${loc.postal.slice(3)}` : '---';
        const structuredAddress = `${loc.prefecture || ''}${loc.city || ''}${loc.town || ''}`;

        return {
            full: structuredAddress,
            postcode: postcode,
            structured: structuredAddress
        };
    } catch (e) {
        console.error("‰ΩèÊâÄ„ÅÆÂèñÂæó‰∏≠„Å´„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:", e);
        return { full: `(‰ΩèÊâÄÂèñÂæóÂ§±Êïó)`, postcode: '---', structured: '---' };
    }
}

async function getElevationFromCoords(lat, lon, signal) {
  try {
    const response = await fetchWithRetry(`https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon=${lon}&lat=${lat}&outtype=JSON`, signal);
    const data = await response.json();
    if (data.elevation && data.elevation !== "none") {
      return parseFloat(data.elevation).toFixed(2);
    }
    return '---';
  } catch (e) {
    console.error("Ê®ôÈ´ò„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
    return '---';
  }
}

function getBestXYForLatLng(lat, lon, prefecture) {
    if (isNaN(lat) || isNaN(lon)) return null;

    let targetSystems = [];

    if (prefecture && prefectureToSystem[prefecture]) {
        const systemNumbers = prefectureToSystem[prefecture];
        targetSystems = coordinateSystems.filter(sys => systemNumbers.includes(sys.num));
    }
    
    if (targetSystems.length === 0) {
        targetSystems = coordinateSystems;
    }

    let minDistance = Infinity;
    let bestSystem = null;

    for (const sys of targetSystems) {
        const distance = Math.sqrt(Math.pow(lat - sys.lat0, 2) + Math.pow((lon - sys.lon0) * Math.cos(lat * Math.PI / 180), 2));
        if (distance < minDistance) {
            minDistance = distance;
            bestSystem = sys;
        }
    }

    if (bestSystem) {
        try {
            const [y, x] = proj4('EPSG:4326', `EPSG:${bestSystem.epsg}`, [lon, lat]);
            return {
                x: x.toFixed(3),
                y: y.toFixed(3),
                system: bestSystem.num
            };
        } catch (e) {
            console.error("XYÂ∫ßÊ®ô„Å∏„ÅÆÂ§âÊèõ„Å´Â§±Êïó:", e);
            return null;
        }
    }
    return null;
}

async function addCoordinateToHistory(lat, lon, zoom, addressInfo, elevation) {
    let history = getProjectData('coordinateHistory') || [];
    
    const prefecture = addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/) ? addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/)[0] : null;
    const xyInfo = getBestXYForLatLng(lat, lon, prefecture);

    const newEntry = {
        lat: lat.toFixed(8),
        lon: lon.toFixed(8),
        zoom,
        timestamp: new Date().toISOString(),
        address: addressInfo.structured,
        postcode: addressInfo.postcode,
        elevation: elevation,
        xy_x: xyInfo ? xyInfo.x : '---',
        xy_y: xyInfo ? xyInfo.y : '---',
        xy_system: xyInfo ? xyInfo.system : '---'
    };

    if (history.length === 0 || (history[0].lat !== newEntry.lat || history[0].lon !== newEntry.lon)) {
        history.unshift(newEntry);
        setProjectData('coordinateHistory', history.slice(0, MAX_HISTORY));
        renderHistoryList(history);
        renderHistoryTable();
        renderHistoryOnMap();
    }
    showNotification('Â∫ßÊ®ôÂ±•Ê≠¥„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
}

async function getCoordsFromAddress(address) {
  try {
    const response = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`);
    const data = await response.json();
    if (Array.isArray(data) && data.length > 0) {
      const coordinates = data[0].geometry.coordinates;
      const lon = coordinates[0];
      const lat = coordinates[1];
      return { lat: lat, lon: lon };
    }
    return null;
  } catch (e) {
    console.error("Âú∞ÁêÜÈô¢Âú∞Âõ≥API„Åß„ÅÆÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
    return null;
  }
}

async function getAddressSuggestions(query) {
  if (query.length < 2) return [];
  try {
    const response = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(query)}`);
    const data = await response.json();
    if (Array.isArray(data)) {
      return data.slice(0, 5).map(item => ({
        display_name: item.properties.title,
        lat: item.geometry.coordinates[1],
        lon: item.geometry.coordinates[0]
      }));
    }
    return [];
  } catch (e) {
    console.error("Âú∞ÁêÜÈô¢Âú∞Âõ≥API„Åß„ÅÆÂÄôË£úÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
    return [];
  }
}
async function getCoordsFromPostalCode(postalCode) {
  try {
    const zipcloudResponse = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode.replace('-', '')}`);
    const zipcloudData = await zipcloudResponse.json();

    if (zipcloudData.status !== 200 || !zipcloudData.results) {
      console.error("zipcloud API„ÅßÈÉµ‰æøÁï™Âè∑„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü:", zipcloudData.message);
      return null;
    }

    const addressResult = zipcloudData.results[0];
    const fullAddress = `${addressResult.address1}${addressResult.address2}${addressResult.address3}`;
    
    console.log(`ÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„Äå${fullAddress}„Äç„ÇíÂèñÂæó„Åó„ÄÅÂ∫ßÊ®ô„ÇíÊ§úÁ¥¢„Åó„Åæ„Åô„ÄÇ`);
    return await getCoordsFromAddress(fullAddress);
    
  } catch (e) {
    console.error("ÈÉµ‰æøÁï™Âè∑„Åß„ÅÆÂ∫ßÊ®ôÂèñÂæóÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:", e);
    return null;
  }
}
function renderHistoryList(history) { $historyList.innerHTML = history.length === 0 ? '<p>Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>' : history.map((item, index) => `<div class="history-item" data-index="${index}"><strong>${index + 1}. ${item.address}</strong><span>Â∫ßÊ®ô: ${item.lat}¬∞N, ${item.lon}¬∞E | ${new Date(item.timestamp).toLocaleString()}</span></div>`).join(''); }

function loadCoordinateFromHistory(item) {
    updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon));
    setZoomLevel(item.zoom);
    updateCurrentCoords(item, true);
    toggleHistoryPopup(false);
    showNotification(`Â±•Ê≠¥„Äå${item.address}„Äç„ÇíÈÅ©Áî®`);
}
function toggleHistoryPopup(open = true) { if (open && $historyPopup.style.display !== 'block') { renderHistoryList(getProjectData('coordinateHistory') || []); $historyPopup.style.display = 'block'; $bookmarkPopup.style.display = 'none'; document.getElementById('csvPopup').style.display = 'none'; } else { $historyPopup.style.display = 'none'; } }
function clearHistory() { if (confirm('ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ±•Ê≠¥„ÇíÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) { setProjectData('coordinateHistory', []); renderHistoryList([]); renderHistoryTable(); renderHistoryOnMap(); showNotification('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü'); toggleHistoryPopup(false); } }
function exportHistoryToCSV() { const d = getProjectData('coordinateHistory')||[]; if(d.length>0) exportToCSV(d, 'Â∫ßÊ®ôÂ±•Ê≠¥'); else showNotification('Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); }

async function saveCurrentAsBookmark() {
    showNotification('‰ΩèÊâÄÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...');
    const [addressInfo, elevation] = await Promise.all([
        getAddressFromCoords(currentLatLon.lat, currentLatLon.lon),
        getElevationFromCoords(currentLatLon.lat, currentLatLon.lon)
    ]);
    showNotification('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    const name = prompt('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÂêç„ÇíÂÖ•Âäõ:', addressInfo.structured || '');
    if (name) {
        addBookmark(name, currentLatLon.lat, currentLatLon.lon, $zoom.value, addressInfo, elevation);
        showNotification(`„Äå${name}„Äç„Çí„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åó„Åæ„Åó„Åü`);
        renderBookmarkList();
        renderBookmarkTable();
    }
}
function addBookmark(name, lat, lon, zoom, addressInfo, elevation) {
    let b = getProjectData(BOOKMARK_KEY) || [];
    
    const prefecture = addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/) ? addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/)[0] : null;
    const xyInfo = getBestXYForLatLng(parseFloat(lat), parseFloat(lon), prefecture);

    const newBookmark = { 
        name, 
        lat: lat.toFixed(8), 
        lon: lon.toFixed(8), 
        zoom: parseInt(zoom, 10), 
        timestamp: new Date().toISOString(),
        postcode: addressInfo.postcode,
        address: addressInfo.structured,
        elevation: elevation,
        xy_x: xyInfo ? xyInfo.x : '---',
        xy_y: xyInfo ? xyInfo.y : '---',
        xy_system: xyInfo ? xyInfo.system : '---'
    };
    b.unshift(newBookmark);
    setProjectData(BOOKMARK_KEY, b);
}

function renderBookmarkList() {
    const b = getProjectData(BOOKMARK_KEY) || [];
    $bookmarkList.innerHTML = b.length === 0 ? '<p>„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>' : b.map((item, index) =>
        `<div class="bookmark-item" data-index="${index}">
            <strong>${sanitizeForHtml(item.name)}</strong>
<span>${sanitizeForHtml(item.address || '---')}</span>
            <span>${item.lat}¬∞N, ${item.lon}¬∞E | Ê®ôÈ´ò: ${item.elevation}m</span>
            <div class="bookmark-actions">
                <button class="btn-bookmark-load">ÈÅ©Áî®</button>
                <button class="btn-bookmark-open">Âú∞Âõ≥</button>
                <button class="btn-bookmark-delete">ÂâäÈô§</button>
            </div>
        </div>`
    ).join('');
}

function handleBookmarkAction(index, action) {
    let b = getProjectData(BOOKMARK_KEY) || [], item = b[index];
    if (!item) return;
    if (action === 'load') {
        updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon));
        setZoomLevel(item.zoom);
        updateCurrentCoords({lat: parseFloat(item.lat), lon: parseFloat(item.lon)}, true);
        toggleBookmarkPopup(false);
        showNotification(`„Äå${item.name}„Äç„ÇíÈÅ©Áî®`);
    } else if (action === 'open') {
        window.open(`https://maps.google.co.jp/maps?q=${item.lat},${item.lon}&z=${item.zoom}`, '_blank');
    } else if (action === 'delete') {
        if (confirm(`„Äå${item.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            b.splice(index, 1);
            setProjectData(BOOKMARK_KEY, b);
            renderBookmarkList();
            renderBookmarkTable();
            renderBookmarksOnMap();
            showNotification('ÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
    }
}
function toggleBookmarkPopup(open = true) { if (open && $bookmarkPopup.style.display !== 'block') { renderBookmarkList(); $bookmarkPopup.style.display = 'block'; $historyPopup.style.display = 'none'; document.getElementById('csvPopup').style.display = 'none'; } else { $bookmarkPopup.style.display = 'none'; } }
function clearBookmarks() { if (confirm('ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) { setProjectData(BOOKMARK_KEY, []); renderBookmarkList([]); renderBookmarkTable(); renderBookmarksOnMap(); showNotification('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü'); toggleBookmarkPopup(false); } }
function exportBookmarksToCSV() { const d = getProjectData(BOOKMARK_KEY)||[]; if(d.length>0) exportToCSV(d, 'bookmarks_export'); else showNotification('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); }

function exportToCSV(data, filename) { 
    if (data.length === 0) return showNotification('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    const headers = Object.keys(data[0]).join(','), 
          rows = data.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')), 
          csv = `${headers}\n${rows.join('\n')}`, 
          bom = new Uint8Array([0xef, 0xbb, 0xbf]), 
          blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' }), 
          url = URL.createObjectURL(blob), a = document.createElement('a');
    
    const sanitizedFilename = filename.replace(/[^\w\s-]/gi, '_');
    a.href = url; 
    a.download = `${sanitizedFilename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url); 
    showNotification('CSV„ÅßÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü'); 
}

async function exportToKML(data, docName, filename) { 
    if (data.length === 0) return showNotification('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); 
    let placemarks = ''; 
    for (const item of data) {
        const description = `
            <![CDATA[
                <p><b>ÈÉµ‰æøÁï™Âè∑:</b> ${escapeXml(item.postcode || '---')}</p>
                <p><b>‰ΩèÊâÄ:</b> ${escapeXml(item.address || '---')}</p>
                <p><b>Ê®ôÈ´ò:</b> ${escapeXml(String(item.elevation) || '---')} m</p>
                <p><b>Â∫ßÊ®ô:</b> ${item.lat}, ${item.lon}</p>
            ]]>
        `;
        placemarks += `<Placemark><name>${escapeXml(item.name||item.address||'ÁÑ°È°å')}</name><description>${description}</description><Point><coordinates>${item.lon},${item.lat},0</coordinates></Point></Placemark>\n`; 
    }
    const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${docName}</name>${placemarks}</Document></kml>`, 
          blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8;' }), 
          url = URL.createObjectURL(blob), a = document.createElement('a'); 
    
    const sanitizedFilename = filename.replace(/[^\w\s-]/gi, '_');
    a.href = url; 
    a.download = `${sanitizedFilename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.kml`; 
    a.click(); 
    URL.revokeObjectURL(url); 
    showNotification('KML„ÅßÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü'); 
}

async function exportHistoryToKML() { exportToKML(getProjectData('coordinateHistory') || [], 'Â∫ßÊ®ôÂ±•Ê≠¥', 'coordinate_history'); }
async function exportBookmarksToKML() { exportToKML(getProjectData(BOOKMARK_KEY) || [], 'Âú∞ÁÇπ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ', 'bookmarks_export'); }

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëXSSÂØæÁ≠ñ„Å®„Åó„Å¶DOMPurify„Çí‰ΩøÁî®„Åô„Çã„Çà„ÅÜ„Å´Èñ¢Êï∞„ÇíÂº∑Âåñ ‚ñº‚ñº‚ñº
/**
 * ÊñáÂ≠óÂàó„ÇíHTML„Å®„Åó„Å¶Ë°®Á§∫„Åô„Çã„Åü„ÇÅ„Å´ÂÆâÂÖ®„Å™ÂΩ¢„Å´„Çµ„Éã„Çø„Ç§„Ç∫ÔºàÁÑ°ÂÆ≥ÂåñÔºâ„Åô„Çã
 * @param {any} str - „Çµ„Éã„Çø„Ç§„Ç∫„Åô„ÇãÊñáÂ≠óÂàó
 * @returns {string} „Çµ„Éã„Çø„Ç§„Ç∫Ê∏à„Åø„ÅÆHTMLÊñáÂ≠óÂàó
 */
function sanitizeForHtml(str) {
    // ÊñáÂ≠óÂàó„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂÆâÂÖ®„Å™ÂΩ¢„Å´Â§âÊèõ„Åó„Å¶Ëøî„Åô
    if (typeof str !== 'string') {
        if (str === null || str === undefined) {
            return '';
        }
        str = String(str);
    }
    // DOMPurify„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çå„Å∞‰ΩøÁî®„Åô„Çã
    if (window.DOMPurify) {
        return DOMPurify.sanitize(str);
    }
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶„ÄÅÂçòÁ¥î„Å™„ÉÜ„Ç≠„Çπ„Éà„Ç®„Çπ„Ç±„Éº„Éó„ÇíË°å„ÅÜ
    console.warn("DOMPurify not loaded. Using basic sanitization.");
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function escapeXml(unsafe) {
    if (typeof unsafe !== 'string') {
        return unsafe;
    }
    return unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'})[c]); 
}

function toggleDarkMode() {
    currentSettings.theme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
    setProjectData(SETTINGS_KEY, currentSettings);
    applySettings();
}

async function searchAddress() {
    const query = $addressInput.value.trim();
    if (!query) return showNotification('‰ΩèÊâÄ„Åæ„Åü„ÅØÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');

    const postalCodeRegex = /^\d{3}-?\d{4}$/;

    let coords = null;
    showNotification('Ê§úÁ¥¢‰∏≠...');

    if (postalCodeRegex.test(query)) {
        coords = await getCoordsFromPostalCode(query);
        if (coords) {
            showNotification(`ÈÉµ‰æøÁï™Âè∑„Äå${query}„Äç„ÅÆÂ∫ßÊ®ô„ÇíË®≠ÂÆö`);
            updateLatLonInputs(coords.lat, coords.lon);
            await updateCurrentCoords(coords, false); 
        } else {
            showNotification('Ë©≤ÂΩì„Åô„ÇãÈÉµ‰æøÁï™Âè∑„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
        }
    } else {
        coords = await getCoordsFromAddress(query);
        if (coords) {
            showNotification(`„Äå${query}„Äç„ÅÆÂ∫ßÊ®ô„ÇíË®≠ÂÆö`);
            updateLatLonInputs(coords.lat, coords.lon);
            await updateCurrentCoords(coords);
        } else {
            showNotification('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
        }
    }
    
    $autocompleteList.classList.remove('show');
}

function renderAutocompleteList(suggestions) { $autocompleteList.innerHTML = ''; selectedAutocompleteIndex = -1; if (suggestions.length === 0) return $autocompleteList.classList.remove('show'); currentAutocompleteResults = suggestions; suggestions.forEach((item, index) => { const li = document.createElement('div'); li.className = 'autocomplete-item'; li.innerHTML = `<strong>${item.display_name}</strong><span>${parseFloat(item.lat).toFixed(6)}, ${parseFloat(item.lon).toFixed(6)}</span>`; li.onclick = () => selectAutocompleteItem(index); $autocompleteList.appendChild(li); }); $autocompleteList.classList.add('show'); }
async function selectAutocompleteItem(index) {
    const selected = currentAutocompleteResults[index];
    if (selected) {
        $addressInput.value = selected.display_name;
        const coords = { lat: parseFloat(selected.lat), lon: parseFloat(selected.lon) };
        updateLatLonInputs(coords.lat, coords.lon);
        await updateCurrentCoords(coords);
        $autocompleteList.classList.remove('show');
    }
}
function openMap(mapData, showPopup=true) { const {lat,lon}=currentLatLon, zoom=Math.min(parseInt($zoom.value,10),18); if((isNaN(lat)||isNaN(lon))&&!mapData.noCoords) return showNotification('ÊúâÂäπ„Å™Â∫ßÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','error'); const url = mapData.isCustom ? mapData.url.replace('{lat}',lat).replace('{lon}',lon).replace('{z}',zoom) : mapData.url(lat,lon,zoom); if(showPopup)showNotification(`${mapData.name}„ÇíÈñã„ÅÑ„Å¶„ÅÑ„Åæ„Åô...`); window.open(url,'_blank'); }
function openCheckedMaps(catKey) { const chks =
document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox:checked`); if (chks.length === 0) return showNotification('Èñã„Åç„Åü„ÅÑÂú∞Âõ≥„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error'); showNotification(`${chks.length}‰ª∂„ÅÆ„É™„É≥„ÇØ„ÇíÈñã„Åç„Åæ„Åô„ÄÇ`); const allMaps = getCombinedMapDefinitions(); chks.forEach(cb => { const mapToOpen = allMaps.find(m => m.id === cb.dataset.mapId); if (mapToOpen) openMap(mapToOpen, false); }); }
function toggleAllCheckboxes(catKey, btn) {
const chks = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox`);
const allChecked = Array.from(chks).every(cb => cb.checked);
chks.forEach(cb => cb.checked = !allChecked);
btn.classList.toggle('checked', !allChecked);
}
function openGoogleMap() { const {lat,lon}=currentLatLon; if (isNaN(lat)||isNaN(lon))return; window.open(`https://maps.google.co.jp/maps?q=${lat},${lon}&z=${$zoom.value}`,'_blank'); }
async function pasteCoordinates() {
    try {
        const text = await navigator.clipboard.readText();
        const match = text.match(/^\s*(-?\d+\.?\d*)\s*[,\s]+\s*(-?\d+\.?\d*)\s*$/);
        if (match) {
            const coords = { lat: parseFloat(match[1]), lon: parseFloat(match[2]) };
            updateLatLonInputs(coords.lat, coords.lon);
            await updateCurrentCoords(coords);
            showNotification('Â∫ßÊ®ô„ÇíË≤º„Çä‰ªò„Åë„Åæ„Åó„Åü');
        } else {
            showNotification('ÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô', 'error');
        }
    } catch (err) {
        showNotification('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâË™≠ÂèñÂ§±Êïó', 'error');
    }
}
function toggleUsage() { document.getElementById('usageGuide').classList.toggle('show'); }
function toggleCategory(header) { header.classList.toggle('collapsed'); header.nextElementSibling.classList.toggle('hidden'); }

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëÁ∑äÊÄ•ÊôÇ„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„ÇÇÁµêÂêà„Åô„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£ ‚ñº‚ñº‚ñº
function getCombinedMapDefinitions() {
    const customLinks = getProjectData(MYLINK_KEY) || [];
    const customMaps = customLinks.filter(l => l).map(link => ({ ...link, isCustom: true }));
    
    const emergencySearches = (currentSettings.emergencySearches || []).map(s => ({
        id: `emergency-${s.id}`,
        name: s.keyword,
        desc: `Âë®Ëæ∫„ÅÆ„Äå${s.keyword}„Äç„ÇíGoogle„Éû„ÉÉ„Éó„ÅßÊ§úÁ¥¢`,
        category: 'liaison',
        icon: 'üîç',
        isEmergencySearch: true,
        url: (lat, lon, zoom) => `https://www.google.com/maps/search/${encodeURIComponent(s.keyword)}/@${lat},${lon},${zoom}z`
    }));

    return [...MAP_DEFINITIONS, ...customMaps, ...emergencySearches];
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function renderMapCards() {
    $container.innerHTML = '';
    let allMaps = getCombinedMapDefinitions();

    if (currentSettings.hiddenMapIds && currentSettings.hiddenMapIds.length > 0) {
        const hiddenSet = new Set(currentSettings.hiddenMapIds);
        allMaps = allMaps.filter(map => !hiddenSet.has(map.id));
    }

    const mapsByCategory = allMaps.reduce((acc, map) => {
        const categoryKey = currentSettings.mapCategoryOverrides?.[map.id] || map.category || 'mylink';
        if (!acc[categoryKey]) acc[categoryKey] = { meta: CATEGORY_META[categoryKey], maps: [] };
        acc[categoryKey].maps.push(map);
        return acc;
    }, {});

    const categoryOrder = currentSettings.categoryOrder || defaultSettings.categoryOrder;

    for (const catKey of categoryOrder) {
        if (!mapsByCategory[catKey] && catKey !== 'mylink' && catKey !== 'liaison') continue;
        
        let catGroup;
        if (mapsByCategory[catKey]) {
            catGroup = mapsByCategory[catKey];
        } else {
            // „Éû„Ç§„É™„É≥„ÇØ„ÇÑÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„ÅÆ„Çà„ÅÜ„Å´„ÄÅÊúÄÂàù„ÅØÁ©∫„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇÇÊèèÁîª„Åô„Çã
            catGroup = { meta: CATEGORY_META[catKey], maps: [] };
        }
        
        if (catGroup.maps.length === 0 && catKey !== 'mylink' && catKey !== 'liaison') continue;

        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        categoryDiv.setAttribute('data-category-key', catKey);
        categoryDiv.setAttribute('draggable', true);
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.classList.add('collapsed');
        categoryHeader.addEventListener('click', e => { if (e.target.closest('.category-title-group')) { toggleCategory(categoryHeader); } });
        const categoryTitleText = currentSettings.categoryNameOverrides?.[catKey] || catGroup.meta.title;
        categoryHeader.innerHTML = `<div class="category-title-group"><div class="category-icon ${catGroup.meta.class}">${catGroup.meta.icon}</div><div class="category-title">${escapeXml(categoryTitleText)}</div><span class="accordion-icon">‚ñº</span></div>`;
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn-toggle-all-checks';
        toggleBtn.setAttribute('title', 'ÂÖ®ÈÅ∏Êäû/Ëß£Èô§');
        toggleBtn.setAttribute('aria-label', `${catGroup.meta.title}„ÅÆÂú∞Âõ≥„ÇíÂÖ®ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ®Ëß£Èô§`);
        toggleBtn.onclick = () => toggleAllCheckboxes(catKey, toggleBtn);
        categoryHeader.appendChild(toggleBtn);
        const bulkOpenBtn = document.createElement('button');
        bulkOpenBtn.className = 'btn-bulk-open';
        bulkOpenBtn.setAttribute('title', '„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÈ†ÖÁõÆ„Çí‰∏ÄÊã¨„ÅßÈñã„Åè');
        bulkOpenBtn.setAttribute('aria-label', `${catGroup.meta.title}„Åß„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÂú∞Âõ≥„Çí‰∏ÄÊã¨„ÅßÈñã„Åè`);
        bulkOpenBtn.onclick = () => openCheckedMaps(catKey);
        categoryHeader.appendChild(bulkOpenBtn);
        categoryDiv.appendChild(categoryHeader);
        const mapGrid = document.createElement('div');
        mapGrid.className = 'map-grid';
        mapGrid.classList.add('hidden');
        
        const order = currentSettings.mapOrderInCategory?.[catKey];
        if (order && Array.isArray(order) && catGroup.maps.length > 1) {
            catGroup.maps.sort((a, b) => {
                const indexA = order.indexOf(a.id);
                const indexB = order.indexOf(b.id);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }

        catGroup.maps.forEach(map => mapGrid.appendChild(createMapCard(map, catKey, categoryHeader)));
        
        if (catKey === 'mylink') {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-mylink';
            addBtn.textContent = 'Ôºã Êñ∞„Åó„ÅÑ„É™„É≥„ÇØ„ÇíËøΩÂä†';
            addBtn.onclick = () => openMyLinkModal();
            mapGrid.appendChild(addBtn);
        }
        
        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„Ç´„ÉÜ„Ç¥„É™„Å´„ÄåËøΩÂä†„Äç„Éú„Çø„É≥„ÇíË®≠ÁΩÆ ‚ñº‚ñº‚ñº
        if (catKey === 'liaison') {
            const emergencySearches = currentSettings.emergencySearches || [];
            if (emergencySearches.length < 5) {
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-add-emergency-search';
                addBtn.textContent = 'Ôºã Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíËøΩÂä†';
                addBtn.onclick = () => openEmergencySearchModal();
                mapGrid.appendChild(addBtn);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

        categoryDiv.appendChild(mapGrid);
        $container.appendChild(categoryDiv);
    }
}

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„ÄëcreateMapCardÈñ¢Êï∞„Çí‰øÆÊ≠£ ‚ñº‚ñº‚ñº
function createMapCard(map, catKey, categoryHeader) {
    const card = document.createElement('div');
    card.className = 'map-card';
    card.dataset.category = catKey;
    card.dataset.mapId = map.id;

    // „Ç´„Çπ„Çø„É†Ê§úÁ¥¢„Ç´„Éº„Éâ„ÅØ„Éâ„É©„ÉÉ„Ç∞‰∏çÂèØ„Å´„Åô„Çã
    card.setAttribute('draggable', !map.isEmergencySearch);
    
    card.addEventListener('click', e => {
        if (!e.target.closest('.map-checkbox, .map-card-actions, a')) {
            openMap(map);
        }
    });

    let actionsHtml = '';
    if (map.isCustom) {
        actionsHtml = `<div class="map-card-actions">
            <button class="btn-mylink-edit">‚úèÔ∏è Á∑®ÈõÜ</button>
            <button class="btn-mylink-delete">üóëÔ∏è ÂâäÈô§</button>
        </div>`;
    } else if (map.isEmergencySearch) {
        const searchItem = (currentSettings.emergencySearches || []).find(s => `emergency-${s.id}` === map.id);
        actionsHtml = `<div class="map-card-actions">
            <button class="btn-emergency-search-edit" data-search-id="${searchItem.id}">‚úèÔ∏è Á∑®ÈõÜ</button>
            <button class="btn-emergency-search-delete" data-search-id="${searchItem.id}">üóëÔ∏è ÂâäÈô§</button>
        </div>`;
    }

    card.innerHTML = `<div class="map-header-with-check"><div class="map-title"><span class="map-icon-in-title">${sanitizeForHtml(map.icon || 'üîó')}</span> ${sanitizeForHtml(map.name)}</div><input type="checkbox" class="map-checkbox" data-map-id="${map.id}" aria-label="${sanitizeForHtml(map.name)}„ÇíÈÅ∏Êäû"></div><div class="map-description">${sanitizeForHtml(map.desc || '„Ç´„Çπ„Çø„É†„É™„É≥„ÇØ')}</div>${map.noCoords ? '<div class="manual-input-warning">‚ÄªÊâãÂãïË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô</div>' : ''}${actionsHtml}`;

    const checkbox = card.querySelector('.map-checkbox');
    checkbox.onclick = (e) => e.stopPropagation();
    checkbox.onchange = () => {
        const btn = categoryHeader.querySelector('.btn-toggle-all-checks');
        if (btn) {
            const allCheckboxes = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox`);
            const checkedCheckboxes = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox:checked`);
            btn.classList.toggle('checked', allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length);
        }
    };

    if (map.isCustom) {
        card.querySelector('.btn-mylink-edit').onclick = (e) => { e.stopPropagation(); openMyLinkModal(map); };
        card.querySelector('.btn-mylink-delete').onclick = (e) => { e.stopPropagation(); deleteMyLink(map.id); };
    } else if (map.isEmergencySearch) {
        card.querySelector('.btn-emergency-search-edit').onclick = (e) => { e.stopPropagation(); openEmergencySearchModal(e.target.dataset.searchId); };
        card.querySelector('.btn-emergency-search-delete').onclick = (e) => { e.stopPropagation(); deleteEmergencySearch(e.target.dataset.searchId); };
    }

    return card;
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function decimalToDMS(dd, isLat) { const dir = dd < 0 ? (isLat ? 'S' : 'W') : (isLat ? 'N' : 'E'); dd = Math.abs(dd); const d = Math.floor(dd), m = Math.floor((dd - d) * 60), s = (((dd - d) * 60 - m) * 60).toFixed(5); return `${d}¬∞${String(m).padStart(2,'0')}'${String(s).padStart(6,'0')}" ${dir}`; }
function dmsToDecimal(dms) { dms = String(dms).trim().toUpperCase(); const parts = dms.match(/(-?\d+\.?\d*)[¬∞D\s]+(\d+)[`'‚Äô\s]+([\d.]+)[S"‚Äù\s]*\s*([NSEW])?/); if (!parts) throw new Error("Invalid DMS format"); let dd = Math.abs(parseFloat(parts[1])) + parseFloat(parts[2])/60 + parseFloat(parts[3])/3600; if (parseFloat(parts[1]) < 0 || parts[4] === 'S' || parts[4] === 'W') dd = -dd; return dd; }
function toggleCoordFormat() {
    currentSettings.coordFormat = isDMSFormat ? 'decimal' : 'dms';
    setProjectData(SETTINGS_KEY, currentSettings);
    applySettings();
}
function updateLatLonInputs(lat, lon) { currentLatLon = {lat, lon}; if (isDMSFormat) { $lat.value = decimalToDMS(lat, true); $lon.value = decimalToDMS(lon, false); } else { $lat.value = lat.toFixed(8); $lon.value = lon.toFixed(8); } }

function copyToClipboard(elementId) {
    let textToCopy = '';
    let notificationMessage = '';

    if (elementId === 'latitude' || elementId === 'longitude') {
        const input = document.getElementById(elementId);
        textToCopy = input.value;
        notificationMessage = `${elementId === 'latitude' ? 'Á∑ØÂ∫¶' : 'ÁµåÂ∫¶'}„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`;
    } else if (elementId === 'currentCoords') {
        textToCopy = `${currentLatLon.lat.toFixed(8)}, ${currentLatLon.lon.toFixed(8)}`;
        notificationMessage = 'Â∫ßÊ®ô (lat, lon) „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü';
    }

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showNotification(notificationMessage);
        }).catch(err => {
            showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        });
    } else {
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'absolute';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification(notificationMessage);
        } catch (err) {
            showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
        }
        document.body.removeChild(textArea);
    }
}

function copyInputToClipboard(inputId) {
    const inputElement = document.getElementById(inputId);
    if (!inputElement) return;

    const textToCopy = inputElement.value;
    const label = inputId === 'latitude' ? 'Á∑ØÂ∫¶' : 'ÁµåÂ∫¶';

    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification(`${label}„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`);
    }).catch(err => {
        showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    });
}

let isMeasuring = false, isMeasuringArea = false;
let measurePoints = [], tempMeasureLine = null, tempMeasureMarker = null, measureTooltip = null;
let measurePointMarkers = [];
let areaPoints = [], tempAreaPolygon = null;
let areaPointMarkers = [];
let analysisLayer;

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂçÅÂ≠óÁ∑ö„ÅÆÊ©üËÉΩ ‚ñº‚ñº‚ñº
function initCrosshair() {
    $crosshairV = document.getElementById('crosshair-v');
    $crosshairH = document.getElementById('crosshair-h');
    // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂè≥ÂÅ¥„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó ‚ñº‚ñº‚ñº
    let $crosshairVRight = document.getElementById('crosshair-v-right');
    let $crosshairHRight = document.getElementById('crosshair-h-right');
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
    const toggleBtn = document.getElementById('toggle-crosshair-btn');

    if (!$crosshairV || !$crosshairH || !toggleBtn || !mapLeft) return;

    mapLeft.on('mousemove', (e) => {
        if (isCrosshairEnabled) {
            // Â∑¶ÂÅ¥„ÅÆÂú∞Âõ≥
            $crosshairV.style.left = `${e.containerPoint.x}px`;
            $crosshairH.style.top = `${e.containerPoint.y}px`;
            
            // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂè≥ÂÅ¥„ÅÆÂú∞Âõ≥„ÇÇÊõ¥Êñ∞ ‚ñº‚ñº‚ñº
            if (isDualView && $crosshairVRight) {
                $crosshairVRight.style.left = `${e.containerPoint.x}px`;
                $crosshairHRight.style.top = `${e.containerPoint.y}px`;
            }
            // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
        }
    });

    mapLeft.on('mouseover', () => {
        if (isCrosshairEnabled) {
            $crosshairV.style.display = 'block';
            $crosshairH.style.display = 'block';
            // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂè≥ÂÅ¥„ÇÇË°®Á§∫ ‚ñº‚ñº‚ñº
            if (isDualView && $crosshairVRight) {
                $crosshairVRight.style.display = 'block';
                $crosshairHRight.style.display = 'block';
            }
            // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
        }
    });

    mapLeft.on('mouseout', () => {
        $crosshairV.style.display = 'none';
        $crosshairH.style.display = 'none';
        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÂè≥ÂÅ¥„ÇÇÈùûË°®Á§∫ ‚ñº‚ñº‚ñº
        if ($crosshairVRight) { // isDualView„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÅØ‰∏çË¶Å
            $crosshairVRight.style.display = 'none';
            $crosshairHRight.style.display = 'none';
        }
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
    });
    
    toggleBtn.addEventListener('click', toggleCrosshair);
}

// `toggleCrosshair` Èñ¢Êï∞„ÇíÁΩÆ„ÅçÊèõ„Åà„Çã
function toggleCrosshair() {
    isCrosshairEnabled = !isCrosshairEnabled;
    const toggleBtn = document.getElementById('toggle-crosshair-btn');
    const mapContainers = document.querySelectorAll('#mapLeft .leaflet-container, #mapRight .leaflet-container');

    toggleBtn.classList.toggle('active', isCrosshairEnabled);

    if (isCrosshairEnabled) {
        $crosshairV.style.display = 'block';
        $crosshairH.style.display = 'block';
        toggleBtn.title = 'ÂçÅÂ≠óÁ∑ö OFF';
        mapContainers.forEach(c => c.classList.add('crosshair-active'));
        if (isDualView && mapRight) { 
            document.getElementById('crosshair-v-right').style.display = 'block';
            document.getElementById('crosshair-h-right').style.display = 'block';
        }
    } else {
        $crosshairV.style.display = 'none';
        $crosshairH.style.display = 'none';
        toggleBtn.title = 'ÂçÅÂ≠óÁ∑ö ON';
        mapContainers.forEach(c => c.classList.remove('crosshair-active'));
        if (mapRight) {
             document.getElementById('crosshair-v-right').style.display = 'none';
             document.getElementById('crosshair-h-right').style.display = 'none';
        }
    }

    currentSettings.crosshairEnabled = isCrosshairEnabled;
    setProjectData(SETTINGS_KEY, currentSettings);
}

// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function setupAnalysisTools() {
    if (!osmMap) return;
    analysisLayer = L.layerGroup().addTo(osmMap);

    document.getElementById('measure-tool-btn').addEventListener('click', () => toggleMeasureMode());
    document.getElementById('area-tool-btn').addEventListener('click', () => toggleAreaMeasureMode());
    document.getElementById('buffer-tool-btn').addEventListener('click', () => {
        const r = parseFloat(document.getElementById('buffer-radius-input').value);
        if(r>0) L.circle(currentLatLon, {radius:r}).addTo(analysisLayer);
    });
    document.getElementById('clear-analysis-btn').addEventListener('click', () => {
        if(analysisLayer) analysisLayer.clearLayers();
        if(isMeasuring) toggleMeasureMode(true);
        if(isMeasuringArea) toggleAreaMeasureMode(true);
    });
    document.getElementById('export-analysis-btn').addEventListener('click', exportAnalysisToKML);

    const analysisTools = document.getElementById('analysis-tools');
    const analysisToolsHeader = document.getElementById('analysis-tools-header');
    if (analysisTools) L.DomEvent.disableClickPropagation(analysisTools);
    if (analysisToolsHeader) analysisToolsHeader.addEventListener('click', () => analysisTools.classList.toggle('collapsed'));
}

function disableOtherModes(currentMode) {
if (currentMode !== 'measure' && isMeasuring) toggleMeasureMode(true);
if (currentMode !== 'area' && isMeasuringArea) toggleAreaMeasureMode(true);
}

function toggleMeasureMode(forceOff = false) {
    isMeasuring = forceOff ? false : !isMeasuring;
    if (isMeasuring) disableOtherModes('measure');
    document.getElementById('measure-tool-btn').classList.toggle('active', isMeasuring);
    osmMap.getContainer().style.cursor = isMeasuring ? 'crosshair' : '';
    if (!isMeasuring) {
        if(tempMeasureLine) analysisLayer.removeLayer(tempMeasureLine);
        if(tempMeasureMarker) analysisLayer.removeLayer(tempMeasureMarker);
        if(measureTooltip) osmMap.removeLayer(measureTooltip);
        tempMeasureLine = tempMeasureMarker = measureTooltip = null;
    }
    measurePoints = [];
    measurePointMarkers = [];
}
function handleMeasureClick(e) {
    measurePoints.push(e.latlng);
    const pointMarker = L.circleMarker(e.latlng, { radius: 5, color: 'red' }).addTo(analysisLayer);
    measurePointMarkers.push(pointMarker);

    if (measurePoints.length > 1) {
        L.polyline(measurePoints.slice(0, measurePoints.length), { color: 'blue' }).addTo(analysisLayer);
        updateMeasureTooltip(e.latlng);
    }
    if (measurePoints.length === 1) {
        tempMeasureMarker = L.circleMarker(e.latlng, { radius: 5, color: 'red', opacity: 0.5 }).addTo(analysisLayer);
        measureTooltip = L.tooltip({permanent: true}).setLatLng(e.latlng).setContent('„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ¨°ÁÇπ„ÄÅ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁµÇ‰∫Ü').addTo(osmMap);
    }
}
function handleMeasureMouseMove(e) {
if (measurePoints.length === 0) return;
const currentPoints = [...measurePoints, e.latlng];
if (tempMeasureLine) {
analysisLayer.removeLayer(tempMeasureLine);
}
tempMeasureLine = L.polyline(currentPoints, { color: 'blue', dashArray: '5, 5' }).addTo(analysisLayer);
if(tempMeasureMarker) tempMeasureMarker.setLatLng(e.latlng);
updateMeasureTooltip(e.latlng);
}

function handleMeasureDoubleClick(e) {
    if (measurePoints.length < 1) {
        toggleMeasureMode(true);
        return;
    }
    const finalPoints = [...measurePoints, e.latlng];
    const finalLine = L.polyline(finalPoints, { color: 'blue' }).addTo(analysisLayer);

    if (finalLine.getBounds().isValid()) {
        osmMap.fitBounds(finalLine.getBounds(), { padding: [50, 50] });
    }

    const totalDistance = calculateTotalDistance(finalPoints);
    const distText = totalDistance > 1000 ? (totalDistance / 1000).toFixed(2) + ' km' : totalDistance.toFixed(1) + ' m';
    
    if (finalPoints.length > 0) {
        L.marker(finalPoints[0], { icon: startIcon }).addTo(analysisLayer).bindPopup('<b>„Çπ„Çø„Éº„ÉàÂú∞ÁÇπ</b>');
        L.marker(finalPoints[finalPoints.length - 1], { icon: endIcon }).addTo(analysisLayer).bindPopup('<b>„Ç®„É≥„ÉâÂú∞ÁÇπ</b>');
    }

    const popupContent = document.createElement('div');
    popupContent.innerHTML = `<b>Á∑èË∑ùÈõ¢:</b> ${distText}<br>`;
    const profileButton = document.createElement('button');
    profileButton.textContent = 'üìà Ê®ôÈ´òÊñ≠Èù¢Âõ≥„Çí‰ΩúÊàê';
    profileButton.style.marginTop = '10px';
    profileButton.style.cursor = 'pointer';

    profileButton.onclick = () => {
        const divisionInput = document.getElementById('profile-division-input');
        let divisionCount = parseInt(divisionInput.value, 10);

        if (isNaN(divisionCount) || divisionCount < 10 || divisionCount > 300) {
            showNotification('ÂàÜÂâ≤Êï∞„Å´„ÅØ10ÔΩû200„ÅÆÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éá„Éï„Ç©„É´„Éà„ÅÆ80„Åß‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ', 'warning');
            divisionCount = 100;
            divisionInput.value = 100;
        }
        
        generateProfileChart(finalPoints, divisionCount);
    };

    popupContent.appendChild(profileButton);

    finalLine.bindPopup(popupContent).openPopup();

    toggleMeasureMode(true);
}
function updateMeasureTooltip(latlng) {
if (!measureTooltip)
return;
const totalDistance = calculateTotalDistance([...measurePoints, latlng]);
const distText = totalDistance > 1000 ? (totalDistance / 1000).toFixed(2) + ' km' : totalDistance.toFixed(1) + ' m';
measureTooltip.setLatLng(latlng).setContent(`Á∑èË∑ùÈõ¢: ${distText}<br>„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁµÇ‰∫Ü`);
}
function calculateTotalDistance(points) {
let totalDistance = 0;
for (let i = 0; i < points.length - 1; i++) {
totalDistance += points[i].distanceTo(points[i + 1]);
}
return totalDistance;
}

function toggleAreaMeasureMode(forceOff = false) {
    isMeasuringArea = forceOff ? false : !isMeasuringArea;
    if(isMeasuringArea) disableOtherModes('area');
    document.getElementById('area-tool-btn').classList.toggle('active', isMeasuringArea);
    osmMap.getContainer().style.cursor = isMeasuringArea ? 'crosshair' : '';
    if (isMeasuringArea) {
        areaPoints = [];
        areaPointMarkers = [];
        if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
        tempAreaPolygon = null;
        $areaDisplay.style.display = 'inline';
        $areaDisplay.textContent = '--- m¬≤';
    } else {
        if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
        tempAreaPolygon = null;
        $areaDisplay.style.display = 'none';
    }
}
function handleAreaMeasureClick(e) {
    areaPoints.push(e.latlng);
    const pointMarker = L.circleMarker(e.latlng, { radius: 5, color: '#9C27B0' }).addTo(analysisLayer);
    areaPointMarkers.push(pointMarker);
    if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
    if (areaPoints.length > 1) {
        tempAreaPolygon = L.polygon(areaPoints, { color: '#9C27B0', weight: 2, fillOpacity: 0.1 }).addTo(analysisLayer);
    }
    if (areaPoints.length >= 3) {
        const area = calculatePolygonArea(areaPoints);
        const areaText = area > 1000000 ? `${(area / 1000000).toFixed(3)} km¬≤` : `${area.toFixed(2)} m¬≤`;
        $areaDisplay.textContent = `Èù¢Á©ç: ${areaText}`;
    } else {
        $areaDisplay.textContent = '--- m¬≤';
    }
}
function handleAreaMeasureDoubleClick() {
if (!isMeasuringArea || areaPoints.length < 3) return;
const finalPolygon = L.polygon(areaPoints, { color: '#9C27B0' }).addTo(analysisLayer);
const area = calculatePolygonArea(areaPoints);
const areaText = area > 1000000 ? `${(area / 1000000).toFixed(3)} km¬≤` : `${area.toFixed(2)} m¬≤`;
finalPolygon.bindPopup(`<b>Èù¢Á©ç:</b> ${areaText}`).openPopup();
toggleAreaMeasureMode(true);
}
function calculatePolygonArea(latlngs) {
if (latlngs.length < 3) return 0;
const centralLon = latlngs.reduce((sum, p) => sum + p.lng, 0) / latlngs.length;
const utmZone = Math.floor((centralLon + 180) / 6) + 1;
const utmProj = `+proj=utm +zone=${utmZone} +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
try {
const projectedPoints = latlngs.map(p => proj4('EPSG:4326', utmProj, [p.lng, p.lat]));
let area = 0;
for (let i = 0, j = projectedPoints.length - 1; i < projectedPoints.length; j = i++) {
area += (projectedPoints[j][0] + projectedPoints[i][0]) * (projectedPoints[j][1] - projectedPoints[i][1]);
}
return Math.abs(area / 2);
} catch (e) {
console.error("Area calculation error:", e);
return 0;
}
}

function latLngsToKmlCoordinates(latlngs, closeRing = false) {
    let coords = latlngs.map(p => `${p.lng},${p.lat},0`).join(' ');
    if (closeRing && latlngs.length > 0) {
        const firstPoint = latlngs[0];
        coords += ` ${firstPoint.lng},${firstPoint.lat},0`;
    }
    return coords;
}

function circleToPolygonPoints(circle) {
    const center = circle.getLatLng();
    const radius = circle.getRadius();
    const points = [];
    const earthRadius = 6371000;
    const lat = center.lat * Math.PI / 180;
    const lon = center.lng * Math.PI / 180;

    for (let i = 0; i <= 360; i += 5) {
        const bearing = i * Math.PI / 180;
        const angDist = radius / earthRadius;
        const newLat = Math.asin(Math.sin(lat) * Math.cos(angDist) + Math.cos(lat) * Math.sin(angDist) * Math.cos(bearing));
        let newLon = lon + Math.atan2(Math.sin(bearing) * Math.sin(angDist) * Math.cos(lat), Math.cos(angDist) - Math.sin(lat) * Math.sin(newLat));
        newLon = (newLon + 3 * Math.PI) % (2 * Math.PI) - Math.PI;
        points.push(L.latLng(newLat * 180 / Math.PI, newLon * 180 / Math.PI));
    }
    return points;
}

function exportAnalysisToKML() {
    if (!analysisLayer || analysisLayer.getLayers().length === 0) {
        showNotification('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂõ≥ÂΩ¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }
    let placemarks = '';
    let itemCounter = { line: 1, area: 1, circle: 1 };

    analysisLayer.eachLayer(layer => {
        let kmlGeom = '';
        let name = '';
        let styleUrl = '';
        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
            name = `Ë∑ùÈõ¢Ë®àÊ∏¨ ${itemCounter.line++}`;
            styleUrl = '#lineStyle';
            const coords = latLngsToKmlCoordinates(layer.getLatLngs());
            kmlGeom = `<LineString><tessellate>1</tessellate><altitudeMode>clampToGround</altitudeMode><coordinates>${coords}</coordinates></LineString>`;
        } else if (layer instanceof L.Polygon && !(layer instanceof L.Circle)) {
            name = `Èù¢Á©çË®àÊ∏¨ ${itemCounter.area++}`;
            styleUrl = '#areaStyle';
            const coords = latLngsToKmlCoordinates(layer.getLatLngs()[0], true);
            kmlGeom = `<Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon>`;
        } else if (layer instanceof L.Circle) {
            name = `ÂÜÜ ${itemCounter.circle++}`;
            styleUrl = '#circleStyle';
            const points = circleToPolygonPoints(layer);
            const coords = latLngsToKmlCoordinates(points, true);
            kmlGeom = `<Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon>`;
        } else if (layer instanceof L.Marker) {
            return;
        }

        if (kmlGeom) {
            placemarks += `<Placemark><name>${escapeXml(name)}</name><styleUrl>${styleUrl}</styleUrl>${kmlGeom}</Placemark>\n`;
        }
    });
    if (!placemarks) {
        showNotification('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°„ÅÆÂõ≥ÂΩ¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }
    const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Ëß£ÊûêÁµêÊûú</name><Style id="lineStyle"><LineStyle><color>ffff0000</color><width>3</width></LineStyle></Style><Style id="areaStyle"><LineStyle><color>ffb07b9c</color><width>2</width></LineStyle><PolyStyle><color>1ab07b9c</color></PolyStyle></Style><Style id="circleStyle"><LineStyle><color>fff4a903</color><width>2</width></LineStyle><PolyStyle><color>33f4a903</color></PolyStyle></Style>${placemarks}</Document></kml>`;
    const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const filename = 'analysis_export';
    const sanitizedFilename = filename.replace(/[^\w\s-]/gi, '_');
    a.download = `${sanitizedFilename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.kml`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Ëß£ÊûêÁµêÊûú„ÇíKML„ÅßÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü');
}

async function generateProfileChart(points, divisionCount = 100) {
    if (points.length < 2) return;
    showNotification('Ê®ôÈ´ò„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠„Åß„Åô...', 'warning');

    try {
        await loadChartJS();
        const sampledPoints = interpolatePoints(points, divisionCount);
        const fetchPromises = sampledPoints.map(point =>
            fetchWithRetry(`https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?outtype=JSON&demtype=dem_merged&lon=${point.lng}&lat=${point.lat}`)
            .then(res => res && res.ok ? res.json() : null)
        );
        const results = await Promise.all(fetchPromises);
        let dist = 0;
        let successfulFetches = 0;

        lastProfileData = results.map((result, i) => {
            if (i > 0) dist += sampledPoints[i - 1].distanceTo(sampledPoints[i]);

            let elev = null;
            let demType = '---';

            if (result) {
                const item = result;
                if (item.elevation && item.elevation !== '-----') {
                    elev = parseFloat(item.elevation);
                    successfulFetches++;
                }
                if (item.hsrc) {
                    demType = item.hsrc;
                }
            }

            return {
                distance: dist,
                elevation: elev,
                lat: sampledPoints[i].lat,
                lon: sampledPoints[i].lng,
                dem: demType
            };
        });


        if (successfulFetches > 0) {
            drawProfileChart(lastProfileData);
            if (successfulFetches < sampledPoints.length) {
                showNotification(`Êñ≠Èù¢Âõ≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü (${sampledPoints.length}ÁÇπ‰∏≠ ${successfulFetches}ÁÇπ„ÅÆÊ®ôÈ´ò„ÇíÂèñÂæó)„ÄÇ`, 'warning');
            } else {
                showNotification('Êñ≠Èù¢Âõ≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        } else {
            throw new Error('ÂÖ®„Å¶„ÅÆÂú∞ÁÇπ„ÅßÊ®ôÈ´ò„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }

    } catch (error) {
        console.error("Error in generateProfileChart:", error);
        showNotification(`Êñ≠Èù¢Âõ≥„ÅÆÁîüÊàê„Å´Â§±Êïó: ${error.message}`, 'error');
        lastProfileData = null;
    }
}
function interpolatePoints(points, num) {
    const totalDist = calculateTotalDistance(points);
    if (totalDist === 0) return [points[0]];
    const interval = totalDist / (num - 1);
    const result = [points[0]];
    let rem = 0;
    for (let i = 0; i < points.length - 1; i++) {
        const start = points[i],
            end = points[i + 1],
            segDist = start.distanceTo(end);
        let covered = rem;
        while (covered + interval <= segDist) {
            covered += interval;
            const ratio = covered / segDist;
            result.push(L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio));
        }
        rem = segDist - covered;
    }
    if (result.length < num) result.push(points[points.length - 1]);
    return result;
}

function drawProfileChart(data) {
    const modal = document.getElementById('profile-modal'),
        ctx = document.getElementById('profileChart').getContext('2d'),
        yToggle = document.getElementById('y-axis-toggle');
    if (profileChartInstance) profileChartInstance.destroy();
    const yOpts = {
        title: {
            display: true,
            text: 'Ê®ôÈ´ò (m)'
        }
    };
if (yToggle.checked) yOpts.min = 0;
    profileChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(p => p.distance.toFixed(1)),
datasets: [{
    label: 'Ê®ôÈ´ò (m)',
    data: data.map(p => p.elevation),
    borderColor: 'rgb(75, 192, 192)',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    tension: .1,
    fill: true,
    pointRadius: 0,
    pointHoverRadius: 6,
    pointHoverBackgroundColor: 'red',
    pointHoverBorderColor: 'red',
    pointHitRadius: 30,
    spanGaps: true
}]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'ÂßãÁÇπ„Åã„Çâ„ÅÆË∑ùÈõ¢ (m)'
                    }
                },
                y: yOpts
            },
            plugins: {
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false
                }
            },
onHover: (e, el) => {
    if (el.length > 0) {
        const d = lastProfileData[el[0].index];
        if (d) {
            const ll = [d.lat, d.lon];
            if (!rolloverMarker) rolloverMarker = L.circleMarker(ll, {
                radius: 10,
                color: 'red',
                weight: 3,
                fillColor: '#ffc107',
                fillOpacity: 0.9,
                pane: 'markerPane'
            }).addTo(osmMap);
            else rolloverMarker.setLatLng(ll);
        }
    } else if (rolloverMarker) {
        rolloverMarker.remove();
        rolloverMarker = null;
    }
}
        }
    });

    document.getElementById('profile-data-source').innerHTML = 'Ê®ôÈ´ò„Éá„Éº„Çø„ÇΩ„Éº„Çπ: <a href="https://maps.gsi.go.jp/development/elevation_s.html" target="_blank">ÂõΩÂúüÂú∞ÁêÜÈô¢ (Áµ±ÂêàDEM)</a>';

    modal.style.display = 'flex';
}
function updateNavButtons() {
    document.getElementById('navBack').disabled = historyIndex <= 0;
    document.getElementById('navForward').disabled = historyIndex >= navigationHistory.length - 1;
}

const $mylinkModal = document.getElementById('mylink-modal'), $mylinkForm = document.getElementById('mylink-form');
function openMyLinkModal(linkToEdit = null) {
    $mylinkForm.reset();
    const categorySelect = document.getElementById('mylink-category');
    categorySelect.innerHTML = ''; 

    const categoryOrder = currentSettings.categoryOrder || defaultSettings.categoryOrder;
    for (const catKey of categoryOrder) {
        const meta = CATEGORY_META[catKey];
        const option = document.createElement('option');
        option.value = catKey;
        option.textContent = meta.title;
        categorySelect.appendChild(option);
    }

    document.getElementById('modal-title').textContent = linkToEdit ? '„É™„É≥„ÇØ„ÇíÁ∑®ÈõÜ' : 'Êñ∞„Åó„ÅÑ„É™„É≥„ÇØ„ÇíËøΩÂä†';

    if (linkToEdit) {
        document.getElementById('mylink-id').value = linkToEdit.id;
        document.getElementById('mylink-name').value = linkToEdit.name;
        document.getElementById('mylink-url').value = linkToEdit.url;
        document.getElementById('mylink-desc').value = linkToEdit.desc;
        categorySelect.value = linkToEdit.category || 'mylink';
    } else {
        categorySelect.value = 'mylink';
    }

    $mylinkModal.style.display = 'flex';
}
function closeMyLinkModal() { $mylinkModal.style.display = 'none'; }

function validateCustomUrl(url) {
    try {
        const parsed = new URL(url.replace('{lat}', '0').replace('{lon}', '0').replace('{z}', '0'));
        if (!['http:', 'https:'].includes(parsed.protocol)) {
            throw new Error('ÁÑ°Âäπ„Å™„Éó„É≠„Éà„Ç≥„É´');
        }
        return true;
    } catch {
        return false;
    }
}

function saveMyLink(e) {
    e.preventDefault();
    const urlToSave = document.getElementById('mylink-url').value;
    if (!validateCustomUrl(urlToSave)) {
        showNotification('ÁÑ°Âäπ„Å™URLÂΩ¢Âºè„Åß„Åô„ÄÇhttp:„Åæ„Åü„ÅØhttps:„ÅßÂßã„Åæ„ÇãURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const selectedCategory = document.getElementById('mylink-category').value;
    let links = getProjectData(MYLINK_KEY) || [];
    const linkId = document.getElementById('mylink-id').value;
    const newLink = {
        id: linkId || `mylink-${Date.now()}`,
        name: document.getElementById('mylink-name').value,
        url: urlToSave,
        desc: document.getElementById('mylink-desc').value,
        category: selectedCategory,
        isCustom: true
    };
    
    if (linkId) {
        links = links.map(l => l.id === linkId ? newLink : l);
    } else {
        links.push(newLink);
    }
    
    setProjectData(MYLINK_KEY, links);
    renderMapCards();
    closeMyLinkModal();
    showNotification('„Éû„Ç§„É™„É≥„ÇØ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
}

function deleteMyLink(linkId) {
    if (confirm('„Åì„ÅÆ„Éû„Ç§„É™„É≥„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        let links = (getProjectData(MYLINK_KEY) || []).filter(l => l.id !== linkId);
        setProjectData(MYLINK_KEY, links);

        if (currentSettings.mapCategoryOverrides?.[linkId]) {
            delete currentSettings.mapCategoryOverrides[linkId];
            setProjectData(SETTINGS_KEY, currentSettings);
        }
        renderMapCards();
        showNotification('„Éû„Ç§„É™„É≥„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
    }
}

function getShareUrl() {
    const p = new URLSearchParams({ lat: currentLatLon.lat.toFixed(8), lon: currentLatLon.lon.toFixed(8), zoom: $zoom.value });
    const c = Array.from(document.querySelectorAll('.map-checkbox:checked')).map(cb => cb.dataset.mapId).join(',');
    if (c) p.append('checked', c);
    return `${location.origin}${location.pathname}?${p.toString()}`;
}
function generateShareUrl() {
    navigator.clipboard.writeText(getShareUrl()).then(() => showNotification('ÂÖ±ÊúâURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'), () => showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó', 'error'));
}

async function openQrModal() {
    try {
        await loadQrCodeJs(); // „É©„Ç§„Éñ„É©„É™„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„ÇÄ
        const modal = document.getElementById('qr-modal');
        const qrContainer = document.getElementById('qrcode');
        const urlInput = document.getElementById('share-url-input');
        const copyBtn = document.getElementById('copy-url-btn');

        const shareUrl = getShareUrl();

        urlInput.value = shareUrl;

        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: shareUrl,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        if (!copyBtn.dataset.listenerAttached) {
            copyBtn.addEventListener('click', () => {
                urlInput.select();
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    showNotification('ÂÖ±ÊúâURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                });
            });
            copyBtn.dataset.listenerAttached = 'true';
        }

        modal.style.display = 'flex';
    } catch (error) {
        console.error("QR„Ç≥„Éº„Éâ„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", error);
        showNotification("ÂÖ±ÊúâÊ©üËÉΩ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", "error");
    }
}
function closeQrModal() {
    document.getElementById('qr-modal').style.display = 'none';
}


function applyStateFromUrl() {
    const p = new URLSearchParams(location.search);
    const lat = p.get('lat'), lon = p.get('lon'), zoom = p.get('zoom'), chk = p.get('checked');
    if (lat && lon) {
        updateLatLonInputs(parseFloat(lat), parseFloat(lon));
        if (zoom) setZoomLevel(zoom);
        if (chk) chk.split(',').forEach(i => { const c = document.querySelector(`.map-checkbox[data-map-id="${i}"]`); if (c) c.checked = true; });
        history.replaceState(null, '', location.pathname);
        return true;
    }
    return false;
}
function convertUrlToTemplate() {
    const exampleUrl = document.getElementById('mylink-example-url').value.trim();
    if (!exampleUrl) {
        showNotification('URL„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }
    const coordRegex = /(-?\d+\.\d{4,})\D+(-?\d+\.\d{4,})/;
    const match = exampleUrl.match(coordRegex);
    if (match && match.length >= 3) {
        const num1Str = match[1];
        const num2Str = match[2];
        const num1 = parseFloat(num1Str);
        const num2 = parseFloat(num2Str);
        let latStr, lonStr;
        const isNum1Lat = num1 >= -90 && num1 <= 90;
        const isNum2Lon = num2 >= -180 && num2 <= 180;
        const isNum1Lon = num1 >= -180 && num1 <= 180;
        const isNum2Lat = num2 >= -90 && num2 <= 90;
        if (isNum1Lat && isNum2Lon) {
            latStr = num1Str;
            lonStr = num2Str;
        } else if (isNum1Lon && isNum2Lat) {
            lonStr = num1Str;
            latStr = num2Str;
        } else {
            showNotification('URL„Åã„ÇâÊúâÂäπ„Å™Á∑ØÂ∫¶ÁµåÂ∫¶„ÅÆ„Éö„Ç¢„ÇíÂà§ÂÆö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
            return;
        }
        let template = exampleUrl.replace(latStr, '{lat}');
        template = template.replace(lonStr, '{lon}');
        document.getElementById('mylink-url').value = template;
        showNotification('URL„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü„ÄÇ');
    } else {
        showNotification('URLÂÜÖ„Å´Á∑ØÂ∫¶ÁµåÂ∫¶„Çâ„Åó„ÅÑÊï∞ÂÄ§„ÅÆ„Éö„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
    }
}

function loadFavoriteSets() {
    const sets = getProjectData(FAVORITE_SETS_KEY) || {};
    const select = document.getElementById('favorite-sets');
    select.innerHTML = '<option value="">„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû...</option>';
    for (const setName in sets) {
        const option = document.createElement('option');
        option.value = setName;
        option.textContent = escapeXml(setName);
        select.appendChild(option);
    }
}

function applyFavoriteSet() {
    const sets = getProjectData(FAVORITE_SETS_KEY) || {};
    const select = document.getElementById('favorite-sets');
    const selectedSet = sets[select.value];
    if (selectedSet) {
        document.querySelectorAll('.map-checkbox').forEach(cb => {
            cb.checked = selectedSet.includes(cb.dataset.mapId);
        });
        showNotification(`„Çª„ÉÉ„Éà„Äå${select.value}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü„ÄÇ`);
    }
}

function openFavoriteSet() {
    const select = document.getElementById('favorite-sets');
    const setName = select.value;
    if (!setName) {
        showNotification('Èñã„Åç„Åü„ÅÑ„ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const sets = getProjectData(FAVORITE_SETS_KEY) || {};
    const mapIdsToOpen = sets[setName];

    if (!mapIdsToOpen || mapIdsToOpen.length === 0) {
        showNotification(`„Çª„ÉÉ„Éà„Äå${setName}„Äç„Å´Âú∞Âõ≥„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ`, 'error');
        return;
    }

    showNotification(`„Çª„ÉÉ„Éà„Äå${setName}„Äç„ÅÆÂú∞Âõ≥ ${mapIdsToOpen.length} ‰ª∂„ÇíÈñã„Åç„Åæ„Åô...`);
    const allMaps = getCombinedMapDefinitions();
    mapIdsToOpen.forEach(mapId => {
        const mapToOpen = allMaps.find(m => m.id === mapId);
        if (mapToOpen) {
            openMap(mapToOpen, false);
        }
    });
}

function saveFavoriteSet() {
    const setName = prompt('‰øùÂ≠ò„Åô„Çã„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
    if (!setName) return;

    const checkedIds = Array.from(document.querySelectorAll('.map-checkbox:checked')).map(cb => cb.dataset.mapId);
    if (checkedIds.length === 0) {
        showNotification('Âú∞Âõ≥„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }

    const sets = getProjectData(FAVORITE_SETS_KEY) || {};
    sets[setName] = checkedIds;
    setProjectData(FAVORITE_SETS_KEY, sets);
    loadFavoriteSets();
    document.getElementById('favorite-sets').value = setName;
    showNotification(`„Çª„ÉÉ„Éà„Äå${setName}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`);
}

function deleteFavoriteSet() {
    const select = document.getElementById('favorite-sets');
    const setName = select.value;
    if (!setName) {
        showNotification('ÂâäÈô§„Åô„Çã„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');return;
    }
    if (confirm(`„Çª„ÉÉ„Éà„Äå${setName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
        const sets = getProjectData(FAVORITE_SETS_KEY) || {};
        delete sets[setName];
        setProjectData(FAVORITE_SETS_KEY, sets);
        loadFavoriteSets();
        showNotification(`„Çª„ÉÉ„Éà„Äå${setName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
    }
}

function toggleRightPanel() {
    const rightPanel = document.querySelector('.right-panel');
    const btns = document.querySelectorAll('.js-toggle-panel-btn');
    const overlay = document.getElementById('panelOverlay');
    const isPinned = document.querySelector('.main-layout').classList.contains('pinned');
    const isOpening = rightPanel.classList.contains('hidden');

    if (isOpening && !isPinned) {
        if (window.innerWidth <= 768) {
            const mobileWidth = '90vw';
            rightPanel.style.width = mobileWidth;
            rightPanel.style.maxWidth = mobileWidth;
        } else {
            const activeTab = document.querySelector('.panel-tab.active');
            const activeTabId = activeTab ? activeTab.dataset.tab : 'map-links';
            const unpinnedWidths = currentSettings.unpinnedPanelWidths || defaultSettings.unpinnedPanelWidths;
            const newWidth = `${unpinnedWidths[activeTabId] || 500}px`;
            rightPanel.style.width = newWidth;
            rightPanel.style.maxWidth = '80vw';
        }
    } else if (!isOpening && !isPinned) {
        rightPanel.style.width = '';
        rightPanel.style.maxWidth = '';
    }

    rightPanel.classList.toggle('hidden');

    const isNowHidden = rightPanel.classList.contains('hidden');
    btns.forEach(btn => {
        btn.innerHTML = isNowHidden ? '‚óÄ' : '‚ñ∂';
        btn.title = isNowHidden ? '„Éë„Éç„É´„ÇíÈñã„Åè' : '„Éë„Éç„É´„ÇíÈñâ„Åò„Çã';
    });

    overlay.classList.toggle('show', !isNowHidden);

    setTimeout(() => {
        if (window.osmMap) window.osmMap.invalidateSize();
    }, 400);
}


function togglePinPanel() {
    const mainLayout = document.querySelector('.main-layout');
    const pinBtn = document.getElementById('pinPanelBtn');
    const rightPanel = document.querySelector('.right-panel');
    const toggleBtns = document.querySelectorAll('.js-toggle-panel-btn');
    const mainToggleBtnWrapper = document.getElementById('main-toggle-panel-btn-wrapper');

    const isPinned = mainLayout.classList.toggle('pinned');
    pinBtn.classList.toggle('pinned', isPinned);
    
    if (mainToggleBtnWrapper) {
        mainToggleBtnWrapper.style.display = isPinned ? 'none' : 'flex';
    }

    rightPanel.style.width = '';
    rightPanel.style.maxWidth = '';
    updatePanelWidth(currentSettings.panelWidth);

    toggleBtns.forEach(btn => {
        btn.disabled = isPinned;
        btn.title = isPinned ? '„Éë„Éç„É´„ÅØÂõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô' : '„Éë„Éç„É´„ÇíÈñã„Åè';
        if (!isPinned) btn.innerHTML = '‚óÄ';
    });

    if (isPinned) {
        pinBtn.innerHTML = 'üìç Âõ∫ÂÆö‰∏≠';
        pinBtn.title = '„Éë„Éç„É´„ÅÆÂõ∫ÂÆö„ÇíËß£Èô§';
    } else {
        pinBtn.innerHTML = 'üìå „Éî„É≥Áïô„ÇÅ';
        pinBtn.title = '„Éë„Éç„É´„ÇíÂõ∫ÂÆö';
    }

    if (isPinned) {
        rightPanel.classList.remove('hidden');
        document.getElementById('panelOverlay').classList.remove('show');
    } else {
        rightPanel.classList.add('hidden');
    }

    setTimeout(() => {
        if (window.osmMap) {
            window.osmMap.invalidateSize();
        }
    }, 450);
}

function initResizer() {
    const resizer = document.getElementById('resizer');
    const rightPanel = document.querySelector('.right-panel');
    const mainLayout = document.getElementById('mainLayout');

    resizer.addEventListener('mousedown', (e) => {
        e.preventDefault();
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';

        const mouseMoveHandler = (e) => {
            const newWidth = window.innerWidth - e.clientX;
            const minWidth = 320;
            const maxWidth = window.innerWidth * 0.8;

            if (newWidth >= minWidth && newWidth <= maxWidth) {
                updatePanelWidth(newWidth);
            }
        };

        const mouseUpHandler = () => {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            window.removeEventListener('mousemove', mouseMoveHandler);
            window.removeEventListener('mouseup', mouseUpHandler);
            
            currentSettings.panelWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--panel-width'));
            setProjectData(SETTINGS_KEY, currentSettings);
        };

        window.addEventListener('mousemove', mouseMoveHandler);
        window.addEventListener('mouseup', mouseUpHandler);
    });
}

function updatePanelWidth(newWidth) {
    const newWidthPx = `${newWidth}px`;
    document.documentElement.style.setProperty('--panel-width', newWidthPx);
    if (window.osmMap) {
        window.osmMap.invalidateSize();
    }
}

function exportData() {
    const checklist = document.getElementById('data-sync-checklist');
    const checkedItems = checklist.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkedItems.length === 0) {
        showNotification('Êõ∏„ÅçÂá∫„Åô„Éá„Éº„Çø„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const dataToExport = {};
    const activeData = getActiveProjectData();
    checkedItems.forEach(item => {
        const key = item.value;
        if (activeData.hasOwnProperty(key)) {
            dataToExport[key] = activeData[key];
        }
    });

    if (Object.keys(dataToExport).length === 0) {
        showNotification('ÈÅ∏Êäû„Åï„Çå„Åü„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
        return;
    }

    const jsonString = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    
    const filename = 'GeoLinkNavi_backup';
    const sanitizedFilename = filename.replace(/[^\w\s-]/gi, '_');
    a.download = `${sanitizedFilename}_${date}.json`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü„ÄÇ');
}

function importDataTrigger() {
    document.getElementById('import-file-input').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const checklist = document.getElementById('data-sync-checklist');
    const checkedItems = checklist.querySelectorAll('input[type="checkbox"]:checked');

    if (checkedItems.length === 0) {
        showNotification('Ë™≠„ÅøËæº„ÇÄ„Éá„Éº„Çø„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        event.target.value = '';
        return;
    }
    const keysToImport = Array.from(checkedItems).map(item => item.value);

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (confirm('„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÄÇ\nÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÄÅÈÅ∏Êäû„Åó„ÅüÈ†ÖÁõÆ„ÅÆÊó¢Â≠ò„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                let importedCount = 0;
                keysToImport.forEach(key => {
                    if (importedData.hasOwnProperty(key)) {
                        setProjectData(key, importedData[key]);
                        importedCount++;
                    }
                });

                if (importedCount > 0) {
                   alert(`${importedCount}ÂÄã„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ\n„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶Â§âÊõ¥„ÇíÈÅ©Áî®„Åó„Åæ„Åô„ÄÇ`);
                   location.reload();
                } else {
                   showNotification('„Éï„Ç°„Ç§„É´ÂÜÖ„Å´„ÄÅÈÅ∏Êäû„Åï„Çå„ÅüÂØæË±°„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                }
            }
        } catch (error) {
            showNotification('„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
            console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

function renderHistoryTable() {
    const historyData = getProjectData('coordinateHistory') || [];
    const filterText = document.getElementById('historySearchInput').value.toLowerCase();

    let filteredData = historyData.filter(item => {
        return (item.address && item.address.toLowerCase().includes(filterText)) ||
               (item.postcode && item.postcode.toLowerCase().includes(filterText)) ||
               (item.lat && item.lat.toLowerCase().includes(filterText)) ||
               (item.lon && item.lon.toLowerCase().includes(filterText));
    });

    filteredData.sort((a, b) => {
        const col = historySortState.column;
        const order = historySortState.order === 'asc' ? 1 : -1;
        
        let valA = a[col], valB = b[col];
        if (col === 'no') {
            valA = historyData.indexOf(a);
            valB = historyData.indexOf(b);
        } else if (col === 'lat' || col === 'lon' || col === 'elevation' || col === 'xy_x' || col === 'xy_y') {
            valA = parseFloat(valA) || -Infinity;
            valB = parseFloat(valB) || -Infinity;
        }

        if (valA < valB) return -1 * order;
        if (valA > valB) return 1 * order;
        return 0;
    });

    $historyTableBody.innerHTML = filteredData.map((item, index) => {
        const originalIndex = historyData.findIndex(h => h.timestamp === item.timestamp);
        return `
            <tr data-history-index="${originalIndex}">
                <td><input type="checkbox" class="history-item-checkbox" data-history-index="${originalIndex}" aria-label="Â±•Ê≠¥ No.${originalIndex + 1} „ÇíÈÅ∏Êäû"></td>
                <td>${originalIndex + 1}</td>
                <td>${sanitizeForHtml(item.postcode || '---')}</td>
<td>${sanitizeForHtml(item.address || '---')}</td>
                <td>${item.lat}</td>
                <td>${item.lon}</td>
                <td>${item.elevation}</td>
                <td>${item.xy_x || '---'}</td>
                <td>${item.xy_y || '---'}</td>
                <td>${(item.xy_system && item.xy_system !== '---') ? `${item.xy_system}Á≥ª` : '---'}</td>
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td class="actions-cell">
                    <button class="btn-action copy" title="„Åì„ÅÆË°å„Çí„Ç≥„Éî„Éº" aria-label="Â±•Ê≠¥ No.${originalIndex + 1} „Çí„Ç≥„Éî„Éº">üìã</button>
                    <button class="btn-action delete" title="„Åì„ÅÆË°å„ÇíÂâäÈô§" aria-label="Â±•Ê≠¥ No.${originalIndex + 1} „ÇíÂâäÈô§">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');

    if(filteredData.length === 0) {
        $historyTableBody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding: 20px;">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>`;
    }

    updateHistoryTableControls();
}

function handleHistoryTableClick(e) {
    const row = e.target.closest('tr');
    if (!row || !row.dataset.historyIndex) return;

    const historyIndex = parseInt(row.dataset.historyIndex, 10);
    let historyData = getProjectData('coordinateHistory') || [];
    const item = historyData[historyIndex];

    if (e.target.classList.contains('history-item-checkbox')) {
        updateHistoryTableControls();
        renderHistoryOnMap(); 
        return;
    }
    
    if (e.target.classList.contains('btn-action')) {
        if (e.target.classList.contains('copy')) {
            const rowData = [
                historyIndex + 1,
                item.postcode,
                item.address,
                item.lat,
                item.lon,
                item.elevation,
                item.xy_x,
                item.xy_y,
                item.xy_system,
                new Date(item.timestamp).toLocaleString()
            ].join('\t');
            navigator.clipboard.writeText(rowData).then(() => showNotification('Ë°å„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ'));
        } else if (e.target.classList.contains('delete')) {
            if (confirm(`Â±•Ê≠¥No.${historyIndex + 1}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                historyData.splice(historyIndex, 1);
                setProjectData('coordinateHistory', historyData);
                renderHistoryTable();
                renderHistoryList(historyData);
                renderHistoryOnMap();
                showNotification('Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
    } else {
        highlightHistoryTableRow(historyIndex);
        updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon));
        setZoomLevel(item.zoom);
        updateCurrentCoords({lat: parseFloat(item.lat), lon: parseFloat(item.lon)}, true);
        showNotification(`Â±•Ê≠¥No.${historyIndex + 1}„ÅÆÂ∫ßÊ®ô„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇ`);
        if (!document.querySelector('.main-layout').classList.contains('pinned')) {
            toggleRightPanel();
        }
    }
}

function updateHistoryTableControls() {
    const selectedCheckboxes = document.querySelectorAll('.history-item-checkbox:checked');
    const hasSelection = selectedCheckboxes.length > 0;
    document.getElementById('btn-copy-selected-history').disabled = !hasSelection;
    document.getElementById('btn-delete-selected-history').disabled = !hasSelection;

    const allCheckboxes = document.querySelectorAll('.history-item-checkbox');
    const selectAllCheckbox = document.getElementById('history-select-all');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length;
}

function setZoomLevel(zoom) {
    const zoomVal = parseInt(zoom, 10);
    if (isNaN(zoomVal)) return;

    $zoom.value = zoomVal;
    $zoomDisplay.textContent = zoomVal;
    // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£„ÅÆÂá¶ÁêÜ„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
    // $currentZoom.textContent = zoomVal;
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤
}

function highlightHistoryTableRow(historyIndex) {
    document.querySelectorAll('#historyTableBody tr').forEach(row => {
        row.style.backgroundColor = '';
    });

    const targetRow = document.querySelector(`#historyTableBody tr[data-history-index="${historyIndex}"]`);
    if (targetRow) {
        targetRow.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
        
        const wrapper = document.querySelector('#history-content .table-wrapper');
        const header = document.querySelector('#historyTable thead');
        
        if (wrapper && header) {
            const headerHeight = header.offsetHeight;
            
            const rowTopRelativeToWrapper = targetRow.getBoundingClientRect().top - wrapper.getBoundingClientRect().top;

            const scrollToPosition = wrapper.scrollTop + rowTopRelativeToWrapper - headerHeight;

            wrapper.scrollTo({
                top: scrollToPosition,
                behavior: 'smooth'
            });
        }
    }
}

function renderHistoryOnMap() {
    if (!osmMap || !historyLayer) return;

    if (!isHistoryVisibleOnMap) {
        historyLayer.clearLayers();
        return;
    }

    const allHistoryData = getProjectData('coordinateHistory') || [];
    const selectedCheckboxes = document.querySelectorAll('.history-item-checkbox:checked');
    let dataToShow = [];

    if (selectedCheckboxes.length > 0) {
        const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.historyIndex, 10));
        dataToShow = allHistoryData.filter((_, index) => selectedIndices.includes(index));
    } else {
        dataToShow = allHistoryData;
    }
    
    const currentPosString = `${currentLatLon.lat.toFixed(8)},${currentLatLon.lon.toFixed(8)}`;
    const idsToShow = new Set();

    dataToShow.forEach(item => {
        const itemPosString = `${parseFloat(item.lat).toFixed(8)},${parseFloat(item.lon).toFixed(8)}`;
        if (itemPosString !== currentPosString) {
            idsToShow.add(item.timestamp);
        }
    });

    const existingMarkers = new Map();
    historyLayer.eachLayer(layer => {
        if (layer.options.historyId) {
            existingMarkers.set(layer.options.historyId, layer);
        }
    });

    existingMarkers.forEach((layer, id) => {
        if (!idsToShow.has(id)) {
            historyLayer.removeLayer(layer);
        }
    });

    dataToShow.forEach(item => {
        if (idsToShow.has(item.timestamp) && !existingMarkers.has(item.timestamp)) {
            const originalIndex = allHistoryData.findIndex(h => h.timestamp === item.timestamp);
            const itemLat = parseFloat(item.lat);
            const itemLon = parseFloat(item.lon);
            if (isNaN(itemLat) || isNaN(itemLon)) return;

            const historyMarker = L.circleMarker([itemLat, itemLon], {
                radius: 7,
                fillColor: "#3498db",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
                historyId: item.timestamp 
            }).addTo(historyLayer);

            historyMarker.bindPopup(`<b>Â±•Ê≠¥ No.${originalIndex + 1}</b><br>${escapeXml(item.address || '---')}<br><small>${item.lat}, ${item.lon}</small>`);
            
            historyMarker.on('click', () => {
                highlightHistoryTableRow(originalIndex);
                updateLatLonInputs(itemLat, itemLon);
                updateCurrentCoords({lat: itemLat, lon: itemLon}, true);
            });
        }
    });
}
function renderBookmarkTable() {
    const bookmarkData = getProjectData(BOOKMARK_KEY) || [];
    const filterText = document.getElementById('bookmarkSearchInput').value.toLowerCase();

    let filteredData = bookmarkData.filter(item => 
        (item.name && item.name.toLowerCase().includes(filterText)) ||
        (item.address && item.address.toLowerCase().includes(filterText)) ||
        (item.postcode && item.postcode.toLowerCase().includes(filterText))
    );

    filteredData.sort((a, b) => {
        const col = bookmarkSortState.column;
        const order = bookmarkSortState.order === 'asc' ? 1 : -1;
        
        let valA = a[col], valB = b[col];
        if (col === 'no') {
            valA = bookmarkData.indexOf(a);
            valB = bookmarkData.indexOf(b);
        } else if (col === 'lat' || col === 'lon' || col === 'elevation' || col === 'xy_x' || col === 'xy_y') {
            valA = parseFloat(valA) || -Infinity;
            valB = parseFloat(valB) || -Infinity;
        }

        if (valA < valB) return -1 * order;
        if (valA > valB) return 1 * order;
        return 0;
    });

    $bookmarkTableBody.innerHTML = filteredData.map(item => {
        const originalIndex = bookmarkData.findIndex(b => b.timestamp === item.timestamp);
        return `
           <tr data-bookmark-index="${originalIndex}">
    <td><input type="checkbox" class="bookmark-item-checkbox" data-bookmark-index="${originalIndex}" aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äå${sanitizeForHtml(item.name)}„Äç„ÇíÈÅ∏Êäû"></td>
                <td>${originalIndex + 1}</td>
                <td>${sanitizeForHtml(item.name)}</td>
<td>${sanitizeForHtml(item.postcode || '---')}</td>
<td>${sanitizeForHtml(item.address || '---')}</td>
                <td>${item.lat}</td>
                <td>${item.lon}</td>
                <td>${item.elevation}</td>
                <td>${item.xy_x || '---'}</td>
                <td>${item.xy_y || '---'}</td>
                <td>${(item.xy_system && item.xy_system !== '---') ? `${item.xy_system}Á≥ª` : '---'}</td>
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td class="actions-cell">
<button class="btn-action copy" title="„Åì„ÅÆË°å„Çí„Ç≥„Éî„Éº" aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äå${sanitizeForHtml(item.name)}„Äç„Çí„Ç≥„Éî„Éº">üìã</button>
<button class="btn-action delete" title="„Åì„ÅÆË°å„ÇíÂâäÈô§" aria-label="„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äå${sanitizeForHtml(item.name)}„Äç„ÇíÂâäÈô§">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
    
    if(filteredData.length === 0) {
        $bookmarkTableBody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding: 20px;">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>`;
    }

    updateBookmarkTableControls();
}

function handleBookmarkTableClick(e) {
    const row = e.target.closest('tr');
    if (!row || !row.dataset.bookmarkIndex) return;
    const bookmarkIndex = parseInt(row.dataset.bookmarkIndex, 10);
    let bookmarkData = getProjectData(BOOKMARK_KEY) || [];
    const item = bookmarkData[bookmarkIndex];
    if (!item) return;

    if (e.target.classList.contains('bookmark-item-checkbox')) {
        updateBookmarkTableControls();
        renderBookmarksOnMap();
        return;
    }
    
    if (e.target.classList.contains('btn-action')) {
        if (e.target.classList.contains('copy')) {
            const rowData = [
                bookmarkIndex + 1, 
                item.name, 
                item.postcode,
                item.address,
                item.lat, 
                item.lon, 
                item.elevation,
                item.xy_x,
                item.xy_y,
                item.xy_system,
                new Date(item.timestamp).toLocaleString()
            ].join('\t');
            navigator.clipboard.writeText(rowData).then(() => showNotification('Ë°å„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ'));
        } else if (e.target.classList.contains('delete')) {
            if (confirm(`„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äå${item.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                bookmarkData.splice(bookmarkIndex, 1);
                setProjectData(BOOKMARK_KEY, bookmarkData);
                renderBookmarkTable();
                renderBookmarkList();
                renderBookmarksOnMap();
                showNotification('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
    } else {
        highlightBookmarkTableRow(bookmarkIndex);
        updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon));
        setZoomLevel(item.zoom);
        updateCurrentCoords({lat: parseFloat(item.lat), lon: parseFloat(item.lon)}, true);
        showNotification(`„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Äå${item.name}„Äç„ÅÆÂ∫ßÊ®ô„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇ`);
        if (!document.querySelector('.main-layout').classList.contains('pinned')) {
            toggleRightPanel();
        }
    }
}
function updateBookmarkTableControls() {
    const selectedCheckboxes = document.querySelectorAll('.bookmark-item-checkbox:checked');
    const hasSelection = selectedCheckboxes.length > 0;
    document.getElementById('btn-copy-selected-bookmarks').disabled = !hasSelection;
    document.getElementById('btn-delete-selected-bookmarks').disabled = !hasSelection;

    const allCheckboxes = document.querySelectorAll('.bookmark-item-checkbox');
    const selectAllCheckbox = document.getElementById('bookmark-select-all');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length;
}

function initTabDragAndDrop() {
    const tabsContainer = document.getElementById('panelTabs');
    tabsContainer.addEventListener('dragstart', e => {
        if (e.target.classList.contains('panel-tab')) {
            e.target.classList.add('dragging');
        }
    });

    tabsContainer.addEventListener('dragend', e => {
        if (e.target.classList.contains('panel-tab')) {
            e.target.classList.remove('dragging');
            saveTabOrder();
        }
    });

    tabsContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const draggingTab = tabsContainer.querySelector('.dragging');
        if (!draggingTab) return;

        const afterElement = getDragAfterElement(tabsContainer, e.clientX);
        if (afterElement == null) {
            tabsContainer.appendChild(draggingTab);
        } else {
            tabsContainer.insertBefore(draggingTab, afterElement);
        }
    });

    function getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('.panel-tab:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
}

function saveTabOrder() {
    const tabsContainer = document.getElementById('panelTabs');
    const contentContainer = document.getElementById('panelContentWrapper');
    const newOrder = [...tabsContainer.querySelectorAll('.panel-tab')].map(tab => tab.dataset.tab);
    setProjectData(TAB_ORDER_KEY, newOrder);

    newOrder.forEach((tabKey, index) => {
        const contentEl = contentContainer.querySelector(`[data-tab-content="${tabKey}"]`);
        if(contentEl) contentEl.style.order = index;
    });
}
function loadTabOrder() {
    const savedOrder = getProjectData(TAB_ORDER_KEY);
    if (savedOrder && Array.isArray(savedOrder)) {
        const tabsContainer = document.getElementById('panelTabs');
        const contentContainer = document.getElementById('panelContentWrapper');
        
        savedOrder.forEach((tabKey, index) => {
            const tabEl = tabsContainer.querySelector(`[data-tab="${tabKey}"]`);
            if (tabEl) tabsContainer.appendChild(tabEl);

            const contentEl = contentContainer.querySelector(`[data-tab-content="${tabKey}"]`);
            if (contentEl) contentEl.style.order = index;
        });
    }
}

function highlightBookmarkTableRow(bookmarkIndex) {
    document.querySelectorAll('#bookmarkTableBody tr').forEach(row => {
        row.style.backgroundColor = '';
    });
    const targetRow = document.querySelector(`#bookmarkTableBody tr[data-bookmark-index="${bookmarkIndex}"]`);
    if (targetRow) {
        targetRow.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
        const wrapper = document.querySelector('#bookmarks-content .table-wrapper');
        const header = document.querySelector('#bookmarkTable thead');
        const headerHeight = header ? header.offsetHeight : 0;
        const scrollToPosition = targetRow.offsetTop - headerHeight;
        wrapper.scrollTo({
            top: scrollToPosition,
            behavior: 'smooth'
        });
    }
}

function renderBookmarksOnMap() {
    if (!osmMap || !bookmarkLayer) return;

    if (!isBookmarksVisibleOnMap) {
        bookmarkLayer.clearLayers();
        return;
    }

    const allBookmarkData = getProjectData(BOOKMARK_KEY) || [];
    const selectedCheckboxes = document.querySelectorAll('.bookmark-item-checkbox:checked');
    let dataToShow = [];

    if (selectedCheckboxes.length > 0) {
        const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.bookmarkIndex, 10));
        dataToShow = allBookmarkData.filter((_, index) => selectedIndices.includes(index));
    } else {
        dataToShow = allBookmarkData;
    }
    
    const idsToShow = new Set(dataToShow.map(item => item.timestamp));

    const existingMarkers = new Map();
    bookmarkLayer.eachLayer(layer => {
        if (layer.options.bookmarkId) {
            existingMarkers.set(layer.options.bookmarkId, layer);
        }
    });

    existingMarkers.forEach((layer, id) => {
        if (!idsToShow.has(id)) {
            bookmarkLayer.removeLayer(layer);
        }
    });

    dataToShow.forEach(item => {
        if (idsToShow.has(item.timestamp) && !existingMarkers.has(item.timestamp)) {
            const originalIndex = allBookmarkData.findIndex(b => b.timestamp === item.timestamp);
            const itemLat = parseFloat(item.lat);
            const itemLon = parseFloat(item.lon);
            if (isNaN(itemLat) || isNaN(itemLon)) return;

            const bookmarkMarker = L.marker([itemLat, itemLon], {
                bookmarkId: item.timestamp
            }).addTo(bookmarkLayer);

            bookmarkMarker.bindPopup(`<b>‚≠ê ${escapeXml(item.name)}</b><br>${escapeXml(item.address || '---')}<br><small>${item.lat}, ${item.lon}</small>`);
            
            bookmarkMarker.on('click', () => {
                highlightBookmarkTableRow(originalIndex);
                updateLatLonInputs(itemLat, itemLon);
                updateCurrentCoords({lat: itemLat, lon: itemLon}, true);
            });
        }
    });
}
async function loadChartJS() {
  if (window.Chart) return;
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„É©„Ç§„Éñ„É©„É™„ÅÆÂãïÁöÑË™≠„ÅøËæº„ÅøÁî®Èñ¢Êï∞ ‚ñº‚ñº‚ñº
function loadScript(src) {
    return new Promise((resolve, reject) => {
        // Âêå„Åò„Çπ„ÇØ„É™„Éó„Éà„ÅåÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
    });
}

async function loadQrCodeJs() {
    if (typeof QRCode === 'undefined') {
        await loadScript('https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js');
    }
}

async function loadPapaParse() {
    if (typeof Papa === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js');
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

function initCategoryDragAndDrop() {
    const container = document.getElementById('map-categories-container');
    let draggingEle = null;

    container.addEventListener('dragstart', (e) => {
        // „Éâ„É©„ÉÉ„Ç∞„ÅåÂú∞Âõ≥„Ç´„Éº„Éâ„Åã„ÇâÈñãÂßã„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åì„ÅÆÈñ¢Êï∞„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        // („Ç´„Éº„ÉâÁßªÂãïÁî®„ÅÆÂà•„ÅÆÈñ¢Êï∞„Å´Âá¶ÁêÜ„Çí‰ªª„Åõ„Çã)
        if (e.target.closest('.map-card')) {
            return;
        }
        
        // „Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥ÂêàÔºàÔºù„Ç´„ÉÜ„Ç¥„É™„Éò„ÉÉ„ÉÄ„Éº„Å™„Å©„Åå„Éâ„É©„ÉÉ„Ç∞„Åï„Çå„ÅüÂ†¥ÂêàÔºâ„ÅÆ„ÅøÂá¶ÁêÜ„ÇíÁ∂öË°å
        const targetCategory = e.target.closest('.category');
        if (targetCategory) {
            draggingEle = targetCategory;
            setTimeout(() => {
                if (draggingEle) draggingEle.classList.add('dragging');
            }, 0);
        }
    });

    container.addEventListener('dragend', (e) => {
        if (draggingEle) {
            draggingEle.classList.remove('dragging');
            draggingEle = null;
            saveCategoryOrder();
        }
    });

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterCategory(container, e.clientY);
        if (draggingEle) {
             if (afterElement == null) {
                container.appendChild(draggingEle);
            } else {
                container.insertBefore(draggingEle, afterElement);
            }
        }
    });
}

function getDragAfterCategory(container, y) {
    const draggableElements = [...container.querySelectorAll('.category:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function saveCategoryOrder() {
    const newOrder = [...document.querySelectorAll('#map-categories-container .category')].map(cat => cat.dataset.categoryKey);
    currentSettings.categoryOrder = newOrder;
    setProjectData(SETTINGS_KEY, currentSettings);
    showNotification('„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰∏¶„Å≥È†Ü„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
}

function initCardDragAndDrop() {
    const container = document.getElementById('map-categories-container');
    let draggingCard = null;

    container.addEventListener('dragstart', (e) => {
        const target = e.target.closest('.map-card');
        if (target) {
            draggingCard = target;
            setTimeout(() => { if (draggingCard) draggingCard.classList.add('dragging'); }, 0);
        }
    });

    container.addEventListener('dragend', () => {
        if (draggingCard) draggingCard.classList.remove('dragging');
        draggingCard = null;
        document.querySelectorAll('.category.drag-over, .map-card.drop-indicator-before').forEach(el => {
            el.classList.remove('drag-over', 'drop-indicator-before');
        });
    });

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const targetCategory = e.target.closest('.category');
        if (!targetCategory || !draggingCard) return;
        
        // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„ÅØ„Éâ„É©„ÉÉ„Ç∞„Åß„Åç„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã ‚ñº‚ñº‚ñº
        if (draggingCard.dataset.category === 'liaison' && !draggingCard.dataset.mapId.startsWith('gmap_search_')) {
             return;
        }
        // ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

        document.querySelectorAll('.category:not(.drag-over)').forEach(cat => cat.classList.remove('drag-over'));
        targetCategory.classList.add('drag-over');

        const grid = targetCategory.querySelector('.map-grid');
        const afterElement = getDragAfterCard(grid, e.clientY);

        document.querySelectorAll('.map-card.drop-indicator-before').forEach(card => card.classList.remove('drop-indicator-before'));
        if (afterElement) {
            afterElement.classList.add('drop-indicator-before');
        }
    });

    container.addEventListener('drop', (e) => {
        e.preventDefault();
        const targetCategoryElement = e.target.closest('.category');
        if (!targetCategoryElement || !draggingCard) return;

        const grid = targetCategoryElement.querySelector('.map-grid');
        const afterElement = getDragAfterCard(grid, e.clientY);
        
        if (afterElement) {
            grid.insertBefore(draggingCard, afterElement);
        } else {
            const addBtn = grid.querySelector('.btn-add-mylink, .btn-add-emergency-search');
            if (addBtn) grid.insertBefore(draggingCard, addBtn);
            else grid.appendChild(draggingCard);
        }
        
        const newCategoryKey = targetCategoryElement.dataset.categoryKey;
        draggingCard.dataset.category = newCategoryKey;

        const allMaps = getCombinedMapDefinitions();
        const mapId = draggingCard.dataset.mapId;
        const movedMap = allMaps.find(m => m.id === mapId);

        if (movedMap?.isCustom) {
            const mylinks = getProjectData(MYLINK_KEY) || [];
            const linkToUpdate = mylinks.find(l => l.id === mapId);
            if (linkToUpdate) linkToUpdate.category = newCategoryKey;
            setProjectData(MYLINK_KEY, mylinks);
        } else {
            if (!currentSettings.mapCategoryOverrides) currentSettings.mapCategoryOverrides = {};
            currentSettings.mapCategoryOverrides[mapId] = newCategoryKey;
        }

        saveMapOrderInCategory(newCategoryKey);
        const oldCategoryKey = draggingCard.dataset.category;
        if (oldCategoryKey !== newCategoryKey) {
            saveMapOrderInCategory(oldCategoryKey);
        }

        showNotification(`„Äå${draggingCard.querySelector('.map-title').textContent.trim()}„Äç„ÇíÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇ`);
        document.querySelectorAll('.category.drag-over, .map-card.drop-indicator-before').forEach(el => {
            el.classList.remove('drag-over', 'drop-indicator-before');
        });
    });
}

function getDragAfterCard(container, y) {
    const draggableElements = [...container.querySelectorAll('.map-card:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function saveMapOrderInCategory(categoryKey) {
    const categoryElement = document.querySelector(`.category[data-category-key="${categoryKey}"]`);
    if (!categoryElement) return;

    const grid = categoryElement.querySelector('.map-grid');
    const newOrder = [...grid.querySelectorAll('.map-card')].map(card => card.dataset.mapId);
    
    if (!currentSettings.mapOrderInCategory) {
        currentSettings.mapOrderInCategory = {};
    }
    currentSettings.mapOrderInCategory[categoryKey] = newOrder;
    setProjectData(SETTINGS_KEY, currentSettings);
}

async function openCoordConverterModal() {
    const lat = isDMSFormat ? dmsToDecimal($lat.value) : parseFloat($lat.value);
    const lon = isDMSFormat ? dmsToDecimal($lon.value) : parseFloat($lon.value);

    const warningDiv = document.getElementById('crustal-deformation-warning');
    const detailsP = document.getElementById('deformation-details');
    
    warningDiv.style.display = 'none';
    detailsP.innerHTML = '';

    if (!isNaN(lat) && !isNaN(lon)) {
        // Âú∞ÊÆªÂ§âÂãï„Ç®„É™„Ç¢„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàÁµêÊûú„ÅØÈÖçÂàó„ÅßËøî„Å£„Å¶„Åè„ÇãÔºâ
        const deformationInfo = await checkCrustalDeformation(lat, lon);
        
        // ÈÖçÂàó„Å´1„Å§‰ª•‰∏ä„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞Ë≠¶Âëä„ÇíË°®Á§∫
        if (deformationInfo && deformationInfo.length > 0) {
            let messageHtml;

            if (deformationInfo.length === 1) {
                // Ë©≤ÂΩì„Åå1„Å§„ÅÆÂ†¥Âêà
                messageHtml = `ÁèæÂú®„ÅÆÂ∫ßÊ®ô„ÅØ„Äå<strong>${deformationInfo[0]}</strong>„Äç„ÅÆÂú∞ÊÆªÂ§âÂãï„Åå„ÅÇ„Å£„Åü„Ç®„É™„Ç¢„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`;
            } else {
                // Ë©≤ÂΩì„ÅåË§áÊï∞„ÅÆÂ†¥Âêà
                messageHtml = 'ÁèæÂú®„ÅÆÂ∫ßÊ®ô„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆË§áÊï∞„ÅÆÂú∞Èúá„Å´„Çà„ÇãÂú∞ÊÆªÂ§âÂãï„Åå„ÅÇ„Å£„Åü„Ç®„É™„Ç¢„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„ÅôÔºö' +
                              '<ul style="margin: 8px 0 0 20px; padding: 0;">' +
                              deformationInfo.map(name => `<li><strong>${name}</strong></li>`).join('') +
                              '</ul>';
            }
            
            // ÂÖ±ÈÄö„ÅÆÊ≥®ÊÑèÊñá„ÇíËøΩÂä†
            messageHtml += '<p style="margin-top: 10px;">Â∫ßÊ®ôÂ§âÊèõ„ÅÆÈöõ„ÅØ„ÄÅÂõΩÂúüÂú∞ÁêÜÈô¢„ÅÆ„Çµ„Ç§„Éà„ÅßË©≤ÂΩì„Åô„Çã<strong>Â∫ßÊ®ôË£úÊ≠£„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´</strong>„ÇíÈÅ©Áî®„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            
            detailsP.innerHTML = messageHtml;
            warningDiv.style.display = 'block';
        }
    }
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

    document.getElementById('conv-lat').value = isNaN(lat) ? '' : lat.toFixed(8);
    document.getElementById('conv-lon').value = isNaN(lon) ? '' : lon.toFixed(8);
    document.getElementById('conv-x').value = '';
    document.getElementById('conv-y').value = '';
    
    await updateSelectorsByCoords(lat, lon);
    
    document.getElementById('coord-converter-modal').style.display = 'flex';
}

function closeCoordConverterModal() {
    document.getElementById('coord-converter-modal').style.display = 'none';
}

function convertToXY() {
    try {
        const latInput = document.getElementById('conv-lat').value;
        const lonInput = document.getElementById('conv-lon').value;
        const epsg = document.getElementById('conv-zone').value;

        const isDmsLat = /[¬∞'"NSEW]/i.test(latInput);
        const isDmsLon = /[¬∞'"NSEW]/i.test(lonInput);

        const lat = isDmsLat ? dmsToDecimal(latInput) : parseFloat(latInput);
        const lon = isDmsLon ? dmsToDecimal(lonInput) : parseFloat(lonInput);

        if (isNaN(lat) || isNaN(lon) || !epsg) {
            throw new Error('Á∑ØÂ∫¶„ÄÅÁµåÂ∫¶„ÄÅÂ∫ßÊ®ôÁ≥ª„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }

        const [y, x] = proj4('EPSG:4326', `EPSG:${epsg}`, [lon, lat]);
        document.getElementById('conv-x').value = x.toFixed(4);
        document.getElementById('conv-y').value = y.toFixed(4);
        showNotification('XYÂ∫ßÊ®ô„Å´Â§âÊèõ„Åó„Åæ„Åó„Åü„ÄÇ');
    } catch (e) {
        showNotification(`Â§âÊèõ„Ç®„É©„Éº: ${e.message}`, 'error');
    }
}

async function convertToLatLon() {
    try {
        const x = parseFloat(document.getElementById('conv-x').value);
        const y = parseFloat(document.getElementById('conv-y').value);
        const epsg = document.getElementById('conv-zone').value;

        if (isNaN(x) || isNaN(y) || !epsg) {
            throw new Error('XÂ∫ßÊ®ô„ÄÅYÂ∫ßÊ®ô„ÄÅÂ∫ßÊ®ôÁ≥ª„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }

        const [lon, lat] = proj4(`EPSG:${epsg}`, 'EPSG:4326', [y, x]);
        document.getElementById('conv-lat').value = lat.toFixed(8);
        document.getElementById('conv-lon').value = lon.toFixed(8);
        
        await updateSelectorsByCoords(lat, lon);

        showNotification('Á∑ØÂ∫¶ÁµåÂ∫¶„Å´Â§âÊèõ„Åó„Åæ„Åó„Åü„ÄÇ');
    } catch (e) {
        showNotification(`Â§âÊèõ„Ç®„É©„Éº: ${e.message}`, 'error');
    }
}

function applyConverterResult() {
    const lat = parseFloat(document.getElementById('conv-lat').value);
    const lon = parseFloat(document.getElementById('conv-lon').value);

    if (isNaN(lat) || isNaN(lon)) {
        showNotification('„É°„Ç§„É≥ÁîªÈù¢„Å´ÂèçÊò†„Åß„Åç„ÇãÊúâÂäπ„Å™Á∑ØÂ∫¶ÁµåÂ∫¶„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }

    updateLatLonInputs(lat, lon);
    updateCurrentCoords({ lat, lon });
    closeCoordConverterModal();
    showNotification('Â§âÊèõÁµêÊûú„Çí„É°„Ç§„É≥ÁîªÈù¢„Å´ÂèçÊò†„Åó„Åæ„Åó„Åü„ÄÇ');
}

function initCoordConverter() {
    const zoneSelect = document.getElementById('conv-zone');
    coordinateSystems.forEach(sys => {
        const option = document.createElement('option');
        option.value = sys.epsg;
        option.textContent = `${sys.num}Á≥ª`;
        zoneSelect.appendChild(option);
    });
    
    const prefSelect = document.getElementById('conv-pref');
    PREFECTURE_ORDER.forEach(p => {
        const o = document.createElement('option'); o.value = p; o.textContent = p; prefSelect.appendChild(o);
    });

    document.getElementById('btn-open-coord-converter').addEventListener('click', openCoordConverterModal);
    document.getElementById('coord-converter-close-btn').addEventListener('click', closeCoordConverterModal);
    document.getElementById('btn-convert-to-xy').addEventListener('click', convertToXY);
    document.getElementById('btn-convert-to-latlon').addEventListener('click', convertToLatLon);
    document.getElementById('btn-apply-coords').addEventListener('click', applyConverterResult);
    document.getElementById('btn-copy-conv-result').addEventListener('click', copyConverterResult);
    document.getElementById('btn-conv-to-dec').addEventListener('click', () => toggleConvFormat('decimal'));
    document.getElementById('btn-conv-to-dms').addEventListener('click', () => toggleConvFormat('dms'));
    prefSelect.addEventListener('change', updateZoneSelectByPref);
    
    document.getElementById('btn-get-main-coords').addEventListener('click', () => {
         const lat = isDMSFormat ? dmsToDecimal($lat.value) : parseFloat($lat.value);
         const lon = isDMSFormat ? dmsToDecimal($lon.value) : parseFloat($lon.value);
         document.getElementById('conv-lat').value = isNaN(lat) ? '' : lat.toFixed(8);
         document.getElementById('conv-lon').value = isNaN(lon) ? '' : lon.toFixed(8);
         showNotification('„É°„Ç§„É≥ÁîªÈù¢„ÅÆÂ∫ßÊ®ô„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü„ÄÇ');
    });


    document.getElementById('btn-open-gsi-bl2xy').addEventListener('click', () => {
        const url = 'https://vldb.gsi.go.jp/sokuchi/surveycalc/surveycalc/bl2xyf.html';
        try {
            const latValue = parseFloat(document.getElementById('conv-lat').value);
            const lonValue = parseFloat(document.getElementById('conv-lon').value);

            if (isNaN(latValue) || isNaN(lonValue)) {
                throw new Error('ÊúâÂäπ„Å™Á∑ØÂ∫¶ÁµåÂ∫¶„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            }

            const textToCopy = `${decimalToGsiDms(latValue)}\n${decimalToGsiDms(lonValue)}`;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                window.open(url, '_blank');
                showNotification('Á∑ØÂ∫¶ÁµåÂ∫¶„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇÂú∞ÁêÜÈô¢„Çµ„Ç§„Éà„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }).catch(err => {
                showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Ç§„Éà„ÅÆ„ÅøÈñã„Åç„Åæ„Åô„ÄÇ', 'error');
                window.open(url, '_blank');
            });
        } catch(e) {
            showNotification(e.message, 'error');
            window.open(url, '_blank');
        }
    });

    document.getElementById('btn-open-gsi-xy2bl').addEventListener('click', () => {
        const url = 'https://vldb.gsi.go.jp/sokuchi/surveycalc/surveycalc/xy2blf.html';
        try {
            const xValue = document.getElementById('conv-x').value;
            const yValue = document.getElementById('conv-y').value;
            const zoneSelect = document.getElementById('conv-zone');
            const systemNum = zoneSelect.options[zoneSelect.selectedIndex].textContent.replace('Á≥ª', '');

            if (xValue.trim() === '' || yValue.trim() === '' || !systemNum) {
                throw new Error('ÊúâÂäπ„Å™XYÂ∫ßÊ®ô„Å®Â∫ßÊ®ôÁ≥ª„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            }

            const textToCopy = `${yValue}\n${xValue}\n${systemNum}`;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                window.open(url, '_blank');
                showNotification('XYÂ∫ßÊ®ô„Å®Á≥ªÁï™Âè∑„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇÂú∞ÁêÜÈô¢„Çµ„Ç§„Éà„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }).catch(err => {
                showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Ç§„Éà„ÅÆ„ÅøÈñã„Åç„Åæ„Åô„ÄÇ', 'error');
                window.open(url, '_blank');
            });
        } catch(e) {
            showNotification(e.message, 'error');
            window.open(url, '_blank');
        }
    });

}

function toggleConvFormat(toFormat) {
    const latInput = document.getElementById('conv-lat');
    const lonInput = document.getElementById('conv-lon');
    try {
        if (toFormat === 'dms') {
            if (/[¬∞'"]/.test(latInput.value) || /[¬∞'"]/.test(lonInput.value)) { return; }
            latInput.value = decimalToDMS(parseFloat(latInput.value), true);
            lonInput.value = decimalToDMS(parseFloat(lonInput.value), false);
        } else {
            if (!/[¬∞'"]/.test(latInput.value) && !/[¬∞'"]/.test(lonInput.value)) { return; }
            latInput.value = dmsToDecimal(latInput.value).toFixed(8);
            lonInput.value = dmsToDecimal(lonInput.value).toFixed(8);
        }
    } catch (e) {
        showNotification('ÊúâÂäπ„Å™Â∫ßÊ®ô„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
    }
}

function updateZoneSelectByPref() {
    const pref = document.getElementById('conv-pref').value;
    const systemsForPref = prefectureToSystem[pref] || [];
    const zoneSelect = document.getElementById('conv-zone');
    let firstVisibleOption = null;

    for (const option of zoneSelect.options) {
        const systemNum = parseInt(option.textContent, 10);
        const shouldShow = pref === "" || systemsForPref.includes(systemNum);
        option.style.display = shouldShow ? '' : 'none';
        if (shouldShow && !firstVisibleOption) {
            firstVisibleOption = option;
        }
    }
    if (zoneSelect.selectedOptions.length > 0 && zoneSelect.selectedOptions[0].style.display === 'none') {
        if (firstVisibleOption) {
            zoneSelect.value = firstVisibleOption.value;
        }
    }
}

async function updateSelectorsByCoords(lat, lon) {
    const prefSelect = document.getElementById('conv-pref');
    const zoneSelect = document.getElementById('conv-zone');

    if (isNaN(lat) || isNaN(lon)) {
        prefSelect.value = "";
        updateZoneSelectByPref();
        return;
    };

    const addressInfo = await getAddressFromCoords(lat, lon);
    const prefecture = addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/) ? addressInfo.structured.match(/^.{2,3}[ÈÉΩÈÅìÂ∫úÁúå]/)[0] : null;

    if (prefecture && prefSelect.querySelector(`option[value="${prefecture}"]`)) {
        prefSelect.value = prefecture;
    } else {
        prefSelect.value = "";
    }
    
    updateZoneSelectByPref();

    let min = Infinity, bestSys = null;
    for (const s of coordinateSystems) {
        const d = Math.sqrt(Math.pow(lat - s.lat0, 2) + Math.pow((lon - s.lon0) * Math.cos(lat * Math.PI / 180), 2));
        if (d < min) { min = d; bestSys = s; }
    }
    
    if (bestSys) {
        if (zoneSelect.querySelector(`option[value="${bestSys.epsg}"]`)) {
             zoneSelect.value = bestSys.epsg;
        }
    }
}

function copyConverterResult() {
    try {
        const zoneSelect = document.getElementById('conv-zone');
        const selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
        const epsg = selectedOption.value;
        const systemText = selectedOption.textContent;
        const x = document.getElementById('conv-x').value;
        const y = document.getElementById('conv-y').value;
        const latDec = parseFloat(document.getElementById('conv-lat').value);
        const lonDec = parseFloat(document.getElementById('conv-lon').value);

        if (!epsg || x === '' || y === '' || isNaN(latDec) || isNaN(lonDec)) {
            throw new Error('„Ç≥„Éî„Éº„Åô„ÇãÊúâÂäπ„Å™Â§âÊèõÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
        }

        const latDms = decimalToDMS(latDec, true);
        const lonDms = decimalToDMS(lonDec, false);

        const textToCopy = `Â∫ßÊ®ôÁ≥ª: ${systemText} (EPSG:${epsg})
X (ÂåóÊñπÂêë): ${x} m
Y (Êù±ÊñπÂêë): ${y} m
Á∑ØÂ∫¶: ${latDec.toFixed(8)}¬∞
ÁµåÂ∫¶: ${lonDec.toFixed(8)}¬∞
Á∑ØÂ∫¶:${latDms}
ÁµåÂ∫¶:${lonDms}`;

        navigator.clipboard.writeText(textToCopy).then(() => {
            showNotification('Â§âÊèõÁµêÊûú„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ');
        }).catch(err => {
            throw new Error('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        });

    } catch (e) {
        showNotification(e.message, 'error');
    }
}

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë„Éá„Éº„ÇøÊ∂àÂ§±„É™„Çπ„ÇØÈñ¢ÈÄ£„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ„ÇíËøΩÂä† ‚ñº‚ñº‚ñº
function initializeDataWarning() {
    const banner = document.getElementById('data-loss-warning-banner');
    const dismissBtn = document.getElementById('dismiss-warning-btn');
    const warningDismissedKey = 'dataWarningDismissed';
    const lastBackupPromptKey = 'lastBackupPrompt';
    const oneWeek = 7 * 24 * 60 * 60 * 1000;

    // 1. Ë≠¶Âëä„Éê„Éä„Éº„ÅÆË°®Á§∫
    if (localStorage.getItem(warningDismissedKey) !== 'true') {
        banner.style.display = 'flex';
        // „Éò„ÉÉ„ÉÄ„Éº„Çí„Éê„Éä„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ
        document.querySelector('.header').style.top = `${banner.offsetHeight}px`;
    }

    dismissBtn.addEventListener('click', () => {
        banner.style.display = 'none';
        document.querySelector('.header').style.top = '0';
        localStorage.setItem(warningDismissedKey, 'true');
    });
    
    // 2. ÂÆöÊúüÁöÑ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊé®Â•®ÈÄöÁü•
    const lastPrompt = localStorage.getItem(lastBackupPromptKey);
    const now = new Date().getTime();
    if (!lastPrompt || (now - parseInt(lastPrompt, 10)) > oneWeek) {
        setTimeout(() => {
            showNotification('„Éá„Éº„Çø„Çí‰øùË≠∑„Åô„Çã„Åü„ÇÅ„ÄÅÂÆöÊúüÁöÑ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ', 'warning', 7000);
            localStorage.setItem(lastBackupPromptKey, now.toString());
        }, 5000); // „Éö„Éº„Ç∏„É≠„Éº„Éâ„Åã„Çâ5ÁßíÂæå„Å´Ë°®Á§∫
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêÂ§âÊõ¥„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇ„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„ÅÆ„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£Èñ¢Êï∞ ‚ñº‚ñº‚ñº
function openEmergencySearchModal(searchId = null) {
    const form = document.getElementById('emergency-search-form');
    form.reset();
    document.getElementById('emergency-search-id').value = '';
    const title = document.getElementById('emergency-search-modal-title');

    if (searchId) {
        const searches = currentSettings.emergencySearches || [];
        const searchItem = searches.find(s => s.id === searchId);
        if (searchItem) {
            title.textContent = 'Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÁ∑®ÈõÜ';
            document.getElementById('emergency-search-id').value = searchItem.id;
            document.getElementById('emergency-search-keyword').value = searchItem.keyword;
        }
    } else {
        title.textContent = 'Êñ∞„Åó„ÅÑÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíËøΩÂä†';
    }
    
    document.getElementById('emergency-search-modal').style.display = 'flex';
}

function closeEmergencySearchModal() {
    document.getElementById('emergency-search-modal').style.display = 'none';
}

function saveEmergencySearch(e) {
    e.preventDefault();
    const keyword = document.getElementById('emergency-search-keyword').value.trim();
    if (!keyword) {
        showNotification('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const searchId = document.getElementById('emergency-search-id').value;
    let searches = currentSettings.emergencySearches || [];

    if (searchId) { // Á∑®ÈõÜ„ÅÆÂ†¥Âêà
        const index = searches.findIndex(s => s.id === searchId);
        if (index > -1) {
            searches[index].keyword = keyword;
        }
    } else { // Êñ∞Ë¶èËøΩÂä†„ÅÆÂ†¥Âêà
        if (searches.length >= 5) {
            showNotification('„Ç´„Çπ„Çø„É†Ê§úÁ¥¢„ÅØÊúÄÂ§ß5ÂÄã„Åæ„Åß„Åß„Åô„ÄÇ', 'error');
            return;
        }
        searches.push({
            id: `es-${Date.now()}`,
            keyword: keyword
        });
    }

    currentSettings.emergencySearches = searches;
    setProjectData(SETTINGS_KEY, currentSettings);
    renderMapCards();
    closeEmergencySearchModal();
    showNotification('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
}

function deleteEmergencySearch(searchId) {
    if (confirm('„Åì„ÅÆÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        let searches = currentSettings.emergencySearches || [];
        currentSettings.emergencySearches = searches.filter(s => s.id !== searchId);
        setProjectData(SETTINGS_KEY, currentSettings);
        renderMapCards();
        showNotification('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
    }
}
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

document.addEventListener('DOMContentLoaded', () => {
    coordinateSystems.forEach(d => {
        const s = `+proj=tmerc +lat_0=${d.lat0} +lon_0=${d.lon0} +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs`;
        proj4.defs("EPSG:" + d.epsg, s);
    });

    migrateOldData();
    loadProjects();
    initializeDataWarning();

    if (window.L) {
        startIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        endIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        L.Control.CurrentLocation = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const link = L.DomUtil.create('a', '', container);
                link.href = '#';
                link.title = 'ÁèæÂú®Âú∞„ÇíË°®Á§∫';
                link.role = 'button';
                link.setAttribute('aria-label', 'ÁèæÂú®Âú∞„ÇíË°®Á§∫');
                link.innerHTML = 'üéØ';
                link.style.width = '30px'; link.style.height = '30px'; link.style.lineHeight = '30px';
                link.style.fontSize = '1.4em'; link.style.textAlign = 'center';
                L.DomEvent.on(container, 'click', L.DomEvent.stopPropagation)
                          .on(container, 'click', L.DomEvent.preventDefault)
                          .on(container, 'click', this._locate, this);
                container.style.backgroundColor = 'white'; link.style.color = '#333';
                return container;
            },
            _locate: async function() {
                showNotification('ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠„Åß„Åô...');
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude, lon = position.coords.longitude;
                        this._map.flyTo([lat, lon], this._map.getZoom());
                        updateLatLonInputs(lat, lon);
                        await updateCurrentCoords();
                        showNotification('ÁèæÂú®Âú∞„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
                    },
                    () => { showNotification('ÁèæÂú®Âú∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error'); },
                    { enableHighAccuracy: true }
                );
            },
            onRemove: function(map) {}
        });
        L.control.currentLocation = function(opts) { return new L.Control.CurrentLocation(opts); }
    }

const tabs = document.querySelectorAll('.panel-tab');
const contents = document.querySelectorAll('.panel-content');
const toggleCatBtn = document.getElementById('toggleAllCategoriesBtn');
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const targetContentId = tab.dataset.tab + '-content';
        const targetContent = document.getElementById(targetContentId);
        if (targetContent) targetContent.classList.add('active');
        toggleCatBtn.disabled = (tab.dataset.tab !== 'map-links');

        const tabId = tab.dataset.tab;
        const rightPanel = document.querySelector('.right-panel');
        const mainLayout = document.querySelector('.main-layout');

        if (!mainLayout.classList.contains('pinned') && !rightPanel.classList.contains('hidden')) {
            if (window.innerWidth > 768) {
                const unpinnedWidths = currentSettings.unpinnedPanelWidths || defaultSettings.unpinnedPanelWidths;
                const newWidth = `${unpinnedWidths[tabId] || 500}px`;
                rightPanel.style.width = newWidth;
                rightPanel.style.maxWidth = '80vw'; 
            }
        }
    });
});

loadSettings();
loadTabOrder();
renderMapCards();
loadFavoriteSets();
initResizer();
renderHistoryList(getProjectData('coordinateHistory') || []);
renderHistoryTable();
renderBookmarkTable();
initTabDragAndDrop();
initCategoryDragAndDrop(); // ‚Üê „Åì„ÅÆË°å„ÇíËøΩË®ò
initCardDragAndDrop();

initProjectSwitcher();
initProjectManagementModal();
initCoordConverter();
initCsvImport();
initCsvPlotter();

const today = new Date();
document.getElementById('lastUpdated').textContent = `ÊúÄÁµÇÊõ¥Êñ∞Êó•: 2025Âπ¥11Êúà17Êó•`;

async function initializeApp() {
    if (applyStateFromUrl()) {
        await updateCurrentCoords(null, true, true);
    } else {
        await updateCurrentCoords(null, true, true);
    }
}

function initializeFullscreenHandler() {
    if (!mapLeft) return;

    mapLeft.on('fullscreenchange', function () {
        const body = document.body;

        if (mapLeft.isFullscreen()) {
            body.classList.add('left-map-is-fullscreen');
        } else {
            body.classList.remove('left-map-is-fullscreen');
            if (isDualView) {
                console.log("Re-initializing dual view after fullscreen exit.");
                toggleDualViewMode();
                setTimeout(() => {
                    toggleDualViewMode();
                }, 100);
            }
        }
    });
}

initializeApp();
initializeFullscreenHandler();
$lat.addEventListener('change', () => updateCurrentCoords());
$lon.addEventListener('change', () => updateCurrentCoords());
$zoom.addEventListener('input', e => {
    const zoomVal = e.target.value;
    $zoomDisplay.textContent = zoomVal;
});
$zoom.addEventListener('change', e => {
    const newZoom = parseInt(e.target.value, 10);
    if(osmMap) osmMap.setZoom(newZoom);
});
$coordFormatToggle.addEventListener('click', toggleCoordFormat);
$addressInput.addEventListener('keypress', async e => { if (e.key === 'Enter') { e.preventDefault(); selectedAutocompleteIndex !== -1 ? await selectAutocompleteItem(selectedAutocompleteIndex) : await searchAddress(); } });
$addressInput.addEventListener('input', () => { clearTimeout(autocompleteTimer); if ($addressInput.value.trim().length<2) return renderAutocompleteList([]); autocompleteTimer = setTimeout(async () => renderAutocompleteList(await getAddressSuggestions($addressInput.value.trim())), 300); });
$addressInput.addEventListener('keydown', e => { const items = $autocompleteList.querySelectorAll('.autocomplete-item'); if(items.length===0)return; if (e.key==='ArrowDown') selectedAutocompleteIndex=(selectedAutocompleteIndex+1)%items.length; else if (e.key==='ArrowUp') selectedAutocompleteIndex=(selectedAutocompleteIndex-1+items.length)%items.length; else return; e.preventDefault(); items.forEach((item,i)=>item.classList.toggle('selected',i===selectedAutocompleteIndex)); if(items[selectedAutocompleteIndex]) items[selectedAutocompleteIndex].scrollIntoView({block:'nearest'}); });

document.addEventListener('click', e => { 
    if (!e.target.closest('.header-button-wrapper, .usage-button, .project-switcher')) { 
        $historyPopup.style.display = 'none'; 
        $bookmarkPopup.style.display = 'none'; 
        document.getElementById('projectSwitcherDropdown').style.display = 'none'; 
        document.getElementById('csvPopup').style.display = 'none'; 
    } 
    if(!e.target.closest('.usage-button, .usage-guide')) { 
        document.getElementById('usageGuide').classList.remove('show'); 
    } 
});

$historyList.addEventListener('click', e => { const i = e.target.closest('.history-item')?.dataset.index; if (i) loadCoordinateFromHistory((getProjectData('coordinateHistory') || [])[i]); });
$bookmarkList.addEventListener('click', e => { const i = e.target.closest('.bookmark-item')?.dataset.index, a = e.target.closest('button')?.className.split('-').pop(); if(i&&a) handleBookmarkAction(parseInt(i), a); });
$mylinkForm.addEventListener('submit', saveMyLink);
document.getElementById('btn-mylink-modal-cancel').addEventListener('click', closeMyLinkModal);
$mylinkModal.addEventListener('click', e => e.target === $mylinkModal && closeMyLinkModal());
document.getElementById('btn-convert-url').addEventListener('click', convertUrlToTemplate);
document.getElementById('modeToggle').addEventListener('click', toggleDarkMode);
const $settingsModal = document.getElementById('settings-modal');
document.getElementById('settingsButton').addEventListener('click', openSettingsModal);
document.getElementById('settings-form').addEventListener('submit', saveSettings);
document.getElementById('btn-settings-modal-cancel').addEventListener('click', closeSettingsModal);
$settingsModal.addEventListener('click', e => e.target === $settingsModal && closeSettingsModal());
document.getElementById('settings-zoom').addEventListener('input', e => { document.getElementById('settings-zoom-value').textContent = e.target.value; });
document.getElementById('settings-panel-width').addEventListener('input', e => { document.getElementById('settings-panel-width-value').textContent = e.target.value; updatePanelWidth(e.target.value); });
document.getElementById('reset-panel-width').addEventListener('click', () => { 
    const val = 500;
    document.getElementById('settings-panel-width').value = val; 
    document.getElementById('settings-panel-width-value').textContent = val; 
    updatePanelWidth(val); 
});

document.getElementById('settings-panel-width-map-links').addEventListener('input', e => { document.getElementById('settings-panel-width-map-links-value').textContent = e.target.value; });
document.getElementById('settings-panel-width-history').addEventListener('input', e => { document.getElementById('settings-panel-width-history-value').textContent = e.target.value; });
document.getElementById('settings-panel-width-bookmarks').addEventListener('input', e => { document.getElementById('settings-panel-width-bookmarks-value').textContent = e.target.value; });
document.getElementById('reset-panel-widths-unpinned').addEventListener('click', () => {
    const defaultWidths = defaultSettings.unpinnedPanelWidths;
    document.getElementById('settings-panel-width-map-links').value = defaultWidths['map-links'];
    document.getElementById('settings-panel-width-map-links-value').textContent = defaultWidths['map-links'];
    document.getElementById('settings-panel-width-history').value = defaultWidths['history'];
    document.getElementById('settings-panel-width-history-value').textContent = defaultWidths['history'];
    document.getElementById('settings-panel-width-bookmarks').value = defaultWidths['bookmarks'];
    document.getElementById('settings-panel-width-bookmarks-value').textContent = defaultWidths['bookmarks'];
    showNotification('„Éë„Éç„É´ÂπÖ„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
});
document.getElementById('navBack').addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; const state = navigationHistory[historyIndex]; updateLatLonInputs(state.lat, state.lon); setZoomLevel(state.zoom); updateCurrentCoords(state, true, true); } });
document.getElementById('navForward').addEventListener('click', () => { if (historyIndex < navigationHistory.length - 1) { historyIndex++; const state = navigationHistory[historyIndex]; updateLatLonInputs(state.lat, state.lon); setZoomLevel(state.zoom); updateCurrentCoords(state, true, true); } });
document.getElementById('toggleAllCategoriesBtn').addEventListener('click', (e) => { const btn = e.currentTarget, isCollapsed = document.querySelector('.category-header')?.classList.contains('collapsed'); if(isCollapsed){ document.querySelectorAll('.category-header').forEach(h => { h.classList.remove('collapsed'); h.nextElementSibling.classList.remove('hidden'); }); btn.textContent = '‚ûñ „Åô„Åπ„Å¶Êäò„Çä„Åü„Åü„Åø'; } else { document.querySelectorAll('.category-header').forEach(h => { h.classList.add('collapsed'); h.nextElementSibling.classList.add('hidden'); }); btn.textContent = '‚ûï „Åô„Åπ„Å¶Â±ïÈñã'; } });
document.getElementById('favorite-sets').addEventListener('change', applyFavoriteSet);
document.getElementById('save-set').addEventListener('click', saveFavoriteSet);
document.getElementById('delete-set').addEventListener('click', deleteFavoriteSet);
document.getElementById('clear-all-checks').addEventListener('click', () => { document.querySelectorAll('.map-checkbox').forEach(cb => cb.checked = false); document.getElementById('favorite-sets').value = ''; showNotification('„Åô„Åπ„Å¶„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ'); });
document.getElementById('open-set').addEventListener('click', openFavoriteSet);
document.addEventListener('keydown', handleUndoLastPoint);
document.getElementById('btn-export-data').addEventListener('click', exportData);
document.getElementById('btn-import-data').addEventListener('click', importDataTrigger);
document.getElementById('import-file-input').addEventListener('change', handleFileSelect);
document.getElementById('btn-check-all').addEventListener('click', () => { document.querySelectorAll('#data-sync-checklist input[type="checkbox"]').forEach(cb => cb.checked = true); });
document.getElementById('btn-uncheck-all').addEventListener('click', () => { document.querySelectorAll('#data-sync-checklist input[type="checkbox"]').forEach(cb => cb.checked = false); });
document.querySelectorAll('#btn-route-google').forEach(button => { button.addEventListener('click', () => { const { lat, lon } = currentLatLon; if (isNaN(lat) || isNaN(lon)) return showNotification('ÊúâÂäπ„Å™Â∫ßÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, '_blank'); }); });
document.getElementById('history-map-toggle').addEventListener('change', (e) => { isHistoryVisibleOnMap = e.target.checked; renderHistoryOnMap(); });
document.getElementById('historySearchInput').addEventListener('input', renderHistoryTable);
document.getElementById('historyTable').querySelector('thead').addEventListener('click', (e) => { const header = e.target.closest('th.sortable'); if (!header) return; const newCol = header.dataset.sort; if (historySortState.column === newCol) { historySortState.order = historySortState.order === 'asc' ? 'desc' : 'asc'; } else { historySortState.column = newCol; historySortState.order = 'asc'; } document.querySelectorAll('#historyTable th.sortable').forEach(th => { th.classList.remove('sorted'); th.querySelector('.sort-icon').textContent = ''; }); header.classList.add('sorted'); header.querySelector('.sort-icon').textContent = historySortState.order === 'asc' ? '‚ñ≤' : '‚ñº'; renderHistoryTable(); });
$historyTableBody.addEventListener('click', handleHistoryTableClick);
document.getElementById('history-select-all').addEventListener('change', (e) => { document.querySelectorAll('.history-item-checkbox').forEach(cb => cb.checked = e.target.checked); updateHistoryTableControls(); renderHistoryOnMap(); });
document.getElementById('btn-copy-table-history').addEventListener('click', () => { const rows = $historyTableBody.querySelectorAll('tr'); if(rows.length === 0 || rows[0].querySelectorAll('td').length < 2) return showNotification('„Ç≥„Éî„Éº„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); const headers = Array.from(document.getElementById('historyTable').querySelectorAll('th')).slice(1, -1).map(th => th.textContent.trim().replace(/\s*‚ñ≤|‚ñº/, '')).join('\t'); const data = Array.from(rows).map(row => Array.from(row.querySelectorAll('td')).slice(1, -1).map(td => td.textContent.trim()).join('\t')).join('\n'); navigator.clipboard.writeText(`${headers}\n${data}`).then(() => showNotification('„ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ')); });
document.getElementById('btn-copy-selected-history').addEventListener('click', () => { const selected = document.querySelectorAll('.history-item-checkbox:checked'); const historyData = getProjectData('coordinateHistory') || []; const headers = "No.\tÈÉµ‰æøÁï™Âè∑\t‰ΩèÊâÄ\tÁ∑ØÂ∫¶\tÁµåÂ∫¶\tÊ®ôÈ´ò(m)\tXÂ∫ßÊ®ô(m)\tYÂ∫ßÊ®ô(m)\tÂ∫ßÊ®ôÁ≥ª\tÂèñÂæóÊó•ÊôÇ"; const data = Array.from(selected).map(cb => { const i = parseInt(cb.dataset.historyIndex, 10), item = historyData[i]; return [i + 1, item.postcode, item.address, item.lat, item.lon, item.elevation, item.xy_x, item.xy_y, item.xy_system, new Date(item.timestamp).toLocaleString()].join('\t'); }).join('\n'); navigator.clipboard.writeText(`${headers}\n${data}`).then(() => showNotification(`${selected.length}‰ª∂„ÅÆÈÅ∏ÊäûË°å„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ`)); });
document.getElementById('btn-delete-selected-history').addEventListener('click', () => { const selected = document.querySelectorAll('.history-item-checkbox:checked'); if (confirm(`${selected.length}‰ª∂„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) { let historyData = getProjectData('coordinateHistory') || []; const indices = Array.from(selected).map(cb => parseInt(cb.dataset.historyIndex, 10)).sort((a,b) => b-a); indices.forEach(index => historyData.splice(index, 1)); setProjectData('coordinateHistory', historyData); renderHistoryTable(); renderHistoryList(historyData); renderHistoryOnMap(); showNotification(`${selected.length}‰ª∂„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`); } });
// Bookmark Table Listeners
document.getElementById('bookmark-map-toggle').addEventListener('change', (e) => { isBookmarksVisibleOnMap = e.target.checked; renderBookmarksOnMap(); });
document.getElementById('bookmarkSearchInput').addEventListener('input', renderBookmarkTable);
document.getElementById('bookmarkTable').querySelector('thead').addEventListener('click', (e) => { const header = e.target.closest('th.sortable'); if (!header) return; const newCol = header.dataset.sort; if (bookmarkSortState.column === newCol) { bookmarkSortState.order = bookmarkSortState.order === 'asc' ? 'desc' : 'asc'; } else { bookmarkSortState.column = newCol; bookmarkSortState.order = 'asc'; } document.querySelectorAll('#bookmarkTable th.sortable').forEach(th => { th.classList.remove('sorted'); th.querySelector('.sort-icon').textContent = ''; }); header.classList.add('sorted'); header.querySelector('.sort-icon').textContent = bookmarkSortState.order === 'asc' ? '‚ñ≤' : '‚ñº'; renderBookmarkTable(); });
$bookmarkTableBody.addEventListener('click', handleBookmarkTableClick);
document.getElementById('bookmark-select-all').addEventListener('change', (e) => { document.querySelectorAll('.bookmark-item-checkbox').forEach(cb => cb.checked = e.target.checked); updateBookmarkTableControls(); renderBookmarksOnMap(); });
document.getElementById('btn-copy-table-bookmarks').addEventListener('click', () => { const rows = $bookmarkTableBody.querySelectorAll('tr'); if(rows.length === 0 || rows[0].querySelectorAll('td').length < 2) return showNotification('„Ç≥„Éî„Éº„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error'); const headers = Array.from(document.getElementById('bookmarkTable').querySelectorAll('th')).slice(1, -1).map(th => th.textContent.trim().replace(/\s*‚ñ≤|‚ñº/, '')).join('\t'); const data = Array.from(rows).map(row => Array.from(row.querySelectorAll('td')).slice(1, -1).map(td => td.textContent.trim()).join('\t')).join('\n'); navigator.clipboard.writeText(`${headers}\n${data}`).then(() => showNotification('„ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ')); });
document.getElementById('btn-copy-selected-bookmarks').addEventListener('click', () => { const selected = document.querySelectorAll('.bookmark-item-checkbox:checked'); const bookmarkData = getProjectData(BOOKMARK_KEY) || []; const headers = "No.\tÂêçÂâç\tÈÉµ‰æøÁï™Âè∑\t‰ΩèÊâÄ\tÁ∑ØÂ∫¶\tÁµåÂ∫¶\tÊ®ôÈ´ò(m)\tXÂ∫ßÊ®ô(m)\tYÂ∫ßÊ®ô(m)\tÂ∫ßÊ®ôÁ≥ª\tÁôªÈå≤Êó•ÊôÇ"; const data = Array.from(selected).map(cb => { const i = parseInt(cb.dataset.bookmarkIndex, 10), item = bookmarkData[i]; return [i + 1, item.name, item.postcode, item.address, item.lat, item.lon, item.elevation, item.xy_x, item.xy_y, item.xy_system, new Date(item.timestamp).toLocaleString()].join('\t'); }).join('\n'); navigator.clipboard.writeText(`${headers}\n${data}`).then(() => showNotification(`${selected.length}‰ª∂„ÅÆÈÅ∏ÊäûË°å„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ`)); });
document.getElementById('btn-delete-selected-bookmarks').addEventListener('click', () => { const selected = document.querySelectorAll('.bookmark-item-checkbox:checked'); if (confirm(`${selected.length}‰ª∂„ÅÆ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) { let bookmarkData = getProjectData(BOOKMARK_KEY) || []; const indices = Array.from(selected).map(cb => parseInt(cb.dataset.bookmarkIndex, 10)).sort((a,b) => b-a); indices.forEach(index => bookmarkData.splice(index, 1)); setProjectData(BOOKMARK_KEY, bookmarkData); renderBookmarkTable(); renderBookmarkList(); renderBookmarksOnMap(); showNotification(`${selected.length}‰ª∂„ÅÆ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`); } });
document.getElementById('btn-show-all-maps').addEventListener('click', () => { document.querySelectorAll('#settings-map-visibility-list input[type="checkbox"]').forEach(cb => cb.checked = false); });
document.getElementById('btn-hide-all-maps').addEventListener('click', () => { document.querySelectorAll('#settings-map-visibility-list input[type="checkbox"]').forEach(cb => cb.checked = true); });
document.getElementById('btn-reset-map-categories').addEventListener('click', () => { if (confirm('„Åô„Åπ„Å¶„ÅÆÂú∞Âõ≥„É™„É≥„ÇØ„Ç´„Éº„Éâ„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÈÖçÁΩÆ„Å®„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰∏¶„Å≥È†Ü„ÇíÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) { currentSettings.mapCategoryOverrides = {}; currentSettings.mapOrderInCategory = {}; currentSettings.categoryOrder = [...defaultSettings.categoryOrder]; setProjectData(SETTINGS_KEY, currentSettings); renderMapCards(); showNotification('„Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ'); } });

window.addEventListener('resize', () => { if (osmMap) { osmMap.invalidateSize(); } });

function handleUndoLastPoint(e) { 
    if (e.key === 'Enter' && isMeasuringArea) {
        e.preventDefault();
        handleAreaMeasureDoubleClick();
        return;
    }

    if (e.key !== 'Backspace' && e.key !== 'Delete') return; 
    
    if (isMeasuring && measurePoints.length > 0) { 
        e.preventDefault(); 
        measurePoints.pop(); 
        const lastMarker = measurePointMarkers.pop(); 
        if (lastMarker) analysisLayer.removeLayer(lastMarker); 
        analysisLayer.eachLayer(layer => { 
            if (layer instanceof L.Polyline && layer !== tempMeasureLine) analysisLayer.removeLayer(layer); 
        }); 
        if (measurePoints.length > 1) L.polyline(measurePoints, { color: 'blue' }).addTo(analysisLayer); 
        if (measurePoints.length > 0) updateMeasureTooltip(measurePoints[measurePoints.length-1]); 
        else if(measureTooltip) { 
            osmMap.removeLayer(measureTooltip); 
            measureTooltip = null; 
            if(tempMeasureMarker) { 
                analysisLayer.removeLayer(tempMeasureMarker); 
                tempMeasureMarker = null; 
            } 
        } 
    } 
    
    if (isMeasuringArea && areaPoints.length > 0) { 
        e.preventDefault(); 
        areaPoints.pop(); 
        const lastMarker = areaPointMarkers.pop(); 
        if (lastMarker) analysisLayer.removeLayer(lastMarker); 
        if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon); 
        tempAreaPolygon = null; 
        if (areaPoints.length > 1) tempAreaPolygon = L.polygon(areaPoints, { color: '#9C27B0', weight: 2, fillOpacity: 0.1 }).addTo(analysisLayer); 
        if (areaPoints.length >= 3) { 
            const area = calculatePolygonArea(areaPoints); 
            $areaDisplay.textContent = `Èù¢Á©ç: ${area > 1000000 ? `${(area / 1000000).toFixed(3)} km¬≤` : `${area.toFixed(2)} m¬≤`}`; 
        } else { 
            $areaDisplay.textContent = '--- m¬≤'; 
        } 
    } 
}

async function generateProfileChart(points, divisionCount = 100) {
    if (points.length < 2) return;
    showNotification('Ê®ôÈ´ò„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠„Åß„Åô...', 'warning');

    try {
        await loadChartJS();
        const sampledPoints = interpolatePoints(points, divisionCount);
        const fetchPromises = sampledPoints.map(point =>
            fetchWithRetry(`https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?outtype=JSON&demtype=dem_merged&lon=${point.lng}&lat=${point.lat}`)
            .then(res => res && res.ok ? res.json() : null)
        );
        const results = await Promise.all(fetchPromises);
        let dist = 0;
        lastProfileData = results.map((item, i) => {
            if (i > 0) dist += sampledPoints[i - 1].distanceTo(sampledPoints[i]);
   const elev = (item && item.elevation !== '-----') ? parseFloat(item.elevation) : null;
    const demType = (item && item.hsrc) ? item.hsrc : '---';
    return { distance: dist, elevation: elev, lat: sampledPoints[i].lat, lon: sampledPoints[i].lng, dem: demType };
});

        if (lastProfileData.some(d => d.elevation !== null)) {
            drawProfileChart(lastProfileData);
            showNotification('Êñ≠Èù¢Âõ≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ');
        } else {
            throw new Error('ÂÖ®„Å¶„ÅÆÂú∞ÁÇπ„ÅßÊ®ôÈ´ò„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }

    } catch (error) {
        showNotification(`Êñ≠Èù¢Âõ≥„ÅÆÁîüÊàê„Å´Â§±Êïó: ${error.message}`, 'error');
        lastProfileData = null;
    }
}
function interpolatePoints(points, num) { const totalDist = calculateTotalDistance(points); if (totalDist === 0) return [points[0]]; const interval = totalDist / (num - 1); const result = [points[0]]; let rem = 0; for (let i = 0; i < points.length - 1; i++) { const start = points[i], end = points[i+1], segDist = start.distanceTo(end); let covered = rem; while (covered + interval <= segDist) { covered += interval; const ratio = covered / segDist; result.push(L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio)); } rem = segDist - covered; } if (result.length < num) result.push(points[points.length - 1]); return result; }
function drawProfileChart(data) { const modal = document.getElementById('profile-modal'), ctx = document.getElementById('profileChart').getContext('2d'), yToggle = document.getElementById('y-axis-toggle'); if (profileChartInstance) profileChartInstance.destroy(); const yOpts = { title: { display: true, text: 'Ê®ôÈ´ò (m)' } }; if (yToggle.checked) yOpts.min = 0; profileChartInstance = new Chart(ctx, { type: 'line', data: { labels: data.map(p => p.distance.toFixed(1)), datasets: [{ label: 'Ê®ôÈ´ò (m)', data: data.map(p => p.elevation), borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: .1, fill: true, pointRadius: 0, spanGaps: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'ÂßãÁÇπ„Åã„Çâ„ÅÆË∑ùÈõ¢ (m)' } }, y: yOpts }, plugins: { tooltip: { enabled: true, mode: 'index', intersect: false } }, onHover: (e, el) => { if (el.length > 0) { const d = lastProfileData[el[0].index]; if (d) { const ll = [d.lat, d.lon]; if (!rolloverMarker) rolloverMarker = L.circleMarker(ll, { radius: 8, color: 'red', fillColor: '#f03', fillOpacity: .8, pane: 'markerPane' }).addTo(osmMap); else rolloverMarker.setLatLng(ll); } } else if (rolloverMarker) { rolloverMarker.remove(); rolloverMarker = null; } } } }); modal.style.display = 'flex'; }
function exportProfileDataToCSV() {
    if (!lastProfileData || lastProfileData.length === 0) return showNotification('Êõ∏„ÅçÂá∫„Åô„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
    const headers = 'No,ÂßãÁÇπ„Åã„Çâ„ÅÆË∑ùÈõ¢(m),Ê®ôÈ´ò(m),Á∑ØÂ∫¶,ÁµåÂ∫¶,DEMÁ®ÆÂà•';
    const rows = lastProfileData.map((p, i) => `${i+1},${p.distance.toFixed(2)},${p.elevation !== null ? p.elevation : ''},${p.lat.toFixed(8)},${p.lon.toFixed(8)},${p.dem}`);
    const csv = `${headers}\n${rows.join('\n')}`;
    const blob = new Blob([new Uint8Array([0xef, 0xbb, 0xbf]), csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `profile_data_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Êñ≠Èù¢Âõ≥„Éá„Éº„Çø„ÇíCSV„ÅßÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü„ÄÇ');
}


function initProjectSwitcher() {
    const btn = document.getElementById('projectSwitcherBtn');
    const dropdown = document.getElementById('projectSwitcherDropdown');
    
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isShown = dropdown.style.display === 'block';
        dropdown.style.display = isShown ? 'none' : 'block';
        btn.setAttribute('aria-expanded', !isShown);
    });

    document.getElementById('manageProjectsBtn').addEventListener('click', (e) => {
        e.preventDefault();
        dropdown.style.display = 'none';
        openProjectModal();
    });

    renderProjectSwitcher();
}

function renderProjectSwitcher() {
    const btn = document.getElementById('projectSwitcherBtn');
    const dropdown = document.getElementById('projectSwitcherDropdown');
    const activeProject = projectsData.projects[activeProjectId];
    
    btn.textContent = activeProject ? activeProject.name : '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„Åó';
    
    dropdown.querySelectorAll('.project-dropdown-item:not(.project-dropdown-manage)').forEach(el => el.remove());
    dropdown.querySelectorAll('hr').forEach(el => el.remove());

    Object.entries(projectsData.projects).forEach(([id, project]) => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'project-dropdown-item';
        item.textContent = project.name;
        item.dataset.projectId = id;
        if (id === activeProjectId) {
            item.classList.add('active');
        }
        item.addEventListener('click', (e) => {
            e.preventDefault();
            if (id !== activeProjectId) {
                switchProject(id);
            }
            dropdown.style.display = 'none';
        });
        dropdown.prepend(item);
    });
    const hr = document.createElement('hr');
    dropdown.insertBefore(hr, document.getElementById('manageProjectsBtn'));
}

function openProjectModal() {
    renderProjectManagementList();
    document.getElementById('project-modal').style.display = 'flex';
}

function closeProjectModal() {
    document.getElementById('project-modal').style.display = 'none';
}

let selectedProjectIdForManagement = null;

function renderProjectManagementList() {
    const list = document.getElementById('projectManagementList');
    list.innerHTML = '';
    Object.entries(projectsData.projects).forEach(([id, project]) => {
        const li = document.createElement('li');
        li.textContent = project.name;
        li.dataset.projectId = id;
        li.addEventListener('click', () => {
            selectedProjectIdForManagement = id;
            document.querySelectorAll('#projectManagementList li').forEach(el => el.classList.remove('selected'));
            li.classList.add('selected');
            updateProjectManagementButtons();
        });
        list.appendChild(li);
    });
    selectedProjectIdForManagement = null;
    updateProjectManagementButtons();
}

function updateProjectManagementButtons() {
    const isProjectSelected = selectedProjectIdForManagement !== null;
    const isNotOnlyOneProject = Object.keys(projectsData.projects).length > 1;

    document.getElementById('btn-rename-project').disabled = !isProjectSelected;
    document.getElementById('btn-duplicate-project').disabled = !isProjectSelected;
    document.getElementById('btn-delete-project').disabled = !isProjectSelected || !isNotOnlyOneProject;
    document.getElementById('btn-export-project').disabled = !isProjectSelected;
}

function initProjectManagementModal() {
    document.getElementById('btn-new-project').addEventListener('click', () => {
        const name = prompt('Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
        if (name && name.trim()) {
            const newId = `proj_${Date.now()}`;
            projectsData.projects[newId] = { name: name.trim(), data: JSON.parse(JSON.stringify(defaultProjectData)) };
            saveProjects();
            renderProjectManagementList();
            renderProjectSwitcher();
        }
    });

    document.getElementById('btn-rename-project').addEventListener('click', () => {
        if (!selectedProjectIdForManagement) return;
        const oldName = projectsData.projects[selectedProjectIdForManagement].name;
        const newName = prompt('Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', oldName);
        if (newName && newName.trim()) {
            projectsData.projects[selectedProjectIdForManagement].name = newName.trim();
            saveProjects();
            renderProjectManagementList();
            renderProjectSwitcher();
            if (selectedProjectIdForManagement === activeProjectId) {
                document.getElementById('projectSwitcherBtn').textContent = newName.trim();
            }
        }
    });
    
    document.getElementById('btn-duplicate-project').addEventListener('click', () => {
        if (!selectedProjectIdForManagement) return;
        const sourceProject = projectsData.projects[selectedProjectIdForManagement];
        const newName = prompt('Ë§áË£ΩÂæå„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `${sourceProject.name} („Ç≥„Éî„Éº)`);
        if (newName && newName.trim()) {
            const newId = `proj_${Date.now()}`;
            projectsData.projects[newId] = {
                name: newName.trim(),
                data: JSON.parse(JSON.stringify(sourceProject.data))
            };
            saveProjects();
            renderProjectManagementList();
            renderProjectSwitcher();
        }
    });

    document.getElementById('btn-delete-project').addEventListener('click', () => {
        if (!selectedProjectIdForManagement || Object.keys(projectsData.projects).length <= 1) return;
        const projectToDelete = projectsData.projects[selectedProjectIdForManagement];
        if (confirm(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${projectToDelete.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
            delete projectsData.projects[selectedProjectIdForManagement];
            if (activeProjectId === selectedProjectIdForManagement) {
                projectsData.activeProjectId = Object.keys(projectsData.projects)[0];
                saveProjects();
                location.reload();
            } else {
                saveProjects();
                renderProjectManagementList();
                renderProjectSwitcher();
            }
        }
    });

    document.getElementById('btn-export-project').addEventListener('click', () => {
        if (!selectedProjectIdForManagement) return;
        const projectToExport = projectsData.projects[selectedProjectIdForManagement];
        const dataStr = JSON.stringify({ [selectedProjectIdForManagement]: projectToExport }, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `GeoLinkNavi_Project_${projectToExport.name}_${date}.json`;
        a.click();
        URL.revokeObjectURL(url);
    });
    
    const importFileInput = document.getElementById('import-project-file-input');
    document.getElementById('btn-import-project').addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                const projectId = Object.keys(imported)[0];
                const projectData = imported[projectId];
                if (!projectId || !projectData || !projectData.name || !projectData.data) {
                    throw new Error("ÁÑ°Âäπ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇ");
                }
                
                if (confirm(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${projectData.name}„Äç„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü\nÂêå„ÅòÂêçÂâç„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ`)) {
                    const existingId = Object.keys(projectsData.projects).find(id => projectsData.projects[id].name === projectData.name);
                    const idToSave = existingId || projectId;
                    
                    projectsData.projects[idToSave] = projectData;
                    saveProjects();
                    renderProjectManagementList();
                    renderProjectSwitcher();
                    showNotification(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${projectData.name}„Äç„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
                }
            } catch (err) {
                showNotification(`„Éï„Ç°„Ç§„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`, "error");
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });
    document.getElementById('project-modal-close-btn-x').addEventListener('click', closeProjectModal);
    document.getElementById('project-modal-close-btn-bottom').addEventListener('click', closeProjectModal);

}
const rightPanelForTabs = document.querySelector('.right-panel');
if (window.ResizeObserver) {
    const tabThreshold = 420;
    const observer = new ResizeObserver(entries => {
        for (let entry of entries) {
            const { width } = entry.contentRect;
            entry.target.classList.toggle('narrow-tabs', width < tabThreshold);
        }
    });
    observer.observe(rightPanelForTabs);
}

    function initializeProfileModal() {
        const profileModal = document.getElementById('profile-modal');
        if (!profileModal) return;

        const yAxisToggle = document.getElementById('y-axis-toggle');

        const closeProfileModal = () => {
            profileModal.style.display = 'none';
            if (rolloverMarker) {
                rolloverMarker.remove();
                rolloverMarker = null;
            }
        };

        document.getElementById('btn-profile-modal-close').addEventListener('click', closeProfileModal);
        document.getElementById('btn-profile-modal-cancel').addEventListener('click', closeProfileModal);
        document.getElementById('btn-export-profile-csv').addEventListener('click', exportProfileDataToCSV);

        profileModal.addEventListener('click', e => {
            if (e.target === profileModal) {
                closeProfileModal();
            }
        });

        yAxisToggle.addEventListener('change', () => {
            if (profileChartInstance) {
                profileChartInstance.options.scales.y.min = yAxisToggle.checked ? 0 : undefined;
                profileChartInstance.update();
            }
        });

        const modalContent = profileModal.querySelector('.modal-content');
        const header = document.getElementById('profile-modal-header');
        
        let isDragging = false;
        let initialX, initialY, offsetX = 0, offsetY = 0;

        const onMouseDown = (e) => {
            if (e.target.tagName === 'BUTTON') return;
            
            e.preventDefault();
            isDragging = true;
            initialX = e.clientX - offsetX;
            initialY = e.clientY - offsetY;
            
            header.style.cursor = 'grabbing';
            document.body.style.userSelect = 'none';
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };

        const onMouseMove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            offsetX = e.clientX - initialX;
            offsetY = e.clientY - initialY;
            
            modalContent.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
        };

        const onMouseUp = () => {
            isDragging = false;
            header.style.cursor = 'move';
            document.body.style.userSelect = '';
            
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        header.addEventListener('mousedown', onMouseDown);

        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style' && profileModal.style.display !== 'flex') {
                    modalContent.style.transform = '';
                    offsetX = 0;
                    offsetY = 0;
                }
            });
        });
        observer.observe(profileModal, { attributes: true });
    }

    initializeProfileModal();

    const settingsTabsContainer = document.querySelector('#settings-modal .settings-tabs');
    if (settingsTabsContainer) {
        const settingsTabs = settingsTabsContainer.querySelectorAll('.settings-tab');
        const settingsTabContents = document.querySelectorAll('#settings-modal .settings-tab-content');
    
        settingsTabsContainer.addEventListener('click', (e) => {
            const targetTab = e.target.closest('.settings-tab');
            if (!targetTab) return;
    
            const tabName = targetTab.dataset.tab;
    
            settingsTabs.forEach(tab => tab.classList.remove('active'));
            targetTab.classList.add('active');
    
            settingsTabContents.forEach(content => content.classList.remove('active'));
            const targetContent = document.querySelector(`.settings-tab-content[data-tab-content="${tabName}"]`);
            if(targetContent) {
                targetContent.classList.add('active');
            }
        });
    }
    const legalToggle = document.getElementById('legal-toggle');
    const legalDetails = document.getElementById('legal-details');
    if (legalToggle && legalDetails) {
        legalToggle.addEventListener('click', () => {
            const isHidden = legalDetails.style.display === 'none';
            legalDetails.style.display = isHidden ? 'block' : 'none';
            legalToggle.textContent = isHidden ? 'ÂÖçË≤¨‰∫ãÈ†Ö („ÇØ„É™„ÉÉ„ÇØ„ÅßÈùûË°®Á§∫)' : 'ÂÖçË≤¨‰∫ãÈ†Ö („ÇØ„É™„ÉÉ„ÇØ„ÅßË°®Á§∫)';
        });
    }
    
    // ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„ÄëÁ∑äÊÄ•ÊôÇÈÄ£Áµ°„Ç´„Çπ„Çø„É†Ê§úÁ¥¢Áî®„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ‚ñº‚ñº‚ñº
    const emergencySearchModal = document.getElementById('emergency-search-modal');
    document.getElementById('emergency-search-form').addEventListener('submit', saveEmergencySearch);
    document.getElementById('btn-emergency-search-modal-cancel').addEventListener('click', closeEmergencySearchModal);
    emergencySearchModal.addEventListener('click', (e) => {
        if (e.target === emergencySearchModal) {
            closeEmergencySearchModal();
        }
    });
    // ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

});

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„Çâ‰∏çË∂≥„Åó„Å¶„ÅÑ„ÅüCSVÈñ¢ÈÄ£„ÅÆÂÖ®„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë„Äë‚ñº‚ñº‚ñº

// „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÅßCSVÈñ¢ÈÄ£„ÅÆÂ§âÊï∞„ÇíÂÆöÁæ©
let csvImportData = {
    raw: null,
    headers: [],
    preview: [],
    mapped: [],
    fileName: ''
};
let currentImportType = 'bookmark'; // 'bookmark', 'plot', 'navigate'

/**
 * „Éò„ÉÉ„ÉÄ„Éº„ÅÆCSV„Éú„Çø„É≥„Å®„Åù„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É°„Éã„É•„Éº„ÇíÂàùÊúüÂåñ
 */
function initCsvPlotter() {
    const csvButton = document.getElementById('csvButton');
    const menu = document.getElementById('csvPopup');

    // ‚ñº‚ñº‚ñº„ÄêÈáçË¶Å„ÄëCSV„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„Åç„Å´„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñã„Åè„Ç§„Éô„É≥„Éà„ÇíËøΩÂä† ‚ñº‚ñº‚ñº
    if (csvButton) {
        csvButton.addEventListener('click', (e) => {
            e.stopPropagation(); // „Ç§„Éô„É≥„Éà„ÅÆ‰ºùÊí≠„ÇíÊ≠¢„ÇÅ„Çã
            toggleCsvPopup();
        });
    }
    
    // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂÜÖ„ÅÆ„Éú„Çø„É≥„Å´„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
    menu.querySelector('#csv-plot-btn-header').addEventListener('click', () => {
        openCsvImportModal('plot');
        menu.style.display = 'none';
    });
    menu.querySelector('#csv-navigate-btn-header').addEventListener('click', () => {
        openCsvImportModal('navigate');
        menu.style.display = 'none';
    });
    menu.querySelector('#csv-clear-plot-btn-header').addEventListener('click', () => {
        if (csvPlotLayer) {
            csvPlotLayer.clearLayers();
            showNotification('CSV„Éó„É≠„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ');
            document.getElementById('csv-clear-plot-btn-header').disabled = true;
        }
        menu.style.display = 'none';
    });
}

/**
 * CSV„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅÆÂàùÊúüÂåñ
 */
function initCsvImport() {
    // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
    document.getElementById('csv-select-file-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
    document.getElementById('csv-file-input').addEventListener('change', handleCsvFileSelect);
    document.getElementById('csv-import-close-btn').addEventListener('click', closeCsvImportModal);
    document.getElementById('csv-back-to-file-select-btn').addEventListener('click', () => showCsvImportStep('file'));
    document.getElementById('csv-goto-confirm-btn').addEventListener('click', processColumnMapping);
    document.getElementById('csv-back-to-mapping-btn').addEventListener('click', () => showCsvImportStep('map'));
    document.getElementById('csv-execute-import-btn').addEventListener('click', executeCsvImport);
    
    // „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Çø„Éñ„ÅÆ„Éú„Çø„É≥„Å´„ÇÇ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
    document.getElementById('btn-import-bookmarks-csv').addEventListener('click', () => openCsvImportModal('bookmark'));
}

/**
 * CSV„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Çã
 */
function toggleCsvPopup(open = true) {
    const csvPopup = document.getElementById('csvPopup');
    if (open && csvPopup.style.display !== 'block') {
        csvPopup.style.display = 'block';
        document.getElementById('bookmarkPopup').style.display = 'none';
        document.getElementById('historyPopup').style.display = 'none';
    } else {
        csvPopup.style.display = 'none';
    }
}

/**
 * CSV„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
 * @param {string} type - 'bookmark', 'plot', 'navigate'
 */
async function openCsvImportModal(type) {
    try {
        await loadPapaParse(); // PapaParse„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„ÇÄ
        currentImportType = type;
        const title = document.getElementById('csv-import-title');
        const description = document.getElementById('csv-import-description');
        
        switch(type) {
            case 'bookmark':
                title.textContent = '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´CSV„Çí„Ç§„É≥„Éù„Éº„Éà';
                description.textContent = '„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´‰∏ÄÊã¨ÁôªÈå≤„Åô„ÇãCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                break;
            case 'plot':
                title.textContent = 'CSVÂú∞ÁÇπ„ÇíÂú∞Âõ≥„Å´„Éó„É≠„ÉÉ„Éà';
                description.textContent = 'Âú∞Âõ≥„Å´‰∏ÄÊôÇÁöÑ„Å´„Éó„É≠„ÉÉ„Éà„Åô„ÇãCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                break;
            case 'navigate':
                title.textContent = 'CSV„ÅßÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥';
                description.textContent = 'Â∑°ÂõûÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„Å´„Çµ„Ç§„Éâ„Éë„Éç„É´„Å´ÁôªÈå≤„Åô„ÇãCSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                break;
        }
        
        document.getElementById('csv-import-modal').style.display = 'flex';
        showCsvImportStep('file');
    } catch(error) {
        console.error("CSV„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", error);
        showNotification("CSV„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", "error");
    }
}

/**
 * CSV„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
 */
function closeCsvImportModal() {
    document.getElementById('csv-import-modal').style.display = 'none';
    csvImportData = { raw: null, headers: [], preview: [], mapped: [], fileName: '' };
    document.getElementById('csv-file-input').value = '';
}

/**
 * CSV„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Çã
 */
function showCsvImportStep(step) {
    document.getElementById('csv-file-selection').style.display = 'none';
    document.getElementById('csv-column-mapping').style.display = 'none';
    document.getElementById('csv-import-confirm').style.display = 'none';

    if (step === 'file') {
        document.getElementById('csv-file-selection').style.display = 'block';
    } else if (step === 'map') {
        document.getElementById('csv-column-mapping').style.display = 'block';
    } else if (step === 'confirm') {
        document.getElementById('csv-import-confirm').style.display = 'block';
    }
}

/**
 * „Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
 */
function handleCsvFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    csvImportData.fileName = file.name;

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        preview: 100,
        complete: function(results) {
            if (results.errors.length > 0) {
                showNotification('CSV„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                console.error(results.errors);
                return;
            }
            csvImportData.raw = results.data;
            csvImportData.headers = results.meta.fields;
            csvImportData.preview = results.data.slice(0, 10);
            
            renderCsvPreview();
            renderColumnMappers();
            showCsvImportStep('map');
        }
    });
}

/**
 * CSV„Éá„Éº„Çø„ÅÆ„Éó„É¨„Éì„É•„Éº„ÉÜ„Éº„Éñ„É´„ÇíÁîüÊàê
 */
function renderCsvPreview() {
    const table = document.getElementById('csv-preview-table');
    table.innerHTML = '';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    csvImportData.headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    csvImportData.preview.forEach(row => {
        const tr = document.createElement('tr');
        csvImportData.headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
}

/**
 * „Ç´„É©„É†„Éû„ÉÉ„Éî„É≥„Ç∞„ÅÆUI„ÇíÁîüÊàê
 */
function renderColumnMappers() {
    const grid = document.getElementById('csv-mapper-grid');
    grid.innerHTML = '';
    
    const fields = [
        { id: 'lat', label: 'Á∑ØÂ∫¶', required: true },
        { id: 'lon', label: 'ÁµåÂ∫¶', required: true },
        { id: 'name', label: 'ÂêçÂâç/„É©„Éô„É´', required: currentImportType === 'bookmark' },
        { id: 'address', label: '‰ΩèÊâÄ', required: false },
        { id: 'postcode', label: 'ÈÉµ‰æøÁï™Âè∑', required: false }
    ];

    fields.forEach(field => {
        if (currentImportType !== 'bookmark' && (field.id === 'address' || field.id === 'postcode')) {
            return;
        }

        const item = document.createElement('div');
        item.className = 'column-mapper-item';
        
        const label = document.createElement('label');
        label.htmlFor = `csv-map-${field.id}`;
        label.textContent = field.label;
        if (field.required) {
            label.classList.add('required');
        }
        
        const select = document.createElement('select');
        select.id = `csv-map-${field.id}`;
        select.innerHTML = '<option value="">-- Âàó„ÇíÈÅ∏Êäû --</option>';
        
        csvImportData.headers.forEach((header, index) => {
            const option = document.createElement('option');
            option.value = header;
            option.textContent = header;
            
            const lowerHeader = header.toLowerCase();
            if ((field.id === 'lat' && (lowerHeader.includes('lat') || lowerHeader.includes('Á∑ØÂ∫¶'))) ||
                (field.id === 'lon' && (lowerHeader.includes('lon') || lowerHeader.includes('ÁµåÂ∫¶'))) ||
                (field.id === 'name' && (lowerHeader.includes('name') || lowerHeader.includes('ÂêçÂâç') || lowerHeader.includes('ÂêçÁß∞'))) ||
                (field.id === 'address' && lowerHeader.includes('‰ΩèÊâÄ')) ||
                (field.id === 'postcode' && (lowerHeader.includes('ÈÉµ‰æø') || lowerHeader.includes('post')))
            ) {
                option.selected = true;
            }

            select.appendChild(option);
        });
        
        item.appendChild(label);
        item.appendChild(select);
        grid.appendChild(item);
    });
}

/**
 * „Ç´„É©„É†„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂá¶ÁêÜ„Åó„ÄÅÁ¢∫Ë™çÁîªÈù¢„Å∏
 */
function processColumnMapping() {
    const latCol = document.getElementById('csv-map-lat').value;
    const lonCol = document.getElementById('csv-map-lon').value;
    const nameCol = document.getElementById('csv-map-name')?.value;

    if (!latCol || !lonCol) {
        showNotification('Á∑ØÂ∫¶„Å®ÁµåÂ∫¶„ÅÆÂàó„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ', 'error');
        return;
    }
    if (currentImportType === 'bookmark' && !nameCol) {
        showNotification('„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´„ÅØÂêçÂâç„ÅÆÂàó„ÅåÂøÖÈ†à„Åß„Åô„ÄÇ', 'error');
        return;
    }

    csvImportData.mapped = csvImportData.raw.map(row => {
        const lat = parseFloat(row[latCol]);
        const lon = parseFloat(row[lonCol]);
        
        if (isNaN(lat) || isNaN(lon)) return null;

        const point = {
            lat: lat,
            lon: lon,
            name: row[nameCol] || `Âú∞ÁÇπ ${lat.toFixed(4)}, ${lon.toFixed(4)}`,
            raw: row
        };

        if(currentImportType === 'bookmark') {
            const addressCol = document.getElementById('csv-map-address')?.value;
            const postcodeCol = document.getElementById('csv-map-postcode')?.value;
            point.address = addressCol ? row[addressCol] : '';
            point.postcode = postcodeCol ? row[postcodeCol] : '';
        }

        return point;
    }).filter(p => p !== null);

    if (csvImportData.mapped.length === 0) {
        showNotification('ÊúâÂäπ„Å™Â∫ßÊ®ô„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂàó„ÅÆÊåáÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    document.getElementById('csv-import-count').textContent = csvImportData.mapped.length;
    showCsvImportStep('confirm');
}


/**
 * ÊúÄÁµÇÁöÑ„Å™„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ„ÇíÂÆüË°å
 */
async function executeCsvImport() {
    const btn = document.getElementById('csv-execute-import-btn');
    btn.disabled = true;
    btn.textContent = 'Âá¶ÁêÜ‰∏≠...';

    try {
        switch (currentImportType) {
            case 'bookmark':
                await importCsvAsBookmarks();
                break;
            case 'plot':
                await plotCsvData();
                break;
            case 'navigate':
                await startCsvNavigator();
                break;
        }
    } finally {
        btn.disabled = false;
        btn.textContent = '„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å';
        closeCsvImportModal();
    }
}

/**
 * CSV„Éá„Éº„Çø„Çí„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å®„Åó„Å¶ÁôªÈå≤
 */
async function importCsvAsBookmarks() {
    let bookmarks = getProjectData(BOOKMARK_KEY) || [];
    let importedCount = 0;
    
    for (const point of csvImportData.mapped) {
        bookmarks.unshift({
            name: point.name,
            lat: point.lat.toFixed(8),
            lon: point.lon.toFixed(8),
            zoom: 16,
            timestamp: new Date().toISOString(),
            postcode: point.postcode || '---',
            address: point.address || '---',
            elevation: '---',
            xy_x: '---',
            xy_y: '---',
            xy_system: '---'
        });
        importedCount++;
    }
    
    setProjectData(BOOKMARK_KEY, bookmarks);
    renderBookmarkList();
    renderBookmarkTable();
    renderBookmarksOnMap();
    showNotification(`${importedCount}‰ª∂„ÅÆ„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
}

/**
 * CSV„Éá„Éº„Çø„ÇíÂú∞Âõ≥‰∏ä„Å´„Éó„É≠„ÉÉ„Éà
 */
async function plotCsvData() {
    if (!csvPlotLayer) return;
    
    csvPlotLayer.clearLayers();
    const markers = [];
    const nameCol = document.getElementById('csv-map-name')?.value;

    csvImportData.mapped.forEach(point => {
const popupContent = Object.entries(point.raw)
    .map(([key, value]) => `<b>${sanitizeForHtml(key)}:</b> ${sanitizeForHtml(String(value))}`)
    .join('<br>');

        const marker = L.marker([point.lat, point.lon])
            .bindPopup(popupContent);
        
        markers.push(marker);
    });

    csvPlotLayer.addLayers(markers);
    if(markers.length > 0) {
        osmMap.fitBounds(csvPlotLayer.getBounds(), { padding: [50, 50] });
        showNotification(`${markers.length}‰ª∂„ÅÆÂú∞ÁÇπ„Çí„Éó„É≠„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
        document.getElementById('csv-clear-plot-btn-header').disabled = false;
    }
}


/**
 * CSVÂ∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº„ÇíÈñãÂßã
 */
async function startCsvNavigator() {
    csvNavigatorData.points = csvImportData.mapped;
    csvNavigatorData.currentIndex = 0;
    csvNavigatorData.fileName = csvImportData.fileName;
    
    initCsvNavigator();
    
    const navTab = document.getElementById('csv-navigator-tab');
    navTab.style.display = 'block';
    navTab.click();
    
    showNotification(`Â∑°Âõû„Éä„Éì„Ç≤„Éº„Çø„Éº„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü: ${csvNavigatorData.points.length}‰ª∂`);
}

/**
 * CSV„Éä„Éì„Ç≤„Éº„Çø„Éº„ÅÆUI„ÇíÂàùÊúüÂåñ„ÉªË°®Á§∫
 */
function initCsvNavigator() {
    const container = document.getElementById('csv-navigator-container');
    L.DomEvent.disableClickPropagation(container);
    document.getElementById('csv-nav-title').textContent = `Â∑°Âõû: ${csvNavigatorData.fileName}`;
    renderCsvNavList();
    updateCsvNavigator();
    document.getElementById('csv-nav-close').onclick = () => {
        csvNavigatorData.points = [];
        csvNavigatorData.currentIndex = -1;
        document.getElementById('csv-navigator-tab').style.display = 'none';
        document.querySelector('.panel-tab[data-tab="map-links"]').click();
    };
    document.getElementById('csv-nav-prev').onclick = () => navigateCsv('prev');
    document.getElementById('csv-nav-next').onclick = () => navigateCsv('next');
}

/**
 * CSV„Éä„Éì„Ç≤„Éº„Çø„Éº„ÅÆ„É™„Çπ„ÉàÈÉ®ÂàÜ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
 */
function renderCsvNavList() {
    const listEl = document.getElementById('csv-nav-list');
    listEl.innerHTML = '';
    csvNavigatorData.points.forEach((point, index) => {
        const li = document.createElement('li');
        li.className = 'csv-nav-item';
        li.dataset.index = index;
        li.textContent = point.name;
        li.onclick = () => {
            csvNavigatorData.currentIndex = index;
            updateCsvNavigator();
        };
        listEl.appendChild(li);
    });
}

/**
 * CSV„Éä„Éì„Ç≤„Éº„Çø„Éº„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞ÔºàÂú∞Âõ≥„ÄÅUIÔºâ
 */
function updateCsvNavigator() {
    const index = csvNavigatorData.currentIndex;
    const points = csvNavigatorData.points;
    if (index < 0 || index >= points.length) return;

    const currentPoint = points[index];
    updateLatLonInputs(currentPoint.lat, currentPoint.lon);
    updateCurrentCoords({ lat: currentPoint.lat, lon: currentPoint.lon }, true);

    document.getElementById('csv-nav-progress').textContent = `${index + 1} / ${points.length}`;
    document.getElementById('csv-nav-prev').disabled = index === 0;
    document.getElementById('csv-nav-next').disabled = index === points.length - 1;

    document.querySelectorAll('.csv-nav-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.index) === index);
    });
    
    const activeItem = document.querySelector(`.csv-nav-item[data-index="${index}"]`);
    if (activeItem) {
        activeItem.scrollIntoView({ block: 'nearest' });
    }
}

/**
 * CSV„Éä„Éì„Ç≤„Éº„Çø„Éº„Åß„ÄåÂâç„Å∏„Äç„ÄåÊ¨°„Å∏„Äç„ÇíÂá¶ÁêÜ
 */
function navigateCsv(direction) {
    if (direction === 'prev' && csvNavigatorData.currentIndex > 0) {
        csvNavigatorData.currentIndex--;
    } else if (direction === 'next' && csvNavigatorData.currentIndex < csvNavigatorData.points.length - 1) {
        csvNavigatorData.currentIndex++;
    }
    updateCsvNavigator();
}

// ‚ñ≤‚ñ≤‚ñ≤„ÄêË≤º„Çä‰ªò„Åë„ÅØ„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº„Äê„Åì„Åì„Åã„ÇâËøΩÂä†„Äë„Çπ„ÉÜ„ÉÉ„Éó3 Áµ±ÂêàÊúÄÁµÇÁâà„Ç≥„Éº„Éâ ‚ñº‚ñº‚ñº

function initRightMap() {
    if (mapRight) {
        mapRight.remove();
        mapRight = null;
    }
    const mapContainer = document.getElementById('mapRight');
    if (!mapContainer) return;

    try {
        const center = mapLeft.getCenter();
        const zoom = mapLeft.getZoom();

        mapRight = L.map('mapRight', {
            zoomControl: false, attributionControl: true
        }).setView(center, zoom);

        const rightBaseMaps = {};
        for (const key in BASE_LAYERS) {
            const config = BASE_LAYERS[key];
            rightBaseMaps[config.name] = L.tileLayer(config.url, { maxZoom: config.maxZoom || 19, attribution: config.attribution });
        }
        L.control.layers(rightBaseMaps).addTo(mapRight);
        
        const defaultRightLayerKey = currentSettings.defaultLayerRight || 'gsi_seamlessphoto';
        const defaultRightLayer = Object.values(rightBaseMaps).find(l => l.options.attribution === BASE_LAYERS[defaultRightLayerKey].attribution && l._url.includes(BASE_LAYERS[defaultRightLayerKey].url.split('/')[3]));
        if (defaultRightLayer) {
            defaultRightLayer.addTo(mapRight);
        } else {
            Object.values(rightBaseMaps)[3].addTo(mapRight); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        }

        markerRight = L.marker(center).addTo(mapRight);

        mapRight.dragging.disable();
        mapRight.touchZoom.disable();
        mapRight.doubleClickZoom.disable();
        mapRight.scrollWheelZoom.disable();
        mapContainer.style.cursor = 'default';

    } catch (e) {
        console.error("Âè≥Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº:", e);
    }
}


let syncTimeout;
function syncRightMap() {
    if (isSyncing || !mapRight) return;
    isSyncing = true;
    mapRight.setView(mapLeft.getCenter(), mapLeft.getZoom(), { animate: false, noMoveStart: true });
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(() => { isSyncing = false; }, 50);
}

function startSync() {
    if (mapLeft) mapLeft.on('move zoom', syncRightMap);
}

function stopSync() {
    if (mapLeft) mapLeft.off('move zoom', syncRightMap);
}

function toggleDualViewMode() {
    if (window.innerWidth <= 1024) {
        showNotification('2ÁîªÈù¢Ë°®Á§∫„ÅØPC„Åß„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ', 'warning');
        return;
    }

    const mapContainer = document.getElementById('osmClickMap');
    const toggleBtn = document.getElementById('toggleDualViewBtn');
    
    isDualView = !isDualView;
    mapContainer.classList.toggle('dual-view-mode', isDualView);
    toggleBtn.classList.toggle('active', isDualView);
    // toggleBtn.innerHTML = isDualView ? 'üî≥' : 'üî≤';

    if (isDualView) {
        // initRightMap„ÅØ„É¨„Ç§„Ç¢„Ç¶„ÉàÂ§âÊõ¥„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´Âëº„Å≥Âá∫„Åô
        setTimeout(() => {
            initRightMap();
            startSync();
        }, 410);
    } else {
        stopSync();
        if (mapRight) {
            mapRight.remove();
            mapRight = null;
        }
    }
    
    // invalidateSize„Çí‰∏°Êñπ„ÅÆÂú∞Âõ≥„Å´ÂØæ„Åó„Å¶„ÄÅ„Çà„ÇäÁ¢∫ÂÆü„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂëº„Å≥Âá∫„Åô
    setTimeout(() => {
        if (mapLeft) mapLeft.invalidateSize();
        if (isDualView && mapRight) {
            mapRight.invalidateSize();
        }
    }, 420); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÁõ¥Âæå
}

// DOMContentLoadedÂÜÖ„Åß„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí‰∏ÄÂ∫¶„Å†„ÅëË®≠ÂÆö
document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('toggleDualViewBtn');
    if (btn) {
        btn.addEventListener('click', toggleDualViewMode);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤„ÄêËøΩÂä†„Åì„Åì„Åæ„Åß„Äë‚ñ≤‚ñ≤‚ñ≤

</script>
</body>
</html>