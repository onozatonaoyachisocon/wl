<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´ä½ãƒ»æ¨™é«˜ å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’§</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px;
            color: #1a1a1a;
        }
        
        .container {
            max-width: 98vw;
            height: calc(100% - 6px);
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex; 
            flex-direction: column; 
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 25px;
            flex-shrink: 0; 
        }

        .header-content {
            display: flex;
            align-items: baseline;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-content h1 { font-size: 1.8em; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 0; white-space: nowrap; }
        .header-content p { font-size: 0.9em; opacity: 0.95; line-height: 1.6; margin: 0; white-space: nowrap; }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .btn-header {
            padding: 8px 16px; border-radius: 8px; font-size: 0.9em;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: 2px solid rgba(255,255,255,0.7); background: transparent; color: white;
        }
        .btn-header:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }

        .content { padding: 10px; flex-grow: 1; overflow: hidden; }
        
        .section {
            background: #f8f9fa; border-radius: 12px;
            padding: 2px 10px 10px 10px;
            border: 1px solid #e9ecef;
        }
        
        .section h2 {
            font-size: 1.3em; font-weight: 600; margin-bottom: 5px;
            color: #667eea; display: flex; align-items: center; gap: 8px;
        }
        .section-description { color: #6c757d; font-size: 0.95em; margin-bottom: 5px; line-height: 1.5; }
        .form-group { display: flex; flex-direction: column; gap: 2px; margin-bottom: 3px; }
        label { font-weight: 600; margin-bottom: 2px; font-size: 0.9em; color: #495057; display: flex; align-items: center; gap: 4px; }
        .required-mark { color: #dc3545; margin-left: 3px; }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px 12px; border: 2px solid #e9ecef;
            border-radius: 8px; font-size: 1em;
            transition: all 0.2s; font-family: inherit;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea { resize: vertical; min-height: 100px; font-family: monospace; }
        
        .btn {
            padding: 7px 20px; border: none; border-radius: 8px;
            font-size: 1em; font-weight: 600; cursor: pointer;
            transition: all 0.2s; width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; margin-top: 5px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
        
        .button-group { display: flex; gap: 10px; margin-top: 5px; }
        .button-group .btn { width: auto; flex: 1; margin-top: 0; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4); }
        .history-panel-header .button-group .btn { font-size: 0.9em; white-space: nowrap; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        th { background-color: #495057; color: white; padding: 8px; text-align: center; font-weight: 600; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        #result-table th, #result-table td { padding: 5px; }
        #result-table th:not(:last-child), #result-table td:not(:last-child) { border-right: 1px solid #dee2e6; }
        .highlight-current { background-color: #e7f3ff !important; border-left: 4px solid #007bff; }
        .highlight-location { background-color: #d4edda !important; border-left: 4px solid #28a745; }
        .el-value { font-weight: 700; color: #dc3545; }

        .graph-container {
            display: flex;
            margin-top: 15px;
            padding: 0 15px 15px 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-items: stretch; 
            flex: 1; 
            min-height: 0;
        }
        .y-axis { display: flex; flex-direction: column; justify-content: space-between; position: relative; flex-shrink: 0; font-size: 0.85em; color: #495057; }
        .y-axis.left { width: 60px; text-align: right; padding-right: 5px; }
        .y-axis.right { width: 80px; text-align: left; padding-left: 5px; }
        .axis-label {
            font-weight: 600; color: #343a40; font-size: 0.9em; position: absolute;
            top: -18px; left: 0; width: 100%; text-align: center; white-space: nowrap;
        }
        .y-axis .tick { position: absolute; transform: translateY(50%); white-space: nowrap; }
        .y-axis .tick-mark { position: absolute; height: 2px; background-color: #aab5c0; width: 8px; transform: translateY(-50%); }
        .y-axis.left .tick-mark { right: -4px; }
        .y-axis.right .tick-mark { left: -4px; }
        
        .chart-area { flex-grow: 1; background: linear-gradient(to top, #e3f2fd 0%, #ffffff 100%); position: relative; border: 2px solid #495057; border-radius: 8px; overflow: hidden; }
        .grid-line { position: absolute; width: 100%; left: 0; border-top: 1px dashed #cdd4da; z-index: 0; }
        .level-line { position: absolute; width: 100%; left: 0; border-top-style: solid; display: flex; align-items: center; z-index: 2; padding: 0 10px; }
        .level-label { background: rgba(255, 255, 255, 0.95); padding: 4px 10px; font-size: 0.85em; border-radius: 6px; font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); border: 2px solid; position: absolute; left: 10px; transform: translateY(-50%); white-space: nowrap; }
        .level-label.center-top { left: 50%; transform: translate(-50%, -50%); margin-top: 0; }
        #line-location { border-top: 3px solid #28a745; }
        #line-location .level-label { border-color: #28a745; background-color: #d4edda; color: #155724; right: 10px; left: auto; }
        #line-keikaku { border-top: 4px dashed #696969; }
        #line-keikaku .level-label { border-color: #696969; color: #000000; background-color: #a9a9a9; }
        #line-hinan { border-top: 3px solid #800080; }
        #line-hinan .level-label { border-color: #800080; color: #fff; background-color: #800080; }
        #line-handan { border-top: 3px solid #dc3545; }
        #line-handan .level-label { border-color: #dc3545; color: #fff; background-color: #dc3545; }
        #line-chuui { border-top: 3px solid #ffc107; }
        #line-chuui .level-label { border-color: #ffc107; color: #343a40; background-color: #fff3cd; }
        #line-taiki { border-top: 3px solid #0000cd; }
        #line-taiki .level-label { border-color: #0000cd; color: #000000; background-color: #87cefa; }
        #line-evacuation-prepare, #line-evacuation-start { border-top: 4px solid black; }
        #line-evacuation-prepare .level-label, #line-evacuation-start .level-label { border-color: black; background-color: #ffff00; color: black; }
        
        .current-water-level { position: absolute; width: 100%; left: 0; bottom: 0; background: linear-gradient(to top, rgba(0, 123, 255, 0.7), rgba(0, 123, 255, 0.3)); transition: height 0.5s ease; display: flex; justify-content: center; align-items: flex-end; z-index: 1; }
        .current-water-label { padding: 6px 12px; font-weight: 700; color: white; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); font-size: 1em; margin-bottom: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; }
        .extracted { background-color: #d4edda !important; border-color: #28a745 !important; }
        
        .two-column-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .column-left-form, .column-right-form { display: flex; flex-direction: column; gap: 1px; }
        .column-right-form h3 { font-size: 1.1em; color: #495057; margin-top: 4px; margin-bottom: 1px; }
        .datum-selection { background-color: #e9ecef; padding: 8px; border-radius: 8px; margin-bottom: 10px; }
        .datum-selection .form-group { margin-bottom: 0; }

        .main-layout-grid {
            display: grid;
            /* Default values, will be overridden by JS if saved state exists */
            grid-template-columns: 1.5fr 5px 3fr 5px 1fr;
            height: 100%;
        }
        .main-layout-grid.history-collapsed {
            grid-template-columns: 1fr 5px 1fr 0px 45px !important; /* Use important to override inline style from JS */
        }
        .resizer-vertical {
            background-color: #e9ecef;
            cursor: col-resize;
            transition: background-color 0.2s;
        }
        .resizer-vertical:hover { background-color: #ced4da; }
        
        .history-panel.collapsed .history-section > *:not(.history-panel-header),
        .history-panel.collapsed #map-container { display: none; }
        .history-panel.collapsed .history-panel-header .header-top-row,
        .history-panel.collapsed .history-panel-header .button-group { display: none; }
        .history-panel.collapsed { padding-top: 0; padding-bottom: 0; }
        .history-panel-header { position: relative; }
        #toggle-history-panel {
            position: absolute; top: 8px; z-index: 10;
            width: 30px; height: 30px; border-radius: 50%;
            border: 1px solid #ccc; background: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            right: -5px;
        }
        .history-collapsed #toggle-history-panel { right: auto; left: 50%; transform: translateX(-50%); }

        .layout-column-center {
            display: grid;
            /* Default values, will be overridden by JS if saved state exists */
            grid-template-columns: 1fr 5px 1fr;
            height: 100%;
            overflow: hidden;
            min-width: 0;
        }
        .layout-column-center > .section { display: flex; flex-direction: column; min-height: 0; min-width: 0; }
        .results-column { display: flex; flex-direction: column; gap: 5px; max-height: 100%; min-width: 0; }
        .results-column > .section:last-of-type { display: flex; flex-direction: column; flex: 1; min-height: 0; }
        .section-b-container { display: flex; flex-direction: column; flex: 1; min-height: 0; }
        .form-scroll-wrapper { flex: 1; overflow-y: auto; padding: 5px 10px 5px 5px; margin: 0 -5px; }
        .button-wrapper { margin-top: auto; padding-top: 5px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 90%; max-width: 500px; }
        .modal-content h2 { margin-bottom: 15px; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-actions .btn { width: auto; }

        .history-panel { display: grid; grid-template-rows: 4fr 6fr; gap: 10px; overflow: hidden; min-width: 0; }
        .history-section { display: flex; flex-direction: column; min-height: 0; }
        .history-panel-header { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .history-panel-header .header-top-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .history-panel-header .header-top-row h2 { margin-bottom: 0; flex-shrink: 0; }
        .history-panel-header .header-top-row .btn { white-space: nowrap; margin-top: 0; flex-shrink: 1; }
        .history-panel-header .button-group { margin-top: 0; }
        .history-tree-wrapper { flex-grow: 1; overflow-y: auto; min-height: 150px; padding: 10px 5px; margin: 10px -5px 0; border-top: 1px solid #e9ecef; }
        .history-tree ul { list-style: none; padding-left: 15px; }
        .history-tree summary { cursor: pointer; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 0.9em; }
        .history-tree summary:hover { background-color: #e9ecef; }
        .history-tree .tree-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 5px; cursor: pointer; border-radius: 4px; margin-left: -15px; padding-left: 15px; font-size: 0.85em; }
        .history-tree li.tree-item:nth-child(even) { background-color: #f8f9fa; }
        .history-tree .tree-item:hover { background-color: #e0e9f5; }
        .history-tree .tree-item.active { background-color: #cddcfa; font-weight: bold; }
        .history-tree .delete-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2em; opacity: 0.5; padding: 0 5px; }
        .history-tree .delete-btn:hover { opacity: 1; }

        #map-container { display: flex; flex-direction: column; min-height: 0; }
        .map-header { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 10px; flex-shrink: 0; margin-bottom: 5px; }
        #map-coordinates { font-size: 0.9em; color: #495057; font-family: monospace; white-space: nowrap; }
        #weather-display { font-size: 1.1em; font-weight: 600; padding: 3px 8px; background-color: rgba(255,255,255,0.7); border-radius: 8px; border: 1px solid #dee2e6; }
        #map { width: 100%; flex-grow: 1; border-radius: 8px; border: 1px solid #e9ecef; z-index: 0; }

        .form-scroll-wrapper input[type="text"], .form-scroll-wrapper input[type="number"], .form-scroll-wrapper select { padding-top: 5px; padding-bottom: 5px; }
        .form-scroll-wrapper label { margin-bottom: 0px; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .section-a-layout { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .section-a-textarea-group { flex-grow: 1; display: flex; flex-direction: column; margin-bottom: 10px; }
        .section-a-textarea-group .form-group { flex-grow: 1; margin-bottom: 0; }
        .section-a-textarea-group textarea { height: 100%; }
        .section-a-button-group { display: flex; gap: 10px; }
        .section-a-button-group .btn { margin-top: 0 !important; white-space: nowrap; font-size: 0.9em; padding-left: 15px; padding-right: 15px; }
        
        .onboarding-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .onboarding-container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 800px; width: 100%; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .progress-bar { height: 4px; background: #e0e0e0; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        .onboarding-content-wrapper { overflow-y: auto; }
        .step-content { padding: 40px; display: none; }
        .step-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 2em; color: #667eea; margin-bottom: 20px; font-weight: 700; }
        .step-description { font-size: 1.1em; line-height: 1.8; color: #555; margin-bottom: 30px; }
        .example-box { background: #f8f9fa; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .example-title { font-weight: 600; color: #667eea; margin-bottom: 10px; }
        .onboarding-container .button-group { display: flex; gap: 15px; margin-top: 40px; }
        .onboarding-container .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; flex: 1; margin-top: 0; }
        .onboarding-container .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .onboarding-container .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .onboarding-container .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .onboarding-container .btn-secondary:hover { background: #f8f9fa; }
        .feature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0; }
        .feature-card { background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center; }
        .feature-icon { font-size: 3em; margin-bottom: 10px; }
        .feature-name { font-weight: 600; color: #333; margin-bottom: 8px; }
        .feature-desc { font-size: 0.9em; color: #666; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .warning-box strong { color: #856404; }
        .step-indicator { text-align: center; color: #999; font-size: 0.9em; margin-top: 20px; }
        
        @media (max-width: 1600px) {
            html, body { height: auto; overflow: auto; }
            .container { height: auto; }
            .main-layout-grid, .layout-column-center {
                grid-template-columns: 1fr;
                height: auto;
            }
            .resizer-vertical { display: none; }
            .main-layout-grid.history-collapsed { grid-template-columns: 1fr; }
            .history-panel { display: none; }
            .layout-column-center { display: contents; } 
            .results-column > .section:last-of-type { min-height: 500px; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 10px; padding: 10px; }
            .header-content h1 { font-size: 1.5em; }
            .graph-container { flex-direction: column; align-items: stretch; }
            .y-axis { width: 100%; height: auto; flex-direction: row; padding: 10px 0; }
            .axis-label { writing-mode: horizontal-tb; transform: none; position: static; text-align: center; width: 100%;}
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-content">
            <h1>ğŸ’§æ°´ä½ãƒ»æ¨™é«˜ å¤‰æ›ãƒ„ãƒ¼ãƒ«ğŸŒŠ</h1>
            <p>æ²³å·è¦³æ¸¬æ‰€ã‚„ç¾åœ°ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã€æ°´ä½ã¨æ¨™é«˜ã®é–¢ä¿‚ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™</p>
        </div>
        <div class="header-actions">
            <button id="sample-data-button" class="btn-header">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
            <button id="show-help-button" class="btn-header">ï¼Ÿ ãƒ˜ãƒ«ãƒ—</button>
        </div>
    </div>

    <div class="content">
        <div class="main-layout-grid" id="main-layout">
            
            <div class="layout-column-center" id="col-ab-container">
                <div class="section" id="col-a">
                    <h2>ğŸ“‹ A. è«¸å…ƒè¡¨ã‹ã‚‰æŠ½å‡º</h2>
                    <div class="form-group" style="background-color: #e9ecef; padding: 8px; border-radius: 8px; margin-bottom: 10px;">
                        <label for="input-datum-select">
                            <strong>è²¼ã‚Šä»˜ã‘ã‚‹<u>é›¶ç‚¹é«˜</u>ã®åŸºæº–é¢ã‚’é¸æŠ</strong>
                        </label>
                        <select id="input-datum-select">
                            <option value="" selected disabled>-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                            <option value="TP" data-name="T.P." data-offset="0">T.P. (æ±äº¬æ¹¾ä¸­ç­‰æ½®ä½)</option>
                            <option value="KP" data-name="K.P." data-offset="-0.8745">K.P. (åŒ—ä¸Šå·) [T.P. -0.8745m]</option>
                            <option value="SP" data-name="S.P." data-offset="-0.0873">S.P. (é³´ç€¬å·) [T.P. -0.0873m]</option>
                            <option value="YP" data-name="Y.P." data-offset="-0.8402">Y.P. (åˆ©æ ¹å·) [T.P. -0.8402m]</option>
                            <option value="AP_ARAKAWA" data-name="A.P." data-offset="-1.1344">A.P. (è’å·ãƒ»ä¸­å·ãƒ»å¤šæ‘©å·) [T.P. -1.1344m]</option>
                            <option value="OP" data-name="O.P." data-offset="-1.3000">O.P. (æ·€å·) [T.P. -1.3000m]</option>
                            <option value="AP_YOSHINO" data-name="A.P." data-offset="-0.8333">A.P. (å‰é‡å·) [T.P. -0.8333m]</option>
                            <option value="TPW" data-name="T.P.W." data-offset="0.113">T.P.W. (æ¸¡å·) [T.P. +0.113m]</option>
                            <option value="BSL" data-name="B.S.L." data-offset="84.371">B.S.L. (çµç¶æ¹–) [T.P. +84.371m]</option>
                        </select>
                    </div>

                    <div class="section-a-layout">
                        <div class="section-a-textarea-group">
                            <p class="section-description">è¦³æ¸¬æ‰€ã®è«¸å…ƒè¡¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘</p>
                            <div class="form-group">
                                <textarea id="spec-text" placeholder="è¦³æ¸¬æ‰€å	å²©æ·µæ°´é–€ï¼ˆä¸Šï¼‰ï¼ˆã„ã‚ã¶ã¡ã™ã„ã‚‚ã‚“ï¼ˆã‹ã¿ï¼‰ï¼‰&#10;..."></textarea>
                            </div>
                        </div>
                        <div class="section-a-button-group">
                            <a href="https://www.river.go.jp/index" target="_blank" class="btn btn-info">å·ã®é˜²ç½æƒ…å ±</a>
                            <button id="extract-button" class="btn btn-primary" style="background: #28a745;">è«¸å…ƒè¡¨ã‹ã‚‰æŠ½å‡º</button>
                        </div>
                    </div>
                </div>
                
                <div class="resizer-vertical" id="resizer-ab"></div>

                <div class="section section-b-container" id="col-b">
                    <h2>âœï¸ B. è¦³æ¸¬æ‰€ã®æƒ…å ±ã‚’å…¥åŠ›</h2>
                    <p class="section-description">Aæ¬„ã§æŠ½å‡ºå¾Œã€å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>

                    <div class="form-scroll-wrapper">
                        <div class="datum-selection">
                            <div class="form-group">
                                <label for="datum-select">
                                    <strong>è¡¨ç¤ºã«ä½¿ç”¨ã™ã‚‹åŸºæº–é¢ã‚’é¸æŠ</strong>
                                </label>
                                <select id="datum-select">
                                    <option value="TP" data-name="T.P." data-offset="0">æ±äº¬æ¹¾ä¸­ç­‰æ½®ä½ (T.P.)</option>
                                    <option value="KP" data-name="K.P." data-offset="-0.8745">åŒ—ä¸Šå· (K.P.) [T.P. -0.8745m]</option>
                                    <option value="SP" data-name="S.P." data-offset="-0.0873">é³´ç€¬å· (S.P.) [T.P. -0.0873m]</option>
                                    <option value="YP" data-name="Y.P." data-offset="-0.8402">åˆ©æ ¹å· (Y.P.) [T.P. -0.8402m]</option>
                                    <option value="AP_ARAKAWA" data-name="A.P." data-offset="-1.1344">è’å·ãƒ»ä¸­å·ãƒ»å¤šæ‘©å· (A.P.) [T.P. -1.1344m]</option>
                                    <option value="OP" data-name="O.P." data-offset="-1.3000">æ·€å· (O.P.) [T.P. -1.3000m]</option>
                                    <option value="AP_YOSHINO" data-name="A.P." data-offset="-0.8333">å‰é‡å· (A.P.) [T.P. -0.8333m]</option>
                                    <option value="TPW" data-name="T.P.W." data-offset="0.113">æ¸¡å· (T.P.W.) [T.P. +0.113m]</option>
                                    <option value="BSL" data-name="B.S.L." data-offset="84.371">çµç¶æ¹– (B.S.L.) [T.P. +84.371m]</option>
                                </select>
                            </div>
                        </div>

                        <div class="two-column-form">
                            <div class="column-left-form">
                                <div class="form-group"><label for="station-name">è¦³æ¸¬æ‰€å</label><input type="text" id="station-name" placeholder="ä¾‹: å²©æ·µæ°´é–€(ä¸Š)"></div>
                                <div class="form-group">
                                    <label for="zero-point">æ°´ä½æ¨™ã®ã‚¼ãƒ­ç‚¹é«˜<span class="required-mark">*</span></label>
                                    <input type="number" id="zero-point" step="0.01" placeholder="ä¾‹: 0.00">
                                </div>
                                <div class="form-group">
                                    <label for="keikaku-level">è¨ˆç”»é«˜æ°´ä½ (m)</label>
                                    <input type="number" id="keikaku-level" step="0.01">
                                </div>
                                <div class="form-group"><label for="hinan-level">æ°¾æ¿«å±é™ºæ°´ä½ (m)</label><input type="number" id="hinan-level" step="0.01"></div>
                                <div class="form-group"><label for="handan-level">é¿é›£åˆ¤æ–­æ°´ä½ (m)</label><input type="number" id="handan-level" step="0.01"></div>
                                <div class="form-group"><label for="chuui-level">æ°¾æ¿«æ³¨æ„æ°´ä½ (m)</label><input type="number" id="chuui-level" step="0.01"></div>
                                <div class="form-group"><label for="taiki-level">æ°´é˜²å›£å¾…æ©Ÿæ°´ä½ (m)</label><input type="number" id="taiki-level" step="0.01"></div>
                            </div>
                            <div class="column-right-form">
                                <div class="form-group"><label for="observation-datetime">æ°´ä½è¦³æ¸¬æ—¥æ™‚</label><input type="text" id="observation-datetime" placeholder="ä¾‹: 2025/11/08 10:00"></div>
                                <div class="form-group"><label for="current-level">æ°´ä½ (m)</label><input type="number" id="current-level" step="0.01" placeholder="ä¾‹: 1.97"></div>
                                <div class="form-group">
                                    <label for="location-elevation">ç¾åœ¨åœ°ã®æ¨™é«˜ (T.P. m)</label>
                                    <input type="number" id="location-elevation" step="0.01" placeholder="ä¾‹: 8.50">
                                </div>
                                <h3>âš ï¸ é¿é›£è¡Œå‹•åŸºæº–</h3>
                                <div class="form-group">
                                    <label for="evacuation-prepare-offset">é¿é›£æº–å‚™é–‹å§‹ (mä¸‹)</label>
                                    <input type="number"id="evacuation-prepare-offset" step="0.1" placeholder="ä¾‹: 2.0">
                                </div>
                                <div class="form-group"><label for="evacuation-start-offset">é¿é›£é–‹å§‹ (mä¸‹)</label><input type="number" id="evacuation-start-offset" step="0.1" placeholder="ä¾‹: 1.5"></div>
                                <h3>ã‚°ãƒ©ãƒ•è¡¨ç¤ºç¯„å›²</h3>
                                <div class="form-row">
                                    <div class="form-group" id="max-level-group"><label for="max-level">æœ€å¤§æ°´ä½ (m)</label><input type="number" id="max-level" step="1" placeholder="è‡ªå‹•èª¿æ•´"></div>
                                    <div class="form-group" id="min-level-group"><label for="min-level">æœ€å°æ°´ä½ (m)</label><input type="number" id="min-level" step="1" placeholder="è‡ªå‹•èª¿æ•´"></div>
                                </div>
                                <input type="hidden" id="latitude">
                                <input type="hidden" id="longitude">
                            </div>
                        </div>
                    </div>
                    <div class="button-wrapper">
                        <button id="calculate-button" class="btn btn-primary">ğŸ“Š è¨ˆç®—ãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º</button>
                    </div>
                </div>
            </div>

            <div class="resizer-vertical" id="resizer-bc"></div>

            <div class="results-column" id="col-c">
                <div class="section">
                    <h2 id="result-title">ğŸ“ˆ C. å¤‰æ›çµæœ</h2>
                    <table id="result-table">
                        <thead><tr><th>æ°´ä½ã®åç§°</th><th>æ°´ä½ (m)</th><th>æ¨™é«˜ (T.P. m)</th></tr></thead>
                        <tbody id="result-table-body"></tbody>
                    </table>
                </div>
                <div class="section">
                    <h2>ğŸ“‰ D. æ°´ä½ã¨æ¨™é«˜ã®ã‚°ãƒ©ãƒ•</h2>
                    <div class="graph-container">
                        <div class="y-axis left" id="level-axis">
                            <div class="axis-label">æ°´ä½ (m)</div>
                        </div>
                        <div class="chart-area" id="chart-area"></div>
                        <div class="y-axis right" id="elevation-axis">
                            <div class="axis-label" id="elevation-axis-label">æ¨™é«˜ (T.P. m)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="resizer-vertical" id="resizer-ch"></div>

            <div class="history-panel section" id="col-h">
                 <div class="history-section">
                    <div class="history-panel-header">
                        <button id="toggle-history-panel" title="ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€">Â»</button>
                         <div class="header-top-row">
                            <h2>ğŸ“ ä¿å­˜å±¥æ­´</h2>
                            <button id="show-save-modal-button" class="btn btn-primary">ç¾åœ¨ã®è¨­å®šã‚’æ–°è¦ä¿å­˜</button>
                         </div>
                         <div class="button-group">
                            <button id="import-button" class="btn btn-info">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                            <button id="export-button" class="btn btn-secondary">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                         </div>
                         <input type="file" id="import-file-input" style="display: none;" accept=".json">
                    </div>
                    <div class="history-tree-wrapper">
                        <div id="history-tree"></div>
                    </div>
                </div>
                
                <div id="map-container">
                    <div class="map-header">
                        <h2>ğŸ“ è¦³æ¸¬æ‰€ä½ç½®</h2>
                        <span id="weather-display"></span>
                        <span id="map-coordinates"></span>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="save-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>å±¥æ­´ã«æ–°è¦ä¿å­˜</h2>
        <div class="form-group"><label for="save-suikei">æ°´ç³»å<span class="required-mark">*</span></label><input type="text" id="save-suikei" placeholder="ä¾‹: è’å·æ°´ç³»"></div>
        <div class="form-group"><label for="save-kasen">æ²³å·å<span class="required-mark">*</span></label><input type="text" id="save-kasen" placeholder="ä¾‹: è’å·"></div>
        <div class="form-group"><label for="save-station">è¦³æ¸¬æ‰€åï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰</label><input type="text" id="save-station" disabled></div>
        <div class="form-group"><label for="save-location-name">åœ°ç‚¹ã®åç§° (ä»»æ„)</label><input type="text" id="save-location-name" placeholder="ä¾‹: è‡ªå®…, å‹¤å‹™å…ˆãªã©"></div>
        <div class="modal-actions">
            <button id="cancel-save-button" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="confirm-save-button" class="btn btn-primary">ã“ã®å†…å®¹ã§ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="onboarding-modal" class="onboarding-modal-overlay">
    <div class="onboarding-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div class="onboarding-content-wrapper">
            <div class="step-content active" data-step="1">
                <div class="step-title">ğŸŒŠ æ°´ä½ãƒ»æ¨™é«˜å¤‰æ›ãƒ„ãƒ¼ãƒ«ã¸ã‚ˆã†ã“ã</div>
                <div class="step-description">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€æ²³å·ã®è¦³æ¸¬æ‰€æƒ…å ±ã‹ã‚‰æ°´ä½ã¨æ¨™é«˜ã®é–¢ä¿‚ã‚’è¨ˆç®—ã—ã€é¿é›£åˆ¤æ–­ã«å½¹ç«‹ã¤è¦–è¦šçš„ãªæƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚</div>
                <div class="feature-grid">
                    <div class="feature-card"><div class="feature-icon">ğŸ“‹</div><div class="feature-name">ç°¡å˜ãƒ‡ãƒ¼ã‚¿æŠ½å‡º</div><div class="feature-desc">è«¸å…ƒè¡¨ã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã ã‘</div></div>
                    <div class="feature-card"><div class="feature-icon">ğŸ“Š</div><div class="feature-name">è¦–è¦šçš„ãªã‚°ãƒ©ãƒ•</div><div class="feature-desc">æ°´ä½ã¨æ¨™é«˜ã®é–¢ä¿‚ã‚’ä¸€ç›®ã§æŠŠæ¡</div></div>
                    <div class="feature-card"><div class="feature-icon">âš ï¸</div><div class="feature-name">é¿é›£åŸºæº–è¡¨ç¤º</div><div class="feature-desc">ç¾åœ¨åœ°ã¨ã®é–¢ä¿‚ã‚’æ˜ç¢ºåŒ–</div></div>
                    <div class="feature-card"><div class="feature-icon">ğŸ’¾</div><div class="feature-name">å±¥æ­´ç®¡ç†</div><div class="feature-desc">è¤‡æ•°åœ°ç‚¹ã‚’ä¿å­˜ãƒ»æ¯”è¼ƒ</div></div>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="onboarding.skip()">ã‚¹ã‚­ãƒƒãƒ—</button>
                    <button class="btn btn-primary" onclick="onboarding.nextStep()">æ¬¡ã¸</button>
                </div>
                <div class="step-indicator">ã‚¹ãƒ†ãƒƒãƒ— 1 / 4</div>
            </div>
            
            <div class="step-content" data-step="2">
                <div class="step-title">ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—1: è«¸å…ƒè¡¨ã‹ã‚‰æŠ½å‡º</div>
                <div class="step-description">å›½åœŸäº¤é€šçœã®ã€Œå·ã®é˜²ç½æƒ…å ±ã‚µã‚¤ãƒˆã€ã‹ã‚‰è¦³æ¸¬æ‰€ã®è«¸å…ƒè¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</div>
                <div class="example-box">
                    <div class="example-title">ğŸ’¡ æ‰‹é †</div>
                    <ol style="padding-left: 20px; line-height: 2;">
                        <li><strong>åŸºæº–é¢ã‚’é¸æŠ</strong>: è«¸å…ƒè¡¨ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é›¶ç‚¹é«˜ã®åŸºæº–é¢ï¼ˆT.P., K.P.ãªã©ï¼‰ã‚’é¸ã³ã¾ã™</li>
                        <li><strong>è«¸å…ƒè¡¨ã‚’ã‚³ãƒ”ãƒš</strong>: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¾ã™</li>
                        <li><strong>ã€Œè«¸å…ƒè¡¨ã‹ã‚‰æŠ½å‡ºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
                    </ol>
                </div>
                <div class="warning-box"><strong>âš ï¸ é‡è¦:</strong> åŸºæº–é¢ã®é¸æŠã‚’é–“é•ãˆã‚‹ã¨ã€è¨ˆç®—çµæœãŒå¤§ãããšã‚Œã¾ã™ã€‚å¿…ãšè«¸å…ƒè¡¨ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹åŸºæº–é¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="onboarding.prevStep()">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" onclick="onboarding.nextStep()">æ¬¡ã¸</button>
                </div>
                <div class="step-indicator">ã‚¹ãƒ†ãƒƒãƒ— 2 / 4</div>
            </div>
            
            <div class="step-content" data-step="3">
                <div class="step-title">âœï¸ ã‚¹ãƒ†ãƒƒãƒ—2: æƒ…å ±ã‚’ç¢ºèªãƒ»å…¥åŠ›</div>
                <div class="step-description">æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</div>
                <div class="example-box">
                    <div class="example-title">ğŸ’¡ å…¥åŠ›é …ç›®</div>
                    <ul style="padding-left: 20px; line-height: 2;">
                        <li><strong>å¿…é ˆ:</strong> æ°´ä½æ¨™ã®ã‚¼ãƒ­ç‚¹é«˜ï¼ˆè‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™ï¼‰</li>
                        <li><strong>æ¨å¥¨:</strong> å„ç¨®æ°´ä½ï¼ˆè¨ˆç”»é«˜æ°´ä½ã€æ°¾æ¿«å±é™ºæ°´ä½ãªã©ï¼‰</li>
                        <li><strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³:</strong> ç¾åœ¨åœ°ã®æ¨™é«˜ã€é¿é›£è¡Œå‹•åŸºæº–</li>
                    </ul>
                </div>
                <div class="example-box">
                    <div class="example-title">ğŸ¯ è¡¨ç¤ºç”¨åŸºæº–é¢ã®é¸æŠ</div>
                    ã‚°ãƒ©ãƒ•ã‚„è¡¨ã®è¨ˆç®—å€¤ã«ä½¿ç”¨ã™ã‚‹åŸºæº–é¢ã‚’é¸ã¹ã¾ã™ã€‚é€šå¸¸ã¯T.P.ï¼ˆæ±äº¬æ¹¾ä¸­ç­‰æ½®ä½ï¼‰ã‚’æ¨å¥¨ã—ã¾ã™ãŒã€åœ°åŸŸã«ã‚ˆã£ã¦ä½¿ã„æ…£ã‚ŒãŸåŸºæº–é¢ã‚’é¸æŠã§ãã¾ã™ã€‚
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="onboarding.prevStep()">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" onclick="onboarding.nextStep()">æ¬¡ã¸</button>
                </div>
                <div class="step-indicator">ã‚¹ãƒ†ãƒƒãƒ— 3 / 4</div>
            </div>
            
            <div class="step-content" data-step="4">
                <div class="step-title">ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—3: çµæœã®ç¢ºèªã¨ä¿å­˜</div>
                <div class="step-description">ã€Œè¨ˆç®—ãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                <div class="example-box">
                    <div class="example-title">ğŸ“ˆ è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±</div>
                    <ul style="padding-left: 20px; line-height: 2;">
                        <li><strong>å¤‰æ›çµæœè¡¨:</strong> å„æ°´ä½ã®æ¨™é«˜å€¤</li>
                        <li><strong>ã‚°ãƒ©ãƒ•:</strong> æ°´ä½ã¨æ¨™é«˜ã®é–¢ä¿‚ã‚’è¦–è¦šåŒ–</li>
                        <li><strong>åœ°å›³:</strong> è¦³æ¸¬æ‰€ã®ä½ç½®ã¨å¤©æ°—æƒ…å ±</li>
                    </ul>
                </div>
                <div class="example-box">
                    <div class="example-title">ğŸ’¾ å±¥æ­´ã¸ã®ä¿å­˜</div>
                    ã€Œç¾åœ¨ã®è¨­å®šã‚’æ–°è¦ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€æ°´ç³»åãƒ»æ²³å·åãƒ»åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚è¤‡æ•°åœ°ç‚¹ã‚’ä¿å­˜ã—ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
                </div>
                <div class="warning-box"><strong>âš ï¸ æ³¨æ„:</strong> å±¥æ­´ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å®šæœŸçš„ã«ã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€æ©Ÿèƒ½ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="onboarding.prevStep()">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" onclick="onboarding.start()">ä½¿ã£ã¦ã¿ã‚‹</button>
                </div>
                <div class="step-indicator">ã‚¹ãƒ†ãƒƒãƒ— 4 / 4</div>
            </div>
        </div>
    </div>
</div>


<script>
    // â–¼â–¼â–¼ ADDED: Column Width Persistence Logic â–¼â–¼â–¼
    function loadColumnWidths() {
        const resizer = document.getElementById('resizer-bc');
        if (!resizer || resizer.offsetParent === null) {
            return; // Don't load widths on mobile/responsive view
        }

        const mainLayoutColumns = localStorage.getItem('mainLayoutColumns');
        if (mainLayoutColumns) {
            document.getElementById('main-layout').style.gridTemplateColumns = mainLayoutColumns;
        }

        const abLayoutColumns = localStorage.getItem('abLayoutColumns');
        if (abLayoutColumns) {
            document.getElementById('col-ab-container').style.gridTemplateColumns = abLayoutColumns;
        }
    }

    function initializeResizers() {
        const createResizableColumn = (resizer, leftEl, rightEl, minLeft, minRight, storageKey) => {
            let x = 0;
            let leftWidth = 0;

            const mouseDownHandler = (e) => {
                e.preventDefault();
                x = e.clientX;
                leftWidth = leftEl.getBoundingClientRect().width;

                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            };

            const mouseMoveHandler = (e) => {
                const dx = e.clientX - x;
                const newLeftWidth = leftWidth + dx;
                
                const parentGrid = leftEl.parentElement;
                const rightWidth = rightEl.getBoundingClientRect().width;
                const newRightWidth = rightWidth - dx;

                if (newLeftWidth < minLeft || newRightWidth < minRight) {
                    return;
                }

                const allColumns = Array.from(parentGrid.children);
                const gridTemplateColumns = getComputedStyle(parentGrid).gridTemplateColumns.split(' ');
                
                const leftIndex = allColumns.indexOf(leftEl);
                const rightIndex = allColumns.indexOf(rightEl);

                gridTemplateColumns[leftIndex] = `${newLeftWidth}px`;
                gridTemplateColumns[rightIndex] = '1fr'; 
                
                parentGrid.style.gridTemplateColumns = gridTemplateColumns.join(' ');
            };

            const mouseUpHandler = () => {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';

                // Save the new layout to localStorage
                if (storageKey) {
                    const parentGrid = leftEl.parentElement;
                    localStorage.setItem(storageKey, parentGrid.style.gridTemplateColumns);
                }

                if (window.map) {
                    setTimeout(() => window.map.invalidateSize(), 50);
                }
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        };

        const resizerAB = document.getElementById('resizer-ab');
        const resizerBC = document.getElementById('resizer-bc');
        const resizerCH = document.getElementById('resizer-ch');

        const colA = document.getElementById('col-a');
        const colB = document.getElementById('col-b');
        const colABContainer = document.getElementById('col-ab-container');
        const colC = document.getElementById('col-c');
        const colH = document.getElementById('col-h');

        createResizableColumn(resizerAB, colA, colB, 250, 250, 'abLayoutColumns');
        createResizableColumn(resizerBC, colABContainer, colC, 540, 400, 'mainLayoutColumns');
        // Both BC and CH resizers affect the main layout, so they save to the same key.
        createResizableColumn(resizerCH, colC, colH, 400, 300, 'mainLayoutColumns');
    }
    // â–²â–²â–² ADDED â–²â–²â–²

    const savableFieldIds = [
        'spec-text', 'datum-select', 'station-name', 'zero-point',
        'keikaku-level', 'hinan-level', 'handan-level', 'chuui-level', 'taiki-level',
        'observation-datetime', 'current-level', 'location-elevation',
        'evacuation-prepare-offset', 'evacuation-start-offset',
        'max-level', 'min-level', 'input-datum-select',
        'latitude', 'longitude'
    ];
    const historyStorageKey = 'waterLevelConverterHistory';
    const onboardingStorageKey = 'onboardingCompleted';
    let historyData = [];
    let activeHistoryId = null;
    let map;
    let marker;

    const saveModal = document.getElementById('save-modal');
    const historyTreeContainer = document.getElementById('history-tree');

    const onboarding = {
        modal: document.getElementById('onboarding-modal'),
        currentStep: 1,
        totalSteps: 4,
        
        show: function() { this.showStep(1); this.modal.style.display = 'flex'; },
        hide: function() { this.modal.style.display = 'none'; },
        updateProgress: function() {
            const progress = (this.currentStep / this.totalSteps) * 100;
            document.getElementById('progress').style.width = progress + '%';
        },
        showStep: function(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
            if (stepContent) {
                stepContent.classList.add('active'); this.currentStep = step; this.updateProgress();
            }
        },
        nextStep: function() { if (this.currentStep < this.totalSteps) this.showStep(this.currentStep + 1); },
        prevStep: function() { if (this.currentStep > 1) this.showStep(this.currentStep - 1); },
        skip: function() { if (confirm('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\nãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œï¼Ÿ ãƒ˜ãƒ«ãƒ—ã€ã‹ã‚‰ã„ã¤ã§ã‚‚å†è¡¨ç¤ºã§ãã¾ã™ã€‚')) this.start(); },
        start: function() { this.hide(); localStorage.setItem(onboardingStorageKey, 'true'); }
    };

    function initMap() {
        const gsiStd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>å›½åœŸåœ°ç†é™¢</a>" });
        const gsiPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>å›½åœŸåœ°ç†é™¢</a>" });
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' });
        map = L.map('map', { center: [36, 138], zoom: 5, layers: [gsiStd] });
        const baseLayers = { "åœ°ç†é™¢åœ°å›³": gsiStd, "åœ°ç†é™¢åœ°å›³(å†™çœŸ)": gsiPhoto, "OpenStreetMap": osm };
        L.control.layers(baseLayers).addTo(map);
    }
    
    async function fetchWeather(lat, lon) {
        const apiKey = 'APIã‚­ãƒ¼';
        const weatherDisplay = document.getElementById('weather-display');
        weatherDisplay.innerHTML = ''; 
        if (apiKey === 'APIã‚­ãƒ¼') { console.warn('å¤©æ°—æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€OpenWeatherMapã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'); return; }
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=ja`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status}`);
            const data = await response.json();
            const icon = mapWeatherToIcon(data.weather[0].main);
            const temp = Math.round(data.main.temp);
            weatherDisplay.innerHTML = `${icon} ${temp}â„ƒ`;
        } catch (error) { console.error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error); weatherDisplay.innerHTML = 'å¤©æ°—å–å¾—å¤±æ•—'; }
    }
    
    function mapWeatherToIcon(weatherMain) {
        switch (weatherMain) {
            case 'Clear': return 'â˜€ï¸'; case 'Clouds': return 'â˜ï¸'; case 'Rain': return 'ğŸŒ§ï¸';
            case 'Drizzle': return 'ğŸŒ¦ï¸'; case 'Thunderstorm': return 'â›ˆï¸'; case 'Snow': return 'â„ï¸';
            case 'Mist': case 'Smoke': case 'Haze': case 'Dust': case 'Fog': case 'Sand': case 'Ash': case 'Squall': case 'Tornado': return 'ğŸŒ«ï¸';
            default: return 'â”';
        }
    }

    function updateMap(lat, lon, name) {
        const coordDisplay = document.getElementById('map-coordinates');
        if (marker) { map.removeLayer(marker); marker = null; }
        coordDisplay.textContent = ''; document.getElementById('weather-display').innerHTML = '';
        const latitude = parseFloat(lat); const longitude = parseFloat(lon); const stationName = name || 'è¦³æ¸¬æ‰€';
        if (!isNaN(latitude) && !isNaN(longitude) && map) {
            coordDisplay.textContent = `ç·¯åº¦: ${latitude.toFixed(6)}, çµŒåº¦: ${longitude.toFixed(6)}`;
            marker = L.marker([latitude, longitude]).addTo(map).bindPopup(`<b>${stationName}</b>`).openPopup();
            map.setView([latitude, longitude], 14);
            fetchWeather(latitude, longitude);
            setTimeout(() => map.invalidateSize(), 200);
        }
    }
    
    function convertDMSToDD(dms) {
        if (!dms || typeof dms !== 'string') return null;
        const pattern = /(\d{1,3})[\sÂ°åº¦ã€-]\s*(\d{1,2})[\s'â€²åˆ†ã€-]\s*(\d{1,2}(?:\.\d+)?)[\s"â€³ç§’]?/;
        const match = dms.match(pattern);
        if (match) {
            const degrees = parseFloat(match[1]), minutes = parseFloat(match[2]), seconds = parseFloat(match[3]);
            if (!isNaN(degrees) && !isNaN(minutes) && !isNaN(seconds)) return degrees + (minutes / 60) + (seconds / 3600);
        }
        return null;
    }

    function calculateNiceTickStep(range, maxTicks = 10) {
        if (range <= 0) return 1;
        const rawStep = range / maxTicks;
        const magnitude = Math.pow(10, Math.floor(Math.log10(rawStep)));
        const residual = rawStep / magnitude;
        if (residual > 5) return 10 * magnitude; if (residual > 2) return 5 * magnitude; if (residual > 1) return 2 * magnitude; return magnitude;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        loadColumnWidths(); // â–¼â–¼â–¼ ADDED: Load saved widths on start â–¼â–¼â–¼
        scriptFunctions.loadHistory();
        scriptFunctions.renderHistoryTree();
        scriptFunctions.setupEventListeners();
        initializeResizers(); 
        if (!localStorage.getItem(onboardingStorageKey)) onboarding.show();
    });

    document.getElementById('extract-button').addEventListener('click', function() {
        const text = document.getElementById('spec-text').value, inputDatumSelect = document.getElementById('input-datum-select');
        const isNewFormat = text.includes('â– æœ€æ–°è¦³æ¸¬å€¤');
        let extractionMap, latLonRegex, isLatLonDMS = false;

        if (isNewFormat) {
            extractionMap = { 'station-name': /^[^\n]+\n([^\n]+)/, 'zero-point': /æ°´ä½æ¨™ã®ã‚¼ãƒ­ç‚¹é«˜\(T\.P\.\)\s*([+-]?[\d\.]+)\s*m/i, 'hinan-level': /æ°¾æ¿«å±é™ºæ°´ä½\s*:\s*([+-]?[\d\.]+)\s*m/i, 'handan-level': /é¿é›£åˆ¤æ–­æ°´ä½\s*:\s*([+-]?[\d\.]+)\s*m/i, 'chuui-level': /æ°¾æ¿«æ³¨æ„æ°´ä½\s*:\s*([+-]?[\d\.]+)\s*m/i };
            latLonRegex = /ç·¯åº¦\s*([\d\.]+)\s*çµŒåº¦\s*([\d\.]+)/; isLatLonDMS = false; inputDatumSelect.value = 'TP';
        } else {
            extractionMap = { 'station-name': /(?:è¦³æ¸¬æ‰€å|åç§°)\s*(.+)/, 'zero-point': /(?:é›¶ç‚¹é«˜|ã‚¼ãƒ­ç‚¹é«˜)\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i, 'keikaku-level': /è¨ˆç”»é«˜æ°´ä½\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i, 'hinan-level': /(?:ã¯ã‚“æ¿«å±é™ºæ°´ä½|æ°¾æ¿«å±é™ºæ°´ä½)\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i, 'handan-level': /é¿é›£åˆ¤æ–­æ°´ä½\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i, 'chuui-level': /(?:ã¯ã‚“æ¿«æ³¨æ„æ°´ä½|æ°¾æ¿«æ³¨æ„æ°´ä½)\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i, 'taiki-level': /æ°´é˜²å›£å¾…æ©Ÿæ°´ä½\s*(?:[A-Z\.\s]+)?([+-]?[\d\.]+)\s*m/i };
            latLonRegex = /ä¸–ç•Œæ¸¬åœ°ç³»\s*.*?åŒ—ç·¯\s*([\d\såº¦Â°åˆ†â€²'ç§’â€³\.\-]+)\s*æ±çµŒ\s*([\d\såº¦Â°åˆ†â€²'ç§’â€³\.\-]+)/; isLatLonDMS = true;
        }

        if (!inputDatumSelect.value) { alert('è«¸å…ƒè¡¨ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã€Œé›¶ç‚¹é«˜ã€ã®åŸºæº–é¢ï¼ˆä¾‹: T.P.ã€A.P.ãªã©ï¼‰ã«åˆã‚ã›ã¦ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰åŒã˜ã‚‚ã®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); inputDatumSelect.focus(); return; }
        
        const selectedOption = inputDatumSelect.selectedOptions[0], inputDatumOffset = parseFloat(selectedOption.dataset.offset), inputDatumName = selectedOption.dataset.name;
        let foundCount = 0;
        ['keikaku-level', 'taiki-level'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });

        for (const id in extractionMap) {
            const match = text.match(extractionMap[id]), element = document.getElementById(id);
            if (!element) continue;
            element.classList.remove('extracted');
            if (match && match[1]) {
                const extractedValueStr = match[1].trim();
                if (id === 'station-name') { element.value = extractedValueStr; } 
                else { const extractedValue = parseFloat(extractedValueStr); if (isNaN(extractedValue)) continue; if (id === 'zero-point') { element.value = (extractedValue + (isNewFormat ? 0 : inputDatumOffset)).toFixed(4); } else { element.value = extractedValue.toFixed(4); } }
                element.classList.add('extracted'); foundCount++;
            }
        }
        
        const latElement = document.getElementById('latitude'), lonElement = document.getElementById('longitude');
        latElement.classList.remove('extracted'); lonElement.classList.remove('extracted');
        
        const latLonMatch = text.match(latLonRegex);
        if (latLonMatch && latLonMatch[1] && latLonMatch[2]) {
            let latDD, lonDD;
            if (isLatLonDMS) { latDD = convertDMSToDD(latLonMatch[1].trim()); lonDD = convertDMSToDD(latLonMatch[2].trim()); } 
            else { latDD = parseFloat(latLonMatch[1].trim()); lonDD = parseFloat(latLonMatch[2].trim()); }
            if (latDD !== null && !isNaN(latDD) && lonDD !== null && !isNaN(lonDD)) {
                latElement.value = latDD.toFixed(6); lonElement.value = lonDD.toFixed(6);
                latElement.classList.add('extracted'); lonElement.classList.add('extracted'); foundCount += 2;
            }
        }

        if (foundCount > 0) {
            const message = isNewFormat ? `âœ… ${foundCount}å€‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã€é›¶ç‚¹é«˜ã‚’T.P.åŸºæº–ã§å…¥åŠ›ã—ã¾ã—ãŸã€‚\nå†…å®¹ã‚’ç¢ºèªã—ã€ä¸è¶³åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚` : `âœ… ${foundCount}å€‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã€é›¶ç‚¹é«˜ã‚’ ${inputDatumName} ã‹ã‚‰T.P.åŸºæº–ã«æ›ç®—ã—ã¾ã—ãŸã€‚\nå†…å®¹ã‚’ç¢ºèªã—ã€ä¸è¶³åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
            alert(message);
        } else { alert('âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); }
        updateMap(latElement.value, lonElement.value, document.getElementById('station-name').value);
    });

    document.getElementById('calculate-button').addEventListener('click', function() {
        const ui = { inputDatumSelect: document.getElementById('input-datum-select'), datumSelect: document.getElementById('datum-select'), zeroPointInput: document.getElementById('zero-point'), tableHeaderRow: document.querySelector('#result-table thead tr'), tableBody: document.getElementById('result-table-body'), chartArea: document.getElementById('chart-area'), levelAxis: document.getElementById('level-axis'), elevationAxis: document.getElementById('elevation-axis'), elevationAxisLabel: document.getElementById('elevation-axis-label'), stationNameInput: document.getElementById('station-name'), resultTitle: document.getElementById('result-title'), minLevelInput: document.getElementById('min-level'), maxLevelInput: document.getElementById('max-level'), latitudeInput: document.getElementById('latitude'), longitudeInput: document.getElementById('longitude'), rightPane: document.getElementById('col-c') };
        const formValues = { keikaku: parseFloat(document.getElementById('keikaku-level').value), hinan: parseFloat(document.getElementById('hinan-level').value), handan: parseFloat(document.getElementById('handan-level').value), chuui: parseFloat(document.getElementById('chuui-level').value), taiki: parseFloat(document.getElementById('taiki-level').value), current: parseFloat(document.getElementById('current-level').value), locationElevation: parseFloat(document.getElementById('location-elevation').value), evacPrepareOffset: parseFloat(document.getElementById('evacuation-prepare-offset').value), evacStartOffset: parseFloat(document.getElementById('evacuation-start-offset').value), observationDateTime: document.getElementById('observation-datetime').value.trim() };

        if (ui.inputDatumSelect.value && ui.datumSelect.value && ui.inputDatumSelect.value !== ui.datumSelect.value) {
            const inputDatumText = ui.inputDatumSelect.selectedOptions[0].text.split(' ')[0], datumText = ui.datumSelect.selectedOptions[0].text.split(' ')[0];
            if (!confirm(`è«¸å…ƒè¡¨ã®åŸºæº–é¢ (${inputDatumText}) ã¨è¡¨ç¤ºç”¨ã®åŸºæº–é¢ (${datumText}) ãŒç•°ãªã£ã¦ã„ã¾ã™ã€‚\n\nã“ã®ã¾ã¾è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
        }
        const zeroPoint = parseFloat(ui.zeroPointInput.value);
        if (isNaN(zeroPoint)) { alert('âš ï¸ å¿…é ˆé …ç›®ã€Œæ°´ä½æ¨™ã®ã‚¼ãƒ­ç‚¹é«˜ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        
        const selectedOption = ui.datumSelect.selectedOptions[0], datumName = selectedOption.dataset.name, datumOffset = parseFloat(selectedOption.dataset.offset), isTpSelected = (datumName === 'T.P.');
        ui.tableBody.innerHTML = ''; ui.tableHeaderRow.innerHTML = isTpSelected ? '<th>æ°´ä½ã®åç§°</th><th>æ°´ä½ (m)</th><th>æ¨™é«˜ (T.P. m)</th>' : `<th>æ°´ä½ã®åç§°</th><th>æ°´ä½ (m)</th><th>æ¨™é«˜ (T.P. m)</th><th>æ¨™é«˜ (${datumName} m)</th>`;
        ui.elevationAxisLabel.textContent = isTpSelected ? `æ¨™é«˜ (T.P. m)` : `æ¨™é«˜ (${datumName} m)`;
        
        const levelsData = [ { id: 'keikaku', name: 'è¨ˆç”»é«˜æ°´ä½', level: formValues.keikaku, centerTop: true }, { id: 'hinan', name: 'æ°¾æ¿«å±é™ºæ°´ä½', level: formValues.hinan }, { id: 'handan', name: 'é¿é›£åˆ¤æ–­æ°´ä½', level: formValues.handan }, { id: 'chuui', name: 'æ°¾æ¿«æ³¨æ„æ°´ä½', level: formValues.chuui }, { id: 'taiki', 'name': 'æ°´é˜²å›£å¾…æ©Ÿæ°´ä½', level: formValues.taiki }, { id: 'current', name: 'ç¾åœ¨ã®æ°´ä½', level: formValues.current } ];
        if (!isNaN(formValues.locationElevation)) {
            const locationWaterLevel = formValues.locationElevation - zeroPoint;
            levelsData.push({ id: 'location', name: 'ç¾åœ¨åœ°', level: locationWaterLevel });
            if (!isNaN(formValues.evacPrepareOffset) && formValues.evacPrepareOffset > 0) levelsData.push({ id: 'evacuation-prepare', name: 'é¿é›£æº–å‚™é–‹å§‹', level: locationWaterLevel - formValues.evacPrepareOffset, centerTop: true });
            if (!isNaN(formValues.evacStartOffset) && formValues.evacStartOffset > 0) levelsData.push({ id: 'evacuation-start', name: 'é¿é›£é–‹å§‹', level: locationWaterLevel - formValues.evacStartOffset, centerTop: true });
        }
        
        ui.chartArea.innerHTML = ''; ui.levelAxis.innerHTML = '<div class="axis-label">æ°´ä½ (m)</div>'; ui.elevationAxis.innerHTML = `<div class="axis-label" id="elevation-axis-label">${isTpSelected ? "æ¨™é«˜ (T.P. m)" : `æ¨™é«˜ (${datumName} m)`}</div>`;
        const stationName = ui.stationNameInput.value;
        ui.resultTitle.textContent = stationName ? `ğŸ“ˆ C. å¤‰æ›çµæœ (${stationName})` : 'ğŸ“ˆ C. å¤‰æ›çµæœ';
        const validLevels = levelsData.filter(item => !isNaN(item.level));
        if (validLevels.length === 0) { ui.tableBody.innerHTML = `<tr><td colspan="${isTpSelected ? 3 : 4}">è¡¨ç¤ºã§ãã‚‹æœ‰åŠ¹ãªæ°´ä½ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`; return; }

        validLevels.sort((a, b) => b.level - a.level).filter(item => !['evacuation-prepare', 'evacuation-start'].includes(item.id)).forEach(item => {
            const elevationTP = (item.level + zeroPoint), row = ui.tableBody.insertRow();
            if (item.id === 'current') row.className = 'highlight-current'; if (item.id === 'location') row.className = 'highlight-location';
            let rowHTML = `<td><strong>${item.name}</strong></td><td>${item.level.toFixed(2)} m</td><td class="el-value">${elevationTP.toFixed(2)} m</td>`;
            if (!isTpSelected) rowHTML += `<td class="el-value">${(elevationTP - datumOffset).toFixed(2)} m</td>`; row.innerHTML = rowHTML;
        });
        
        const userMinLevel = parseFloat(ui.minLevelInput.value), userMaxLevel = parseFloat(ui.maxLevelInput.value);
        let chartMinLevel = isNaN(userMinLevel) ? 0 : userMinLevel, chartMaxLevel;
        if (!isNaN(userMaxLevel) && userMaxLevel > chartMinLevel) { chartMaxLevel = userMaxLevel; } 
        else {
            const maxLevelValue = Math.max(...validLevels.map(item => item.level), chartMinLevel), keikakuLevel = formValues.keikaku;
            const topValue = !isNaN(keikakuLevel) && keikakuLevel > maxLevelValue ? keikakuLevel : maxLevelValue;
            if (topValue <= chartMinLevel) chartMaxLevel = chartMinLevel + 10;
            else { const range = topValue - chartMinLevel, expandedRange = range / 0.85, niceStep = calculateNiceTickStep(expandedRange, 5); chartMaxLevel = Math.ceil((chartMinLevel + expandedRange) / niceStep) * niceStep; }
        }
        if (chartMinLevel >= chartMaxLevel) chartMaxLevel = chartMinLevel + 10;
        
        const chartRange = chartMaxLevel - chartMinLevel; if (chartRange <= 0) return;
        const axisStep = calculateNiceTickStep(chartRange, 10), startTick = Math.ceil(chartMinLevel / axisStep) * axisStep;

        for (let i = startTick; i <= chartMaxLevel; i += axisStep) {
            if (i < chartMinLevel) continue;
            const bottomPercent = ((i - chartMinLevel) / chartRange) * 100;
            if (bottomPercent > 100) continue;
            const gridLine = document.createElement('div'); gridLine.className = 'grid-line'; gridLine.style.bottom = `${bottomPercent}%`; ui.chartArea.appendChild(gridLine);
            const levelTick = document.createElement('div'); levelTick.className = 'tick'; levelTick.style.bottom = `${bottomPercent}%`; levelTick.textContent = `${i.toFixed(i % 1 !== 0 ? 1 : 0)}m`; ui.levelAxis.appendChild(levelTick);
            const levelTickMark = document.createElement('div'); levelTickMark.className = 'tick-mark'; levelTickMark.style.bottom = `${bottomPercent}%`; ui.levelAxis.appendChild(levelTickMark);
            const elevationValueTP = i + zeroPoint, elevationTick = document.createElement('div'); elevationTick.className = 'tick'; elevationTick.style.bottom = `${bottomPercent}%`;
            elevationTick.textContent = isTpSelected ? `${elevationValueTP.toFixed(2)}m` : `${(elevationValueTP - datumOffset).toFixed(2)}m`; ui.elevationAxis.appendChild(elevationTick);
            const elevationTickMark = document.createElement('div'); elevationTickMark.className = 'tick-mark'; elevationTickMark.style.bottom = `${bottomPercent}%`; ui.elevationAxis.appendChild(elevationTickMark);
        }

        const currentLevelItem = validLevels.find(item => item.id === 'current');
        if (currentLevelItem && currentLevelItem.level >= chartMinLevel) {
            const heightPercent = Math.min(100, ((currentLevelItem.level - chartMinLevel) / chartRange) * 100), currentWaterDiv = document.createElement('div');
            currentWaterDiv.className = 'current-water-level'; currentWaterDiv.style.height = `${heightPercent}%`;
            if (heightPercent > 5) { const labelText = formValues.observationDateTime ? `${formValues.observationDateTime.replace(/ /g, '_')}_æ°´ä½: ${currentLevelItem.level.toFixed(2)}m` : `ç¾åœ¨æ°´ä½: ${currentLevelItem.level.toFixed(2)}m`; currentWaterDiv.innerHTML = `<div class="current-water-label">${labelText}</div>`; }
            ui.chartArea.appendChild(currentWaterDiv);
        }
        validLevels.filter(item => item.id !== 'current').forEach(item => {
            if (item.level < chartMinLevel || item.level > chartMaxLevel) return;
            const bottomPercent = ((item.level - chartMinLevel) / chartRange) * 100, line = document.createElement('div'); line.className = 'level-line'; line.id = `line-${item.id}`; line.style.bottom = `${bottomPercent}%`;
            line.innerHTML = `<span class="${item.centerTop ? 'level-label center-top' : 'level-label'}">${item.name} ${item.level.toFixed(2)}m</span>`; ui.chartArea.appendChild(line);
        });

        if (ui.rightPane) {
            ui.rightPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        updateMap(ui.latitudeInput.value, ui.longitudeInput.value, stationName);
    });
    
    function closeModal() { saveModal.style.display = 'none'; }
    
    const scriptFunctions = {
        loadHistory: () => { const saved = localStorage.getItem(historyStorageKey); historyData = saved ? JSON.parse(saved) : []; },
        saveHistory: () => { localStorage.setItem(historyStorageKey, JSON.stringify(historyData)); },
        renderHistoryTree: () => {
            if (historyData.length === 0) { historyTreeContainer.innerHTML = '<p style="color: #6c757d; text-align: center; padding-top: 20px;">ä¿å­˜ã•ã‚ŒãŸå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; }
            const grouped = historyData.reduce((acc, item) => {
                const suikei = item.suikei || 'æœªåˆ†é¡', kasen = item.kasen || 'æœªåˆ†é¡';
                if (!acc[suikei]) acc[suikei] = {}; if (!acc[suikei][kasen]) acc[suikei][kasen] = [];
                acc[suikei][kasen].push(item); return acc;
            }, {});
            let html = '<ul class="history-tree">';
            for (const suikei of Object.keys(grouped).sort()) {
                html += `<li><details open><summary><strong>${suikei}</strong></summary><ul>`;
                for (const kasen of Object.keys(grouped[suikei]).sort()) {
                    html += `<li><details open><summary><em>${kasen}</em></summary><ul>`;
                    grouped[suikei][kasen].sort((a,b) => a.displayName.localeCompare(b.displayName, 'ja')).forEach(item => {
                        html += `<li class="tree-item ${item.id === activeHistoryId ? 'active' : ''}" data-id="${item.id}"><span>${item.displayName}</span><button class="delete-btn" data-id="${item.id}" title="å‰Šé™¤">Ã—</button></li>`;
                    });
                    html += '</ul></details></li>';
                }
                html += '</ul></details></li>';
            }
            historyTreeContainer.innerHTML = html + '</ul>';
        },
        setupEventListeners: () => {
            document.getElementById('show-save-modal-button').addEventListener('click', () => {
                const specText = document.getElementById('spec-text').value, stationNameInput = document.getElementById('station-name');
                document.getElementById('save-station').value = stationNameInput.value;
                const saveSuikeiInput = document.getElementById('save-suikei'), saveKasenInput = document.getElementById('save-kasen');
                let suikeiMatch, kasenMatch;
                if (specText.includes('â– æœ€æ–°è¦³æ¸¬å€¤')) { suikeiMatch = specText.match(/[^\n]*ã™ã„ã‘ã„\n([^\n]*æ°´ç³»)/); kasenMatch = specText.match(/[^\n]*(?:ã‹ã‚|ãŒã‚)\n([^\n]*(?:å·|ãŒã‚))/); } 
                else { suikeiMatch = specText.match(/æ°´ç³»å\s*(.+)/); kasenMatch = specText.match(/æ²³å·å\s*(.+)/); }
                saveSuikeiInput.value = suikeiMatch ? suikeiMatch[1].trim() : ''; saveKasenInput.value = kasenMatch ? kasenMatch[1].trim() : '';
                if (!saveSuikeiInput.value && !saveKasenInput.value && stationNameInput.value) { const existing = historyData.find(item => item.station === stationNameInput.value); if(existing){ saveSuikeiInput.value = existing.suikei; saveKasenInput.value = existing.kasen; } }
                document.getElementById('save-location-name').value = ''; saveModal.style.display = 'flex';
            });
            
            document.getElementById('cancel-save-button').addEventListener('click', closeModal);
            saveModal.addEventListener('click', (e) => { if (e.target === saveModal) closeModal(); });

            document.getElementById('confirm-save-button').addEventListener('click', () => {
                const suikei = document.getElementById('save-suikei').value.trim(), kasen = document.getElementById('save-kasen').value.trim(), station = document.getElementById('station-name').value.trim(), locationName = document.getElementById('save-location-name').value.trim();
                if (!suikei || !kasen) { alert('âš ï¸ æ°´ç³»åã¨æ²³å·åã¯å¿…é ˆã§ã™ã€‚'); return; }
                const displayName = station + (locationName ? ` (${locationName})` : ''), newEntry = { id: `hist_${new Date().getTime()}`, suikei, kasen, station, locationName, displayName, formData: {} };
                savableFieldIds.forEach(id => { const el = document.getElementById(id); if (el) newEntry.formData[id] = el.value; });
                historyData.push(newEntry); scriptFunctions.saveHistory(); activeHistoryId = newEntry.id; scriptFunctions.renderHistoryTree(); closeModal(); alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            });
            
            historyTreeContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.delete-btn, .delete-btn *')) {
                    const idToDelete = target.closest('.delete-btn').dataset.id;
                    if (confirm('æœ¬å½“ã«ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        historyData = historyData.filter(item => item.id !== idToDelete); scriptFunctions.saveHistory();
                        if (activeHistoryId === idToDelete) activeHistoryId = null;
                        scriptFunctions.renderHistoryTree();
                    }
                } else if (target.closest('.tree-item')) {
                    const idToLoad = target.closest('.tree-item').dataset.id, dataToLoad = historyData.find(item => item.id === idToLoad);
                    if (dataToLoad) {
                        savableFieldIds.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; el.classList.remove('extracted'); } });
                        for (const id in dataToLoad.formData) { const el = document.getElementById(id); if (el && dataToLoad.formData[id] !== undefined) el.value = dataToLoad.formData[id]; }
                        activeHistoryId = idToLoad; scriptFunctions.renderHistoryTree(); document.getElementById('calculate-button').click();
                    }
                }
            });

            document.getElementById('export-button').addEventListener('click', () => {
                if (historyData.length === 0) { alert('â„¹ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹ä¿å­˜å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
                const dataStr = JSON.stringify(historyData, null, 2), dataBlob = new Blob([dataStr], { type: 'application/json' }), a = document.createElement('a');
                a.href = URL.createObjectURL(dataBlob); a.download = `water_level_converter_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            });
            
            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('import-button').addEventListener('click', () => { importFileInput.click(); });
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData) && importedData.every(item => item.id && item.displayName && item.formData)) {
                            if (confirm('ç¾åœ¨ã®å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå†…å®¹ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®å±¥æ­´ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰')) {
                                historyData = importedData; scriptFunctions.saveHistory(); activeHistoryId = null;
                                scriptFunctions.renderHistoryTree(); alert('âœ… å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                            }
                        } else { alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'); }
                    } catch (err) { alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
                };
                reader.readAsText(file); e.target.value = '';
            });

            document.getElementById('show-help-button').addEventListener('click', () => onboarding.show());

            document.getElementById('sample-data-button').addEventListener('click', () => {
                const sampleData = { specText: `æ°´ç³»å	è’å·æ°´ç³»\næ²³å·å	è’å·\nè¦³æ¸¬æ‰€å	å²©æ·µæ°´é–€ï¼ˆä¸Šï¼‰ï¼ˆã„ã‚ã¶ã¡ã™ã„ã‚‚ã‚“ï¼ˆã‹ã¿ï¼‰ï¼‰\næ‰€åœ¨åœ°	æ±äº¬éƒ½åŒ—åŒºå¿—èŒ‚5ä¸ç›®\nç·¯åº¦çµŒåº¦	ä¸–ç•Œæ¸¬åœ°ç³»ã€€åŒ—ç·¯ 35åº¦47åˆ†15ç§’ã€€æ±çµŒ 139åº¦43åˆ†38ç§’\né›¶ç‚¹é«˜	A.P.+2.10m\nè¨ˆç”»é«˜æ°´ä½	8.57m\nã¯ã‚“æ¿«å±é™ºæ°´ä½	7.70m\né¿é›£åˆ¤æ–­æ°´ä½	6.50m\nã¯ã‚“æ¿«æ³¨æ„æ°´ä½	4.10m\næ°´é˜²å›£å¾…æ©Ÿæ°´ä½	3.00m\n`, inputDatum: 'AP_ARAKAWA', currentLevel: '3.15', locationElevation: '6.8', evacuationPrepareOffset: '2.0', evacuationStartOffset: '1.5', observationDateTime: new Date().toLocaleString('sv-SE').replace(' ', ' ').slice(0, 16) };
                document.getElementById('spec-text').value = sampleData.specText;
                document.getElementById('input-datum-select').value = sampleData.inputDatum;
                document.getElementById('current-level').value = sampleData.currentLevel;
                document.getElementById('location-elevation').value = sampleData.locationElevation;
                document.getElementById('evacuation-prepare-offset').value = sampleData.evacuationPrepareOffset;
                document.getElementById('evacuation-start-offset').value = sampleData.evacuationStartOffset;
                document.getElementById('observation-datetime').value = sampleData.observationDateTime.replace('T', ' ');
                document.getElementById('extract-button').click();
                setTimeout(() => { document.getElementById('calculate-button').click(); }, 100);
            });

            document.getElementById('toggle-history-panel').addEventListener('click', (e) => {
                const mainLayout = document.getElementById('main-layout');
                const historyPanel = document.getElementById('col-h');
                const isCollapsed = mainLayout.classList.toggle('history-collapsed');
                historyPanel.classList.toggle('collapsed', isCollapsed);
                e.target.innerHTML = isCollapsed ? 'Â«' : 'Â»'; e.target.title = isCollapsed ? 'ãƒ‘ãƒãƒ«ã‚’å±•é–‹' : 'ãƒ‘ãƒãƒ«ã‚’æŠ˜ã‚ŠãŸãŸã‚€';
                setTimeout(() => {
                    if (map) map.invalidateSize()
                }, 400);
            });
        }
    };
</script>

</body>
</html>