<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ§ÂÜÖÂúüË≥™Ë©¶È®ìÁµêÊûú„ÉªÊï¥ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
   <link rel="icon" href='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>'>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
        .text-dark { color: #0f172a; }
        input:focus { z-index: 10; position: relative; }
        .cell-input:focus { outline: 2px solid #2563eb; outline-offset: -2px; background-color: #e0f2fe; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 5px; border: 2px solid #f1f5f9; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .dragging { opacity: 0.5; background-color: #e2e8f0; }
        .selectable-cell { user-select: text; cursor: text; }
        .bg-detail-col { background-color: #f0f9ff; }
        .bg-calc-col { background-color: #fffbeb; }
        table { border-spacing: 0; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @media print {
            @page { size: landscape; margin: 10mm; }
            body { overflow: visible !important; height: auto !important; background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, .screen-table-container, .screen-graph-container { display: none !important; }
            .print-only, .print-table-container, .print-graph-container { display: block !important; width: 100% !important; }
            th, td, div, span, thead, tbody, tr { position: static !important; overflow: visible !important; }
            table { width: 100% !important; border-collapse: collapse !important; font-size: 8pt !important; margin-bottom: 10px; page-break-inside: auto; }
            th, td { border: 1px solid #000 !important; padding: 2px 4px !important; white-space: nowrap; }
            th { background-color: #f3f4f6 !important; color: #000 !important; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            .print-break-before { page-break-before: always; }
            .print-break-inside-avoid { page-break-inside: avoid; }
            .print-graph-grid { display: grid !important; gap: 20px; width: 100%; }
            .chart-wrapper { page-break-inside: avoid; break-inside: avoid; margin-bottom: 10px; border: none !important; }
        }
        .print-only { display: none; }
        .print-table-container { display: none; }
        .print-graph-container { display: none; }
        /* „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback } = React;

        const PRECISION_MAP = {
            depth_top: 2, depth_bottom: 2,
            N_value: 0,
            rho_t: 3, rho_s: 3,
            wn: 1, WL: 1, WP: 1,
            gravel: 1, sand: 1, silt: 1, clay: 1, Fc: 1,
            D10: 4, D20: 4, D30: 4, D50: 4, D60: 4,
            e: 3, Sr: 1,
            qu: 2, qu_1: 2, qu_2: 2, qu_3: 2, c_uu_qu: 2,
            E50_u: 1, E50_u1: 1, E50_u2: 1, E50_u3: 1,
            c_uu: 2, phi_uu: 1,
            c_cu: 2, phi_cu: 1,
            c_dash: 2, phi_dash: 1,
            c_cd: 2, phi_cd: 1,
            E50_t: 1, E50_t1: 1, E50_t2: 1, E50_t3: 1,
            e0: 3, Cc: 3, Pc: 0,
            Ip: 1, Ic: 3, IL: 3, m_phys: 3, Uc: 2, Uc_prime: 2, m_ratio: 3
        };

        const roundValue = (key, value) => {
            if (value === null || value === '' || isNaN(value)) return value;
            const precision = PRECISION_MAP[key];
            if (precision === undefined) return value;
            const factor = Math.pow(10, precision);
            return Math.round(parseFloat(value) * factor) / factor;
        };

        const calculateAutoStep = (min, max) => {
            if (min >= max) return 1;
            const range = max - min;
            const rough = range / 4; 
            const power = Math.pow(10, Math.floor(Math.log10(rough)));
            let step = Math.ceil(rough / power) * power;
            if (step / power < 1.5) step = 1 * power;
            else if (step / power < 3.5) step = 2 * power;
            else if (step / power < 7.5) step = 5 * power;
            else step = 10 * power;
            return step || 1;
        };

        const getInputStep = (min, max) => {
            const range = Math.abs(max - min);
            if (range <= 10) return 0.1;
            if (range <= 100) return 1;
            if (range <= 1000) return 10;
            return 100;
        };

        const DEFAULT_SOIL_CLASS_MAP = {
            "CH": "Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "CHG-S": "Á†ÇÊ∑∑„Åò„ÇäÁ§´Ë≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "CHS": "Á†ÇË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "CH-S": "Á†ÇÊ∑∑„Åò„ÇäÁ≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "CHSG": "Á†ÇÁ§´Ë≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "CH-SG": "Á†ÇÁ§´Ê∑∑„Åò„ÇäÁ≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "CHS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "CL": "Á≤òÂúüÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "CLS": "Á†ÇË≥™Á≤òÂúüÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "CL-S": "Á†ÇÊ∑∑„Åò„ÇäÁ≤òÂúüÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "CLS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™Á≤òÂúüÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "Cs": "Á≤òÊÄßÂúü", "CsG-S": "Á†ÇÊ∑∑„Åò„ÇäÁ§´Ë≥™Á≤òÊÄßÂúü", "CsS": "Á†ÇË≥™Á≤òÊÄßÂúü", "Cs-SG": "Á†ÇÁ§´Ê∑∑„Åò„ÇäÁ≤òÊÄßÂúü", "CsS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™Á≤òÊÄßÂúü",
            "Fm": "Á¥∞Á≤íÂúü", "Fs": "Á†ÇË≥™Á¥∞Á≤íÂúü", "F-S": "Á†ÇÊ∑∑„Åò„ÇäÁ¥∞Á≤íÂúü", "FS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™Á¥∞Á≤íÂúü",
            "GCsS": "Á≤òÊÄßÂúüË≥™Á†ÇË≥™Á§´", "G-CsS": "Á≤òÊÄßÂúüÁ†ÇÊ∑∑„Åò„ÇäÁ§´", "GCs-S": "Á†ÇÊ∑∑„Åò„ÇäÁ≤òÊÄßÂúüË≥™Á§´",
            "GFA": "Á¥∞Á≤íÂàÜË≥™Á§´", "GFS": "Á¥∞Á≤íÂàÜË≥™Á†ÇË≥™Á§´", "G-FS": "Á¥∞Á≤íÂàÜÁ†ÇÊ∑∑„Åò„ÇäÁ§´", "GF-S": "Á†ÇÊ∑∑„Åò„ÇäÁ¥∞Á≤íÂàÜË≥™Á§´",
            "GOS": "ÊúâÊ©üË≥™Á†ÇË≥™Á§´", "GPS": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ†ÇË≥™Á§´", "GP-S": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ†ÇÊ∑∑„Åò„ÇäÁ§´",
            "GS": "Á†ÇË≥™Á§´", "GS-Cs": "Á≤òÊÄßÂúüÊ∑∑„Åò„ÇäÁ†ÇË≥™Á§´", "GS-F": "Á¥∞Á≤íÂàÜÊ∑∑„Åò„ÇäÁ†ÇË≥™Á§´",
            "GVS": "ÁÅ´Â±±ÁÅ∞Ë≥™Á†ÇË≥™Á§´", "GWS": "Á≤íÂæÑÂπÖ„ÅÆÂ∫É„ÅÑÁ†ÇË≥™Á§´", "GW-S": "Á≤íÂæÑÂπÖ„ÅÆÂ∫É„ÅÑÁ†ÇÊ∑∑„Åò„ÇäÁ§´",
            "MH": "„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MHG": "Á§´Ë≥™„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MH-G": "Á§´Á≤íÂàÜÊ∑∑„Çä„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MHG-S": "Á†ÇÊ∑∑„Åò„ÇäÁ§´Ë≥™„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "MHS": "Á†ÇË≥™„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MH-S": "Á†ÇÊ∑∑„Åò„Çä„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MHSG": "Á†ÇÁ§´Ë≥™„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MH-SG": "Á†ÇÁ§´Ê∑∑„Åò„Çä„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "MHS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™„Ç∑„É´„ÉàÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "ML": "„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "MLG-S": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "MLS": "Á†ÇË≥™„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "ML-S": "Á†ÇÊ∑∑„Åò„Çä„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "ML-SG": "Á†ÇÊ∑∑„Åò„Çä„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "MLS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "OH": "ÊúâÊ©üË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "OH-G": "Á§´Ê∑∑„Åò„ÇäÊúâÊ©üË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "OHS": "Á†ÇË≥™ÊúâÊ©üË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "OH-S": "Á†ÇÊ∑∑„Åò„ÇäÊúâÊ©üË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "OH-SG": "Á†ÇÁ§´Ê∑∑„Åò„ÇäÊúâÊ©üË≥™Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ", "OHS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™ÊúâÊ©üË≥™Á≤òÂúü",
            "OL-SG": "Á†ÇÁ§´Ê∑∑„Åò„ÇäÊúâÊ©üË≥™Á≤òÂúüÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ",
            "Pt": "Ê≥•ÁÇ≠", "Pt-S": "Á†ÇÊ∑∑„Åò„ÇäÊ≥•ÁÇ≠",
            "SCs": "Á≤òÊÄßÂúüË≥™Á†Ç", "S-Cs": "Á≤òÊÄßÂúüÊ∑∑„Åò„ÇäÁ†Ç", "SCsG": "Á≤òÊÄßÂúüË≥™Á§´Ë≥™Á†Ç", "S-CsG": "Á≤òÊÄßÂúüÁ§´Ê∑∑„Åò„ÇäÁ†Ç", "SCs-G": "Á§´Ê∑∑„Åò„ÇäÁ≤òÊÄßÂúüË≥™Á†Ç",
            "SF": "Á¥∞Á≤íÂàÜË≥™Á†Ç", "S-F": "Á¥∞Á≤íÂàÜÊ∑∑„Åò„ÇäÁ†Ç", "SFG": "Á¥∞Á≤íÂàÜË≥™Á§´Ë≥™Á†Ç", "S-FG": "Á¥∞Á≤íÂàÜÊ∑∑„Åò„ÇäÁ§´Ë≥™Á†Ç", "SF-G": "Á§´Ê∑∑„Åò„ÇäÁ¥∞Á≤íÂàÜË≥™Á†Ç",
            "SG": "Á§´Ë≥™Á†Ç", "SG-Cs": "Á≤òÊÄßÂúüÊ∑∑„Åò„ÇäÁ§´Ë≥™Á†Ç", "SGF": "Á¥∞Á≤íÂàÜË≥™Á§´Ë≥™Á†Ç", "SG-F": "Á¥∞Á≤íÂàÜÊ∑∑„Åò„ÇäÁ§´Ë≥™Á†Ç",
            "SO-G": "Á§´Ê∑∑„ÇäÊúâÊ©üË≥™Á†Ç", "SP": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ†Ç", "SPG": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ§´Ë≥™Á†Ç", "SP-G": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ§´Ê∑∑„Åò„ÇäÁ†Ç", "SWG": "Á≤íÂæÑÂπÖ„ÅÆÂ∫É„ÅÑÁ§´Ë≥™Á†Ç",
            "VH1S": "Á†ÇË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúüÔºàIÂûãÔºâ", "VH1-S": "Á†ÇÊ∑∑„Åò„ÇäÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúüÔºàIÂûãÔºâ", "VH1S-G": "Á†ÇË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúü(‚Ö†Âûã)", "VH2": "ÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúüÔºà‚Ö°ÂûãÔºâ",
            "MLSG": "Á†ÇÁ§´Ë≥™„Ç∑„É´„ÉàÔºà‰ΩéÊ∂≤ÊÄßÈôêÁïåÔºâ", "VLS": "Á†ÇË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúü", "GP": "ÂàÜÁ¥ö„Åï„Çå„ÅüÁ§´",
            "OVS-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™ÊúâÊ©üË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Âúü", "SV-G": "Á§´Ê∑∑„Åò„ÇäÁÅ´Â±±ÁÅ∞Ë≥™Á†Ç", "OS": "Á†ÇË≥™ÊúâÊ©üË≥™Âúü",
            "SCH": "Á≤òÂúüË≥™Á†Ç(‰ΩéÊ∂≤ÊÄßÈôêÁïå)", "SCL": "Á≤òÂúüË≥™Á†Ç", "SML": "„Ç∑„É´„ÉàË≥™Á†Ç", "SCH-G": "Á§´Ê∑∑„Åò„ÇäÁ≤òÂúüË≥™Á†Ç",
            "GCLS": "Á≤òÂúüË≥™Á†ÇË≥™Á§´", "VH2S-G": "Á§´Ê∑∑„Åò„ÇäÁ†ÇË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Á≤òÊÄßÂúüÔºà‚Ö°ÂûãÔºâ", "SG-V": "ÁÅ´Â±±ÁÅ∞Ë≥™ÂúüÊ∑∑„Åò„ÇäÁ§´Ë≥™Á†Ç",
            "CH-G": "Á§´Ê∑∑„Åò„ÇäÁ≤òÂúü(È´òÊ∂≤ÊÄßÈôêÁïå)", "OVS": "Á†ÇË≥™ÊúâÊ©üË≥™ÁÅ´Â±±ÁÅ∞Ë≥™Âúü", "FSG": "Á†ÇÁ§´Ë≥™Á¥∞Á≤íÂúü"
        };

        const COLUMN_DEFS = [
            { key: 'boring', label: 'Â≠îÁï™', type: 'text', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 60, fixed: true },
            { key: 'sample_no', label: 'Ë©¶ÊñôNo', type: 'text', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 50, fixed: true },
            { key: 'depth_top', label: '‰∏äÁ´Ø', unit: 'm', type: 'number', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 50, fixed: true },
            { key: 'depth_bottom', label: '‰∏ãÁ´Ø', unit: 'm', type: 'number', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 50, fixed: true },
            { key: 'soilType', label: 'ÂúüÂ±§', type: 'text', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 50, fixed: true },
            { key: 'N_value', label: 'NÂÄ§', unit: 'Âõû', type: 'number', group: 'Âü∫Êú¨‰∫ãÈ†Ö', width: 40, graph: true, defaultMin: 0, defaultMax: 60 },
            { key: 'rho_t', label: 'ÊπøÊΩ§ÂØÜÂ∫¶ œÅt', unit: 'g/cm¬≥', type: 'number', group: 'Áâ©ÁêÜÁâπÊÄß', width: 60, graph: true, defaultMin: 1.2, defaultMax: 2.4 },
            { key: 'rho_s', label: 'ÂúüÁ≤íÂ≠êÂØÜÂ∫¶ œÅs', unit: 'g/cm¬≥', type: 'number', group: 'Áâ©ÁêÜÁâπÊÄß', width: 60, graph: true, defaultMin: 2.4, defaultMax: 2.8 },
            { key: 'wn', label: 'Âê´Ê∞¥ÊØî Wn', unit: '%', type: 'number', group: 'Áâ©ÁêÜÁâπÊÄß', width: 60, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'e', label: 'ÈñìÈöôÊØî e', unit: '', type: 'number', group: 'Áâ©ÁêÜÁâπÊÄß', width: 60, graph: true, defaultMin: 0, defaultMax: 3.0 },
            { key: 'Sr', label: 'È£ΩÂíåÂ∫¶ Sr', unit: '%', type: 'number', group: 'Áâ©ÁêÜÁâπÊÄß', width: 60, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'gravel', label: 'Á§´ÂàÜ', unit: '%', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'sand', label: 'Á†ÇÂàÜ', unit: '%', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'silt', label: '„Ç∑„É´„Éà', unit: '%', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'clay', label: 'Á≤òÂúü', unit: '%', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'Fc', label: 'Á¥∞Á≤íÂàÜÂê´ÊúâÁéá Fc', unit: '%', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 70, graph: true, defaultMin: 0, defaultMax: 100, calc: true },
            { key: 'D10', label: 'D10', unit: 'mm', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 10 },
            { key: 'D20', label: 'D20', unit: 'mm', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 10 },
            { key: 'D30', label: 'D30', unit: 'mm', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 10 },
            { key: 'D50', label: 'D50', unit: 'mm', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 10 },
            { key: 'D60', label: 'D60', unit: 'mm', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 50, graph: true, defaultMin: 0, defaultMax: 10 },
            { key: 'Uc', label: 'ÂùáÁ≠â‰øÇÊï∞ Uc', unit: '', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 60, calc: true },
            { key: 'Uc_prime', label: 'Êõ≤Áéá‰øÇÊï∞ Uc\'', unit: '', type: 'number', group: 'Á≤íÂ∫¶ÁâπÊÄß', width: 60, calc: true },
            { key: 'WL', label: 'Ê∂≤ÊÄßÈôêÁïå WL', unit: '%', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 60, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'WP', label: 'Â°ëÊÄßÈôêÁïå WP', unit: '%', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 60, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'Ip', label: 'Â°ëÊÄßÊåáÊï∞ Ip', unit: '', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 60, graph: true, defaultMin: 0, defaultMax: 100, calc: true },
            { key: 'Ic', label: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„ÉºÊåáÊï∞ Ic', unit: '', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 60, graph: true, defaultMin: 0, defaultMax: 2.0, calc: true },
            { key: 'IL', label: 'Ê∂≤ÊÄßÊåáÊï∞ IL', unit: '', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 60, graph: true, defaultMin: 0, defaultMax: 2.0, calc: true },
            { key: 'm_phys', label: 'Âº∑Â∫¶Â¢óÂä†Áéá m(Áâ©ÁêÜ)', unit: '', type: 'number', group: '„Ç≥„É≥„Ç∑„Çπ„ÉÜ„É≥„Ç∑„Éº', width: 70, calc: true, detail: false },
            { key: 'class_symbol', label: 'Ë®òÂè∑', type: 'text', group: 'ÂúüË≥™ÂàÜÈ°û', width: 50 },
            { key: 'class_name', label: 'ÂàÜÈ°ûÂêç', type: 'text', group: 'ÂúüË≥™ÂàÜÈ°û', width: 120, detail: false },
            { key: 'qu_1', label: 'qu(1)', unit: 'kN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'qu_2', label: 'qu(2)', unit: 'kN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'qu_3', label: 'qu(3)', unit: 'kN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'qu', label: '‰∏ÄËª∏ÂúßÁ∏ÆÂº∑„Åï qu', unit: 'kN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 500 },
            { key: 'c_uu_qu', label: 'Á≤òÁùÄÂäõ c(qu)', unit: 'kN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 250, calc: true },
            { key: 'E50_u1', label: 'E50(1)', unit: 'MN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'E50_u2', label: 'E50(2)', unit: 'MN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'E50_u3', label: 'E50(3)', unit: 'MN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 50, detail: true },
            { key: 'E50_u', label: 'Â§âÂΩ¢‰øÇÊï∞ E50', unit: 'MN/m¬≤', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'm_ratio', label: 'Âº∑Â∫¶Â¢óÂä†Áéá m(qu)', unit: '', type: 'number', group: '‰∏ÄËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, calc: true },
            { key: 'c_uu', label: 'Á≤òÁùÄÂäõ c(UU)', unit: 'kN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 200 },
            { key: 'phi_uu', label: 'ÂÜÖÈÉ®Êë©Êì¶Ëßí œÜ(UU)', unit: '¬∞', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 45 },
            { key: 'c_cu', label: 'Á≤òÁùÄÂäõ c(CU)', unit: 'kN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 200 },
            { key: 'phi_cu', label: 'ÂÜÖÈÉ®Êë©Êì¶Ëßí œÜ(CU)', unit: '¬∞', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 45 },
            { key: 'c_dash', label: 'Á≤òÁùÄÂäõ c\'', unit: 'kN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 200 },
            { key: 'phi_dash', label: 'ÂÜÖÈÉ®Êë©Êì¶Ëßí œÜ\'', unit: '¬∞', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 45 },
            { key: 'm_cu', label: 'Âº∑Â∫¶Â¢óÂä†Áéá m(CU)', unit: '', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, calc: false },
            { key: 'c_cd', label: 'Á≤òÁùÄÂäõ c(CD)', unit: 'kN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 200 },
            { key: 'phi_cd', label: 'ÂÜÖÈÉ®Êë©Êì¶Ëßí œÜ(CD)', unit: '¬∞', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 70, graph: true, defaultMin: 0, defaultMax: 45 },
            { key: 'E50_t1', label: 'E50(3Ëª∏-1)', unit: 'MN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 60, detail: true },
            { key: 'E50_t2', label: 'E50(3Ëª∏-2)', unit: 'MN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 60, detail: true },
            { key: 'E50_t3', label: 'E50(3Ëª∏-3)', unit: 'MN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 60, detail: true },
            { key: 'E50_t', label: 'Â§âÂΩ¢‰øÇÊï∞ E50(3Ëª∏)', unit: 'MN/m¬≤', type: 'number', group: '‰∏âËª∏ÂúßÁ∏ÆË©¶È®ì', width: 90, graph: true, defaultMin: 0, defaultMax: 100 },
            { key: 'e0', label: 'ÂàùÊúüÈñìÈöôÊØî e0', unit: '', type: 'number', group: 'ÂúßÂØÜË©¶È®ì', width: 65, graph: true, defaultMin: 0, defaultMax: 3.0 },
            { key: 'Cc', label: 'ÂúßÁ∏ÆÊåáÊï∞ Cc', unit: '', type: 'number', group: 'ÂúßÂØÜË©¶È®ì', width: 65, graph: true, defaultMin: 0, defaultMax: 2.0 },
            { key: 'Pc', label: 'ÂúßÂØÜÈôç‰ºèÂøúÂäõ Pc', unit: 'kN/m¬≤', type: 'number', group: 'ÂúßÂØÜË©¶È®ì', width: 80, graph: true, defaultMin: 0, defaultMax: 2000 },
            { key: 'k_est', label: 'ÈÄèÊ∞¥‰øÇÊï∞ k(Êé®ÂÆö)', unit: 'm/s', type: 'number', group: 'ÈÄèÊ∞¥ÁâπÊÄß', width: 80, calc: true },
        ];

        const EditableCell = React.memo(({ 
            rowId, colKey, initialValue, onUpdate, onPaste, rowIndex, colIndex, isDetail, isCalc, type, readOnly, fontSize 
        }) => {
            const [value, setValue] = useState(initialValue ?? '');
            
            useEffect(() => { 
                setValue(initialValue ?? ''); 
            }, [initialValue]);

            const handleChange = (e) => { 
                setValue(e.target.value); 
            };

            const handleBlur = () => {
                if (value != initialValue) {
                    onUpdate(rowId, colKey, value);
                }
            };

            const handleKeyDown = (e) => {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) {
                    e.preventDefault();
                    let nextRow = rowIndex;
                    if (e.key === 'ArrowUp') nextRow = Math.max(0, rowIndex - 1);
                    if (e.key === 'ArrowDown' || e.key === 'Enter') nextRow = rowIndex + 1;

                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        const currentEl = document.getElementById(`cell-${rowIndex}-${colKey}`);
                        if (currentEl) {
                            const td = currentEl.closest('td');
                            const targetTd = e.key === 'ArrowLeft' ? td.previousElementSibling : td.nextElementSibling;
                            if (targetTd) {
                                const input = targetTd.querySelector('input');
                                if (input) { input.focus(); input.select(); return; }
                            }
                        }
                    } else {
                        const targetId = `cell-${nextRow}-${colKey}`;
                        const targetInput = document.getElementById(targetId);
                        if (targetInput) {
                            targetInput.focus();
                            targetInput.select();
                        }
                    }
                }
            };

            const height = Math.max(26, fontSize + 15);

            return (
                <input
                    id={`cell-${rowIndex}-${colKey}`}
                    type={type === 'number' && colKey !== 'k_est' ? 'number' : 'text'}
                    value={value}
                    onChange={handleChange}
                    onBlur={handleBlur}
                    onKeyDown={handleKeyDown}
                    onPaste={(e) => onPaste(e, rowId, colKey)}
                    className={`cell-input w-full bg-transparent border-none text-right px-1 text-dark outline-none ${isDetail ? 'text-blue-800' : isCalc ? 'font-bold text-gray-600' : ''}`}
                    style={{ fontSize: `${fontSize}px`, height: `${height}px` }}
                    step={type === 'number' ? "0.001" : undefined}
                    readOnly={readOnly}
                />
            );
        });

        const rgbToHex = (r, g, b) => "#" + [r, g, b].map(x => {
            const hex = Math.max(0, Math.min(255, Number(x) || 0)).toString(16);
            return hex.length === 1 ? "0" + hex : hex;
        }).join("");

        const renderShape = (shape, cx, cy, r, color, opacity = 1) => {
            const size = r * 2;
            const style = { opacity: opacity * 0.9 };
            switch (shape) {
                case 'square': return <rect x={cx - r} y={cy - r} width={size} height={size} fill={color} stroke="#000" strokeWidth="0.5" style={style} />;
                case 'triangle': const h = size * Math.sin(Math.PI / 3); const points = `${cx},${cy - r} ${cx + r},${cy + h/2} ${cx - r},${cy + h/2}`; return <polygon points={points} fill={color} stroke="#000" strokeWidth="0.5" style={style} />;
                case 'diamond': return <polygon points={`${cx},${cy - r - 1} ${cx + r + 1},${cy} ${cx},${cy + r + 1} ${cx - r - 1},${cy}`} fill={color} stroke="#000" strokeWidth="0.5" style={style} />;
                case 'circle': default: return <circle cx={cx} cy={cy} r={r} fill={color} stroke="#000" strokeWidth="0.5" style={style} />;
            }
        };

        const ScatterChart = ({ 
            data, xKey, yKey, xLabel, yLabel, xUnit, yUnit, soilSettings, pointSize = 5, 
            isYReversed = false, isLogX = false, calcX = null, calcY = null, 
            renderBackground = null, renderForeground = null,
            defaultMinX: propMinX, defaultMaxX: propMaxX, defaultMinY: propMinY, defaultMaxY: propMaxY,
            boringSettings = {}, width = 350, height = 350, baseFontSize = 11
        }) => {
            const [showScaleSettings, setShowScaleSettings] = useState(false);
            const [customScale, setCustomScale] = useState({});
            const uniqueId = useMemo(() => Math.random().toString(36).substr(2, 9), []);
            const settingMap = useMemo(() => soilSettings.reduce((acc, s) => ({...acc, [s.name]: s}), {}), [soilSettings]);

            const validData = data.map(d => {
                const setting = settingMap[d.soilType];
                const isDimmed = setting ? setting.visible === false : false;
                let xVal = calcX ? calcX(d) : d[xKey];
                let yVal = calcY ? calcY(d) : d[yKey];
                if (yKey === 'depth' || yKey === 'depth_top' || yLabel.includes('Ê∑±Â∫¶') || yLabel.includes('Ê®ôÈ´ò')) {
                    if (yLabel.includes('Ê®ôÈ´ò')) {
                         const gl = boringSettings[d.boring]?.altitude || 0;
                         const depth = d.depth_top !== null ? d.depth_top : 0;
                         yVal = gl - depth;
                    } else if (d.depth_top !== null && d.depth_bottom !== null) {
                         yVal = (d.depth_top + d.depth_bottom) / 2;
                    } else if (d.depth_top !== null) {
                         yVal = d.depth_top;
                    }
                }
                if (isLogX && xVal <= 0) return null;
                if (xVal === null || xVal === undefined || isNaN(xVal) || yVal === null || yVal === undefined || isNaN(yVal)) return null;
                return { ...d, _x: xVal, _y: yVal, _isDimmed: isDimmed };
            }).filter(Boolean);

            const activeSoilTypes = useMemo(() => new Set(validData.map(d => d.soilType)), [validData]);

            const xValues = validData.map(d => d._x);
            const yValues = validData.map(d => d._y);
            let defaultMinX, defaultMaxX, defaultMinY, defaultMaxY;

            if (isLogX) {
                defaultMinX = propMinX !== undefined ? propMinX : (xValues.length > 0 ? Math.pow(10, Math.floor(Math.log10(Math.min(...xValues)))) : 0.0001);
                defaultMaxX = propMaxX !== undefined ? propMaxX : (xValues.length > 0 ? Math.pow(10, Math.ceil(Math.log10(Math.max(...xValues)))) : 1);
            } else {
                const autoMinX = xValues.length > 0 ? Math.min(...xValues, 0) : 0;
                const autoMaxX = xValues.length > 0 ? Math.max(...xValues) : 100;
                const rangeX = autoMaxX - autoMinX || 1;
                defaultMinX = propMinX !== undefined ? propMinX : (autoMinX > 0 ? 0 : autoMinX);
                defaultMaxX = propMaxX !== undefined ? propMaxX : (autoMaxX + rangeX * 0.1);
            }

            const autoMinY = yValues.length > 0 ? Math.min(...yValues, 0) : 0;
            const autoMaxY = yValues.length > 0 ? Math.max(...yValues) : 100;
            const rangeY = autoMaxY - autoMinY || 1;
            defaultMinY = propMinY !== undefined ? propMinY : (!isYReversed && autoMinY > 0 ? 0 : autoMinY);
            defaultMaxY = propMaxY !== undefined ? propMaxY : (isYReversed ? autoMaxY + rangeY * 0.1 : autoMaxY + rangeY * 0.1);
            if(isYReversed && propMinY === undefined) defaultMinY = 0;

            const finalMinX = (customScale.xMin !== undefined && customScale.xMin !== '') ? Number(customScale.xMin) : defaultMinX;
            const finalMaxX = (customScale.xMax !== undefined && customScale.xMax !== '') ? Number(customScale.xMax) : defaultMaxX;
            const finalMinY = (customScale.yMin !== undefined && customScale.yMin !== '') ? Number(customScale.yMin) : defaultMinY;
            const finalMaxY = (customScale.yMax !== undefined && customScale.yMax !== '') ? Number(customScale.yMax) : defaultMaxY;

            const autoStepX = calculateAutoStep(finalMinX, finalMaxX);
            const autoStepY = calculateAutoStep(finalMinY, finalMaxY);
            const inputStepX = getInputStep(finalMinX, finalMaxX);
            const inputStepY = getInputStep(finalMinY, finalMaxY);

            const stepX = (customScale.xStep !== undefined && customScale.xStep !== '') ? Number(customScale.xStep) : autoStepX;
            const stepY = (customScale.yStep !== undefined && customScale.yStep !== '') ? Number(customScale.yStep) : autoStepY;

            const generateTicks = (min, max, step, isLog) => {
                 if (isLog) {
                     const ticks = [];
                     let startExp = Math.floor(Math.log10(min));
                     let endExp = Math.ceil(Math.log10(max));
                     for(let i=startExp; i<=endExp; i++) {
                         const val = Math.pow(10, i);
                         if (val >= min && val <= max) ticks.push(val);
                     }
                     if (ticks.length < 2) { const val = Math.pow(10, startExp); [2,5].forEach(m => { if(val*m >= min && val*m <= max) ticks.push(val*m) }); }
                     return ticks.sort((a,b) => a-b);
                 }
                 if (min >= max) return [min];
                 const ticks = [];
                 for(let v=Math.ceil(min/step)*step; v<=max+step/1000; v+=step) ticks.push(v);
                 return ticks;
            };
            const xTicks = generateTicks(finalMinX, finalMaxX, stepX, isLogX);
            const yTicks = generateTicks(finalMinY, finalMaxY, stepY, false);
            
            const chartW = width; 
            const chartH = height; 
            const padding = { top: 35, right: 20, bottom: baseFontSize * 3 + 10, left: baseFontSize * 4 + 10 };
            
            const xScale = (val) => isLogX ? padding.left + ((Math.log10(val) - Math.log10(finalMinX)) / (Math.log10(finalMaxX) - Math.log10(finalMinX))) * (chartW - padding.left - padding.right) : padding.left + ((val - finalMinX) / (finalMaxX - finalMinX)) * (chartW - padding.left - padding.right);
            const yScale = (val) => isYReversed ? padding.top + ((val - finalMinY) / (finalMaxY - finalMinY)) * (chartH - padding.top - padding.bottom) : chartH - padding.bottom - ((val - finalMinY) / (finalMaxY - finalMinY)) * (chartH - padding.top - padding.bottom);
            const gridColor = "#94a3b8"; const axisColor = "#000000"; const textColor = "#000000";

            return (
                <div className="bg-white border border-gray-300 shadow-sm flex flex-col items-center relative print-break-inside-avoid" style={{width: chartW}}>
                    <div className="w-full bg-slate-700 text-white text-center py-1.5 px-2 text-xs font-bold border-b border-gray-500 leading-tight relative">
                        <div className="flex flex-col">
                            <span style={{fontSize: baseFontSize}}>{yLabel} <span className="font-normal opacity-75">{yUnit ? `(${yUnit})` : ''}</span></span>
                            <span className="text-[9px] text-gray-300 my-0.5">„Éª</span>
                            <span style={{fontSize: baseFontSize}}>{xLabel} <span className="font-normal opacity-75">{xUnit ? `(${xUnit})` : ''}</span></span>
                        </div>
                        <button onClick={() => setShowScaleSettings(!showScaleSettings)} className="absolute right-2 top-2 text-gray-300 hover:text-white font-bold px-1 rounded border border-transparent hover:border-gray-500 no-print" title="„Ç∞„É©„ÉïË®≠ÂÆö">‚öô</button>
                    </div>
                    {showScaleSettings && (
                        <div className="absolute top-14 left-0 w-full bg-white shadow-xl border border-gray-300 z-50 p-3 text-xs no-print">
                            <div className="font-bold mb-2 text-gray-700 border-b pb-1">„Ç∞„É©„ÉïË®≠ÂÆö</div>
                            <div className="text-[10px] font-bold text-blue-600 mt-1">XËª∏: {xLabel} {isLogX && '(Log)'}</div>
                            <div className="grid grid-cols-3 gap-1 mb-2">
                                <div><label className="text-[9px] text-gray-500">Min</label><input type="number" step={inputStepX} value={customScale.xMin ?? ''} placeholder={isLogX ? defaultMinX.toExponential(1) : defaultMinX.toFixed(1)} onChange={e=>setCustomScale({...customScale, xMin:e.target.value})} className="w-full border p-1 rounded text-right"/></div>
                                <div><label className="text-[9px] text-gray-500">Max</label><input type="number" step={inputStepX} value={customScale.xMax ?? ''} placeholder={isLogX ? defaultMaxX.toExponential(1) : defaultMaxX.toFixed(1)} onChange={e=>setCustomScale({...customScale, xMax:e.target.value})} className="w-full border p-1 rounded text-right"/></div>
                                <div><label className="text-[9px] text-gray-500">Step</label><input type="number" step={inputStepX} value={customScale.xStep ?? ''} placeholder={isLogX ? 'Log' : `Auto (${autoStepX})`} disabled={isLogX} onChange={e=>setCustomScale({...customScale, xStep:e.target.value})} className={`w-full border p-1 rounded text-right ${isLogX?'bg-gray-100':''}`}/></div>
                            </div>
                            <div className="text-[10px] font-bold text-indigo-600 mt-1">YËª∏: {yLabel}</div>
                            <div className="grid grid-cols-3 gap-1 mb-2">
                                <div><label className="text-[9px] text-gray-500">Min</label><input type="number" step={inputStepY} value={customScale.yMin ?? ''} placeholder={defaultMinY.toFixed(1)} onChange={e=>setCustomScale({...customScale, yMin:e.target.value})} className="w-full border p-1 rounded text-right"/></div>
                                <div><label className="text-[9px] text-gray-500">Max</label><input type="number" step={inputStepY} value={customScale.yMax ?? ''} placeholder={defaultMaxY.toFixed(1)} onChange={e=>setCustomScale({...customScale, yMax:e.target.value})} className="w-full border p-1 rounded text-right"/></div>
                                <div><label className="text-[9px] text-gray-500">Step</label><input type="number" step={inputStepY} value={customScale.yStep ?? ''} placeholder={`Auto (${autoStepY})`} onChange={e=>setCustomScale({...customScale, yStep:e.target.value})} className="w-full border p-1 rounded text-right"/></div>
                            </div>
                            <div className="flex justify-between border-t pt-2 mt-2"><button onClick={() => setCustomScale({})} className="text-[10px] text-red-500 underline">„É™„Çª„ÉÉ„Éà</button><button onClick={() => setShowScaleSettings(false)} className="bg-blue-600 text-white px-3 py-1 rounded font-bold">Èñâ„Åò„Çã</button></div>
                        </div>
                    )}
                    <svg width={chartW} height={chartH} className="bg-white">
                        <defs><clipPath id={`clip-${uniqueId}`}><rect x={padding.left} y={padding.top} width={chartW - padding.left - padding.right} height={chartH - padding.top - padding.bottom} /></clipPath></defs>
                        <text x={chartW/2} y={chartH - 5} textAnchor="middle" fontSize={baseFontSize} fill={textColor} fontWeight="bold">{xLabel} {xUnit ? `(${xUnit})` : ''}</text>
                        <text x={15} y={chartH/2} transform={`rotate(-90, 15, ${chartH/2})`} textAnchor="middle" fontSize={baseFontSize} fill={textColor} fontWeight="bold">{yLabel} {yUnit ? `(${yUnit})` : ''}</text>
                        {xTicks.map(val => { const x = xScale(val); if(x < padding.left || x > chartW - padding.right) return null; return <line key={val} x1={x} y1={padding.top} x2={x} y2={chartH - padding.bottom} stroke={gridColor} strokeWidth="1" strokeDasharray="4 2" />; })}
                        {yTicks.map(val => { const y = yScale(val); if(y < padding.top || y > chartH - padding.bottom) return null; return <line key={val} x1={padding.left} y1={y} x2={chartW - padding.right} y2={y} stroke={gridColor} strokeWidth="1" strokeDasharray="4 2" />; })}
                        <rect x={padding.left} y={padding.top} width={chartW - padding.left - padding.right} height={chartH - padding.top - padding.bottom} fill="none" stroke={axisColor} strokeWidth="1.5" />
                        
                        <g clipPath={`url(#clip-${uniqueId})`}>
                            {renderBackground && renderBackground(xScale, yScale, finalMinX, finalMaxX, finalMinY, finalMaxY)}
                            
                            {validData.map((d, i) => { 
                                const setting = settingMap[d.soilType] || { color: '#888', shape: 'circle' }; 
                                const cx = xScale(d._x); const cy = yScale(d._y); 
                                const color = d._isDimmed ? "#d1d5db" : setting.color;
                                const opacity = d._isDimmed ? 0.2 : 1;
                                return (<g key={i} style={{opacity}}>{renderShape(setting.shape, cx, cy, pointSize, color)}<title>{`[${d.boring}] ${d.soilType}\n${xLabel}: ${d._x}\n${yLabel}: ${d._y}`}</title></g>); 
                            })}
                        </g>

                        {renderForeground && renderForeground(xScale, yScale, finalMinX, finalMaxX, finalMinY, finalMaxY)}

                        {xTicks.map(val => { const x = xScale(val); if(x < padding.left - 2 || x > chartW - padding.right + 2) return null; const label = isLogX ? (val < 0.001 ? val.toExponential(0) : val.toString()) : parseFloat(val.toFixed(2)); return <text key={val} x={x} y={chartH - padding.bottom + baseFontSize + 3} fontSize={Math.max(9, baseFontSize - 1)} textAnchor="middle" fill={textColor} fontWeight="bold">{label}</text>; })}
                        {yTicks.map(val => { const y = yScale(val); if(y < padding.top - 2 || y > chartH - padding.bottom + 2) return null; return <text key={val} x={padding.left - 6} y={y + (baseFontSize/2 - 1)} fontSize={Math.max(9, baseFontSize - 1)} textAnchor="end" fill={textColor} fontWeight="bold">{parseFloat(val.toFixed(2))}</text>; })}
                    </svg>
                    
                    <div className="w-full p-2 border-t border-gray-200 bg-slate-50 flex flex-wrap gap-2 justify-center content-start min-h-[40px]">
                        {soilSettings.filter(s => activeSoilTypes.has(s.name)).map(s => (
                            <div key={s.name} className={`flex items-center gap-1 border border-gray-200 px-1.5 py-0.5 rounded shadow-sm ${s.visible === false ? 'bg-gray-100 opacity-60' : 'bg-white'}`}>
                                <svg width={baseFontSize} height={baseFontSize} viewBox="0 0 20 20" className="overflow-visible" style={{opacity: s.visible === false ? 0.3 : 1}}>
                                    {renderShape(s.shape, 10, 10, 8, s.color)}
                                </svg>
                                <span className={`font-bold leading-none ${s.visible === false ? 'text-gray-400 line-through' : 'text-gray-600'}`} style={{fontSize: baseFontSize}}>{s.name}</span>
                            </div>
                        ))}
                        {activeSoilTypes.size === 0 && <span className="text-gray-400 text-[10px]">„Éá„Éº„Çø„Å™„Åó</span>}
                    </div>
                </div>
            );
        };

        const DepthProfileChart = ({ data, colDef, soilSettings, height = 500, pointSize = 4, axisMode = 'depth', customScale, onUpdateScale, width = 240, hideLegend = false, commonYScale, baseFontSize = 11, boringSettings }) => {
            const settingMap = useMemo(() => soilSettings.reduce((acc, s) => ({...acc, [s.name]: s}), {}), [soilSettings]);
            const [showScaleSettings, setShowScaleSettings] = useState(false);
            
            const validData = data.map(d => {
                const setting = settingMap[d.soilType];
                const isDimmed = setting ? setting.visible === false : false;
                const val = d[colDef.key];
                let yVal = null;
                if (axisMode === 'depth') {
                    if (d.depth_top !== null && d.depth_bottom !== null) yVal = (d.depth_top + d.depth_bottom) / 2;
                    else if (d.depth_top !== null) yVal = d.depth_top;
                    else if (d.depth_bottom !== null) yVal = d.depth_bottom;
                } else { 
                    const gl = boringSettings[d.boring]?.altitude || 0;
                    const depth = d.depth_top !== null ? d.depth_top : 0;
                    yVal = gl - depth;
                }
                return { ...d, _val: val, _yVal: yVal, _isDimmed: isDimmed };
            }).filter(d => d._val !== null && !isNaN(d._val) && d._yVal !== null && !isNaN(d._yVal));
            
            const activeSoilTypes = useMemo(() => new Set(validData.map(d => d.soilType)), [validData]);
            const values = validData.map(d => d._val);
            
            const defaultMinX = colDef.defaultMin !== undefined ? colDef.defaultMin : 0;
            const defaultMaxX = colDef.defaultMax !== undefined ? colDef.defaultMax : (values.length > 0 && Math.max(...values) > 0 ? Math.max(...values) * 1.2 : 10);
            
            const minVal = (customScale?.min !== undefined && customScale.min !== '') ? Number(customScale.min) : defaultMinX;
            const maxVal = (customScale?.max !== undefined && customScale.max !== '') ? Number(customScale.max) : defaultMaxX;
            
            const autoStepX = calculateAutoStep(minVal, maxVal);
            const inputStepX = getInputStep(minVal, maxVal);
            const stepVal = (customScale?.step !== undefined && customScale.step !== '') ? Number(customScale.step) : autoStepX;
            
            const yValues = validData.map(d => d._yVal);
            let autoMinY, autoMaxY;
            if (axisMode === 'depth') { 
                autoMinY = 0; autoMaxY = yValues.length > 0 ? Math.max(...yValues, 10) : 10; if (autoMaxY < 10) autoMaxY = 10; 
            } else { 
                const minAlt = yValues.length > 0 ? Math.min(...yValues) : 0; 
                const maxAlt = yValues.length > 0 ? Math.max(...yValues) : 10; 
                const range = maxAlt - minAlt || 10; 
                autoMinY = minAlt - range * 0.1; 
                autoMaxY = maxAlt + range * 0.1; 
            }
            
            let minY, maxY, stepY;

            // Min Y
            if (customScale?.yMin !== undefined && customScale.yMin !== '') {
                 minY = Number(customScale.yMin);
            } else if (commonYScale && commonYScale.min !== '' && commonYScale.min !== undefined && commonYScale.min !== null) {
                 minY = Number(commonYScale.min);
            } else {
                 minY = autoMinY;
            }

            // Max Y
            if (customScale?.yMax !== undefined && customScale.yMax !== '') {
                 maxY = Number(customScale.yMax);
            } else if (commonYScale && commonYScale.max !== '' && commonYScale.max !== undefined && commonYScale.max !== null) {
                 maxY = Number(commonYScale.max);
            } else {
                 maxY = autoMaxY;
            }

            const autoStepY = calculateAutoStep(minY, maxY);
            const inputStepY = getInputStep(minY, maxY);

            // Step Y
            if (customScale?.yStep !== undefined && customScale.yStep !== '') {
                stepY = Number(customScale.yStep);
            } else if (commonYScale && commonYScale.step !== '' && commonYScale.step !== undefined && commonYScale.step !== null) {
                stepY = Number(commonYScale.step);
            } else {
                stepY = autoStepY;
            }

            const generateTicks = (min, max, step) => {
                if (min >= max) return [min];
                const ticks = []; const epsilon = step / 10000; let current = Math.ceil(min / step) * step; if (current < min - epsilon) current += step; let safetyCount = 0; const MAX_TICKS = 1000; 
                while (current <= max + epsilon) { ticks.push(current); current += step; safetyCount++; if (safetyCount > MAX_TICKS) break; }
                return ticks;
            };
            const xTicks = generateTicks(minVal, maxVal, stepVal);
            const yTicks = generateTicks(minY, maxY, stepY);
            const padding = { top: 40, right: baseFontSize + 5, bottom: baseFontSize + 10, left: baseFontSize * 4 + 10 }; 
            
            const chartW = width === '100%' ? 240 : width; 
            const chartH = height; 
            
            const xScale = (val) => padding.left + ((val - minVal) / (maxVal - minVal)) * (chartW - padding.left - padding.right);
            const yScale = (yVal) => axisMode === 'depth' ? padding.top + ((yVal - minY) / (maxY - minY)) * (chartH - padding.top - padding.bottom) : padding.top + ((maxY - yVal) / (maxY - minY)) * (chartH - padding.top - padding.bottom);
            const gridColor = "#94a3b8"; const axisColor = "#000000"; const textColor = "#000000";

            return (
                <div className="bg-white border-r border-gray-300 flex flex-col items-center flex-shrink-0 relative print-break-inside-avoid h-auto" style={{width: width === '100%' ? '100%' : chartW}}>
                    <div className="w-full h-[44px] bg-slate-700 text-white text-center text-xs font-bold border-b border-gray-500 leading-tight relative group flex flex-col justify-center items-center flex-shrink-0">
                        <div style={{fontSize: baseFontSize}}>{colDef.label.split(' ')[0]} <span className="font-normal opacity-75">{colDef.unit ? `(${colDef.unit})` : ''}</span></div>
                        {colDef.label.split(' ')[1] && (<div className="text-[10px] font-mono text-yellow-200">{colDef.label.split(' ')[1]}</div>)}
                        <button onClick={() => setShowScaleSettings(!showScaleSettings)} className="absolute right-1 top-1 text-gray-300 hover:text-white font-bold px-1 rounded no-print" title="„Ç∞„É©„Éï„ÅÆ„Çπ„Ç±„Éº„É´Ë®≠ÂÆö">‚öô</button>
                    </div>
                    {showScaleSettings && (
                        <div className="absolute top-8 left-0 w-full bg-white shadow-xl border border-gray-300 z-50 p-2 text-xs no-print">
                             <div className="font-bold mb-1 text-gray-700 border-b pb-1">„Çπ„Ç±„Éº„É´Ë®≠ÂÆö</div>
                             <div className="text-[10px] font-bold text-blue-600 mt-1">Ê®™Ëª∏ (X)</div>
                             <div className="grid grid-cols-3 gap-1 mb-2">
                                <div><label className="block text-[9px] text-gray-500">Min</label><input type="number" step={inputStepX} value={customScale?.min ?? ''} placeholder={defaultMinX} onChange={(e) => onUpdateScale({...customScale, min: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                                <div><label className="block text-[9px] text-gray-500">Max</label><input type="number" step={inputStepX} value={customScale?.max ?? ''} placeholder={defaultMaxX.toFixed(1)} onChange={(e) => onUpdateScale({...customScale, max: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                                <div><label className="block text-[9px] text-gray-500">Step</label><input type="number" step={inputStepX} value={customScale?.step ?? ''} placeholder={`Auto (${autoStepX})`} onChange={(e) => onUpdateScale({...customScale, step: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                            </div>
                            <div className="text-[10px] font-bold text-indigo-600 mt-1">Á∏¶Ëª∏ (Y)</div>
                             <div className="grid grid-cols-3 gap-1 mb-2">
                                <div><label className="block text-[9px] text-gray-500">Min</label><input type="number" step={inputStepY} value={customScale?.yMin ?? ''} placeholder={autoMinY.toFixed(1)} onChange={(e) => onUpdateScale({...customScale, yMin: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                                <div><label className="block text-[9px] text-gray-500">Max</label><input type="number" step={inputStepY} value={customScale?.yMax ?? ''} placeholder={autoMaxY.toFixed(1)} onChange={(e) => onUpdateScale({...customScale, yMax: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                                <div><label className="block text-[9px] text-gray-500">Step</label><input type="number" step={inputStepY} value={customScale?.yStep ?? ''} placeholder={`Auto (${autoStepY})`} onChange={(e) => onUpdateScale({...customScale, yStep: e.target.value})} className="w-full border p-1 rounded text-right" /></div>
                            </div>
                            <div className="flex justify-between border-t pt-2"><button onClick={() => onUpdateScale({})} className="text-[9px] text-red-500 underline">„É™„Çª„ÉÉ„Éà</button><button onClick={() => setShowScaleSettings(false)} className="bg-blue-600 text-white px-2 py-0.5 rounded font-bold">Èñâ„Åò„Çã</button></div>
                        </div>
                    )}
                    <svg width={chartW} height={chartH} className="bg-white flex-shrink-0" style={{display: 'block'}}>
                        <text x={15} y={chartH / 2} transform={`rotate(-90, 15, ${chartH / 2})`} fontSize={baseFontSize} fontWeight="bold" fill={textColor} textAnchor="middle">{axisMode === 'depth' ? 'Ê∑±Â∫¶ (m)' : 'Ê®ôÈ´ò (m)'}</text>
                        {xTicks.map(val => { const x = xScale(val); if (x < padding.left || x > chartW - padding.right) return null; 
                             let label = Number(val.toFixed(2));
                             if (colDef.key === 'k_est') { label = val.toExponential(0); }
                             return (<g key={val}><line x1={x} y1={padding.top} x2={x} y2={chartH-padding.bottom} stroke={gridColor} strokeWidth="1" strokeDasharray="4 2" /><text x={x} y={padding.top - 8} fontSize={baseFontSize} fontWeight="bold" textAnchor="middle" fill={textColor}>{label}</text></g>); 
                        })}
                        {yTicks.map(d => { const y = yScale(d); if (y < padding.top || y > chartH - padding.bottom) return null; return <line key={d} x1={padding.left} y1={y} x2={chartW-padding.right} y2={y} stroke={gridColor} strokeWidth="1.5" />; })}
                        
                        {colDef.key === 'Fc' && xScale(35) >= padding.left && xScale(35) <= chartW - padding.right && (
                            <g>
                                <line x1={xScale(35)} y1={padding.top} x2={xScale(35)} y2={chartH-padding.bottom} stroke="#ef4444" strokeWidth="2" />
                                <text x={xScale(35)+2} y={chartH-padding.bottom-5} fontSize={baseFontSize - 1} fill="#ef4444" fontWeight="bold">35%</text>
                            </g>
                        )}
                        {colDef.key === 'Ip' && xScale(15) >= padding.left && xScale(15) <= chartW - padding.right && (
                            <g>
                                <line x1={xScale(15)} y1={padding.top} x2={xScale(15)} y2={chartH-padding.bottom} stroke="#ef4444" strokeWidth="2" />
                                <text x={xScale(15)+2} y={chartH-padding.bottom-5} fontSize={baseFontSize - 1} fill="#ef4444" fontWeight="bold">15</text>
                            </g>
                        )}

                        <line x1={padding.left} y1={padding.top} x2={padding.left} y2={chartH-padding.bottom} stroke={axisColor} strokeWidth="1.5" />
                        <line x1={padding.left} y1={padding.top} x2={chartW-padding.right} y2={padding.top} stroke={axisColor} strokeWidth="1.5" />
                        {validData.map((point, i) => { 
                            const setting = settingMap[point.soilType] || { color: '#4682B4', shape: 'circle' }; 
                            const cx = xScale(point._val); const cy = yScale(point._yVal); 
                            const color = point._isDimmed ? "#d1d5db" : setting.color;
                            const opacity = point._isDimmed ? 0.2 : 1;
                            if (cx < padding.left || cx > chartW - padding.right || cy < padding.top || cy > chartH - padding.bottom) return null; 
                            return (<g key={i} style={{opacity}}>{renderShape(setting.shape, cx, cy, pointSize, color)}<title>{`[${point.boring}] ${point.soilType}\nVal: ${point._val}\nDepth: ${point._yVal}`}</title></g>); 
                        })}
                        {yTicks.map(d => { const y = yScale(d); if (y < padding.top - 5 || y > chartH - padding.bottom + 5) return null; return <text key={d} x={padding.left - 5} y={y + 4} fontSize={baseFontSize} fontWeight="bold" textAnchor="end" fill={textColor}>{Number(d.toFixed(1))}</text> })}
                    </svg>
                    {!hideLegend && (
                        <div className="w-full p-2 border-t border-gray-200 bg-slate-50 flex flex-wrap gap-2 justify-center content-start min-h-[60px] flex-shrink-0">
                            {soilSettings.filter(s => activeSoilTypes.has(s.name)).map(s => (
                                <div key={s.name} className={`flex items-center gap-1 border border-gray-200 px-1.5 py-0.5 rounded shadow-sm ${s.visible === false ? 'bg-gray-100 opacity-60' : 'bg-white'}`}>
                                    <svg width={baseFontSize} height={baseFontSize} viewBox="0 0 20 20" className="overflow-visible" style={{opacity: s.visible === false ? 0.3 : 1}}>
                                        {renderShape(s.shape, 10, 10, 8, s.color)}
                                    </svg>
                                    <span className={`font-bold leading-none ${s.visible === false ? 'text-gray-400 line-through' : 'text-gray-600'}`} style={{fontSize: baseFontSize}}>{s.name}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SoilSettingsContent = ({ settings, setSettings, allDataSoilTypes }) => {
            const [pasteRows, setPasteRows] = useState(Array.from({length: 15}, (_, i) => ({ id: i, name: '', r: '', g: '', b: '' })));
            const [dragItemIndex, setDragItemIndex] = useState(null);
            
            const handleGridPaste = (e, startRowIdx, colKey) => {
                e.preventDefault(); const text = e.clipboardData.getData('text'); const lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== ''); if (lines.length === 0) return; const newRows = [...pasteRows]; const keys = ['id', 'name', 'r', 'g', 'b']; const startColIdx = colKey === 'name' ? 1 : colKey === 'r' ? 2 : colKey === 'g' ? 3 : 4;
                lines.forEach((line, lIdx) => { const rIdx = startRowIdx + lIdx; if (rIdx >= newRows.length) return; const vals = line.split('\t'); vals.forEach((val, vIdx) => { const cIdx = startColIdx + vIdx; if (cIdx < 5) newRows[rIdx][keys[cIdx]] = val.trim(); }); });
                setPasteRows(newRows);
            };
            const updateGridRow = (idx, key, val) => { const newRows = [...pasteRows]; newRows[idx][key] = val; setPasteRows(newRows); };
            const applyGridToSettings = () => {
                const newItems = []; pasteRows.forEach(row => { if (!row.name) return; let color = '#888888'; if (row.r && row.g && row.b) color = rgbToHex(row.r, row.g, row.b); newItems.push({ name: row.name, color: color, shape: 'circle', visible: true }); });
                if (newItems.length === 0) { alert('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
                const mergedSettings = []; const processedNames = new Set();
                newItems.forEach(item => { const existing = settings.find(s => s.name === item.name); mergedSettings.push({ ...item, shape: existing ? existing.shape : 'circle', visible: existing ? existing.visible : true }); processedNames.add(item.name); });
                settings.forEach(s => { if (!processedNames.has(s.name)) mergedSettings.push(s); });
                setSettings(mergedSettings); alert('Âá°‰æã„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            };
            const onDragStart = (e, index) => { setDragItemIndex(index); };
            const onDragEnter = (e, index) => { if (dragItemIndex === null || dragItemIndex === index) return; const newSettings = [...settings]; const item = newSettings.splice(dragItemIndex, 1)[0]; newSettings.splice(index, 0, item); setDragItemIndex(index); setSettings(newSettings); };
            const onDragEnd = () => { setDragItemIndex(null); };
            const updateSetting = (index, key, val) => { const newSettings = [...settings]; newSettings[index][key] = val; setSettings(newSettings); };
            const toggleAll = (visible) => { setSettings(settings.map(s => ({ ...s, visible }))); };
            const removeUnused = () => { const usedSoils = new Set(allDataSoilTypes); setSettings(settings.filter(s => usedSoils.has(s.name))); };

            return (
                <div className="flex-1 flex overflow-hidden h-full bg-slate-100">
                    <div className="w-1/2 border-r border-gray-300 flex flex-col p-4 bg-gray-50 h-full">
                        <div className="flex justify-between items-center mb-2"><h4 className="font-bold text-gray-800 text-sm">Âá°‰æã‰∏ÄÊã¨Ë®≠ÂÆö (ExcelË≤º‰ªò)</h4><button onClick={applyGridToSettings} className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow">Âá°‰æãË®≠ÂÆö„Å´ÂèçÊò† ‚ñ∂</button></div>
                        <div className="flex-1 overflow-auto border border-gray-400 bg-white shadow-inner">
                            <table className="w-full text-xs border-collapse">
                                <thead className="bg-slate-700 text-white sticky top-0 z-10">
                                    <tr><th className="border border-gray-500 px-2 py-1 w-10">No.</th><th className="border border-gray-500 px-2 py-1">Âú∞Â±§Ë®òÂè∑</th><th className="border border-gray-500 px-2 py-1 w-12">R</th><th className="border border-gray-500 px-2 py-1 w-12">G</th><th className="border border-gray-500 px-2 py-1 w-12">B</th><th className="border border-gray-500 px-2 py-1 w-12">Á¢∫Ë™ç</th></tr>
                                </thead>
                                <tbody>
                                    {pasteRows.map((row, idx) => (
                                        <tr key={row.id} className="hover:bg-blue-50">
                                            <td className="border border-gray-300 px-1 py-1 text-center text-gray-500 bg-gray-100 font-bold">{idx + 1}</td>
                                            <td className="border border-gray-300 p-0.5"><input type="text" value={row.name} onChange={(e)=>updateGridRow(idx,'name',e.target.value)} onPaste={(e)=>handleGridPaste(e, idx, 'name')} className="w-full px-2 py-1 border border-gray-200 outline-none focus:border-blue-500 focus:bg-blue-50 bg-white" /></td>
                                            <td className="border border-gray-300 p-0.5"><input type="text" value={row.r} onChange={(e)=>updateGridRow(idx,'r',e.target.value)} onPaste={(e)=>handleGridPaste(e, idx, 'r')} className="w-full px-1 py-1 text-center border border-gray-200 outline-none focus:border-blue-500 focus:bg-blue-50 bg-white" /></td>
                                            <td className="border border-gray-300 p-0.5"><input type="text" value={row.g} onChange={(e)=>updateGridRow(idx,'g',e.target.value)} onPaste={(e)=>handleGridPaste(e, idx, 'g')} className="w-full px-1 py-1 text-center border border-gray-200 outline-none focus:border-blue-500 focus:bg-blue-50 bg-white" /></td>
                                            <td className="border border-gray-300 p-0.5"><input type="text" value={row.b} onChange={(e)=>updateGridRow(idx,'b',e.target.value)} onPaste={(e)=>handleGridPaste(e, idx, 'b')} className="w-full px-1 py-1 text-center border border-gray-200 outline-none focus:border-blue-500 focus:bg-blue-50 bg-white" /></td>
                                            <td className="border border-gray-300 px-2 py-1 bg-gray-50">{(row.r && row.g && row.b) && <div className="w-full h-4 border border-gray-400 shadow-sm" style={{backgroundColor: `rgb(${row.r},${row.g},${row.b})`}}></div>}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="w-1/2 flex flex-col p-4 bg-slate-200 h-full border-l border-white">
                        <div className="flex justify-between items-center mb-2"><h4 className="font-bold text-gray-800 text-sm">Âá°‰æã„ÅÆÈ†ÜÂ∫è„Éª„Çπ„Çø„Ç§„É´Ë®≠ÂÆö</h4><div className="flex gap-2 text-[10px]"><button onClick={()=>toggleAll(true)} className="bg-white hover:bg-gray-100 border border-gray-300 px-2 py-1 rounded text-gray-700 font-bold shadow-sm">‚òë ÂÖ®ÈÅ∏Êäû</button><button onClick={()=>toggleAll(false)} className="bg-white hover:bg-gray-100 border border-gray-300 px-2 py-1 rounded text-gray-700 font-bold shadow-sm">‚ñ° ÂÖ®Ëß£Èô§</button><button onClick={removeUnused} className="bg-red-100 hover:bg-red-200 text-red-600 border border-red-300 px-2 py-1 rounded font-bold shadow-sm">üóë Êú™‰ΩøÁî®ÂâäÈô§</button></div></div>
                        <div className="flex-1 overflow-y-auto pr-2 space-y-2 p-1">
                            {settings.map((item, idx) => (
                                <div key={item.name} draggable onDragStart={(e) => onDragStart(e, idx)} onDragEnter={(e) => onDragEnter(e, idx)} onDragEnd={onDragEnd} className={`flex items-center gap-2 p-2 border border-gray-300 rounded shadow-sm bg-white hover:border-blue-500 transition-colors ${dragItemIndex === idx ? 'dragging' : ''}`}>
                                    <div className="cursor-move text-gray-400 px-1 font-bold text-lg select-none">‚â°</div>
                                    <input type="checkbox" checked={item.visible !== false} onChange={(e)=>updateSetting(idx, 'visible', e.target.checked)} className="w-5 h-5 rounded text-blue-600 cursor-pointer border-gray-400" />
                                    <span className={`font-bold w-20 truncate ${item.visible !== false ? 'text-gray-800' : 'text-gray-400 line-through'}`} title={item.name}>{item.name}</span>
                                    <div className="flex items-center gap-2 ml-auto">
                                        <input type="color" value={item.color} onChange={(e)=>updateSetting(idx, 'color', e.target.value)} className="w-8 h-8 rounded cursor-pointer border border-gray-300 p-0.5 bg-white" />
                                        <select value={item.shape || 'circle'} onChange={(e)=>updateSetting(idx, 'shape', e.target.value)} className="border border-gray-400 rounded text-xs py-1.5 px-1 bg-white hover:bg-gray-50 w-28 text-gray-700 font-medium">
                                            <option value="circle">‚óè ÂÜÜ (Circle)</option>
                                            <option value="square">‚ñ† ÂõõËßí (Square)</option>
                                            <option value="triangle">‚ñ≤ ‰∏âËßí (Tri)</option>
                                            <option value="diamond">‚óÜ Ëè±ÂΩ¢ (Dia)</option>
                                        </select>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        const ClassDefinitionContent = ({ classMap, setClassMap }) => {
            const [filterText, setFilterText] = useState('');
            const [newSymbol, setNewSymbol] = useState('');
            const [newName, setNewName] = useState('');
            const scrollRef = useRef(null);
            const handleAdd = () => {
                if (!newSymbol || !newName) { alert('Ë®òÂè∑„Å®ÂàÜÈ°ûÂêç„ÅÆ‰∏°Êñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                setClassMap(prev => ({ ...prev, [newSymbol]: newName }));
                setNewSymbol(''); setNewName(''); alert(`„Äå${newSymbol}: ${newName}„Äç„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
            };
            const handleDelete = (symbol) => {
                if(!window.confirm(`„Äå${symbol}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
                setClassMap(prev => { const next = { ...prev }; delete next[symbol]; return next; });
            };
            const filteredList = Object.entries(classMap)
                .filter(([sym, name]) => sym.toLowerCase().includes(filterText.toLowerCase()) || name.includes(filterText))
                .sort((a, b) => a[0].localeCompare(b[0]));
            return (
                <div className="flex flex-col h-full">
                     <div className="p-4 bg-gray-50 border-b border-gray-200">
                        <div className="text-xs text-gray-500 mb-2">‚Äª Êñ∞„Åó„ÅÑË®òÂè∑„ÇíËøΩÂä†„ÄÅ„Åæ„Åü„ÅØÊó¢Â≠ò„ÅÆÂÆöÁæ©„ÇíÁ∑®ÈõÜ„Åó„Åæ„Åô„ÄÇ</div>
                        <div className="flex gap-2 items-end">
                            <div className="flex-1"><label className="block text-xs font-bold text-gray-700 mb-1">Ë®òÂè∑ (Symbol)</label><input type="text" value={newSymbol} onChange={e => setNewSymbol(e.target.value)} placeholder="‰æã: CH-New" className="w-full border p-1.5 rounded text-sm" /></div>
                            <div className="flex-[2]"><label className="block text-xs font-bold text-gray-700 mb-1">ÂàÜÈ°ûÂêç (Classification Name)</label><input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="‰æã: Êñ∞„Åó„ÅÑÁ≤òÂúü" className="w-full border p-1.5 rounded text-sm" /></div>
                            <button onClick={handleAdd} className="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-blue-700 whitespace-nowrap h-[34px]">ÁôªÈå≤ / Êõ¥Êñ∞</button>
                        </div>
                    </div>
                    <div className="p-2 border-b bg-white flex items-center gap-2"><span className="text-xs font-bold text-gray-500">üîç Ê§úÁ¥¢:</span><input type="text" value={filterText} onChange={e => setFilterText(e.target.value)} placeholder="Ë®òÂè∑„Åæ„Åü„ÅØÂàÜÈ°ûÂêç„ÅßÊ§úÁ¥¢..." className="border p-1 rounded text-xs flex-1" /><span className="text-xs text-gray-400">{filteredList.length}‰ª∂</span></div>
                    <div className="flex-1 overflow-y-auto p-0" ref={scrollRef}>
                        <table className="w-full text-sm border-collapse">
                            <thead className="bg-gray-100 sticky top-0 z-10 text-xs text-gray-600"><tr><th className="border-b px-4 py-2 text-left w-1/4">Ë®òÂè∑</th><th className="border-b px-4 py-2 text-left">ÂàÜÈ°ûÂêç</th><th className="border-b px-2 py-2 w-16">Êìç‰Ωú</th></tr></thead>
                            <tbody>
                                {filteredList.map(([sym, name]) => (<tr key={sym} className="border-b hover:bg-blue-50"><td className="px-4 py-2 font-bold text-slate-700">{sym}</td><td className="px-4 py-2">{name}</td><td className="px-2 py-2 text-center"><button onClick={() => { setNewSymbol(sym); setNewName(name); }} className="text-blue-500 hover:text-blue-700 text-xs mr-2">Á∑®ÈõÜ</button><button onClick={() => handleDelete(sym)} className="text-red-500 hover:text-red-700 text-xs">ÂâäÈô§</button></td></tr>))}
                                {filteredList.length === 0 && <tr><td colSpan="3" className="text-center py-8 text-gray-400">Ë©≤ÂΩì„Åô„ÇãÂÆöÁæ©„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        const BoringSettingsContent = ({ boringList, boringSettings, setBoringSettings }) => {
            const [localSettings, setLocalSettings] = useState({});
            useEffect(() => { const merged = {}; boringList.forEach(b => { merged[b] = boringSettings[b] || { altitude: 0 }; }); setLocalSettings(merged); }, [boringList, boringSettings]);
            const handleChange = (boring, key, val) => { setLocalSettings(prev => ({ ...prev, [boring]: { ...prev[boring], [key]: parseFloat(val) || 0 } })); };
            const handleSave = () => { setBoringSettings(localSettings); alert('Ê®ôÈ´òË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); };
            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="p-6 flex-1 overflow-y-auto">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-xs text-blue-800 shadow-sm">
                            <p className="font-bold">üí° „Éí„É≥„Éà</p>
                            <p>„Åì„Åì„ÅßË®≠ÂÆö„Åó„ÅüÂ≠îÂè£Ê®ôÈ´ò(GL)„Å´Âü∫„Å•„Åç„ÄÅ„Ç∞„É©„Éï„ÅÆÊ®ôÈ´òË°®Á§∫„ÅåË®àÁÆó„Åï„Çå„Åæ„Åô (Ê®ôÈ´ò = GL - Ê∑±Â∫¶)„ÄÇ</p>
                        </div>
                        <div className="border border-gray-400 rounded overflow-hidden shadow">
                            <table className="w-full text-sm bg-white">
                                <thead className="bg-slate-700 text-white">
                                    <tr>
                                        <th className="p-3 text-left font-bold border-r border-slate-600">Â≠îÁï™ (Boring No.)</th>
                                        <th className="p-3 text-left font-bold">Â≠îÂè£Ê®ôÈ´ò (GL m)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {boringList.map((b, idx) => (
                                        <tr key={b} className={idx % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                                            <td className="border-t border-r border-gray-300 p-3 font-bold text-gray-700">{b}</td>
                                            <td className="border-t border-gray-300 p-3">
                                                <div className="relative">
                                                    <input type="number" step="0.01" value={localSettings[b]?.altitude ?? 0} onChange={e => handleChange(b, 'altitude', e.target.value)} className="w-full border border-gray-400 p-2 rounded text-right font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white bg-white shadow-sm" placeholder="0.00" />
                                                    <span className="absolute right-8 top-2 text-gray-400 text-xs pointer-events-none">m</span>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {boringList.length === 0 && <tr><td colSpan="2" className="p-8 text-center text-gray-400">„Éá„Éº„Çø„Å´ÂÖ•Âäõ„Åï„Çå„ÅüÂ≠îÁï™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="p-4 border-t border-gray-300 bg-gray-100 text-right flex justify-end">
                        <button onClick={handleSave} className="bg-blue-600 text-white px-8 py-2.5 rounded shadow-lg font-bold hover:bg-blue-700 transition-transform active:scale-95 flex items-center gap-2">
                            <span>üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</span>
                        </button>
                    </div>
                </div>
            );
        };
        const UnifiedSettingsModal = ({ 
            isOpen, onClose, 
            soilSettings, setSoilSettings, allDataSoilTypes,
            boringList, boringSettings, setBoringSettings,
            classMap, setClassMap
        }) => {
            const [activeTab, setActiveTab] = useState('soil');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center modal-overlay backdrop-blur-sm no-print">
                    <div className="bg-white rounded-lg shadow-2xl w-[1000px] h-[85vh] flex flex-col overflow-hidden animate-fade-in border border-gray-600">
                        <div className="px-4 py-2 bg-slate-800 text-white flex justify-between items-center flex-shrink-0">
                            <div className="flex gap-4 items-end">
                                <h3 className="font-bold text-lg mr-4">‚öô Ë®≠ÂÆö</h3>
                                <div className="flex space-x-1">
                                    <button onClick={() => setActiveTab('soil')} className={`px-4 py-1.5 text-sm font-bold rounded-t-md transition-colors ${activeTab === 'soil' ? 'bg-slate-100 text-slate-900 border-t border-l border-r border-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600 hover:text-white'}`}>Âá°‰æã„ÉªÂúüÂ±§</button>
                                    <button onClick={() => setActiveTab('boring')} className={`px-4 py-1.5 text-sm font-bold rounded-t-md transition-colors ${activeTab === 'boring' ? 'bg-slate-100 text-slate-900 border-t border-l border-r border-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600 hover:text-white'}`}>Â≠îÂè£Ê®ôÈ´ò</button>
                                    <button onClick={() => setActiveTab('class')} className={`px-4 py-1.5 text-sm font-bold rounded-t-md transition-colors ${activeTab === 'class' ? 'bg-slate-100 text-slate-900 border-t border-l border-r border-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600 hover:text-white'}`}>ÂúüË≥™ÂàÜÈ°ûÂÆöÁæ©</button>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none px-2">√ó</button>
                        </div>
                        <div className="flex-1 overflow-hidden bg-slate-100 relative">
                            {activeTab === 'soil' && <SoilSettingsContent settings={soilSettings} setSettings={setSoilSettings} allDataSoilTypes={allDataSoilTypes} />}
                            {activeTab === 'boring' && <BoringSettingsContent boringList={boringList} boringSettings={boringSettings} setBoringSettings={setBoringSettings} />}
                            {activeTab === 'class' && <ClassDefinitionContent classMap={classMap} setClassMap={setClassMap} />}
                        </div>
                        <div className="p-3 border-t bg-gray-200 text-right flex-shrink-0">
                            <button onClick={onClose} className="bg-slate-700 text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-slate-800">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                </div>
            );
        };
        const ConsolidationParamsModal = ({ isOpen, onClose, params, setParams }) => {
            const [text, setText] = useState('');
            useEffect(() => {
                if (isOpen && params.length > 0) {}
            }, [isOpen, params]);
            const handlePaste = (e) => { };
            const parseAndSave = () => {
                const lines = text.split(/\r\n|\n|\r/).filter(l => l.trim() !== '');
                const newParams = [];
                lines.forEach(line => {
                    const cols = line.trim().split(/\s+/);
                    if (cols.length >= 2) {
                        const z = parseFloat(cols[0]);
                        const p0 = parseFloat(cols[1]);
                        const dp = parseFloat(cols[2] || 0);
                        if (!isNaN(z) && !isNaN(p0)) {
                            newParams.push({ z, p0, dp });
                        }
                    }
                });
                if (newParams.length === 0) { alert('ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË™≠„ÅøÂèñ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nÂΩ¢Âºè: Ê∑±Â∫¶(m) [Tab] P0 [Tab] ŒîP'); return; }
                newParams.sort((a, b) => a.z - b.z);
                setParams(newParams);
                alert(`${newParams.length} ‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ`);
                onClose();
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center modal-overlay backdrop-blur-sm no-print">
                    <div className="bg-white rounded-lg shadow-2xl w-[600px] h-[80vh] flex flex-col overflow-hidden">
                        <div className="px-6 py-3 border-b bg-slate-800 text-white flex justify-between items-center"><h3 className="font-bold text-lg">ÂúßÂØÜË®àÁÆóÁî®„Éë„É©„É°„Éº„ÇøË®≠ÂÆö (P0, ŒîP)</h3><button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">√ó</button></div>
                        <div className="p-4 bg-gray-50 flex-1 flex flex-col overflow-hidden"><p className="text-xs text-gray-600 mb-2">ExcelÁ≠â„Åã„Çâ„ÄåÊ∑±Â∫¶(m)„Äç„ÄåÊúâÂäπ‰∏äËºâÂúß P0 (kN/m¬≤)„Äç„ÄåÂ¢óÂä†ÂøúÂäõ ŒîP (kN/m¬≤)„Äç„ÅÆ3Âàó„Çí„Ç≥„Éî„Éº„Åó„Å¶Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br/>‚Äª„Ç∞„É©„Éï„ÅÆÂèÇÁÖßÁ∑ö„Åä„Çà„Å≥OCRÁ≠â„ÅÆË®àÁÆó„Å´‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ</p><div className="flex gap-4 flex-1 overflow-hidden"><div className="flex-1 flex flex-col"><label className="text-xs font-bold mb-1">„Éá„Éº„ÇøË≤º„Çä‰ªò„Åë„Ç®„É™„Ç¢</label><textarea className="flex-1 border border-gray-300 p-2 text-xs font-mono resize-none focus:outline-blue-500" placeholder={`0.0\t0.0\t100.0\n0.5\t9.0\t100.0\n1.0\t18.0\t100.0\n...`} value={text} onChange={e => setText(e.target.value)} onPaste={handlePaste} /></div><div className="w-48 flex flex-col border-l pl-4"><label className="text-xs font-bold mb-1">ÁèæÂú®„ÅÆÁôªÈå≤„Éá„Éº„Çø</label><div className="flex-1 overflow-y-auto border border-gray-200 bg-white"><table className="w-full text-[10px] text-center border-collapse"><thead className="sticky top-0 bg-gray-100"><tr><th className="border-b">Z(m)</th><th className="border-b">P0</th><th className="border-b">ŒîP</th></tr></thead><tbody>{params.map((r, i) => (<tr key={i} className="border-b border-gray-100"><td>{r.z}</td><td>{r.p0}</td><td>{r.dp}</td></tr>))}{params.length === 0 && <tr><td colSpan="3" className="text-gray-400 py-4">„Éá„Éº„Çø„Å™„Åó</td></tr>}</tbody></table></div></div></div></div>
                        <div className="p-3 border-t bg-gray-100 text-right flex justify-end gap-2"><button onClick={onClose} className="text-gray-600 px-4 py-2 text-sm font-bold hover:bg-gray-200 rounded">„Ç≠„É£„É≥„Çª„É´</button><button onClick={parseAndSave} className="bg-blue-600 text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-blue-700">ÁôªÈå≤ / Êõ¥Êñ∞</button></div>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center modal-overlay backdrop-blur-sm no-print" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-2xl w-[800px] h-[85vh] flex flex-col overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-3 bg-slate-800 text-white flex justify-between items-center flex-shrink-0">
                            <h3 className="font-bold text-lg flex items-center gap-2">üìö „É¶„Éº„Ç∂„Éº„Ç¨„Ç§„Éâ / „Éò„É´„Éó</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">√ó</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-8 text-sm text-gray-700 leading-relaxed space-y-6">
                            
                            <section>
                                <h4 className="text-lg font-bold text-blue-800 border-b-2 border-blue-200 mb-2 pb-1">1. Âü∫Êú¨Êìç‰Ωú„Å®‰øùÂ≠ò</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>Ëá™Âãï‰øùÂ≠ò:</strong> ÂÖ•ÂäõÂÜÖÂÆπ„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô„Åå„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§„ÅßÊ∂à„Åà„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</li>
                                    <li><strong>„Éï„Ç°„Ç§„É´‰øùÂ≠ò:</strong> ÈáçË¶Å„Å™„Éá„Éº„Çø„ÅØ„Çµ„Ç§„Éâ„Éê„Éº„ÅÆ<span className="bg-emerald-700 text-white px-1 py-0.5 text-xs rounded mx-1">‰øùÂ≠ò</span>„Éú„Çø„É≥„Åã„ÇâJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶PC„Å´‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
                                    <li><strong>Âç∞Âà∑:</strong> „Éñ„É©„Ç¶„Ç∂„ÅÆÂç∞Âà∑Ê©üËÉΩÔºàCtrl+PÔºâ„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇA4Ê®™Âêë„Åç„Åß„ÅÆPDF‰øùÂ≠ò„ÇÑÂç∞Âà∑„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</li>
                                </ul>
                            </section>

                            <section>
                                <h4 className="text-lg font-bold text-blue-800 border-b-2 border-blue-200 mb-2 pb-1">2. „Éá„Éº„ÇøÂÖ•Âäõ (ExcelÈÄ£Êê∫)</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>Excel„Åã„Çâ„ÅÆË≤º‰ªò:</strong> Excel„Åß„Éá„Éº„ÇøÁØÑÂõ≤„Çí„Ç≥„Éî„Éº„Åó„ÄÅÂÖ•Âäõ„ÉÜ„Éº„Éñ„É´„ÅÆ„Çª„É´„ÇíÈÅ∏Êäû„Åó„Å¶Ë≤º„Çä‰ªò„ÅëÔºàCtrl+VÔºâ„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ</li>
                                    <li><strong>Ë©≥Á¥∞Âàó„ÅÆË°®Á§∫:</strong> ÁîªÈù¢‰∏äÈÉ®„ÅÆ„ÄåË©≥Á¥∞Âàó„ÇíË°®Á§∫„Äç„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Çã„Å®„ÄÅqu(1)ÔΩû(3)„Å™„Å©„ÅÆÂÖÉ„Éá„Éº„ÇøÂÖ•ÂäõÊ¨Ñ„ÅåÁèæ„Çå„Åæ„Åô„ÄÇ</li>
                                    <li><strong>Ëá™ÂãïË®àÁÆó:</strong> Ê∂≤ÊÄßÈôêÁïå(WL)„ÉªÂ°ëÊÄßÈôêÁïå(WP)„ÇíÂÖ•„Çå„Çã„Å®Ip, Ic, IL„Å™„Å©„ÅåËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô„ÄÇÁ≤íÂ∫¶ÂàÜÂ∏É„Åã„Çâ„ÇÇUc, FcÁ≠â„ÅåË®àÁÆó„Åï„Çå„Åæ„Åô„ÄÇ</li>
                                    <li><strong>„Ç≠„ÉºÊìç‰Ωú:</strong> Áü¢Âç∞„Ç≠„Éº„Åß„Çª„É´„ÅÆÁßªÂãï„ÄÅEnter„Ç≠„Éº„Åß‰∏ã„ÅÆË°å„Å∏ÁßªÂãï„Åß„Åç„Åæ„Åô„ÄÇ</li>
                                </ul>
                            </section>

                            <section>
                                <h4 className="text-lg font-bold text-blue-800 border-b-2 border-blue-200 mb-2 pb-1">3. „Ç∞„É©„Éï„ÉªÂàÜÊûêÊ©üËÉΩ</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <h5 className="font-bold text-slate-700 mb-1">üìà Ê∑±Â∫¶„ÉªÊ®ôÈ´ò„Ç∞„É©„Éï</h5>
                                        <ul className="list-disc pl-4 text-xs space-y-1">
                                            <li>„ÄåÊ∑±Â∫¶„Äç„Å®„ÄåÊ®ôÈ´ò„Äç„ÅÆYËª∏Âàá„ÇäÊõø„Åà„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ</li>
                                            <li>„Ç∞„É©„ÉïË®≠ÂÆöÔºàÊ≠ØËªä„Ç¢„Ç§„Ç≥„É≥Ôºâ„Åã„ÇâËª∏„ÅÆÊúÄÂ§ß„ÉªÊúÄÂ∞èÂÄ§„ÇíÂõ∫ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ</li>
                                            <li>Âá°‰æãÔºàÂúüË≥™„Åî„Å®„ÅÆËâ≤„ÉªÂΩ¢Áä∂Ôºâ„ÅØ„ÄåË®≠ÂÆö„Äç„É°„Éã„É•„Éº„Åã„ÇâËá™Áî±„Å´Â§âÊõ¥ÂèØËÉΩ„Åß„Åô„ÄÇ</li>
                                        </ul>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <h5 className="font-bold text-slate-700 mb-1">üìâ Áõ∏Èñ¢ÂàÜÊûê„ÉªÊï£Â∏ÉÂõ≥</h5>
                                        <ul className="list-disc pl-4 text-xs space-y-1">
                                            <li>Â°ëÊÄßÂõ≥„ÄÅÁ≤íÂ∫¶ÂàÜÂ∏É„ÄÅNÂÄ§Áõ∏Èñ¢„Å™„Å©‰∏ªË¶Å„Å™„Ç∞„É©„Éï„ÇíÁ∂≤ÁæÖ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</li>
                                            <li><strong>ÂúßÂØÜ„Éë„É©„É°„Éº„ÇøË®≠ÂÆö:</strong> „ÄåÂúßÂØÜ„Éë„É©„É°„Éº„ÇøË®≠ÂÆö„Äç„Éú„Çø„É≥„Åã„ÇâÊ∑±Â∫¶„Åî„Å®„ÅÆP0, ŒîP„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅOCR„Ç∞„É©„Éï„ÇÑPc-P0„Ç∞„É©„Éï„Å´ÂèÇÁÖßÁ∑ö„ÅåÊèèÁîª„Åï„Çå„Åæ„Åô„ÄÇ</li>
                                        </ul>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h4 className="text-lg font-bold text-blue-800 border-b-2 border-blue-200 mb-2 pb-1">4. ‰æøÂà©„Å™Ê©üËÉΩ (Tips)</h4>
                                <ul className="list-disc pl-5 space-y-1">
                                    <li><strong>Âàó„ÅÆÈùûË°®Á§∫ (Âè≥„ÇØ„É™„ÉÉ„ÇØ):</strong> Áµ±Ë®à‰∏ÄË¶ßË°®„ÅÆË¶ãÂá∫„Åó„Çí<strong>Âè≥„ÇØ„É™„ÉÉ„ÇØ</strong>„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÂàó„Çí‰∏ÄÊôÇÁöÑ„Å´ÈùûË°®Á§∫„Å´„Åß„Åç„Åæ„Åô„ÄÇÂç∞Âà∑ÊôÇ„ÅÆÂàóÊï∞Ë™øÊï¥„Å´‰æøÂà©„Åß„Åô„ÄÇ</li>
                                    <li><strong>Èñ≤Ë¶ß„É¢„Éº„Éâ:</strong> ÂÖ•ÂäõÁîªÈù¢„Åß„ÄåÈñ≤Ë¶ß„É¢„Éº„Éâ„Äç„Å´„Åô„Çã„Å®„ÄÅË™§ÂÖ•Âäõ„ÇíÈò≤„Åé„Å™„Åå„Çâ„Éá„Éº„Çø„ÇíÂèÇÁÖß„Åß„Åç„Åæ„Åô„ÄÇ</li>
                                    <li><strong>Âá°‰æã„ÅÆ„ÇØ„Ç§„ÉÉ„ÇØÂàáÊõø:</strong> „Ç∞„É©„Éï‰∏äÈÉ®„ÅÆÂá°‰æã„É©„Éô„É´„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅÁâπÂÆö„ÅÆÂúüË≥™„Å†„Åë„Çí‰∏ÄÊôÇÁöÑ„Å´ÈùûË°®Á§∫„Å´„Åß„Åç„Åæ„Åô„ÄÇ</li>
                                </ul>
                            </section>

                             <div className="bg-yellow-50 border border-yellow-200 p-3 rounded text-xs text-yellow-800">
                                <strong>ÂÖçË≤¨‰∫ãÈ†Ö:</strong> Êú¨„Ç∑„Çπ„ÉÜ„É†„ÅØË®àÁÆóÁµêÊûú„ÅÆÊ≠£Á¢∫ÊÄß„Çí‰øùË®º„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂøÖ„ÅöÊäÄË°ìËÄÖ„Å´„Çà„ÇãÁ¢∫Ë™ç„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </div>
                        </div>
                        <div className="p-3 border-t bg-gray-50 text-right">
                            <button onClick={onClose} className="bg-blue-600 text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-blue-700">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LegalFooter = () => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <footer className="bg-slate-50 border-t border-gray-300 text-gray-500 text-[10px] py-2 px-4 flex-shrink-0 no-print z-[100]">
                    <div className="flex justify-center items-center gap-4"><span>ÊúÄÁµÇÊõ¥Êñ∞Êó•: 2025Âπ¥11Êúà26Êó•</span><button onClick={() => setIsOpen(!isOpen)} className="font-bold hover:text-slate-800 underline decoration-dotted cursor-pointer transition-colors">ÂÖçË≤¨‰∫ãÈ†Ö ({isOpen ? '„ÇØ„É™„ÉÉ„ÇØ„ÅßÈùûË°®Á§∫' : '„ÇØ„É™„ÉÉ„ÇØ„ÅßË°®Á§∫'})</button></div>
                    {isOpen && (
                        <div className="mt-2 pt-2 border-t border-gray-200 text-left max-w-[800px] mx-auto leading-relaxed animate-fade-in"><p className="text-center font-bold mb-1">Copyright &copy; 2025 (Ê†™)Âú∞ÂúèÁ∑èÂêà„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà All Rights Reserved.</p><p className="text-center text-[9px] text-gray-400 mb-2">Developed by: Naoya.Onozato</p><div className="bg-yellow-50 border border-yellow-300 text-red-600 font-bold text-center p-1.5 rounded mb-2 mx-4">‚ö† Êú¨„Ç∑„Çπ„ÉÜ„É†„ÅÆÂÜçÈÖçÂ∏É„ÉªÁ¨¨‰∏âËÄÖ„Å∏„ÅÆÊèê‰æõ„ÇíÁ¶ÅÊ≠¢„Åó„Åæ„Åô„ÄÇ</div><div className="px-4 space-y-2"><p><strong>ÂÖçË≤¨‰∫ãÈ†Ö:</strong><br/>Êú¨„Ç∑„Çπ„ÉÜ„É†„ÅÆÂà©Áî®„Å´„Çà„Å£„Å¶Áîü„Åò„Åü„ÅÑ„Åã„Å™„ÇãÊêçÂÆ≥„Å´„Å§„ÅÑ„Å¶„ÇÇ„ÄÅ‰ΩúÊàêËÄÖ„ÅØ‰∏ÄÂàá„ÅÆË≤¨‰ªª„ÇíË≤†„ÅÑ„Åæ„Åõ„Çì„ÄÇÊú¨„ÉÑ„Éº„É´„ÅØ„ÅÇ„Åè„Åæ„ÅßÂúüË≥™Ë©¶È®ìÁµêÊûúÊï¥ÁêÜ„ÅÆË£úÂä©ÁöÑ„Å™„ÇÇ„ÅÆ„Åß„ÅÇ„Çä„ÄÅË®àÁÆóÁµêÊûú„ÇÑÊèèÁîªÂÜÖÂÆπ„ÅØÂøÖ„ÅöÂ∞ÇÈñÄÊäÄË°ìËÄÖ„ÅåÁ¢∫Ë™ç„ÉªÊ§úË®º„Åó„Åü‰∏ä„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊú¨„Ç∑„Çπ„ÉÜ„É†„ÅåÂá∫Âäõ„Åô„ÇãÂÄ§„ÅÆÊ≠£Á¢∫ÊÄß„ÇÑÂÆåÂÖ®ÊÄß„Çí„ÄÅÂ∑•Â≠¶ÁöÑÂà§Êñ≠„Å™„Åó„Å´‰øùË®º„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p></div><div className="text-center mt-2 pb-2"><button onClick={() => setIsOpen(false)} className="bg-gray-200 hover:bg-gray-300 text-gray-600 px-4 py-1 rounded text-[9px] font-bold">Èñâ„Åò„Çã</button></div></div>
                    )}
                </footer>
            );
        };

        const STORAGE_KEY = 'soil_app_v71_data';

        const App = () => {
            const [data, setData] = useState([]);
            const [activeTab, setActiveTab] = useState('input');
            const [visibleGraphs, setVisibleGraphs] = useState(COLUMN_DEFS.filter(c => c.graph).map(c => c.key));
            const [selectedBorings, setSelectedBorings] = useState(new Set());
            const [selectedSoils, setSelectedSoils] = useState(new Set());
            const [statsExpanded, setStatsExpanded] = useState({});
            const [soilSettings, setSoilSettings] = useState([
                { name: 'Ac', color: '#8B4513', shape: 'circle', visible: true }, { name: 'As', color: '#CD853F', shape: 'square', visible: true }, 
                { name: 'Ag', color: '#A0522D', shape: 'triangle', visible: true }, { name: 'Dc', color: '#2F4F4F', shape: 'diamond', visible: true }, 
                { name: 'Ds', color: '#556B2F', shape: 'circle', visible: true }, { name: 'Dg', color: '#808000', shape: 'square', visible: true }
            ]);
            const [soilClassMap, setSoilClassMap] = useState(DEFAULT_SOIL_CLASS_MAP);
            const [isUnifiedSettingsOpen, setIsUnifiedSettingsOpen] = useState(false);
            const [boringSettings, setBoringSettings] = useState({});
            const [isViewMode, setIsViewMode] = useState(false);
            const [showDetailCols, setShowDetailCols] = useState(false);
            
            const [graphPointSize, setGraphPointSize] = useState(4);
            const [graphFontSize, setGraphFontSize] = useState(11);
            const [verticalAxisMode, setVerticalAxisMode] = useState('depth');
            const [columnScales, setColumnScales] = useState({});
            
            const [depthYScale, setDepthYScale] = useState({ min: '', max: '', step: '' });
            const [elevationYScale, setElevationYScale] = useState({ min: '', max: '', step: '' });

            const [globalGraphHeight, setGlobalGraphHeight] = useState(500);
            const [globalGraphWidth, setGlobalGraphWidth] = useState(240);
            const [printGraphsPerRow, setPrintGraphsPerRow] = useState(5);

            const [analysisGraphFontSize, setAnalysisGraphFontSize] = useState(14);
            const [analysisGraphPointSize, setAnalysisGraphPointSize] = useState(6);
            const [analysisGraphHeight, setAnalysisGraphHeight] = useState(600);
            const [analysisGraphWidth, setAnalysisGraphWidth] = useState(500); 
            
            const [correlationChartSize, setCorrelationChartSize] = useState(350);
            const [correlationGraphPointSize, setCorrelationGraphPointSize] = useState(5);
            const [correlationGraphFontSize, setCorrelationGraphFontSize] = useState(11);

            const [inputTableFontSize, setInputTableFontSize] = useState(11);
            const [statsTableFontSize, setStatsTableFontSize] = useState(11);
            const [analysisTableFontSize, setAnalysisTableFontSize] = useState(11);
            const [multiStatsTableFontSize, setMultiStatsTableFontSize] = useState(11);

            const [visibleStatCols, setVisibleStatCols] = useState(COLUMN_DEFS.filter(c => c.type === 'number').map(c => c.key));
            const [isStatMenuOpen, setIsStatMenuOpen] = useState(false);
            const [printWithBreakdown, setPrintWithBreakdown] = useState(false);
            const [analysisTargetKey, setAnalysisTargetKey] = useState('rho_t');
            const DEFAULT_MULTI_COLS = ['rho_t', 'wn', 'qu', 'm_ratio', 'c_uu', 'phi_uu', 'm_cu', 'c_dash', 'phi_dash', 'Pc', 'Cc', 'Fc', 'Ip', 'IL', 'k_est'];
            const [selectedMultiAnalysisCols, setSelectedMultiAnalysisCols] = useState(new Set(DEFAULT_MULTI_COLS));
            const [isMultiSelectMenuOpen, setIsMultiSelectMenuOpen] = useState(false);
            const [pcGraphMode, setPcGraphMode] = useState('uu');
            const [statsPrintColLimit, setStatsPrintColLimit] = useState(10);
            const [multiPrintColLimit, setMultiPrintColLimit] = useState(5);
            const [consolidationParams, setConsolidationParams] = useState([]);
            const [isConsolidationModalOpen, setIsConsolidationModalOpen] = useState(false);
            const [isHelpOpen, setIsHelpOpen] = useState(false);
            const [contextMenu, setContextMenu] = useState(null);

            const fileInputRef = useRef(null);
            const graphSettingsInputRef = useRef(null); 

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.data) setData(parsed.data);
                        if (parsed.soilSettings) setSoilSettings(parsed.soilSettings);
                        if (parsed.boringSettings) setBoringSettings(parsed.boringSettings);
                        if (parsed.consolidationParams) setConsolidationParams(parsed.consolidationParams);
                        if (parsed.inputTableFontSize) setInputTableFontSize(parsed.inputTableFontSize);
                        if (parsed.statsTableFontSize) setStatsTableFontSize(parsed.statsTableFontSize);
                        if (parsed.analysisTableFontSize) setAnalysisTableFontSize(parsed.analysisTableFontSize);
                        if (parsed.multiStatsTableFontSize) setMultiStatsTableFontSize(parsed.multiStatsTableFontSize);
                        if (parsed.depthYScale) setDepthYScale(parsed.depthYScale);
                        if (parsed.elevationYScale) setElevationYScale(parsed.elevationYScale);
                    } catch(e) { console.error(e); }
                } else {
                    const sample = [
                        { id: 1, boring: 'No.1', sample_no: 'S1', depth_top: 2.0, depth_bottom: 2.45, soilType: 'As', N_value: 8, wn: 20.5, rho_t: 1.85, sand: 85, silt: 15, Fc: 15 },
                        { id: 2, boring: 'No.1', sample_no: 'T1', depth_top: 5.0, depth_bottom: 5.80, soilType: 'Ac', N_value: 2, wn: 65.2, rho_t: 1.55, qu_1: 44, qu_2: 46, qu_3: 45.6, qu: 45.2, clay: 60, silt: 40, WL: 70, WP: 30, Ip: 40, D20: 0.005, Cc: 1.2, c_cu: 15, phi_cu: 5, m_cu: 0.15, c_dash: 2, phi_dash: 25, Pc: 80, Fc: 100, class_symbol: 'CH', class_name: 'Á≤òÂúüÔºàÈ´òÊ∂≤ÊÄßÈôêÁïåÔºâ', Ic: 0.12, IL: 0.88, m_ratio: 0.28, k_est: 1.8E-6 },
                    ];
                    setData(sample);
                    setSelectedBorings(new Set(sample.map(d => d.boring)));
                    setSelectedSoils(new Set(sample.map(d => d.soilType)));
                    setBoringSettings({ "No.1": { altitude: 10.0 } });
                }
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => {
                    const saveData = {
                        data, soilSettings, boringSettings, consolidationParams,
                        inputTableFontSize, statsTableFontSize, analysisTableFontSize, multiStatsTableFontSize, 
                        depthYScale, elevationYScale,
                        version: "72"
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
                }, 1000);
                return () => clearTimeout(timer);
            }, [data, soilSettings, boringSettings, consolidationParams, inputTableFontSize, statsTableFontSize, analysisTableFontSize, multiStatsTableFontSize, depthYScale, elevationYScale]);


            useEffect(() => {
                const existingSoils = new Set(soilSettings.map(s => s.name));
                const currentSoils = [...new Set(data.map(d => d.soilType).filter(Boolean))];
                const newSoils = currentSoils.filter(s => !existingSoils.has(s)).map(s => ({
                    name: s, color: '#' + Math.floor(Math.random()*16777215).toString(16), shape: 'circle', visible: true
                }));
                if (newSoils.length > 0) setSoilSettings(prev => [...prev, ...newSoils]);
            }, [data]);

            const availableBorings = useMemo(() => [...new Set(data.map(d => d.boring).filter(Boolean))].sort(), [data]);
            const availableSoils = useMemo(() => [...new Set(data.map(d => d.soilType).filter(Boolean))].sort(), [data]);

            const filteredData = useMemo(() => {
                return data.filter(d => {
                    const boringMatch = !d.boring || selectedBorings.has(d.boring);
                    const soilMatch = !d.soilType || selectedSoils.has(d.soilType);
                    return boringMatch && soilMatch;
                });
            }, [data, selectedBorings, selectedSoils]);

            const addRow = () => { const newRow = { id: Date.now() }; COLUMN_DEFS.forEach(c => newRow[c.key] = null); setData(prev => [...prev, newRow]); };
            // --- Êó¢Â≠ò„ÅÆ addRow „ÅÆ‰∏ã„Å´„Åì„Çå„ÇíËøΩÂä† ---
            const deleteAllData = () => {
                if (window.confirm("„ÄêË≠¶Âëä„Äë\nË°®Á§∫‰∏≠„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ")) {
                    setData([]);
                    alert("„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
                }
            };
            // ------------------------------------
const deleteRow = (id) => setData(prev => prev.filter(r => r.id !== id));
            
            const updateRow = useCallback((id, key, rawVal) => {
                let val = roundValue(key, rawVal);
                
                setData(prev => prev.map(row => {
                    if (row.id !== id) return row;
                    let newRow = { ...row, [key]: val };
                    const isValid = (v) => v !== null && v !== "" && !isNaN(parseFloat(v));
                    const num = (v) => parseFloat(v);

                    if (key === 'silt' || key === 'clay') {
                         if (isValid(newRow.silt) && isValid(newRow.clay)) {
                             newRow.Fc = roundValue('Fc', num(newRow.silt) + num(newRow.clay));
                         }
                    }

                    if (['WL', 'WP', 'wn'].includes(key)) {
                        if (isValid(newRow.WL) && isValid(newRow.WP)) {
                            const ip = roundValue('Ip', num(newRow.WL) - num(newRow.WP));
                            newRow.Ip = ip;
                            if (isValid(newRow.wn) && ip !== 0) {
                                newRow.Ic = roundValue('Ic', (num(newRow.WL) - num(newRow.wn)) / ip);
                                newRow.IL = roundValue('IL', (num(newRow.wn) - num(newRow.WP)) / ip);
                            }
                            newRow.m_phys = roundValue('m_phys', 0.11 + 0.0037 * ip);
                        }
                    }

                    if (['D10', 'D30', 'D60'].includes(key)) {
                        const d10 = key === 'D10' ? num(val) : num(newRow.D10);
                        const d30 = key === 'D30' ? num(val) : num(newRow.D30);
                        const d60 = key === 'D60' ? num(val) : num(newRow.D60);

                        if (isValid(d10) && isValid(d60) && d10 !== 0) {
                            newRow.Uc = roundValue('Uc', d60 / d10);
                        }
                        if (isValid(d10) && isValid(d30) && isValid(d60) && d10 !== 0 && d60 !== 0) {
                            newRow.Uc_prime = roundValue('Uc_prime', Math.pow(d30, 2) / (d10 * d60));
                        }
                    }

                    if (key === 'class_symbol') {
                        if (val && soilClassMap[val]) newRow.class_name = soilClassMap[val];
                    }

                    const calcAvg = (keys, targetKey) => {
                        const vals = keys.map(k => parseFloat(newRow[k])).filter(v => v !== null && !isNaN(v));
                        if (vals.length === 0) return null;
                        return roundValue(targetKey, vals.reduce((a, b) => a + b, 0) / vals.length);
                    };
                    if (['qu_1', 'qu_2', 'qu_3'].includes(key)) newRow.qu = calcAvg(['qu_1', 'qu_2', 'qu_3'], 'qu');
                    if (['E50_u1', 'E50_u2', 'E50_u3'].includes(key)) newRow.E50_u = calcAvg(['E50_u1', 'E50_u2', 'E50_u3'], 'E50_u');
                    if (['E50_t1', 'E50_t2', 'E50_t3'].includes(key)) newRow.E50_t = calcAvg(['E50_t1', 'E50_t2', 'E50_t3'], 'E50_t');

                    if (key === 'qu' || ['qu_1', 'qu_2', 'qu_3'].includes(key)) {
                        if (isValid(newRow.qu)) {
                            newRow.c_uu_qu = roundValue('c_uu_qu', num(newRow.qu) / 2);
                        }
                    }

                    if (['qu', 'qu_1', 'qu_2', 'qu_3', 'Pc'].includes(key)) {
                        if (isValid(newRow.qu) && isValid(newRow.Pc) && num(newRow.Pc) !== 0) {
                            newRow.m_ratio = roundValue('m_ratio', (num(newRow.qu) / 2) / num(newRow.Pc));
                        }
                    }

                    if (key === 'D20') {
                        if (isValid(newRow.D20) && num(newRow.D20) > 0) {
                             newRow.k_est = 0.3441 * Math.pow(num(newRow.D20), 2.2954);
                        } else {
                             newRow.k_est = null;
                        }
                    }

                    return newRow;
                }));
            }, [soilClassMap]);
            
            const handlePaste = useCallback((e, startRowId, startColKey) => { 
                e.preventDefault(); const text = e.clipboardData.getData('text'); const rows = text.split(/\r\n|\n|\r/).filter(row => row.trim() !== ''); if (rows.length === 0) return; 
                const startRowIndex = data.findIndex(d => d.id === startRowId); const startColIndex = COLUMN_DEFS.findIndex(c => c.key === startColKey); if (startRowIndex === -1 || startColIndex === -1) return; 
                let newData = [...data]; const neededRows = (startRowIndex + rows.length) - newData.length; if (neededRows > 0) { for(let i=0; i<neededRows; i++){ const newRow = { id: Date.now() + i }; COLUMN_DEFS.forEach(c => newRow[c.key] = null); newData.push(newRow); } } 
                
                rows.forEach((rowText, rIdx) => { 
                    const currentRowIndex = startRowIndex + rIdx; if (currentRowIndex >= newData.length) return; const cells = rowText.split('\t'); 
                    let currentRow = { ...newData[currentRowIndex] };
                    cells.forEach((cellVal, cIdx) => { 
                        const currentColIndex = startColIndex + cIdx; if (currentColIndex >= COLUMN_DEFS.length) return; 
                        const colDef = COLUMN_DEFS[currentColIndex]; let val = cellVal.trim(); 
                        if (colDef.type === 'number') { val = val === '' ? null : parseFloat(val); if (isNaN(val)) val = null; } 
                        currentRow[colDef.key] = roundValue(colDef.key, val); 
                    });
                    
                    const num = (v) => v !== null && !isNaN(v) ? parseFloat(v) : null;
                    const isValid = (v) => v !== null && v !== undefined && v !== '';
                    
                    if (isValid(currentRow.silt) && isValid(currentRow.clay)) {
                        currentRow.Fc = roundValue('Fc', num(currentRow.silt) + num(currentRow.clay));
                    }
                    if (isValid(currentRow.WL) && isValid(currentRow.WP)) {
                        const ip = roundValue('Ip', num(currentRow.WL) - num(currentRow.WP));
                        currentRow.Ip = ip;
                        if (isValid(currentRow.wn) && currentRow.Ip !== 0) {
                            currentRow.Ic = roundValue('Ic', (num(currentRow.WL) - num(currentRow.wn)) / currentRow.Ip);
                            currentRow.IL = roundValue('IL', (num(currentRow.wn) - num(currentRow.WP)) / currentRow.Ip);
                        }
                        currentRow.m_phys = roundValue('m_phys', 0.11 + 0.0037 * ip);
                    }
                    if (isValid(currentRow.D10) && isValid(currentRow.D60) && num(currentRow.D10) !== 0) {
                        currentRow.Uc = roundValue('Uc', num(currentRow.D60) / num(currentRow.D10));
                    }
                    if (isValid(currentRow.D10) && isValid(currentRow.D30) && isValid(currentRow.D60) && num(currentRow.D10) !== 0 && num(currentRow.D60) !== 0) {
                        currentRow.Uc_prime = roundValue('Uc_prime', Math.pow(num(currentRow.D30), 2) / (num(currentRow.D10) * num(currentRow.D60)));
                    }

                    if (currentRow.class_symbol && soilClassMap[currentRow.class_symbol]) currentRow.class_name = soilClassMap[currentRow.class_symbol];
                    
                    const calcAvg = (keys, row, targetKey) => { const vals = keys.map(k => parseFloat(row[k])).filter(v => v !== null && !isNaN(v)); if (vals.length === 0) return row[keys[0].replace(/_\d+$/, '')]; return roundValue(targetKey, vals.reduce((a, b) => a + b, 0) / vals.length); };
                    const quAvg = calcAvg(['qu_1', 'qu_2', 'qu_3'], currentRow, 'qu'); if(quAvg !== undefined) currentRow.qu = quAvg;
                    const EuAvg = calcAvg(['E50_u1', 'E50_u2', 'E50_u3'], currentRow, 'E50_u'); if(EuAvg !== undefined) currentRow.E50_u = EuAvg;
                    const EtAvg = calcAvg(['E50_t1', 'E50_t2', 'E50_t3'], currentRow, 'E50_t'); if(EtAvg !== undefined) currentRow.E50_t = EtAvg;
                    
                    if (isValid(currentRow.qu)) currentRow.c_uu_qu = roundValue('c_uu_qu', num(currentRow.qu) / 2);

                    if (isValid(currentRow.qu) && isValid(currentRow.Pc) && num(currentRow.Pc) !== 0) {
                        currentRow.m_ratio = roundValue('m_ratio', (num(currentRow.qu) / 2) / num(currentRow.Pc));
                    }
                    if (isValid(currentRow.D20) && num(currentRow.D20) > 0) {
                         currentRow.k_est = 0.3441 * Math.pow(num(currentRow.D20), 2.2954);
                    }
                    newData[currentRowIndex] = currentRow;
                }); 
                setData(newData); const allBorings = new Set(newData.map(d => d.boring).filter(Boolean)); const allSoils = new Set(newData.map(d => d.soilType).filter(Boolean)); setSelectedBorings(allBorings); setSelectedSoils(allSoils);
            }, [data, soilClassMap]);

            const downloadTemplate = () => {
                const headers = COLUMN_DEFS.map(c => c.label.replace(/\s+/g, '_'));
                const content = headers.join(',') + '\n';
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), content], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data_input_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            
            const toggleFilter = (set, setter, val) => { const newSet = new Set(set); if (newSet.has(val)) newSet.delete(val); else newSet.add(val); setter(newSet); };
            const toggleGraphGroup = (groupName, isChecked) => { const groupKeys = COLUMN_DEFS.filter(c => c.group === groupName && c.graph).map(c => c.key); setVisibleGraphs(prev => isChecked ? [...prev.filter(k => !groupKeys.includes(k)), ...groupKeys] : prev.filter(k => !groupKeys.includes(k))); };

            const statistics = useMemo(() => {
                const grouped = {};
                filteredData.forEach(row => {
                    if (!row.soilType) return;
                    if (!grouped[row.soilType]) { grouped[row.soilType] = { rows: [] }; COLUMN_DEFS.filter(c => c.type === 'number').forEach(c => grouped[row.soilType][c.key] = []); }
                    grouped[row.soilType].rows.push(row);
                    COLUMN_DEFS.filter(c => c.type === 'number').forEach(c => { const val = parseFloat(row[c.key]); if (val !== null && !isNaN(val)) grouped[row.soilType][c.key].push(val); });
                });
                const sortedSoilNames = soilSettings.filter(s => s.visible !== false).map(s => s.name).filter(n => grouped[n]);
                return sortedSoilNames.map(soil => {
                    const dataObj = { soil, rawRows: grouped[soil].rows, color: soilSettings.find(s => s.name === soil)?.color || '#ccc' };
                    COLUMN_DEFS.filter(c => c.type === 'number').forEach(col => {
                        const arr = grouped[soil][col.key];
                        if (arr.length === 0) { dataObj[col.key] = { n: 0, min: null, max: null, avg: null, geo: null }; } 
                        else { 
                            const sum = arr.reduce((a, b) => a + b, 0); 
                            let geo = null;
                            const useGeoMean = col.key.includes('E50') || col.key.includes('D20') || col.key.includes('k_');
                            if (useGeoMean && arr.every(v => v > 0)) { 
                                geo = Math.exp(arr.reduce((acc, val) => acc + Math.log(val), 0) / arr.length); 
                            }
                            dataObj[col.key] = { n: arr.length, min: Math.min(...arr), max: Math.max(...arr), avg: (sum / arr.length), geo: geo }; 
                        }
                    });
                    return dataObj;
                });
            }, [filteredData, soilSettings]);
            const allDataSoilTypes = useMemo(() => [...new Set(data.map(d => d.soilType).filter(Boolean))], [data]);

            const visibleColumns = useMemo(() => {
                return COLUMN_DEFS.filter(col => showDetailCols || !col.detail);
            }, [showDetailCols]);

            const { headerRows, statHeaderRows } = useMemo(() => {
                const makeGroups = (cols) => {
                    const map = new Map();
                    cols.forEach(col => { const groupId = `${col.group}_${col.fixed ? 'F' : 'S'}`; if (!map.has(groupId)) map.set(groupId, { label: col.group, fixed: col.fixed, cols: [] }); map.get(groupId).cols.push(col); });
                    return Array.from(map.values());
                };
                return { headerRows: makeGroups(visibleColumns), statHeaderRows: makeGroups(COLUMN_DEFS.filter(c => c.type === 'number')) };
            }, [visibleColumns]);

            const expandAllStats = () => { const newExpanded = {}; statistics.forEach(s => newExpanded[s.soil] = true); setStatsExpanded(newExpanded); };
            const collapseAllStats = () => setStatsExpanded({});

            const handleSaveFile = () => {
                const saveData = { 
                    data: data, 
                    soilSettings: soilSettings, 
                    soilClassMap: soilClassMap, 
                    visibleGraphs: visibleGraphs, 
                    columnScales: columnScales, 
                    depthYScale, elevationYScale, 
                    selectedMultiAnalysisCols: Array.from(selectedMultiAnalysisCols), 
                    boringSettings: boringSettings,
                    consolidationParams: consolidationParams,
                    inputTableFontSize, statsTableFontSize, analysisTableFontSize, multiStatsTableFontSize,
                    version: "72" 
                };
                const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `soil_data_v72_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };

            const handleLoadFileClick = () => { if(fileInputRef.current) fileInputRef.current.click(); };
            const handleFileChange = (e) => {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (event) => {
                    try { 
                        const json = JSON.parse(event.target.result); 
                        if (json.data) setData(json.data); 
                        if (json.soilSettings) setSoilSettings(json.soilSettings); 
                        if (json.soilClassMap) setSoilClassMap(json.soilClassMap);
                        if (json.visibleGraphs) setVisibleGraphs(json.visibleGraphs); 
                        if (json.columnScales) setColumnScales(json.columnScales); 
                        if (json.depthYScale) setDepthYScale(json.depthYScale);
                        if (json.elevationYScale) setElevationYScale(json.elevationYScale);
                        
                        if (json.selectedMultiAnalysisCols) setSelectedMultiAnalysisCols(new Set(json.selectedMultiAnalysisCols)); 
                        if (json.boringSettings) setBoringSettings(json.boringSettings);
                        if (json.consolidationParams) setConsolidationParams(json.consolidationParams);
                        if (json.inputTableFontSize) setInputTableFontSize(json.inputTableFontSize);
                        if (json.statsTableFontSize) setStatsTableFontSize(json.statsTableFontSize);
                        if (json.analysisTableFontSize) setAnalysisTableFontSize(json.analysisTableFontSize);
                        if (json.multiStatsTableFontSize) setMultiStatsTableFontSize(json.multiStatsTableFontSize);

                        if (json.data) { const allBorings = new Set(json.data.map(d => d.boring).filter(Boolean)); const allSoils = new Set(json.data.map(d => d.soilType).filter(Boolean)); setSelectedBorings(allBorings); setSelectedSoils(allSoils); } 
                        alert('„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü'); 
                    } catch (err) { alert('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'); console.error(err); }
                };
                reader.readAsText(file); e.target.value = '';
            };
            const handleSaveGraphSettings = () => {
                const settingsData = { 
                    type: 'graph_only', 
                    visibleGraphs: visibleGraphs, 
                    columnScales: columnScales, 
                    depthYScale, elevationYScale, 
                    soilSettings: soilSettings, 
                    graphPointSize: graphPointSize, 
                    graphFontSize: graphFontSize,
                    verticalAxisMode: verticalAxisMode, 
                    globalGraphHeight, 
                    globalGraphWidth,
                    printGraphsPerRow, 
                    correlationChartSize, 
                    analysisGraphHeight, 
                    analysisGraphWidth,
                    analysisGraphFontSize, 
                    analysisGraphPointSize,
                    correlationGraphPointSize,
                    correlationGraphFontSize,
                    version: "72" 
                };
                const blob = new Blob([JSON.stringify(settingsData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `graph_style_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };
            const handleLoadGraphSettingsChange = (e) => {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (event) => { 
                    try { 
                        const json = JSON.parse(event.target.result); 
                        if (json.visibleGraphs) setVisibleGraphs(json.visibleGraphs); 
                        if (json.columnScales) setColumnScales(json.columnScales); 
                        if (json.depthYScale) setDepthYScale(json.depthYScale); 
                        if (json.elevationYScale) setElevationYScale(json.elevationYScale); 
                        if (json.soilSettings) setSoilSettings(json.soilSettings); 
                        if (json.graphPointSize) setGraphPointSize(json.graphPointSize);
                        if (json.graphFontSize) setGraphFontSize(json.graphFontSize);
                        if (json.verticalAxisMode) setVerticalAxisMode(json.verticalAxisMode); 
                        if (json.globalGraphHeight) setGlobalGraphHeight(json.globalGraphHeight); 
                        if (json.globalGraphWidth) setGlobalGraphWidth(json.globalGraphWidth);
                        if (json.printGraphsPerRow) setPrintGraphsPerRow(json.printGraphsPerRow); 
                        if (json.correlationChartSize) setCorrelationChartSize(json.correlationChartSize); 
                        if (json.analysisGraphHeight) setAnalysisGraphHeight(json.analysisGraphHeight);
                        if (json.analysisGraphWidth) setAnalysisGraphWidth(json.analysisGraphWidth);
                        if (json.analysisGraphFontSize) setAnalysisGraphFontSize(json.analysisGraphFontSize);
                        if (json.analysisGraphPointSize) setAnalysisGraphPointSize(json.analysisGraphPointSize);
                        if (json.correlationGraphPointSize) setCorrelationGraphPointSize(json.correlationGraphPointSize);
                        if (json.correlationGraphFontSize) setCorrelationGraphFontSize(json.correlationGraphFontSize);
                        alert('„Ç∞„É©„ÉïË®≠ÂÆöÔºà„Çπ„Çø„Ç§„É´Ôºâ„ÅÆ„Åø„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü'); 
                    } catch (err) { alert('Ë®≠ÂÆö„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'); console.error(err); } 
                };
                reader.readAsText(file); e.target.value = '';
            };
            const updateScale = (key, newScale) => { setColumnScales(prev => ({...prev, [key]: newScale})); };
            const handlePrintReport = () => { window.print(); };

            // --- Â°ëÊÄßÂõ≥ (ËÉåÊôØ: Á∑ö„Å®Ëâ≤) ---
            const drawPlasticityLinesBackground = (xScale, yScale, minX, maxX, minY, maxY) => { 
                const limitWL = 50; const ipLow = 6; 
                const wlStartA = 20 + (ipLow / 0.73); 
                const ipAtB = 0.73 * (limitWL - 20); 
                const drawMaxX = Math.max(maxX, 200); const drawMaxY = Math.max(maxY, 200); 
                const X = (val) => xScale(val); const Y = (val) => yScale(val); 
                
                const pathCL = `M ${X(ipLow)},${Y(ipLow)} L ${X(wlStartA)},${Y(ipLow)} L ${X(limitWL)},${Y(ipAtB)} L ${X(limitWL)},${Y(limitWL)} Z`; 
                const pathML = `M ${X(0)},${Y(0)} L ${X(limitWL)},${Y(0)} L ${X(limitWL)},${Y(ipAtB)} L ${X(wlStartA)},${Y(ipLow)} L ${X(ipLow)},${Y(ipLow)} L ${X(0)},${Y(0)} Z`; 
                const ipAtMaxX = 0.73 * (drawMaxX - 20); 
                const pathCH = `M ${X(limitWL)},${Y(ipAtB)} L ${X(limitWL)},${Y(limitWL)} L ${X(drawMaxX)},${Y(drawMaxX)} L ${X(drawMaxX)},${Y(ipAtMaxX)} Z`; 
                const pathMH = `M ${X(limitWL)},${Y(0)} L ${X(limitWL)},${Y(ipAtB)} L ${X(drawMaxX)},${Y(ipAtMaxX)} L ${X(drawMaxX)},${Y(0)} Z`; 
            
                return ( 
                    <>
                        <path d={pathCL} fill="#ffedd5" stroke="none" className="opacity-60" /> 
                        <path d={pathML} fill="#dbeafe" stroke="none" className="opacity-60" /> 
                        <path d={pathCH} fill="#dcfce7" stroke="none" className="opacity-60" /> 
                        <path d={pathMH} fill="#fef9c3" stroke="none" className="opacity-60" /> 
                        {drawMaxX > wlStartA && ( <line x1={X(wlStartA)} y1={Y(ipLow)} x2={X(drawMaxX)} y2={Y(ipAtMaxX)} stroke="#000" strokeWidth="1.5" /> )} 
                        <line x1={X(limitWL)} y1={Y(0)} x2={X(limitWL)} y2={Y(limitWL)} stroke="#000" strokeWidth="1.5" /> 
                        <line x1={X(0)} y1={Y(0)} x2={X(drawMaxX)} y2={Y(drawMaxX)} stroke="#000" strokeWidth="1" strokeDasharray="4 2" /> 
                        <line x1={X(0)} y1={Y(ipLow)} x2={X(wlStartA)} y2={Y(ipLow)} stroke="#000" strokeWidth="1.5" /> 
                    </> 
                ); 
            };

            // --- Â°ëÊÄßÂõ≥ (ÂâçÈù¢: ÊñáÂ≠ó„É©„Éô„É´) ---
            const drawPlasticityLinesForeground = (xScale, yScale, minX, maxX, minY, maxY) => {
                const X = (val) => xScale(val); const Y = (val) => yScale(val);
                const limitWL = 50; 
                // „Éó„É≠„ÉÉ„Éà„Å®Èáç„Å™„Å£„Å¶„ÇÇË™≠„ÇÅ„Çã„Çà„ÅÜ„ÄÅÁôΩÁ∏ÅÂèñ„ÇäÁ≠â„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®„Åô„Çã„Åã„ÄÅÂçò„Å´ÂâçÈù¢„Å´ÊèèÁîª
                const textStyle = { textShadow: '0px 0px 3px rgba(255,255,255,0.8), 0px 0px 3px rgba(255,255,255,0.8)' };

                return (
                    <>
                         <text x={X(Math.min(maxX, 90))} y={Y(0.73*(Math.min(maxX, 90)-20)) - 4} fontSize="10" fill="#000" textAnchor="end" fontWeight="bold" style={textStyle}>AÁ∑ö</text> 
                         <text x={X(limitWL)} y={Y(10)} fontSize="10" fill="#000" textAnchor="start" fontWeight="bold" writingMode="tb" dx="2" style={textStyle}>BÁ∑ö</text> 
                         <text x={X(Math.min(maxX, 80))} y={Y(Math.min(maxX, 80)) - 5} fontSize="9" fill="#666" textAnchor="end" style={textStyle}>Ip = WL</text> 
                         <text x={X(5)} y={Y(6) - 2} fontSize="9" fill="#000" fontWeight="bold" style={textStyle}>Ip=6</text> 
                         
                         <text x={X(70)} y={Y(45)} fontSize="12" fill="#000" fontWeight="bold" textAnchor="middle" style={textStyle}>CH<tspan x={X(70)} dy="1.2em" fontSize="9" fontWeight="normal">Á≤òÂúü(È´ò)</tspan></text>
                         <text x={X(70)} y={Y(20)} fontSize="12" fill="#000" fontWeight="bold" textAnchor="middle" style={textStyle}>MH<tspan x={X(70)} dy="1.2em" fontSize="9" fontWeight="normal">„Ç∑„É´„Éà(È´ò)</tspan></text>
                         <text x={X(35)} y={Y(18)} fontSize="12" fill="#000" fontWeight="bold" textAnchor="middle" style={textStyle}>CL<tspan x={X(35)} dy="1.2em" fontSize="9" fontWeight="normal">Á≤òÂúü(‰Ωé)</tspan></text>
                         <text x={X(35)} y={Y(6)} fontSize="12" fill="#000" fontWeight="bold" textAnchor="middle" style={textStyle}>ML<tspan x={X(35)} dy="1.2em" fontSize="9" fontWeight="normal">„Ç∑„É´„Éà(‰Ωé)</tspan></text>
                    </>
                );
            };
            
            // --- ÊπøÊΩ§ÂØÜÂ∫¶-Âê´Ê∞¥ÊØî (ÂâçÈù¢ÊñáÂ≠ó‰øÆÊ≠£: "‰∏ÄËà¨ÂÄ§"„ÅåÂàá„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´‰ΩçÁΩÆË™øÊï¥) ---
            const drawRhoCurveBackground = (xScale, yScale, minX, maxX, minY, maxY) => { 
                let d = ""; const step = (maxX - minX) / 100; let isFirst = true; 
                const startX = Math.max(minX, 1); 
                for (let x = startX; x <= maxX; x += step) { 
                    let y; if (x <= 280) y = -0.828 * Math.log10(x) + 3.126; else y = -0.000208 * x + 1.167; 
                    const px = xScale(x); const py = yScale(y); 
                    if (isFirst) { d += `M ${px} ${py}`; isFirst = false; } else { d += ` L ${px} ${py}`; } 
                } 
                return <path d={d} fill="none" stroke="#047857" strokeWidth="2" strokeDasharray="4 2" />;
            };
            const drawRhoCurveForeground = (xScale, yScale, minX, maxX, minY, maxY) => {
                // maxX (100) ‰ªòËøë„Å†„Å® textAnchor="middle" „ÅßÂè≥ÂÅ¥„ÅåÂàá„Çå„Çã„Åü„ÇÅ„ÄÅ‰ΩçÁΩÆ„ÇíÂ∞ë„ÅóÂÜÖÂÅ¥„Å´„Åô„Çã„Åã„ÄÅAnchor„ÇíË™øÊï¥
                const labelX = Math.min(maxX, 100);
                const labelY = -0.828*Math.log10(labelX)+3.126;
                // Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ„ÉÅ„Çß„ÉÉ„ÇØ
                if (labelY < minY || labelY > maxY) return null;

                return (
                    <text x={xScale(labelX)} y={yScale(labelY) - 10} fontSize="10" fill="#047857" textAnchor="end" dx="-5" fontWeight="bold" style={{textShadow: '0px 0px 2px white'}}>‰∏ÄËà¨ÂÄ§</text>
                );
            };

            // --- Wn - WL (Â§âÊõ¥„Å™„Åó„ÉªÁµ±Âêà) ---
            const drawWnWlOverlay = (xScale, yScale, minX, maxX, minY, maxY) => { 
                return (<><line x1={xScale(0)} y1={yScale(0)} x2={xScale(Math.max(maxX, maxY))} y2={yScale(Math.max(maxX, maxY))} stroke="#000" strokeWidth="2" /><text x={xScale(minX) + 10} y={yScale(maxY) + 20} fontSize="10" fill="#000" fontWeight="bold">‰∏çÂÆâÂÆöÈ†òÂüü (Wn‚âßWL)</text><text x={xScale(maxX) - 10} y={yScale(minY) - 10} fontSize="10" fill="#000" fontWeight="bold" textAnchor="end">ÂÆâÂÆöÈ†òÂüü (WnÔºúWL)</text></>); 
            };
            
            // --- Cc - WL (Â§âÊõ¥„Å™„Åó„ÉªÁµ±Âêà) ---
            const drawCcWlOverlay = (xScale, yScale, minX, maxX, minY, maxY) => { 
                const y1_start = 0.015 * (minX - 19); const y1_end = 0.015 * (maxX - 19); 
                const y2_start = 0.009 * (minX - 10); const y2_end = 0.009 * (maxX - 10); 
                return (<><line x1={xScale(minX)} y1={yScale(y1_start)} x2={xScale(maxX)} y2={yScale(y1_end)} stroke="#000" strokeWidth="1.5" /><text x={xScale(maxX) - 5} y={yScale(y1_end) - 5} fontSize="9" textAnchor="end" fontWeight="bold" transform={`rotate(-15, ${xScale(maxX)-5}, ${yScale(y1_end)-5})`}>Cc=0.015(wL-19)</text><line x1={xScale(minX)} y1={yScale(y2_start)} x2={xScale(maxX)} y2={yScale(y2_end)} stroke="#000" strokeWidth="1.5" strokeDasharray="4 2"/><text x={xScale(maxX) - 5} y={yScale(y2_end) - 5} fontSize="9" textAnchor="end" fontWeight="bold" transform={`rotate(-10, ${xScale(maxX)-5}, ${yScale(y2_end)-5})`}>Cc=0.009(wL-10)</text></>); 
            };
            
            // --- Ks Formula (Ks) ---
            const drawKsFormula = (xScale, yScale, minX, maxX, minY, maxY) => (<text x={xScale(maxX) - 10} y={yScale(minY) + 20} fontSize="11" textAnchor="end" fill="#854d0e" fontWeight="bold">Ks = 0.3441 (D<tspan baselineShift="sub" fontSize="8">20</tspan>)<tspan baselineShift="super" fontSize="8">2.2954</tspan></text>);
            
            // --- Consolidation Lines ---
            const getP0AtDepth = (depth) => {
                if (!consolidationParams || consolidationParams.length === 0) return null;
                if (depth <= consolidationParams[0].z) return consolidationParams[0].p0;
                const last = consolidationParams[consolidationParams.length - 1];
                if (depth >= last.z) return last.p0;
                const idx = consolidationParams.findIndex(p => p.z >= depth);
                if (idx === -1) return null;
                const p1 = consolidationParams[idx - 1];
                const p2 = consolidationParams[idx];
                const ratio = (depth - p1.z) / (p2.z - p1.z);
                return p1.p0 + (p2.p0 - p1.p0) * ratio;
            };
            const drawConsolidationLines = (xScale, yScale, minX, maxX, minY, maxY) => {
                if (consolidationParams.length === 0) return null;
                let dP0 = ""; let dTotal = ""; let isFirst = true;
                consolidationParams.forEach(pt => { if (pt.z >= minY && pt.z <= maxY) { const y = yScale(pt.z); const xP0 = xScale(pt.p0); const xTotal = xScale(pt.p0 + pt.dp); if (isFirst) { dP0 += `M ${xP0} ${y}`; dTotal += `M ${xTotal} ${y}`; isFirst = false; } else { dP0 += ` L ${xP0} ${y}`; dTotal += ` L ${xTotal} ${y}`; } } });
                return ( <><path d={dP0} fill="none" stroke="#6b7280" strokeWidth="2" strokeDasharray="5 3" /><text x={xScale(consolidationParams[consolidationParams.length-1]?.p0 || 0)} y={yScale(Math.min(maxY, consolidationParams[consolidationParams.length-1]?.z || 0)) - 5} fontSize="10" fill="#6b7280" textAnchor="end" fontWeight="bold">P0</text><path d={dTotal} fill="none" stroke="#ef4444" strokeWidth="2" strokeDasharray="5 3" /><text x={xScale((consolidationParams[consolidationParams.length-1]?.p0 || 0) + (consolidationParams[consolidationParams.length-1]?.dp || 0))} y={yScale(Math.min(maxY, consolidationParams[consolidationParams.length-1]?.z || 0)) - 5} fontSize="10" fill="#ef4444" textAnchor="start" fontWeight="bold">P0+ŒîP</text></> );
            };

            // --- OCR„Ç∞„É©„Éï (ÊñáÂ≠óÂàá„Çå‰øÆÊ≠£: Á∏¶Êõ∏„ÅçÂªÉÊ≠¢ ‚Üí Ê®™Êõ∏„Åç„Å∏Â§âÊõ¥) ---
            const drawOCRRegionsBackground = (xScale, yScale, minX, maxX, minY, maxY) => { 
                const Y_top = yScale(minY); const Y_bottom = yScale(maxY); 
                const x1 = xScale(1.0); const x2 = xScale(2.0); const x8 = xScale(8.0); const xMax = xScale(Math.max(maxX, 10)); 
                return ( <><rect x={xScale(minX)} y={Math.min(Y_top, Y_bottom)} width={x1 - xScale(minX)} height={Math.abs(Y_bottom - Y_top)} fill="#dbeafe" className="opacity-30" /><rect x={x1} y={Math.min(Y_top, Y_bottom)} width={Math.max(0, x2 - x1)} height={Math.abs(Y_bottom - Y_top)} fill="#ecfccb" className="opacity-30" /><rect x={x2} y={Math.min(Y_top, Y_bottom)} width={Math.max(0, x8 - x2)} height={Math.abs(Y_bottom - Y_top)} fill="#fef9c3" className="opacity-30" /><rect x={x8} y={Math.min(Y_top, Y_bottom)} width={Math.max(0, xMax - x8)} height={Math.abs(Y_bottom - Y_top)} fill="#fee2e2" className="opacity-30" /><line x1={x1} y1={Y_top} x2={x1} y2={Y_bottom} stroke="#000" strokeWidth="1" strokeDasharray="4 2" /><line x1={x2} y1={Y_top} x2={x2} y2={Y_bottom} stroke="#000" strokeWidth="1" strokeDasharray="4 2" /><line x1={x8} y1={Y_top} x2={x8} y2={Y_bottom} stroke="#000" strokeWidth="1" strokeDasharray="4 2" /></> ); 
            };
            const drawOCRRegionsForeground = (xScale, yScale, minX, maxX, minY, maxY) => {
                const Y_bottom = yScale(maxY);
                // Á∏¶Êõ∏„Åç(writingMode="tb")„Å†„Å®‰∏ãÁ´Ø„ÅåÂàá„Çå„Çã„Åü„ÇÅ„ÄÅÊ®™Êõ∏„Åç„ÅßÊû†ÂÜÖ„Å´Âèé„ÇÅ„Çã
                return (
                    <>
                    <text x={xScale(0.5)} y={Y_bottom - 10} fontSize="9" fill="#1e40af" textAnchor="middle" fontWeight="bold">Ê≠£Ë¶èÂúßÂØÜ</text>
                    <text x={xScale(1.5)} y={Y_bottom - 10} fontSize="9" fill="#3f6212" textAnchor="middle" fontWeight="bold">ËªΩ„ÅÑÈÅéÂúßÂØÜ</text>
                    <text x={xScale(4.0)} y={Y_bottom - 10} fontSize="9" fill="#854d0e" textAnchor="middle" fontWeight="bold">ÈÅéÂúßÂØÜ</text>
                    <text x={xScale(9.0)} y={Y_bottom - 10} fontSize="9" fill="#991b1b" textAnchor="middle" fontWeight="bold">Âº∑„ÅÑÈÅéÂúßÂØÜ</text>
                    </>
                );
            };

            // --- Pc - P0 (ÊñáÂ≠óÂàá„Çå‰øÆÊ≠£) ---
            const drawOverConsolidationLineBackground = (xScale, yScale, minX, maxX, minY, maxY) => { 
                const x0 = xScale(0); const Y_top = yScale(minY); const Y_bottom = yScale(maxY); 
                return ( <line x1={x0} y1={Y_top} x2={x0} y2={Y_bottom} stroke="#000" strokeWidth="1.5" /> ); 
            };
            const drawOverConsolidationLineForeground = (xScale, yScale, minX, maxX, minY, maxY) => { 
                const x0 = xScale(0); const Y_bottom = yScale(maxY); 
                // writingMode="tb" „Çí„ÇÑ„ÇÅ„Å¶Ê®™Êõ∏„Åç„ÄÅ„Åæ„Åü„ÅØ‰ΩçÁΩÆ„ÇíË™øÊï¥
                return ( <text x={x0 + 5} y={Y_bottom - 15} fontSize="10" fontWeight="bold">Pc = P0</text> ); 
            };

            const formatValue = (val, key) => {
                if (val === null || val === undefined || val === '-') return '-';
                if (key.includes('k_') || key.includes('est')) {
                    return Number(val).toExponential(2).toUpperCase();
                }
                const isSmallValue = Math.abs(val) < 0.001 && val !== 0;
                if (isSmallValue) return Number(val).toExponential(2).toUpperCase();
                
                if (PRECISION_MAP[key] !== undefined) {
                    return val.toFixed(PRECISION_MAP[key]);
                }

                return parseFloat(val.toFixed(3));
            };

            const getSingleAnalysisData = (targetKey) => {
                const colDef = COLUMN_DEFS.find(c => c.key === targetKey);
                if(!colDef) return { tableData: [], colDef: null };
                const tableData = statistics.map(stat => {
                    const vals = stat[targetKey];
                    return { soil: stat.soil, color: stat.color, n: vals.n, min: formatValue(vals.min, targetKey), max: formatValue(vals.max, targetKey), avg: formatValue(vals.avg, targetKey) };
                });
                return { tableData, colDef };
            };
            
            const { tableData: analysisTable, colDef: analysisColDef } = useMemo(() => getSingleAnalysisData(analysisTargetKey), [analysisTargetKey, statistics]);

            const multiAnalysisData = useMemo(() => {
                const cols = COLUMN_DEFS.filter(c => selectedMultiAnalysisCols.has(c.key));
                const groupMap = new Map();
                cols.forEach(c => { if(!groupMap.has(c.group)) groupMap.set(c.group, []); groupMap.get(c.group).push(c); });
                const groups = Array.from(groupMap.entries()).map(([name, columns]) => ({ name, columns }));
                return groups;
            }, [selectedMultiAnalysisCols]);

            const chunkArray = (array, size) => { const chunked = []; for (let i = 0; i < array.length; i += size) { chunked.push(array.slice(i, i + size)); } return chunked; };

            const handleContextMenu = (e, key, type) => {
                e.preventDefault();
                setContextMenu({ x: e.pageX, y: e.pageY, key, type });
            };

            const handleHideColumn = () => {
                if (!contextMenu) return;
                if (contextMenu.type === 'stats') {
                    setVisibleStatCols(prev => prev.filter(k => k !== contextMenu.key));
                } else if (contextMenu.type === 'multi') {
                    setSelectedMultiAnalysisCols(prev => {
                        const next = new Set(prev);
                        next.delete(contextMenu.key);
                        return next;
                    });
                }
                setContextMenu(null);
            };

            return (
                <div className="flex h-screen w-full bg-slate-50" onClick={() => setContextMenu(null)}>
                    <UnifiedSettingsModal 
                        isOpen={isUnifiedSettingsOpen} 
                        onClose={() => setIsUnifiedSettingsOpen(false)}
                        soilSettings={soilSettings} setSoilSettings={setSoilSettings} allDataSoilTypes={allDataSoilTypes}
                        boringList={availableBorings} boringSettings={boringSettings} setBoringSettings={setBoringSettings}
                        classMap={soilClassMap} setClassMap={setSoilClassMap}
                    />
                    <ConsolidationParamsModal isOpen={isConsolidationModalOpen} onClose={() => setIsConsolidationModalOpen(false)} params={consolidationParams} setParams={setConsolidationParams} />
                    <HelpModal isOpen={isHelpOpen} onClose={() => setIsHelpOpen(false)} />
                    <div className="w-64 bg-slate-800 flex-shrink-0 flex flex-col text-white shadow-xl z-[100] no-print">
                        <div className="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-start">
                            <div>
                                <h1 className="font-bold text-lg">ÂúüË≥™Ë©¶È®ìÊï¥ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                            </div>
                            <button onClick={() => setIsHelpOpen(true)} className="text-slate-400 hover:text-white border border-slate-600 hover:border-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold transition-all" title="„Éò„É´„Éó / ‰Ωø„ÅÑÊñπ">?</button>
                        </div>
                        <div className="p-2 space-y-1">
                            <button onClick={() => setActiveTab('input')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'input' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìù „Éá„Éº„ÇøÂÖ•Âäõ</button>
                            <button onClick={() => setActiveTab('stats')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'stats' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìä Âú∞Â±§Âà•Áµ±Ë®à‰∏ÄË¶ß</button>
                            <button onClick={() => setActiveTab('graph')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'graph' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìà Ê∑±Â∫¶„ÉªÊ®ôÈ´ò„Ç∞„É©„Éï</button>
                            <button onClick={() => setActiveTab('multi_analysis')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'multi_analysis' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìë Ë©¶È®ìÂà•Áµ±Ë®à‰∏ÄË¶ß</button>
                            <button onClick={() => setActiveTab('analysis')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'analysis' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìã Ë©¶È®ìÂà•‰∏ÄË¶ßÔºã„Ç∞„É©„Éï</button>
                            <button onClick={() => setActiveTab('correlation')} className={`w-full text-left px-4 py-2 rounded text-sm font-bold transition-all ${activeTab === 'correlation' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}>üìâ Áõ∏Èñ¢Èñ¢‰øÇÂõ≥</button>
                        </div>
                        <div className="px-2 py-2 border-t border-slate-700 mt-2"><h3 className="text-[10px] font-bold text-slate-400 uppercase px-2 mb-1">üíæ ‰øùÂ≠ò / Ë™≠Ëæº</h3><div className="flex gap-2 px-2"><button onClick={handleSaveFile} className="flex-1 bg-emerald-700 hover:bg-emerald-600 text-white text-xs py-1 rounded border border-emerald-600">‰øùÂ≠ò</button><button onClick={handleLoadFileClick} className="flex-1 bg-amber-700 hover:bg-amber-600 text-white text-xs py-1 rounded border border-amber-600">Ë™≠Ëæº</button><input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" /></div></div>
                        <div className="px-4 py-2 mt-auto space-y-2">
                            <button onClick={() => setIsUnifiedSettingsOpen(true)} className="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm font-bold text-gray-200 border border-slate-600 flex items-center gap-2 shadow-md hover:text-white transition-colors"><span className="text-xl">‚öô</span><span>Ë®≠ÂÆö (Âá°‰æã„ÉªÊ®ôÈ´ò„ÉªÂÆöÁæ©)</span></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6 border-t border-slate-700"><div><div className="flex justify-between items-end mb-2"><h3 className="text-xs font-bold text-slate-300 uppercase">Â≠îÁï™„Éï„Ç£„É´„Çø</h3><div className="flex gap-2 text-[10px]"><button onClick={() => setSelectedBorings(new Set(availableBorings))} className="text-blue-400 hover:text-blue-300">ÂÖ®ÈÅ∏Êäû</button><button onClick={() => setSelectedBorings(new Set())} className="text-blue-400 hover:text-blue-300">ÂÖ®Ëß£Èô§</button></div></div><div className="space-y-1 bg-slate-900/50 p-2 rounded border border-slate-700 max-h-40 overflow-y-auto">{availableBorings.map(b => (<label key={b} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-700 p-1 rounded"><input type="checkbox" checked={selectedBorings.has(b)} onChange={() => toggleFilter(selectedBorings, setSelectedBorings, b)} className="rounded text-blue-500 bg-slate-800 border-slate-600" /><span className="text-xs">{b}</span></label>))}</div></div><div><div className="flex justify-between items-end mb-2"><h3 className="text-xs font-bold text-slate-300 uppercase">ÂúüÂ±§„Éï„Ç£„É´„Çø</h3><div className="flex gap-2 text-[10px]"><button onClick={() => setSelectedSoils(new Set(availableSoils))} className="text-blue-400 hover:text-blue-300">ÂÖ®ÈÅ∏Êäû</button><button onClick={() => setSelectedSoils(new Set())} className="text-blue-400 hover:text-blue-300">ÂÖ®Ëß£Èô§</button></div></div><div className="space-y-1 bg-slate-900/50 p-2 rounded border border-slate-700 max-h-40 overflow-y-auto">{availableSoils.map(s => { const setting = soilSettings.find(set => set.name === s); const color = setting?.color || '#ccc'; if(setting && setting.visible===false) return null; return (<label key={s} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-700 p-1 rounded"><input type="checkbox" checked={selectedSoils.has(s)} onChange={() => toggleFilter(selectedSoils, setSelectedSoils, s)} className="rounded text-blue-500 bg-slate-800 border-slate-600" /><span className="w-2 h-2 rounded-full" style={{backgroundColor: color}}></span><span className="text-xs">{s}</span></label>); })}</div></div></div>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden relative print:overflow-visible print:h-auto print:block">
                        <div className="flex-1 overflow-hidden relative flex flex-col">
                            {activeTab === 'input' && (
                                <div className="flex flex-col h-full">
                                    <div className="p-2 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-[60] no-print">
                                        <div className="flex items-center gap-4"><h2 className="font-bold text-gray-700 text-sm">„Éá„Éº„ÇøÂÖ•Âäõ‰∏ÄË¶ß (Ëá™Âãï‰øùÂ≠òÊúâÂäπ)</h2><button onClick={addRow} className="bg-blue-600 text-white px-3 py-1 rounded shadow text-xs font-bold hover:bg-blue-700">+ Ë°åËøΩÂä†</button>
<button onClick={deleteAllData} className="bg-red-600 text-white px-3 py-1 rounded shadow text-xs font-bold hover:bg-red-700 ml-2">üóëÔ∏è ÂÖ®ÂâäÈô§</button><button onClick={downloadTemplate} className="bg-green-600 text-white px-3 py-1 rounded shadow text-xs font-bold hover:bg-green-700 flex items-center gap-1">üì• ExcelÂÖ•ÂäõÁî®Êû†‰ΩúÊàê</button><label className="flex items-center gap-2 cursor-pointer bg-slate-100 px-3 py-1 rounded border border-gray-300 hover:bg-slate-200"><input type="checkbox" checked={showDetailCols} onChange={(e) => setShowDetailCols(e.target.checked)} className="rounded text-blue-600" /><span className="text-xs font-bold text-slate-700">üìù Ë©≥Á¥∞Âàó„ÇíË°®Á§∫</span></label><div className="flex items-center gap-2 bg-gray-50 border border-gray-300 rounded px-2 py-0.5"><span className="text-xs font-bold text-gray-600">ÊñáÂ≠ó:</span><input type="range" min="9" max="16" step="1" value={inputTableFontSize} onChange={(e) => setInputTableFontSize(Number(e.target.value))} className="w-16" /></div></div>
                                        <div className="flex items-center gap-2 bg-gray-100 p-1 rounded border border-gray-300"><button onClick={() => setIsViewMode(true)} className={`px-3 py-1 text-xs rounded font-bold transition-colors ${isViewMode ? 'bg-indigo-600 text-white shadow' : 'text-gray-600 hover:bg-gray-200'}`}>üëÅÔ∏è Èñ≤Ë¶ß„É¢„Éº„Éâ</button><button onClick={() => setIsViewMode(false)} className={`px-3 py-1 text-xs rounded font-bold transition-colors ${!isViewMode ? 'bg-blue-600 text-white shadow' : 'text-gray-600 hover:bg-gray-200'}`}>‚úèÔ∏è Á∑®ÈõÜ„É¢„Éº„Éâ</button></div>
                                    </div>
                                    <div className="flex-1 overflow-auto bg-white relative">
                                        <table className="border-collapse text-xs w-max">
                                            <thead className="bg-slate-900 text-white">
                                                <tr className="h-8 sticky top-0 z-[50]"><th className="p-0 bg-slate-900 sticky left-0 z-[60] w-[30px] border-b border-slate-700"></th>{headerRows.map((group, gIdx) => { let leftPos = 'auto'; let zIndex = 50; if(group.fixed) { leftPos = '30px'; zIndex = 60; } return (<th key={gIdx} colSpan={group.cols.length} className={`py-1 px-2 border-r border-b border-slate-600 font-bold text-center text-[11px] ${group.fixed ? 'sticky bg-slate-900' : 'bg-slate-900'}`} style={{ left: leftPos, zIndex: zIndex, fontSize: `${inputTableFontSize}px` }}>{group.label}</th>); })}</tr>
                                                <tr className="sticky top-8 z-[40]"><th className="p-1 border border-slate-700 bg-slate-800 sticky left-0 z-[60] w-[30px]"></th>{visibleColumns.map((col) => { let leftPos = 'auto'; let zIndex = 40; if (col.fixed) { if (col.key === 'boring') leftPos = 30; else if (col.key === 'sample_no') leftPos = 90; else if (col.key === 'depth_top') leftPos = 140; else if (col.key === 'depth_bottom') leftPos = 190; else if (col.key === 'soilType') leftPos = 240; zIndex = 60; } const isDetail = col.detail; const isCalc = col.calc; return (<th key={col.key} className={`px-1 py-1 border border-slate-700 font-normal ${col.fixed ? 'sticky bg-slate-800 border-r-2 border-slate-500' : isDetail ? 'bg-slate-800' : isCalc ? 'bg-slate-800 text-yellow-100' : 'bg-slate-800'}`} style={{ width: col.width, minWidth: col.width, left: leftPos, zIndex: zIndex }}><div className="flex flex-col items-center justify-center"><span className="font-bold text-[10px]" style={{ fontSize: `${inputTableFontSize}px` }}>{col.label.split(' ')[0]}</span><span className="font-mono text-yellow-200 text-[9px]">{col.label.split(' ')[1] || ''}</span><span className="text-[9px] text-slate-400 mt-0.5">{col.unit}</span></div></th>) })}</tr>
                                            </thead>
                                            <tbody>
                                                {filteredData.map((row, rIdx) => { 
                                                    const rowBg = rIdx % 2 === 0 ? '#ffffff' : '#f9fafb'; 
                                                    const rowClass = rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'; 
                                                    return (<tr key={row.id} className={`${rowClass} hover:bg-blue-50 transition-colors`}><td className="p-0 border border-gray-300 text-center sticky left-0 z-[35] border-r border-r-gray-400" style={{backgroundColor: rowBg}}>{!isViewMode && <button onClick={() => deleteRow(row.id)} className="text-red-400 hover:text-red-600 font-bold px-1">√ó</button>}</td>{visibleColumns.map((col, cIdx) => { 
                                                        let leftPos = 'auto'; let zIndex = 'auto'; let stickyStyle = {}; if (col.fixed) { if (col.key === 'boring') leftPos = 30; else if (col.key === 'sample_no') leftPos = 90; else if (col.key === 'depth_top') leftPos = 140; else if (col.key === 'depth_bottom') leftPos = 190; else if (col.key === 'soilType') leftPos = 240; zIndex = 30; stickyStyle = { position: 'sticky', left: leftPos, zIndex: zIndex, backgroundColor: rowBg, borderRight: col.key === 'soilType' ? '2px solid #94a3b8' : '1px solid #cbd5e1' }; } 
                                                        const cellValue = row[col.key]; const isDetail = col.detail; const isCalc = col.calc; 
                                                        
                                                        let initialVal = cellValue;
                                                        if (col.key === 'k_est' && cellValue !== null && !isNaN(cellValue)) {
                                                            initialVal = Number(cellValue).toExponential(2).toUpperCase();
                                                        }

                                                        return (<td key={col.key} className={`p-0 border border-gray-300 ${isViewMode ? 'selectable-cell px-1 text-right align-middle' : ''} ${isDetail ? 'bg-detail-col' : isCalc ? 'bg-calc-col' : ''}`} style={stickyStyle}>{isViewMode ? ( <span className="block w-full h-full overflow-hidden whitespace-nowrap text-dark" style={{fontSize: `${inputTableFontSize}px`, lineHeight: '26px'}}>{initialVal ?? ''}</span> ) : ( 
                                                            <EditableCell 
                                                                rowId={row.id} 
                                                                colKey={col.key} 
                                                                initialValue={initialVal} 
                                                                onUpdate={updateRow} 
                                                                onPaste={handlePaste}
                                                                rowIndex={rIdx}
                                                                colIndex={cIdx}
                                                                isDetail={isDetail}
                                                                isCalc={isCalc}
                                                                type={col.type}
                                                                readOnly={col.key === 'class_name'}
                                                                fontSize={inputTableFontSize}
                                                            />
                                                        )}</td>); 
                                                    })}</tr>); 
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'stats' && (
                                <div className="h-full overflow-auto p-4 bg-white relative" onClick={() => isStatMenuOpen && setIsStatMenuOpen(false)}>
                                    <div className="flex justify-between items-center mb-4 border-l-4 border-blue-600 pl-2 no-print"><h2 className="text-sm font-bold text-gray-700">Áµ±Ë®àÂá¶ÁêÜÁµêÊûú</h2><div className="flex gap-2 items-center"><button onClick={expandAllStats} className="bg-white border border-gray-300 text-gray-600 px-2 py-1.5 rounded hover:bg-gray-50 text-[10px] font-bold">‚ñº ÂÖ®„Å¶Èñã„Åè</button><button onClick={collapseAllStats} className="bg-white border border-gray-300 text-gray-600 px-2 py-1.5 rounded hover:bg-gray-50 text-[10px] font-bold mr-2">‚ñ∂ ÂÖ®„Å¶Èñâ„Åò„Çã</button><div className="flex items-center gap-2 bg-gray-50 border border-gray-300 rounded px-2 py-0.5 mr-2"><span className="text-xs font-bold text-gray-600">ÊñáÂ≠ó:</span><input type="range" min="9" max="16" step="1" value={statsTableFontSize} onChange={(e) => setStatsTableFontSize(Number(e.target.value))} className="w-16" /></div><div className="relative" onClick={e => e.stopPropagation()}><button onClick={() => setIsStatMenuOpen(!isStatMenuOpen)} className="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded shadow hover:bg-gray-50 font-bold text-xs flex items-center gap-1">üëÅÔ∏è Ë°®Á§∫È†ÖÁõÆË®≠ÂÆö {visibleStatCols.length !== COLUMN_DEFS.filter(c=>c.type==='number').length && <span className="w-2 h-2 bg-red-500 rounded-full"></span>}</button>{isStatMenuOpen && (<div className="absolute right-0 top-8 w-64 bg-white border border-gray-300 shadow-xl rounded z-[100] p-3 text-xs"><div className="flex justify-between border-b pb-2 mb-2"><span className="font-bold">Ë°®Á§∫„Åô„ÇãÂàó„ÇíÈÅ∏Êäû</span><button onClick={() => setIsStatMenuOpen(false)} className="text-gray-400">√ó</button></div><div className="max-h-[300px] overflow-y-auto space-y-3">{[...new Set(COLUMN_DEFS.filter(c => c.type === 'number').map(c => c.group))].map(group => { const groupCols = COLUMN_DEFS.filter(c => c.type === 'number' && c.group === group); return (<div key={group}><div className="font-bold text-slate-500 bg-slate-100 px-1 mb-1">{group}</div><div className="grid grid-cols-2 gap-1">{groupCols.map(col => (<label key={col.key} className="flex items-center gap-1 cursor-pointer hover:bg-blue-50 p-0.5 rounded"><input type="checkbox" checked={visibleStatCols.includes(col.key)} onChange={(e) => { if(e.target.checked) setVisibleStatCols([...visibleStatCols, col.key]); else setVisibleStatCols(visibleStatCols.filter(k => k !== col.key)); }} className="rounded text-blue-600" /><span>{col.label.split(' ')[0]} <span className="text-[9px] text-gray-400">({col.label.split(' ')[1] || ''})</span></span></label>))}</div></div>); })}</div></div>)}</div><div className="flex items-center gap-2 bg-slate-100 px-2 rounded border border-gray-200"><label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={printWithBreakdown} onChange={e=>setPrintWithBreakdown(e.target.checked)} className="rounded text-blue-600" /><span className="text-[10px] font-bold text-gray-600">ÂÜÖË®≥„ÇÇÂç∞Âà∑</span></label><div className="flex items-center gap-1 ml-2 border-l pl-2 border-gray-300"><span className="text-[10px] font-bold text-gray-600">Âç∞Âà∑ÂàóÊï∞/È†Å:</span><input type="number" value={statsPrintColLimit} onChange={(e) => setStatsPrintColLimit(Math.max(1, parseInt(e.target.value)))} className="w-12 text-xs border rounded px-1 text-right" min="1" /></div><button onClick={handlePrintReport} className="bg-slate-700 text-white px-3 py-1.5 rounded shadow hover:bg-slate-600 font-bold text-xs flex items-center gap-1">üñ®Ô∏è Âç∞Âà∑</button></div></div></div>
                                    <div className="screen-table-container mb-20"><table className="border-collapse text-xs w-max"><thead className="sticky top-0 z-30 bg-slate-700 text-white"><tr className="h-8"><th className="p-2 border border-slate-600 sticky left-0 top-0 z-[60] bg-slate-700 w-[80px] min-w-[80px]" rowSpan={2} style={{fontSize: `${statsTableFontSize}px`}}>ÂúüË≥™</th><th className="p-2 border border-slate-600 sticky left-[80px] top-0 z-[60] bg-slate-700 w-[80px] min-w-[80px]" rowSpan={2} style={{fontSize: `${statsTableFontSize}px`}}>È†ÖÁõÆ</th>{statHeaderRows.map((group, gIdx) => { const visibleCount = group.cols.filter(c => visibleStatCols.includes(c.key)).length; if (visibleCount === 0) return null; return (<th key={gIdx} colSpan={visibleCount} className="py-1 px-2 border border-slate-600 font-bold text-center text-[11px] bg-slate-700 sticky top-0 z-40" style={{fontSize: `${statsTableFontSize}px`}}>{group.label}</th>); })}</tr><tr className="h-8">{COLUMN_DEFS.filter(c => c.type === 'number' && visibleStatCols.includes(c.key)).map(col => (<th key={col.key} className="px-2 py-1 border border-slate-600 min-w-[80px] whitespace-nowrap bg-slate-700 sticky top-8 z-40 cursor-context-menu" onContextMenu={(e) => handleContextMenu(e, col.key, 'stats')}><div>{col.label.split(' ')[0]}</div><div className="font-mono text-yellow-200 text-[9px]">{col.label.split(' ')[1] || ''}</div><div className="text-[9px] opacity-70">{col.unit ? `(${col.unit})` : ''}</div></th>))}</tr></thead><tbody>{statistics.map((stat, idx) => (<React.Fragment key={stat.soil}><tr className="bg-gray-200 border-t-2 border-gray-400"><td colSpan={2} className="p-1 text-left sticky left-0 z-20 bg-gray-200 border-r border-gray-300 w-[160px] min-w-[160px] align-middle"><button onClick={() => setStatsExpanded(prev => ({...prev, [stat.soil]: !prev[stat.soil]}))} className="text-blue-700 hover:text-blue-900 font-bold flex items-center gap-1 text-[11px] ml-1 w-full text-left whitespace-nowrap" style={{fontSize: `${statsTableFontSize}px`}}>{statsExpanded[stat.soil] ? '‚ñº' : '‚ñ∂'} {stat.soil} „ÅÆ„Éá„Éº„ÇøÂÜÖË®≥ ({stat.rawRows.length}‰ª∂)</button></td><td colSpan={visibleStatCols.length} className="bg-gray-200"></td></tr>{statsExpanded[stat.soil] && (<><tr className="bg-blue-100 text-blue-900 font-bold"><td className="px-2 py-1 border border-gray-300 sticky left-0 z-[30] bg-blue-100 border-r border-gray-400 w-[80px] min-w-[80px]" style={{fontSize: `${statsTableFontSize}px`}}>Â≠îÁï™</td><td className="px-2 py-1 border border-gray-300 sticky left-[80px] z-[30] bg-blue-100 border-r border-gray-400 w-[80px] min-w-[80px]" style={{fontSize: `${statsTableFontSize}px`}}>Ë©¶ÊñôNo</td>{COLUMN_DEFS.filter(c => c.type === 'number' && visibleStatCols.includes(c.key)).map(c => (<td key={c.key} className="px-2 py-1 border border-gray-300 text-center text-[9px] opacity-50">‚Üì</td>))}</tr>{stat.rawRows.map(r => (<tr key={r.id} className="bg-white hover:bg-yellow-50 text-gray-600"><td className="px-2 py-1 border border-gray-300 sticky left-0 z-[30] bg-slate-50 border-r border-gray-400 font-medium w-[80px] min-w-[80px]" style={{fontSize: `${statsTableFontSize}px`}}>{r.boring}</td><td className="px-2 py-1 border border-gray-300 sticky left-[80px] z-[30] bg-slate-50 border-r border-gray-400 text-center w-[80px] min-w-[80px]" style={{fontSize: `${statsTableFontSize}px`}}>{r.sample_no}</td>{COLUMN_DEFS.filter(c => c.type === 'number' && visibleStatCols.includes(c.key)).map(c => { let val = r[c.key]; if(c.key==='k_est' && val!=null) val = Number(val).toExponential(2).toUpperCase(); return (<td key={c.key} className="px-2 py-1 border border-gray-300 text-right" style={{fontSize: `${statsTableFontSize}px`}}>{val}</td>)})}</tr>))}</>)}{['ÂÄãÊï∞', 'ÊúÄÂ∞èÂÄ§', 'ÊúÄÂ§ßÂÄ§', 'Áõ∏Âä†Âπ≥Âùá', 'Áõ∏‰πóÂπ≥Âùá'].map((type, tIdx) => { const keys = { 'ÂÄãÊï∞':'n', 'ÊúÄÂ∞èÂÄ§':'min', 'ÊúÄÂ§ßÂÄ§':'max', 'Áõ∏Âä†Âπ≥Âùá':'avg', 'Áõ∏‰πóÂπ≥Âùá':'geo' }; const key = keys[type]; return (<tr key={`${stat.soil}-${type}`} className={`${tIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50'} hover:bg-yellow-50`}>{tIdx === 0 && (<td rowSpan={5} className="p-1 border border-gray-400 font-bold text-center align-middle sticky left-0 z-[30] border-r border-r-gray-500 text-white shadow-sm w-[80px] min-w-[80px]" style={{backgroundColor: stat.color}}><span className="drop-shadow-md" style={{textShadow: '0 1px 2px rgba(0,0,0,0.8)', fontSize: `${statsTableFontSize}px`}}>{stat.soil}</span></td>)}<td className="p-1 border border-gray-400 font-bold text-gray-700 sticky left-[80px] z-[30] border-r border-r-gray-500 text-right w-[80px] min-w-[80px] bg-gray-100" style={{fontSize: `${statsTableFontSize}px`}}>{type}</td>{COLUMN_DEFS.filter(c => c.type === 'number' && visibleStatCols.includes(c.key)).map(col => (<td key={col.key} className="px-2 py-1 border border-gray-400 text-right text-dark font-medium" style={{fontSize: `${statsTableFontSize}px`}}>{formatValue(stat[col.key][key], col.key)}</td>))}</tr>); })}</React.Fragment>))}</tbody></table></div>
                                    <div className="print-table-container">{chunkArray(COLUMN_DEFS.filter(c => c.type === 'number' && visibleStatCols.includes(c.key)), statsPrintColLimit).map((colChunk, chunkIndex, allChunks) => (<div key={chunkIndex} className="print-break-before mb-4 w-auto inline-block"><div className="font-bold text-sm mb-2">Áµ±Ë®àÂá¶ÁêÜÁµêÊûú ({chunkIndex + 1}/{allChunks.length})</div><table className="border-collapse border border-black text-xs w-auto"><thead><tr><th className="border border-black p-1 bg-gray-200 w-[80px]" rowSpan={2}>ÂúüË≥™</th><th className="border border-black p-1 bg-gray-200 w-[80px]" rowSpan={2}>È†ÖÁõÆ</th>{colChunk.map(col => (<th key={col.key} className="border border-black p-1 bg-gray-200"><div>{col.label.split(' ')[0]}</div><div className="text-[9px] font-normal">{col.unit ? `(${col.unit})` : ''}</div></th>))}</tr><tr>{colChunk.map(col => <th key={col.key} className="border border-black p-1 bg-gray-100 text-[9px]">{col.label.split(' ')[1]}</th>)}</tr></thead><tbody>{statistics.map(stat => (<React.Fragment key={stat.soil}>{printWithBreakdown && (<><tr className="bg-gray-100 border-t-2 border-black"><td colSpan={colChunk.length+2} className="border border-black font-bold p-1 text-left">‚ñº {stat.soil} ÂÜÖË®≥</td></tr>{stat.rawRows.map(r => (<tr key={r.id}><td className="border border-black p-1 text-center">{r.boring}</td><td className="border border-black p-1 text-center">{r.sample_no}</td><td className="border border-black p-1 text-center">{r.depth_top}</td>{colChunk.map(c => {let val = r[c.key]; if(c.key==='k_est' && val!=null) val = Number(val).toExponential(2).toUpperCase(); return (<td key={c.key} className="border border-black p-1 text-right">{val}</td>)})}</tr>))}</>)}{['ÂÄãÊï∞', 'ÊúÄÂ∞èÂÄ§', 'ÊúÄÂ§ßÂÄ§', 'Áõ∏Âä†Âπ≥Âùá', 'Áõ∏‰πóÂπ≥Âùá'].map((type, tIdx) => { const keys = { 'ÂÄãÊï∞':'n', 'ÊúÄÂ∞èÂÄ§':'min', 'ÊúÄÂ§ßÂÄ§':'max', 'Áõ∏Âä†Âπ≥Âùá':'avg', 'Áõ∏‰πóÂπ≥Âùá':'geo' }; const key = keys[type]; return (<tr key={`${stat.soil}-${type}`}>{tIdx === 0 && <td rowSpan={5} className="border border-black font-bold text-center align-middle" style={{backgroundColor: stat.color, color: 'white', textShadow: '0 1px 1px black'}}>{stat.soil}</td>}<td className="border border-black p-1 bg-gray-50 text-right">{type}</td>{colChunk.map(col => <td key={col.key} className="border border-black p-1 text-right">{formatValue(stat[col.key][key], col.key)}</td>)}</tr>); })}</React.Fragment>))}</tbody></table></div>))}</div>
                                </div>
                            )}
                            {activeTab === 'graph' && (
                                <div className="h-full flex flex-col">
                                    <div className="bg-white border-b border-gray-300 shadow-sm text-xs flex flex-col no-print">
                                        <div className="flex items-stretch p-2 bg-slate-50 border-b border-gray-200 overflow-x-auto gap-2">
                                            <div className="flex flex-col gap-1 pr-3 border-r border-gray-300 min-w-[140px]">
                                                <span className="font-bold text-gray-500 text-[10px] uppercase">„Ç∑„Çπ„ÉÜ„É†</span>
                                                <div className="grid grid-cols-2 gap-1">
                                                     <button onClick={handleSaveGraphSettings} className="bg-white border border-gray-300 text-gray-600 hover:text-blue-600 px-2 py-1 rounded text-[10px] font-bold shadow-sm whitespace-nowrap text-left">üíæ Ë®≠ÂÆö‰øùÂ≠ò</button>
                                                     <button onClick={() => graphSettingsInputRef.current.click()} className="bg-white border border-gray-300 text-gray-600 hover:text-blue-600 px-2 py-1 rounded text-[10px] font-bold shadow-sm whitespace-nowrap text-left">üìÇ Ë™≠Ëæº</button>
                                                     <input type="file" ref={graphSettingsInputRef} onChange={handleLoadGraphSettingsChange} accept=".json" className="hidden" />
                                                </div>
                                                <div className="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded border border-blue-100 mt-auto">
                                                    <span className="text-[10px] whitespace-nowrap">ÂàóÊï∞:</span>
                                                    <input type="number" value={printGraphsPerRow} onChange={(e)=>setPrintGraphsPerRow(Math.max(1, Number(e.target.value)))} className="w-8 text-right border p-0.5 rounded text-[10px]" />
                                                    <button onClick={handlePrintReport} className="ml-auto bg-slate-700 text-white px-2 py-0.5 rounded shadow text-[10px] font-bold hover:bg-slate-800">üñ®Ô∏è Âç∞Âà∑</button>
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-1 pr-3 border-r border-gray-300 min-w-[200px]">
                                                <span className="font-bold text-gray-500 text-[10px] uppercase">Ëª∏„ÉªÁØÑÂõ≤Ë®≠ÂÆö</span>
                                                <div className="flex bg-white rounded border border-gray-300 overflow-hidden mb-1 w-fit">
                                                    <button onClick={()=>setVerticalAxisMode('depth')} className={`px-3 py-1 text-[10px] font-bold transition-colors ${verticalAxisMode==='depth' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}>Ê∑±Â∫¶ (Depth)</button>
                                                    <button onClick={()=>setVerticalAxisMode('elevation')} className={`px-3 py-1 text-[10px] font-bold transition-colors ${verticalAxisMode==='elevation' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}>Ê®ôÈ´ò (Elev)</button>
                                                </div>
                                                {verticalAxisMode === 'depth' ? (
                                                    <div className="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded border border-blue-200">
                                                        <span className="text-[10px] font-bold text-blue-800">Ê∑±Â∫¶YËª∏:</span>
                                                        <input type="number" placeholder="Min" value={depthYScale.min} onChange={e=>setDepthYScale({...depthYScale, min: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" />
                                                        <span className="text-gray-400">~</span>
                                                        <input type="number" placeholder="Max" value={depthYScale.max} onChange={e=>setDepthYScale({...depthYScale, max: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" />
                                                        <span className="text-gray-400 text-[9px] mx-0.5">/</span>
                                                        <input type="number" placeholder="Step" value={depthYScale.step} onChange={e=>setDepthYScale({...depthYScale, step: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" title="ÁõÆÁõõÈñìÈöî" />
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-1 bg-indigo-50 px-2 py-1 rounded border border-indigo-200">
                                                        <span className="text-[10px] font-bold text-indigo-800">Ê®ôÈ´òYËª∏:</span>
                                                        <input type="number" placeholder="Min" value={elevationYScale.min} onChange={e=>setElevationYScale({...elevationYScale, min: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" />
                                                        <span className="text-gray-400">~</span>
                                                        <input type="number" placeholder="Max" value={elevationYScale.max} onChange={e=>setElevationYScale({...elevationYScale, max: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" />
                                                        <span className="text-gray-400 text-[9px] mx-0.5">/</span>
                                                        <input type="number" placeholder="Step" value={elevationYScale.step} onChange={e=>setElevationYScale({...elevationYScale, step: e.target.value})} className="w-10 text-right border p-1 rounded text-[10px]" title="ÁõÆÁõõÈñìÈöî" />
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex flex-col gap-1 flex-1 min-w-[400px]">
                                                <span className="font-bold text-gray-500 text-[10px] uppercase">„Ç∞„É©„Éï„Çπ„Çø„Ç§„É´</span>
                                                <div className="grid grid-cols-2 gap-x-6 gap-y-0">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] text-gray-600 w-8 text-right">ÂπÖ:</span>
                                                        <input type="range" min="100" max="600" step="10" value={globalGraphWidth} onChange={(e)=>setGlobalGraphWidth(Number(e.target.value))} className="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                                        <input type="number" value={globalGraphWidth} onChange={(e)=>setGlobalGraphWidth(Number(e.target.value))} className="w-10 text-right border p-0.5 rounded text-[10px]" />
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] text-gray-600 w-8 text-right">ÁÇπ:</span>
                                                        <input type="range" min="2" max="10" step="0.5" value={graphPointSize} onChange={(e)=>setGraphPointSize(Number(e.target.value))} className="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                                        <input type="number" value={graphPointSize} onChange={(e)=>setGraphPointSize(Number(e.target.value))} className="w-10 text-right border p-0.5 rounded text-[10px]" />
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] text-gray-600 w-8 text-right">È´ò„Åï:</span>
                                                        <input type="range" min="300" max="800" step="50" value={globalGraphHeight} onChange={(e)=>setGlobalGraphHeight(Number(e.target.value))} className="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                                        <input type="number" value={globalGraphHeight} onChange={(e)=>setGlobalGraphHeight(Number(e.target.value))} className="w-10 text-right border p-0.5 rounded text-[10px]" />
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] text-gray-600 w-8 text-right">ÊñáÂ≠ó:</span>
                                                        <input type="range" min="9" max="20" step="1" value={graphFontSize} onChange={(e)=>setGraphFontSize(Number(e.target.value))} className="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                                        <input type="number" value={graphFontSize} onChange={(e)=>setGraphFontSize(Number(e.target.value))} className="w-10 text-right border p-0.5 rounded text-[10px]" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 px-2 py-1.5 bg-white border-b border-gray-200 overflow-x-auto">
                                            <span className="text-[10px] font-bold text-gray-500 flex-shrink-0">Âá°‰æã („ÇØ„É™„ÉÉ„ÇØ„ÅßÂàáÊõø):</span>
                                            <div className="flex gap-1">
                                                <button onClick={() => setSoilSettings(prev => prev.map(item => ({ ...item, visible: true })))} className="bg-blue-50 text-blue-600 border border-blue-200 px-1.5 rounded text-[9px] font-bold hover:bg-blue-100 whitespace-nowrap">ÂÖ®„Å¶Ë°®Á§∫</button>
                                                <button onClick={() => setSoilSettings(prev => prev.map(item => ({ ...item, visible: item.visible === false ? true : false })))} className="bg-orange-50 text-orange-600 border border-orange-200 px-1.5 rounded text-[9px] font-bold hover:bg-orange-100 whitespace-nowrap">ÂèçËª¢</button>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                                {soilSettings.map(s => (
                                                    <div 
                                                        key={s.name} 
                                                        onClick={() => setSoilSettings(prev => prev.map(item => item.name === s.name ? { ...item, visible: !item.visible } : item))}
                                                        className={`flex items-center gap-1 border px-1.5 py-0.5 rounded cursor-pointer select-none transition-all ${s.visible !== false ? 'bg-gray-50 border-gray-300 opacity-100 hover:bg-gray-100 shadow-sm' : 'bg-gray-100 border-gray-200 opacity-60 hover:opacity-80'}`}
                                                    >
                                                        <svg width="8" height="8" viewBox="0 0 20 20" className="overflow-visible" style={{opacity: s.visible !== false ? 1 : 0.3}}>{renderShape(s.shape, 10, 10, 8, s.color)}</svg>
                                                        <span className={`text-[10px] font-bold ${s.visible !== false ? 'text-gray-700' : 'text-gray-400 line-through'}`}>{s.name}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <button className="text-[9px] text-blue-500 underline ml-2 whitespace-nowrap" onClick={() => setIsUnifiedSettingsOpen(true)}>Ë©≥Á¥∞Ë®≠ÂÆö</button>
                                        </div>
                                        <div className="flex items-start gap-4 px-2 py-2 bg-slate-50 border-b border-gray-200 overflow-x-auto">
                                            {[...new Set(COLUMN_DEFS.filter(c => c.graph).map(c => c.group))].map(group => { 
                                                const groupCols = COLUMN_DEFS.filter(c => c.group === group && c.graph); 
                                                const allChecked = groupCols.every(c => visibleGraphs.includes(c.key)); 
                                                const isBasic = group === 'Âü∫Êú¨‰∫ãÈ†Ö'; 
                                                return (
                                                    <div key={group} className="flex flex-col gap-1 border-r border-gray-200 pr-3 last:border-none min-w-max">
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-bold text-gray-600 text-[10px] bg-gray-200 px-1 rounded">{group}</span>
                                                            {!isBasic && <label className="flex items-center cursor-pointer ml-1 text-[9px] text-blue-600 hover:underline"><input type="checkbox" checked={allChecked} onChange={(e) => toggleGraphGroup(group, e.target.checked)} className="hidden" />(ÂÖ®ÈÅ∏Êäû)</label>}
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {groupCols.map(col => (
                                                                <label key={col.key} className={`flex items-center px-2 py-0.5 rounded cursor-pointer border transition-all text-[10px] shadow-sm ${visibleGraphs.includes(col.key) ? 'bg-blue-600 text-white border-blue-700 font-bold' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}>
                                                                    <input type="checkbox" checked={visibleGraphs.includes(col.key)} onChange={() => setVisibleGraphs(prev => prev.includes(col.key) ? prev.filter(k => k !== col.key) : [...prev, col.key])} className="hidden" />
                                                                    <span>{col.label.split(' ')[1] || col.label.split(' ')[0]}</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ); 
                                            })}
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-auto bg-slate-100 p-2 screen-graph-container">
                                        <div className="flex gap-2 h-full min-w-max pb-2 items-start">
                                            {COLUMN_DEFS.filter(col => visibleGraphs.includes(col.key)).map(col => (
                                                <div key={col.key} className="shadow-sm rounded overflow-hidden bg-white">
                                                    <DepthProfileChart 
                                                        data={filteredData} 
                                                        colDef={col} 
                                                        soilSettings={soilSettings} 
                                                        pointSize={graphPointSize} 
                                                        axisMode={verticalAxisMode} 
                                                        customScale={columnScales[col.key]} 
                                                        onUpdateScale={(newScale) => updateScale(col.key, newScale)} 
                                                        commonYScale={verticalAxisMode === 'depth' ? depthYScale : elevationYScale} 
                                                        boringSettings={boringSettings} 
                                                        baseFontSize={graphFontSize} 
                                                        height={globalGraphHeight} 
                                                        width={globalGraphWidth} 
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="print-graph-container">
                                        <div className="print-graph-grid" style={{ gridTemplateColumns: `repeat(${printGraphsPerRow}, 1fr)` }}>
                                            {COLUMN_DEFS.filter(col => visibleGraphs.includes(col.key)).map(col => (
                                                <div key={col.key} className="border border-gray-400 bg-white chart-wrapper">
                                                    <DepthProfileChart 
                                                        data={filteredData} 
                                                        colDef={col} 
                                                        soilSettings={soilSettings} 
                                                        pointSize={graphPointSize} 
                                                        axisMode={verticalAxisMode} 
                                                        customScale={columnScales[col.key]} 
                                                        onUpdateScale={(newScale) => updateScale(col.key, newScale)} 
                                                        commonYScale={verticalAxisMode === 'depth' ? depthYScale : elevationYScale} 
                                                        boringSettings={boringSettings} 
                                                        baseFontSize={graphFontSize} 
                                                        height={globalGraphHeight} 
                                                        width="100%" 
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'analysis' && (
                                <div className="h-full flex flex-col bg-white overflow-hidden">
                                    <div className="p-3 bg-gray-50 border-b border-gray-200 flex items-center gap-4 no-print">
                                        <label className="font-bold text-gray-700 text-sm">ÂàÜÊûêÈ†ÖÁõÆ„ÇíÈÅ∏Êäû:</label>
                                        <select value={analysisTargetKey} onChange={(e) => setAnalysisTargetKey(e.target.value)} className="border border-gray-300 rounded px-3 py-1.5 font-bold text-sm bg-white shadow-sm">{[...new Set(COLUMN_DEFS.filter(c => c.graph || c.type==='number').map(c => c.group))].map(group => (<optgroup key={group} label={group}>{COLUMN_DEFS.filter(c => (c.graph || c.type==='number') && c.group === group).map(col => (<option key={col.key} value={col.key}>{col.label}</option>))}</optgroup>))}</select>
                                        <div className="flex items-center gap-2 ml-auto"><span className="text-xs font-bold text-gray-600">Ë°®ÊñáÂ≠ó:</span><input type="range" min="9" max="16" step="1" value={analysisTableFontSize} onChange={(e) => setAnalysisTableFontSize(Number(e.target.value))} className="w-16" /></div>
                                        <div className="flex items-center gap-2 border-l border-gray-300 pl-3 ml-1"><span className="text-xs font-bold text-gray-600">„Ç∞„É©„ÉïÊñáÂ≠ó:</span><input type="range" min="10" max="24" step="1" value={analysisGraphFontSize} onChange={(e) => setAnalysisGraphFontSize(Number(e.target.value))} className="w-16" /></div>
                                        <div className="flex items-center gap-2 border-l border-gray-300 pl-3 ml-1"><span className="text-xs font-bold text-gray-600">ÁÇπ:</span><input type="range" min="2" max="12" step="0.5" value={analysisGraphPointSize} onChange={(e) => setAnalysisGraphPointSize(Number(e.target.value))} className="w-12" /></div>
                                        <div className="flex items-center gap-2 border-l border-gray-300 pl-3 ml-1"><span className="text-xs font-bold text-gray-600">ÂπÖ:</span><input type="range" min="200" max="1000" step="50" value={analysisGraphWidth} onChange={(e) => setAnalysisGraphWidth(Number(e.target.value))} className="w-16" /></div>
                                        <div className="flex items-center gap-2 ml-1"><span className="text-xs font-bold text-gray-600">È´ò:</span><input type="range" min="300" max="1200" step="50" value={analysisGraphHeight} onChange={(e) => setAnalysisGraphHeight(Number(e.target.value))} className="w-16" /></div>
                                        <button onClick={()=>window.print()} className="bg-slate-700 text-white px-3 py-1 rounded shadow text-xs font-bold hover:bg-slate-800 ml-2">üñ®Ô∏è Âç∞Âà∑</button>
                                    </div>
                                    <div className="flex-1 flex overflow-hidden p-4 gap-4">
                                        <div className="flex flex-col w-[400px] flex-shrink-0">
                                            <div className="overflow-auto border border-black h-full">
                                                <table className="w-full text-sm border-collapse">
                                                    <thead className="sticky top-0 z-10">
                                                        <tr><th colSpan="5" className="bg-emerald-100 border border-black py-2"><div className="text-base font-bold" style={{fontSize: `${analysisTableFontSize+2}px`}}>{analysisColDef?.label.split(' ')[0]}</div><div className="text-xs font-normal" style={{fontSize: `${analysisTableFontSize}px`}}>{analysisColDef?.label.split(' ')[1]}</div></th></tr>
                                                        <tr><th rowSpan="2" className="w-[100px] bg-white border border-black font-normal text-xs" style={{fontSize: `${analysisTableFontSize}px`}}>Âú∞Â±§<br/>Ë®òÂè∑</th><th colSpan="4" className="bg-emerald-100 border border-black py-1"><div style={{fontSize: `${analysisTableFontSize}px`}}>{analysisColDef?.label.split(' ')[1] || analysisColDef?.key}</div><div className="font-normal text-xs" style={{fontSize: `${analysisTableFontSize-1}px`}}>{analysisColDef?.unit ? `(${analysisColDef.unit})` : ''}</div></th></tr>
                                                        <tr className="bg-white"><th className="border border-black font-normal text-xs py-1 w-14" style={{fontSize: `${analysisTableFontSize}px`}}>„Éá„Éº„ÇøÊï∞</th><th className="border border-black font-normal text-xs py-1" style={{fontSize: `${analysisTableFontSize}px`}}>ÊúÄÂ∞èÂÄ§</th><th className="border border-black font-normal text-xs py-1" style={{fontSize: `${analysisTableFontSize}px`}}>ÊúÄÂ§ßÂÄ§</th><th className="border border-black font-normal text-xs py-1" style={{fontSize: `${analysisTableFontSize}px`}}>Âπ≥ÂùáÂÄ§</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        {analysisTable.map(row => (<tr key={row.soil} className="text-center h-8"><td className="border border-black font-bold text-white shadow-sm" style={{backgroundColor: row.color, textShadow: '0 1px 2px rgba(0,0,0,0.8)', fontSize: `${analysisTableFontSize}px`}}>{row.soil}</td><td className="border border-black bg-white" style={{fontSize: `${analysisTableFontSize}px`}}>{row.n}</td><td className="border border-black bg-white" style={{fontSize: `${analysisTableFontSize}px`}}>{row.min}</td><td className="border border-black bg-white" style={{fontSize: `${analysisTableFontSize}px`}}>{row.max}</td><td className="border border-black bg-white" style={{fontSize: `${analysisTableFontSize}px`}}>{row.avg}</td></tr>))}
                                                        {Array.from({length: Math.max(0, 15 - analysisTable.length)}).map((_, i) => (<tr key={`empty-${i}`} className="h-8"><td className="border border-black bg-gray-100"></td><td className="border border-black"></td><td className="border border-black"></td><td className="border border-black"></td><td className="border border-black"></td></tr>))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div className="flex-1 border border-black bg-white relative flex justify-center items-start overflow-auto pt-4">
                                            <div className="absolute top-2 right-2 z-10 text-xs font-bold bg-white/80 p-1 rounded">{analysisColDef?.label} {analysisColDef?.unit ? `(${analysisColDef.unit})` : ''}</div>
                                            {analysisColDef ? (<div className="flex justify-center"><DepthProfileChart data={filteredData} colDef={analysisColDef} soilSettings={soilSettings} pointSize={analysisGraphPointSize} axisMode={verticalAxisMode} customScale={columnScales[analysisTargetKey]} onUpdateScale={(newScale) => updateScale(analysisTargetKey, newScale)} height={analysisGraphHeight} width={analysisGraphWidth} hideLegend={false} commonYScale={verticalAxisMode === 'depth' ? depthYScale : elevationYScale} baseFontSize={analysisGraphFontSize} boringSettings={boringSettings} /></div>) : (<div className="flex items-center justify-center h-full text-gray-400">„Ç∞„É©„Éï„ÇíË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì</div>)}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'multi_analysis' && (
                                <div className="h-full flex flex-col bg-white overflow-hidden" onClick={() => isMultiSelectMenuOpen && setIsMultiSelectMenuOpen(false)}>
                                    <div className="p-3 bg-gray-50 border-b border-gray-200 flex items-center gap-4 relative no-print">
                                        <div className="relative" onClick={e => e.stopPropagation()}>
                                            <button onClick={() => setIsMultiSelectMenuOpen(!isMultiSelectMenuOpen)} className="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded shadow hover:bg-gray-50 font-bold text-xs flex items-center gap-1">üìë Ë°®Á§∫È†ÖÁõÆ„ÇíÈÅ∏Êäû„ÉªÂ§âÊõ¥ ‚ñº</button>
                                            {isMultiSelectMenuOpen && (
                                                <div className="absolute left-0 top-8 w-[400px] bg-white border border-gray-300 shadow-xl rounded z-[100] p-3 text-xs max-h-[400px] overflow-y-auto">
                                                    <div className="flex justify-between items-center border-b pb-2 mb-2"><span className="font-bold">‰∏ÄË¶ßË°®„Å´Ë°®Á§∫„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû</span><button onClick={() => setIsMultiSelectMenuOpen(false)} className="text-gray-400">√ó</button></div>
                                                    <div className="flex gap-2 mb-3 border-b pb-2"><button onClick={() => setSelectedMultiAnalysisCols(new Set(DEFAULT_MULTI_COLS))} className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 text-[10px] font-bold">ÂàùÊúüÂÄ§</button><button onClick={() => setSelectedMultiAnalysisCols(new Set(COLUMN_DEFS.filter(c => c.type === 'number').map(c => c.key)))} className="bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 text-[10px] font-bold">ÂÖ®ÈÅ∏Êäû</button><button onClick={() => setSelectedMultiAnalysisCols(new Set())} className="bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200 text-[10px] font-bold">ÂÖ®Ëß£Èô§</button></div>
                                                    {[...new Set(COLUMN_DEFS.filter(c => c.type === 'number').map(c => c.group))].map(group => { const groupCols = COLUMN_DEFS.filter(c => c.type === 'number' && c.group === group); return (<div key={group} className="mb-3"><div className="font-bold text-slate-600 bg-slate-100 px-2 py-1 mb-1 rounded-sm">{group}</div><div className="grid grid-cols-2 gap-1 pl-2">{groupCols.map(col => (<label key={col.key} className="flex items-center gap-1 cursor-pointer hover:bg-blue-50 p-0.5 rounded"><input type="checkbox" checked={selectedMultiAnalysisCols.has(col.key)} onChange={(e) => { const newSet = new Set(selectedMultiAnalysisCols); if(e.target.checked) newSet.add(col.key); else newSet.delete(col.key); setSelectedMultiAnalysisCols(newSet); }} className="rounded text-blue-600" /><span>{col.label.split(' ')[0]} <span className="text-[9px] text-gray-400">({col.label.split(' ')[1] || ''})</span></span></label>))}</div></div>); })}
                                                </div>
                                            )}
                                        </div>
                                        <div className="text-xs text-gray-500 ml-auto">‚ÄªD20(ÈÄèÊ∞¥)„Åä„Çà„Å≥E50(Â§âÂΩ¢‰øÇÊï∞)„ÇíÂê´„ÇÄÂàó„ÅØËá™ÂãïÁöÑ„Å´„ÄåÁõ∏‰πóÂπ≥Âùá„Äç„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô</div>
                                        <div className="flex items-center gap-1 ml-2 border-l pl-2 border-gray-300"><span className="text-[10px] font-bold text-gray-600">ÊñáÂ≠ó:</span><input type="number" value={multiStatsTableFontSize} onChange={(e) => setMultiStatsTableFontSize(Math.max(6, parseInt(e.target.value)))} className="w-10 text-xs border rounded px-1 text-right" min="6" /></div>
                                        <div className="flex items-center gap-1 ml-2 border-l pl-2 border-gray-300"><span className="text-[10px] font-bold text-gray-600">Âç∞Âà∑ÂàóÊï∞/È†Å:</span><input type="number" value={multiPrintColLimit} onChange={(e) => setMultiPrintColLimit(Math.max(1, parseInt(e.target.value)))} className="w-12 text-xs border rounded px-1 text-right" min="1" /></div>
                                        <button onClick={()=>window.print()} className="bg-slate-700 text-white px-3 py-1 rounded shadow text-xs font-bold hover:bg-slate-800 ml-2">üñ®Ô∏è Âç∞Âà∑</button>
                                    </div>
                                    <div className="flex-1 overflow-auto p-4 screen-table-container">
                                        <table className="w-auto border-collapse text-xs border border-black">
                                            <thead className="sticky top-0 z-10">
                                                <tr><th rowSpan="3" className="bg-white border border-black p-2 min-w-[80px] z-20 sticky left-0" style={{fontSize: `${multiStatsTableFontSize}px`}}>Âú∞Â±§<br/>Ë®òÂè∑</th>{multiAnalysisData.map(group => { const colSpan = group.columns.reduce((acc, col) => { const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return acc + (useGeo ? 5 : 4); }, 0); return <th key={group.name} colSpan={colSpan} className="bg-green-100 border border-black py-2 font-bold text-sm" style={{fontSize: `${multiStatsTableFontSize}px`}}>{group.name}</th>; })}</tr>
                                                <tr>{multiAnalysisData.map(group => group.columns.map(col => { const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return <th key={col.key} colSpan={useGeo ? 5 : 4} className="bg-green-50 border border-black py-1 font-normal cursor-context-menu" onContextMenu={(e) => handleContextMenu(e, col.key, 'multi')}><div className="font-bold text-[10px] text-gray-700" style={{fontSize: `${multiStatsTableFontSize}px`}}>{col.label.split(' ')[0]}</div><div className="font-bold text-sm" style={{fontSize: `${multiStatsTableFontSize}px`}}>{col.label.split(' ')[1] || ''}</div><div className="text-[10px] text-gray-600">{col.unit ? `(${col.unit})` : ''}</div></th>; }))}</tr>
                                                <tr>{multiAnalysisData.map(group => group.columns.map(col => { const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return (<React.Fragment key={col.key}><th className="border border-black bg-white font-normal px-1 w-12" style={{fontSize: `${multiStatsTableFontSize}px`}}>„Éá„Éº„ÇøÊï∞</th><th className="border border-black bg-white font-normal px-1 w-16" style={{fontSize: `${multiStatsTableFontSize}px`}}>ÊúÄÂ∞èÂÄ§</th><th className="border border-black bg-white font-normal px-1 w-16" style={{fontSize: `${multiStatsTableFontSize}px`}}>ÊúÄÂ§ßÂÄ§</th><th className="border border-black bg-white font-normal px-1 w-16" style={{fontSize: `${multiStatsTableFontSize}px`}}>Âπ≥ÂùáÂÄ§</th>{useGeo && <th className="border border-black bg-yellow-50 font-normal px-1 w-16 text-yellow-900" style={{fontSize: `${multiStatsTableFontSize}px`}}>Áõ∏‰πóÂπ≥Âùá</th>}</React.Fragment>); }))}</tr>
                                            </thead>
                                            <tbody>
                                                {statistics.map(stat => (<tr key={stat.soil} className="text-center h-8 hover:bg-gray-50"><td className="border border-black font-bold text-white sticky left-0 z-10 shadow-sm" style={{backgroundColor: stat.color, textShadow: '0 1px 2px rgba(0,0,0,0.8)', fontSize: `${multiStatsTableFontSize}px`}}>{stat.soil}</td>{multiAnalysisData.map(group => group.columns.map(col => { const vals = stat[col.key]; const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return (<React.Fragment key={col.key}><td className="border border-black px-1" style={{fontSize: `${multiStatsTableFontSize}px`}}>{vals.n}</td><td className="border border-black px-1" style={{fontSize: `${multiStatsTableFontSize}px`}}>{formatValue(vals.min, col.key)}</td><td className="border border-black px-1" style={{fontSize: `${multiStatsTableFontSize}px`}}>{formatValue(vals.max, col.key)}</td><td className="border border-black px-1" style={{fontSize: `${multiStatsTableFontSize}px`}}>{formatValue(vals.avg, col.key)}</td>{useGeo && <td className="border border-black px-1 bg-yellow-50" style={{fontSize: `${multiStatsTableFontSize}px`}}>{formatValue(vals.geo, col.key)}</td>}</React.Fragment>); }))}</tr>))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="print-table-container">{(() => { const flatCols = []; multiAnalysisData.forEach(g => { g.columns.forEach(c => flatCols.push({ ...c, groupName: g.name })); }); const chunks = chunkArray(flatCols, multiPrintColLimit); return chunks.map((chunk, i) => (<div key={i} className="print-break-before mb-4 w-auto inline-block"><div className="font-bold text-sm mb-2">Ë§áÊï∞È†ÖÁõÆÂàÜÊûêÁµêÊûú ({i + 1}/{chunks.length})</div><table className="w-auto border-collapse text-xs border border-black"><thead><tr><th rowSpan="3" className="bg-gray-200 border border-black p-1 w-[80px]">ÂúüË≥™</th>{(() => { const groupsInChunk = []; let currentGroup = null; let count = 0; chunk.forEach(c => { if (c.groupName !== currentGroup) { if(currentGroup) groupsInChunk.push({name: currentGroup, count}); currentGroup = c.groupName; count = 0; } const useGeo = c.key.includes('D20') || c.key.includes('E50') || c.key.includes('k_'); count += (useGeo ? 5 : 4); }); if(currentGroup) groupsInChunk.push({name: currentGroup, count}); return groupsInChunk.map((g, idx) => <th key={idx} colSpan={g.count} className="bg-green-100 border border-black p-1">{g.name}</th>); })()}</tr><tr>{chunk.map(col => { const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return <th key={col.key} colSpan={useGeo ? 5 : 4} className="bg-green-50 border border-black p-1 font-normal"><div className="font-bold text-[9px] text-gray-700">{col.label.split(' ')[0]}</div><div className="font-bold text-xs">{col.label.split(' ')[1] || ''}</div><div className="text-[9px] text-gray-600">{col.unit ? `(${col.unit})` : ''}</div></th>; })}</tr><tr>{chunk.map(col => { const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return (<React.Fragment key={col.key}><th className="border border-black bg-white font-normal p-0.5">n</th><th className="border border-black bg-white font-normal p-0.5">Min</th><th className="border border-black bg-white font-normal p-0.5">Max</th><th className="border border-black bg-white font-normal p-0.5">Avg</th>{useGeo && <th className="border border-black bg-yellow-50 font-normal p-0.5">Geo</th>}</React.Fragment>); })}</tr></thead><tbody>{statistics.map(stat => (<tr key={stat.soil}><td className="border border-black font-bold text-center" style={{backgroundColor: stat.color, color: 'white', textShadow: '0 1px 1px black'}}>{stat.soil}</td>{chunk.map(col => { const vals = stat[col.key]; const useGeo = col.key.includes('D20') || col.key.includes('E50') || col.key.includes('k_'); return (<React.Fragment key={col.key}><td className="border border-black text-right p-1">{vals.n}</td><td className="border border-black text-right p-1">{formatValue(vals.min, col.key)}</td><td className="border border-black text-right p-1">{formatValue(vals.max, col.key)}</td><td className="border border-black text-right p-1">{formatValue(vals.avg, col.key)}</td>{useGeo && <td className="border border-black text-right p-1 bg-yellow-50">{formatValue(vals.geo, col.key)}</td>}</React.Fragment>); })}</tr>))}</tbody></table></div>)); })()}</div>
                                </div>
                            )}

                            {activeTab === 'correlation' && (
                                <div className="h-full overflow-auto p-6 bg-slate-100">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2 border-gray-300 no-print">
                                        <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><span>üìâ Áõ∏Èñ¢ÂàÜÊûê„ÉªÊï£Â∏ÉÂõ≥</span><button onClick={() => setIsConsolidationModalOpen(true)} className="ml-4 bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-xs shadow font-bold flex items-center gap-1">üìä ÂúßÂØÜ„Éë„É©„É°„Éº„Çø(P0)Ë®≠ÂÆö</button></h2>
                                        <div className="flex items-center gap-3">
                                            <div className="flex items-center gap-1">
                                                <span className="text-xs font-bold text-gray-600">ÊñáÂ≠ó:</span>
                                                <input type="range" min="9" max="20" step="1" value={correlationGraphFontSize} onChange={(e)=>setCorrelationGraphFontSize(Number(e.target.value))} className="w-16" />
                                                <span className="text-xs w-6">{correlationGraphFontSize}</span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <span className="text-xs font-bold text-gray-600">ÁÇπ:</span>
                                                <input type="range" min="2" max="12" step="0.5" value={correlationGraphPointSize} onChange={(e)=>setCorrelationGraphPointSize(Number(e.target.value))} className="w-16" />
                                                <span className="text-xs w-6">{correlationGraphPointSize}</span>
                                            </div>
                                            <div className="flex items-center gap-1"><span className="text-xs font-bold text-gray-600">„Ç∞„É©„Éï„Çµ„Ç§„Ç∫:</span><input type="range" min="200" max="600" step="10" value={correlationChartSize} onChange={(e)=>setCorrelationChartSize(Number(e.target.value))} className="w-24" /><span className="text-xs w-8">{correlationChartSize}px</span></div><button onClick={()=>window.print()} className="bg-slate-700 text-white px-4 py-1.5 rounded shadow text-xs font-bold hover:bg-slate-800">üñ®Ô∏è Âç∞Âà∑</button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-6 pb-20 print:grid-cols-2">
                                        {/* Â°ëÊÄßÂõ≥: ËÉåÊôØ„Å®ÂâçÊôØ„ÇíÂàÜÈõ¢ */}
                                        <ScatterChart data={filteredData} xKey="WL" xLabel="Ê∂≤ÊÄßÈôêÁïå WL" xUnit="%" defaultMinX={0} defaultMaxX={100} yKey="Ip" yLabel="Â°ëÊÄßÊåáÊï∞ Ip" yUnit="" defaultMinY={0} defaultMaxY={100} soilSettings={soilSettings} 
                                            renderBackground={drawPlasticityLinesBackground} renderForeground={drawPlasticityLinesForeground} 
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        {/* Rho-Wn: ÂâçÊôØÊñáÂ≠ó‰øÆÊ≠£ */}
                                        <ScatterChart data={filteredData} xKey="wn" xLabel="Âê´Ê∞¥ÊØî Wn" xUnit="%" defaultMinX={0} defaultMaxX={100} yKey="rho_t" yLabel="ÊπøÊΩ§ÂØÜÂ∫¶ œÅt" yUnit="g/cm¬≥" defaultMinY={1.0} defaultMaxY={2.4} soilSettings={soilSettings} 
                                            renderBackground={drawRhoCurveBackground} renderForeground={drawRhoCurveForeground}
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        {/* Wn-WL: ÂæìÊù•ÈÄö„ÇärenderBackground (Overlay) „ÅÆ„Åø„ÅßOK„Å†„Åå„ÄÅ„Éó„É≠„ÉÉ„ÉóÂêç„ÇíÁµ±‰∏Ä */}
                                        <ScatterChart data={filteredData} xKey="WL" xLabel="Ê∂≤ÊÄßÈôêÁïå WL" xUnit="%" defaultMinX={0} defaultMaxX={100} yKey="wn" yLabel="Âê´Ê∞¥ÊØî Wn" yUnit="%" defaultMinY={0} defaultMaxY={100} soilSettings={soilSettings} 
                                            renderBackground={drawWnWlOverlay} 
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        <ScatterChart data={filteredData} xKey="WL" xLabel="Ê∂≤ÊÄßÈôêÁïå WL" xUnit="%" defaultMinX={0} defaultMaxX={100} yKey="Cc" yLabel="ÂúßÁ∏ÆÊåáÊï∞ Cc" yUnit="" defaultMinY={0} defaultMaxY={2.0} soilSettings={soilSettings} 
                                            renderBackground={drawCcWlOverlay} 
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        <div className="flex flex-col gap-1 items-center" style={{width: correlationChartSize}}>
                                            <div className="flex items-center gap-1 ml-auto mr-4 no-print"><span className="text-[10px] font-bold text-gray-600">YËª∏ÂàáÊõø:</span><button onClick={()=>setPcGraphMode('uu')} className={`px-2 py-0.5 text-[10px] rounded border ${pcGraphMode==='uu' ? 'bg-blue-600 text-white border-blue-700' : 'bg-white text-gray-600 border-gray-300'}`}>c(UU)</button><button onClick={()=>setPcGraphMode('qu')} className={`px-2 py-0.5 text-[10px] rounded border ml-1 ${pcGraphMode==='qu' ? 'bg-indigo-600 text-white border-indigo-700' : 'bg-white text-gray-600 border-gray-300'}`}>qu/2</button></div>
                                            <ScatterChart data={filteredData} xKey="Pc" xLabel="ÂúßÂØÜÈôç‰ºèÂøúÂäõ Pc" xUnit="kN/m¬≤" defaultMinX={0} defaultMaxX={1000} yKey={pcGraphMode === 'uu' ? "c_uu" : null} calcY={pcGraphMode === 'qu' ? (d) => (d.qu !== null && d.qu !== undefined ? d.qu / 2 : null) : null} yLabel={pcGraphMode === 'uu' ? "Á≤òÁùÄÂäõ c(UU)" : "Á≤òÁùÄÂäõ cu (qu/2)"} yUnit="kN/m¬≤" defaultMinY={0} defaultMaxY={200} soilSettings={soilSettings} boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        </div>
                                        
                                        <ScatterChart data={filteredData} xKey="D20" calcX={(d) => (d.D20 != null && d.D20 > 0 ? 0.3441 * Math.pow(d.D20, 2.2954) : null)} xLabel="D20ÈÄèÊ∞¥‰øÇÊï∞ Ks" xUnit="mm/s" defaultMinX={0.000001} defaultMaxX={0.1} yKey="depth_top" yLabel="Ê∑±Â∫¶" yUnit="m" defaultMinY={0} defaultMaxY={60} isYReversed={true} isLogX={true} soilSettings={soilSettings} 
                                            renderForeground={drawKsFormula} 
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        <ScatterChart data={filteredData} xKey="Pc" xLabel="ÂúßÂØÜÈôç‰ºèÂøúÂäõ Pc" xUnit="kN/m¬≤" defaultMinX={0} defaultMaxX={2000} yKey="depth_top" yLabel={verticalAxisMode === 'elevation' ? "Ê®ôÈ´ò" : "Ê∑±Â∫¶"} yUnit="m" defaultMinY={0} defaultMaxY={50} isYReversed={verticalAxisMode === 'depth'} calcY={(d) => { const z = d.depth_top !== null ? d.depth_top : 0; if (verticalAxisMode === 'elevation') { const gl = boringSettings[d.boring]?.altitude || 0; return gl - z; } return z; }} soilSettings={soilSettings} 
                                            renderBackground={verticalAxisMode === 'depth' ? drawConsolidationLines : null} 
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        {/* OCR: ËÉåÊôØ„Å®ÂâçÊôØÂàÜÈõ¢ */}
                                        <ScatterChart data={filteredData} xKey={null} calcX={(d) => { if (!d.Pc) return null; const z = (d.depth_top + d.depth_bottom) / 2; const p0 = getP0AtDepth(z); if (!p0) return null; return d.Pc / p0; }} xLabel="ÈÅéÂúßÂØÜÊØî OCR" xUnit="" defaultMinX={0} defaultMaxX={10} isLogX={false} yKey="depth_top" yLabel={verticalAxisMode === 'elevation' ? "Ê®ôÈ´ò" : "Ê∑±Â∫¶"} yUnit="m" defaultMinY={0} defaultMaxY={50} isYReversed={verticalAxisMode === 'depth'} calcY={(d) => { const z = d.depth_top !== null ? d.depth_top : 0; if (verticalAxisMode === 'elevation') { const gl = boringSettings[d.boring]?.altitude || 0; return gl - z; } return z; }} soilSettings={soilSettings} 
                                            renderBackground={drawOCRRegionsBackground} renderForeground={drawOCRRegionsForeground}
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                        
                                        {/* Pc-P0: ÊñáÂ≠ó‰øÆÊ≠£ */}
                                        <ScatterChart data={filteredData} xKey={null} calcX={(d) => { if (!d.Pc) return null; const z = (d.depth_top + d.depth_bottom) / 2; const p0 = getP0AtDepth(z); if (!p0) return null; return d.Pc - p0; }} xLabel="ÈÅéÂúßÂØÜÈáè Pc - P0" xUnit="kN/m¬≤" defaultMinX={-100} defaultMaxX={500} yKey="depth_top" yLabel={verticalAxisMode === 'elevation' ? "Ê®ôÈ´ò" : "Ê∑±Â∫¶"} yUnit="m" defaultMinY={0} defaultMaxY={50} isYReversed={verticalAxisMode === 'depth'} calcY={(d) => { const z = d.depth_top !== null ? d.depth_top : 0; if (verticalAxisMode === 'elevation') { const gl = boringSettings[d.boring]?.altitude || 0; return gl - z; } return z; }} soilSettings={soilSettings} 
                                            renderBackground={drawOverConsolidationLineBackground} renderForeground={drawOverConsolidationLineForeground}
                                            boringSettings={boringSettings} width={correlationChartSize} height={correlationChartSize} baseFontSize={correlationGraphFontSize} pointSize={correlationGraphPointSize} />
                                    </div>
                                </div>
                            )}
                        </div>
                        {contextMenu && (
                            <div 
                                className="fixed z-[9999] bg-white border border-gray-300 shadow-lg rounded py-1 px-1 text-xs" 
                                style={{ top: contextMenu.y, left: contextMenu.x }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <button 
                                    onClick={handleHideColumn}
                                    className="w-full text-left px-3 py-1.5 hover:bg-red-50 hover:text-red-600 font-bold whitespace-nowrap flex items-center gap-2"
                                >
                                    <span>üö´ „Åì„ÅÆÂàó„ÇíÈùûË°®Á§∫„Å´„Åô„Çã</span>
                                </button>
                                <div className="text-[10px] text-gray-400 px-3 py-1 border-t border-gray-100">‚Äª ÂÜçË°®Á§∫„ÅØÂè≥‰∏ä„ÅÆË®≠ÂÆö„Éú„Çø„É≥„Åã„Çâ</div>
                            </div>
                        )}
                        <LegalFooter />
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>