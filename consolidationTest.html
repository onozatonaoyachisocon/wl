<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ§å¯†è©¦é¨“çµæœæ•´ç†ã‚·ã‚¹ãƒ†ãƒ  (200ä»¶å¯¾å¿œç‰ˆ)</title>
 <link rel="icon" href='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“‰</text></svg>'>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js 3.9.1 stable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@6.2.2/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@6.2.2/dist/handsontable.full.min.js"></script>

<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    
    .sidebar-scroll::-webkit-scrollbar-track { background: #111827; }

    .chart-header { background-color: #34495e; color: white; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
    .symbol-text { color: #f1c40f; font-family: 'Times New Roman', serif; font-style: italic; }

    .handsontable th { background-color: #f3f4f6; color: #374151; font-weight: bold; font-size: 0.75rem; vertical-align: middle; text-align: center; }
    
    .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #eff6ff; }
    .tab-inactive { color: #6b7280; border-bottom: 3px solid transparent; }
    .tab-inactive:hover { color: #374151; border-bottom: 3px solid #d1d5db; }

    #contextMenu {
        position: absolute; z-index: 1000; background: white; border: 1px solid #ccc;
        border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); padding: 5px 0; min-width: 150px;
    }
    #contextMenu div { padding: 8px 15px; cursor: pointer; font-size: 14px; color: #333; }
    #contextMenu div:hover { background-color: #f3f4f6; color: #2563eb; }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #68D391;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #68D391;
    }
</style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex">

<!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
<aside class="w-72 bg-slate-900 text-white flex flex-col h-full shadow-xl flex-shrink-0 z-20">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³è¿½åŠ ï¼‰ -->
    <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-start">
        <div>
            <h1 class="text-xl font-bold text-blue-400 tracking-wide"><i class="fas fa-chart-line mr-2"></i>åœ§å¯†è©¦é¨“æ•´ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>
        <button onclick="openHelpModal()" class="text-slate-400 hover:text-white transition-colors mt-1" title="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">
            <i class="fas fa-question-circle fa-lg"></i>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto sidebar-scroll p-4 space-y-6">
        <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
            <h2 class="text-xs uppercase text-slate-400 font-bold mb-2"><i class="fas fa-database mr-2"></i> ãƒ‡ãƒ¼ã‚¿å…¥å‡ºåŠ›</h2>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="saveData()" class="bg-green-600 hover:bg-green-700 text-white py-1 px-2 rounded text-sm transition"><i class="fas fa-save mr-1"></i>ä¿å­˜</button>
                <label class="bg-orange-600 hover:bg-orange-700 text-white py-1 px-2 rounded text-sm transition text-center cursor-pointer"><i class="fas fa-folder-open mr-1"></i>èª­è¾¼
                    <input type="file" id="fileInput" class="hidden" onchange="loadData(this)">
                </label>
            </div>
            <button onclick="openBatchModal()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded text-sm transition">
                <i class="fas fa-table mr-1"></i> Excelä¸€æ‹¬ç™»éŒ²
            </button>
            <button onclick="openDataListModal()" class="w-full mt-2 bg-slate-600 hover:bg-slate-500 text-white py-1 px-2 rounded text-sm transition border border-slate-500">
                <i class="fas fa-list mr-1"></i> ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ãƒ»ç·¨é›†
            </button>
        </div>

        <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
            <h2 class="text-xs uppercase text-slate-400 font-bold mb-2"><i class="fas fa-sliders-h mr-2"></i> ã‚°ãƒ©ãƒ•è¡¨ç¤ºè¨­å®š</h2>
            <div class="mb-4">
                <label class="text-xs text-slate-400 block mb-1">ã‚°ãƒ©ãƒ•ã®é«˜ã•</label>
                <input type="range" min="200" max="800" value="350" step="10" id="heightSlider" oninput="updateChartHeight(this.value)" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                <div class="text-right text-xs text-slate-400 mt-1" id="heightValue">350px</div>
            </div>
            <div>
                <label class="text-xs text-slate-400 block mb-1">ãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚º</label>
                <input type="range" min="1" max="10" value="4" step="1" id="pointSizeSlider" oninput="updatePointSize(this.value)" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                <div class="text-right text-xs text-slate-400 mt-1" id="pointSizeValue">4px</div>
            </div>
            
            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºãƒˆã‚°ãƒ« -->
            <div class="mt-4 pt-4 border-t border-slate-700">
                <label class="flex items-center cursor-pointer justify-between">
                    <span class="text-xs font-bold text-slate-300">ä»£è¡¨æ›²ç·šãƒ‡ãƒ¼ã‚¿è¡¨ã‚’è¡¨ç¤º</span>
                    <div class="relative">
                        <input type="checkbox" id="toggleTableSwitch" class="sr-only peer" onchange="toggleTableMode(this.checked)">
                        <div class="w-10 h-5 bg-slate-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                    </div>
                </label>
            </div>
        </div>

        <div>
            <h2 class="text-sm font-bold text-slate-300 mb-2 border-l-4 border-blue-500 pl-2">è¡¨ç¤ºè¨­å®š</h2>
            <div class="bg-slate-800 rounded p-2">
                <label class="text-xs text-slate-400 block mb-1">ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°åŸºæº–</label>
                <select id="groupSelect" onchange="refreshView()" class="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded p-1">
                    <option value="layer">åœ°å±¤ã”ã¨ (Ac2, Ac3...)</option>
                    <option value="hole">å­”ç•ªã”ã¨ (No.1, No.2...)</option>
                </select>
            </div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-2 border-l-4 border-blue-500 pl-2">
                <h2 class="text-sm font-bold text-slate-300">å­”ç•ªãƒ•ã‚£ãƒ«ã‚¿</h2>
                <div class="text-xs space-x-1"><button onclick="toggleAllFilters('hole', true)" class="text-blue-400">å…¨</button><span class="text-slate-600">|</span><button onclick="toggleAllFilters('hole', false)" class="text-slate-400">è§£</button></div>
            </div>
            <div id="holeFilterList" class="bg-slate-800 rounded p-2 space-y-1 max-h-40 overflow-y-auto text-sm"></div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-2 border-l-4 border-pink-500 pl-2">
                <h2 class="text-sm font-bold text-slate-300">åœŸå±¤ãƒ•ã‚£ãƒ«ã‚¿</h2>
                <div class="text-xs space-x-1"><button onclick="toggleAllFilters('layer', true)" class="text-blue-400">å…¨</button><span class="text-slate-600">|</span><button onclick="toggleAllFilters('layer', false)" class="text-slate-400">è§£</button></div>
            </div>
            <div id="layerFilterList" class="bg-slate-800 rounded p-2 space-y-1 max-h-40 overflow-y-auto text-sm"></div>
        </div>
    </div>
</aside>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<main class="flex-1 h-full overflow-y-auto bg-gray-200 relative" id="mainContent">
    <div class="p-6 pb-20">
        <div id="chartsContainer" class="space-y-8">
            <div class="text-center text-gray-500 mt-20"><p class="text-xl">èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>

<!-- â–¼â–¼â–¼ å…è²¬äº‹é …ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã“ã“ã‹ã‚‰ â–¼â–¼â–¼ -->
<footer style="font-size: 12px; text-align: center; padding: 20px; color: #6c757d; background-color: #f3f4f6; border-top: 1px solid #d1d5db; margin-top: 50px;">
    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 10px;">
        <p id="lastUpdated" style="margin: 0; font-weight: 500; color: #4b5563;"></p>
        <button id="legal-toggle" style="background: none; border: none; cursor: pointer; font-weight: bold; color: #2563eb; text-decoration: underline; padding: 5px;">
            å…è²¬äº‹é … (ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º)
        </button>
    </div>

    <div id="legal-details" style="display: none; margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 15px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.6;">
        <p style="text-align: center; font-weight: bold; margin-bottom: 5px; color: #1f2937;">
            Copyright &copy; 2025 (æ ª)åœ°åœç·åˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ All Rights Reserved.
        </p>
        <p style="font-size: 11px; color: #6b7280; text-align: center; margin-bottom: 15px;">
            Developed by: Naoya.Onozato
        </p>
        
        <div style="background-color: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-weight: bold; text-align: center;">
            âš  æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®å†é…å¸ƒãƒ»ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç„¡æ–­è»¢ç”¨ã‚’ç¦æ­¢ã—ã¾ã™ã€‚
        </div>

        <div style="font-size: 11px; color: #4b5563;">
            <p style="margin-bottom: 10px;">
                <strong>ã€å…è²¬äº‹é …ã€‘</strong><br>
                æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯åœ§å¯†è©¦é¨“çµæœï¼ˆe-logP, Cv, mvï¼‰ã®æ•´ç†ãŠã‚ˆã³ä½œå›³ä½œæ¥­ã‚’æ”¯æ´ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
                å‡ºåŠ›ã•ã‚Œã‚‹ã‚°ãƒ©ãƒ•ã€ä»£è¡¨æ›²ç·šã®è¨­å®šã€ãŠã‚ˆã³å„ç¨®èª­ã¿å–ã‚Šå€¤ã«ã¤ã„ã¦ã¯ã€<strong>å¿…ãšåœŸè³ªåŸºç¤ç­‰ã®å°‚é–€çŸ¥è­˜ã‚’æœ‰ã™ã‚‹æŠ€è¡“è€…ãŒã€ä¾›è©¦ä½“ã®ä¹±ã‚Œã‚„è©¦é¨“æ¡ä»¶ç­‰ã‚’è€ƒæ…®ã—ãŸä¸Šã§å¦¥å½“æ€§ã‚’ç¢ºèªãƒ»åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚</strong><br>
                æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹è¨ˆç®—èª¤ã‚Šã‚„æå®³ã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ãŠã‚ˆã³è‘—ä½œæ¨©è€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
            </p>
            <p style="margin-bottom: 0;">
                <strong>ã€ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‘</strong><br>
                Chart.js, Handsontable, Tailwind CSS, FontAwesome
            </p>
        </div>
    </div>
</footer>

<script>
    // ãƒ•ãƒƒã‚¿ãƒ¼æ©Ÿèƒ½ã®åˆæœŸåŒ–
    (function() {
        // æœ€çµ‚æ›´æ–°æ—¥ã®è¨­å®š
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedEl) { 
            // å¿…è¦ã«å¿œã˜ã¦æ—¥ä»˜ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
            lastUpdatedEl.textContent = `æœ€çµ‚æ›´æ–°æ—¥: 2025å¹´11æœˆ25æ—¥`; 
        }

        // å…è²¬äº‹é …ã®è¡¨ç¤ºåˆ‡æ›¿
        const legalToggle = document.getElementById('legal-toggle');
        const legalDetails = document.getElementById('legal-details');
        
        if (legalToggle && legalDetails) {
            legalToggle.addEventListener('click', function() {
                const isHidden = legalDetails.style.display === 'none';
                legalDetails.style.display = isHidden ? 'block' : 'none';
                legalToggle.textContent = isHidden ? 'å…è²¬äº‹é … (ã‚¯ãƒªãƒƒã‚¯ã§éè¡¨ç¤º)' : 'å…è²¬äº‹é … (ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º)';
                
                // è¡¨ç¤ºæ™‚ã«ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (isHidden) {
                    setTimeout(() => {
                        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹
                        const mainContent = document.getElementById('mainContent');
                        if(mainContent) {
                            mainContent.scrollTo({ top: mainContent.scrollHeight, behavior: 'smooth' });
                        } else {
                            legalDetails.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                    }, 100);
                }
            });
        }
    })();
</script>
<!-- â–²â–²â–² å…è²¬äº‹é …ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã“ã“ã¾ã§ â–²â–²â–² -->

    </div>
</main>

<!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="contextMenu" class="hidden">
    <div onclick="setRepresentativeCurve()">â˜… ä»£è¡¨æ›²ç·šã«è¨­å®šã™ã‚‹</div>
    <div onclick="removeRepresentativeCurve()" class="text-red-500">Ã— è¨­å®šã‚’è§£é™¤ã™ã‚‹</div>
</div>

<!-- è»¸è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="axisSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white w-full max-w-md rounded-lg shadow-2xl p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ã‚°ãƒ©ãƒ•è¨­å®š (å€‹åˆ¥)</h2>
        <div class="text-xs text-gray-500 mb-4" id="axisModalTitle">å¯¾è±¡: </div>
        <div class="space-y-4">
            <div class="bg-gray-50 p-3 rounded border">
                <h3 class="font-bold text-sm text-gray-700 mb-2">æ¨ªè»¸ (X-Axis)</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-xs text-gray-400">Min</label><input type="number" step="any" id="axisXMin" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                    <div><label class="text-xs text-gray-400">Max</label><input type="number" step="any" id="axisXMax" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                    <div><label class="text-xs text-gray-400">Step</label><input type="number" step="any" id="axisXStep" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                </div>
            </div>
            <div class="bg-gray-50 p-3 rounded border">
                <h3 class="font-bold text-sm text-gray-700 mb-2">ç¸¦è»¸ (Y-Axis)</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-xs text-gray-400">Min</label><input type="number" step="any" id="axisYMin" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                    <div><label class="text-xs text-gray-400">Max</label><input type="number" step="any" id="axisYMax" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                    <div><label class="text-xs text-gray-400">Step</label><input type="number" step="any" id="axisYStep" class="w-full border rounded p-1 text-sm" oninput="previewAxisSettings()"></div>
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="resetAxisSettings()" class="px-4 py-2 text-red-600 border border-red-200 rounded hover:bg-red-50 text-sm">åˆæœŸåŒ–</button>
            <div class="flex-1"></div>
            <button onclick="cancelAxisSettings()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="applyAxisSettings()" class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700">é©ç”¨(ç¢ºå®š)</button>
        </div>
    </div>
</div>

<!-- ä¸€æ‹¬ç™»éŒ²ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="batchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white w-full max-w-7xl h-[95vh] rounded-lg shadow-2xl flex flex-col overflow-hidden relative">
        <div class="flex-shrink-0 flex justify-between items-center p-4 border-b bg-gray-50 z-20">
            <div>
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-file-excel text-green-600 mr-2"></i>Excelãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ç™»éŒ²</h2>
                <p class="text-xs text-gray-500 mt-1">ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯å«ã‚ãšã«ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <button onclick="closeBatchModal()" class="text-gray-500 hover:text-red-500 p-2"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="flex-1 flex flex-col p-4 space-y-4 overflow-hidden bg-white">
            <div class="flex-shrink-0 h-48 flex flex-col">
                <h3 class="flex-shrink-0 font-bold text-sm text-gray-700 mb-2 border-l-4 border-blue-600 pl-2">1. è©¦æ–™ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ (å·¦å´ã®è¡¨)</h3>
                <div class="flex-1 border border-gray-300 relative">
                    <div id="hotMeta" class="absolute inset-0 overflow-hidden"></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col min-h-0">
                <h3 class="flex-shrink-0 font-bold text-sm text-gray-700 mb-2 border-l-4 border-green-600 pl-2">2. è©¦é¨“çµæœãƒ‡ãƒ¼ã‚¿ (å³å´ã®è¡¨)</h3>
                <div class="flex-shrink-0 flex border-b border-gray-200">
                    <button onclick="switchTab('ep')" id="tab-ep" class="tab-active py-2 px-6 text-sm font-medium transition-colors border-r">â‘  e-logP</button>
                    <button onclick="switchTab('cv')" id="tab-cv" class="tab-inactive py-2 px-6 text-sm font-medium transition-colors border-r">â‘¡ Cv</button>
                    <button onclick="switchTab('mv')" id="tab-mv" class="tab-inactive py-2 px-6 text-sm font-medium transition-colors border-r">â‘¢ mv</button>
                </div>
                <div class="flex-1 border border-t-0 border-gray-300 relative bg-gray-50">
                    <div id="pane-ep" class="absolute inset-0 p-0 block"><div id="hotEp" class="w-full h-full overflow-hidden"></div></div>
                    <div id="pane-cv" class="absolute inset-0 p-0 hidden"><div id="hotCv" class="w-full h-full overflow-hidden"></div></div>
                    <div id="pane-mv" class="absolute inset-0 p-0 hidden"><div id="hotMv" class="w-full h-full overflow-hidden"></div></div>
                </div>
            </div>
        </div>
        <div class="flex-shrink-0 p-4 border-t bg-gray-50 flex justify-end space-x-3 z-20">
            <button onclick="clearAllGrids()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded text-sm"><i class="fas fa-trash mr-1"></i> å…¨ã¦ã‚¯ãƒªã‚¢</button>
            <div class="flex-1"></div>
            <button onclick="closeBatchModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="registerBatchData()" class="px-6 py-2 text-white bg-blue-600 rounded hover:bg-blue-700 font-bold shadow"><i class="fas fa-check mr-1"></i> ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</button>
        </div>
    </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="dataListModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white w-full max-w-5xl h-[90vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
        <div class="flex-shrink-0 p-4 border-b bg-gray-50 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-tasks text-slate-600 mr-2"></i>ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <button onclick="closeDataListModal()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div id="dataListView" class="flex-1 overflow-y-auto p-4">
            <table class="min-w-full bg-white border border-gray-300">
                <thead class="bg-gray-100 text-gray-700 text-sm sticky top-0 shadow">
                    <tr>
                        <th class="py-2 px-4 border text-left">å­”ç•ª (Hole)</th>
                        <th class="py-2 px-4 border text-left">è©¦æ–™å (Sample)</th>
                        <th class="py-2 px-4 border text-left">æ·±åº¦ (Depth)</th>
                        <th class="py-2 px-4 border text-left">åœŸå±¤ (Layer)</th>
                        <th class="py-2 px-4 border text-center">ãƒ‡ãƒ¼ã‚¿æ•°</th>
                        <th class="py-2 px-4 border text-center w-32">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="dataListTableBody" class="text-sm text-gray-600"></tbody>
            </table>
        </div>
        <div id="dataEditView" class="hidden flex-1 flex flex-col p-4 bg-gray-50 overflow-y-auto">
            <div class="flex space-x-4 mb-4 border-b pb-4">
                <div class="w-1/4"><label class="block text-xs font-bold text-gray-700 mb-1">å­”ç•ª</label><input type="text" id="editHole" class="w-full border rounded p-2"></div>
                <div class="w-1/4"><label class="block text-xs font-bold text-gray-700 mb-1">è©¦æ–™å</label><input type="text" id="editSample" class="w-full border rounded p-2"></div>
                <div class="w-1/4"><label class="block text-xs font-bold text-gray-700 mb-1">æ·±åº¦</label><input type="text" id="editDepth" class="w-full border rounded p-2"></div>
                <div class="w-1/4"><label class="block text-xs font-bold text-gray-700 mb-1">åœŸå±¤å</label><input type="text" id="editLayer" class="w-full border rounded p-2"></div>
            </div>
            <div class="flex-1 grid grid-cols-3 gap-4 min-h-0">
                <div class="flex flex-col h-full"><label class="text-xs font-bold text-red-600 mb-1">e-logP ãƒ‡ãƒ¼ã‚¿ (P, e)</label><textarea id="editEpData" class="flex-1 w-full border p-2 font-mono text-xs resize-none focus:ring-2 focus:ring-red-200"></textarea></div>
                <div class="flex flex-col h-full"><label class="text-xs font-bold text-blue-600 mb-1">Cv ãƒ‡ãƒ¼ã‚¿ (P_avg, Cv)</label><textarea id="editCvData" class="flex-1 w-full border p-2 font-mono text-xs resize-none focus:ring-2 focus:ring-blue-200"></textarea></div>
                <div class="flex flex-col h-full"><label class="text-xs font-bold text-green-600 mb-1">mv ãƒ‡ãƒ¼ã‚¿ (P_avg, mv)</label><textarea id="editMvData" class="flex-1 w-full border p-2 font-mono text-xs resize-none focus:ring-2 focus:ring-green-200"></textarea></div>
            </div>
        </div>
        <div class="flex-shrink-0 p-4 border-t bg-gray-100 flex justify-end space-x-2">
            <button id="btnBackToList" onclick="showListView()" class="hidden px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">ä¸€è¦§ã«æˆ»ã‚‹</button>
            <button id="btnSaveEdit" onclick="saveEditedData()" class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold">ä¿å­˜ã™ã‚‹</button>
            <button id="btnCloseList" onclick="closeDataListModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« (æ–°è¦è¿½åŠ ) -->
<div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white w-full max-w-2xl h-[80vh] rounded-lg shadow-2xl flex flex-col overflow-hidden relative">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex-shrink-0 flex justify-between items-center p-4 border-b bg-gray-50">
            <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-book-open text-blue-600 mr-2"></i>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <button onclick="closeHelpModal()" class="text-gray-500 hover:text-red-500 p-2"><i class="fas fa-times fa-lg"></i></button>
        </div>
        
        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="flex-1 overflow-y-auto p-6 text-sm text-gray-700 space-y-6 leading-relaxed">
            
            <section>
                <h3 class="font-bold text-base text-gray-900 border-l-4 border-blue-500 pl-2 mb-2">1. ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²æ–¹æ³•</h3>
                <ul class="list-disc pl-5 space-y-1">
                    <li><span class="font-bold">Excelä¸€æ‹¬ç™»éŒ²:</span> ã€ŒExcelä¸€æ‹¬ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€è©¦æ–™æƒ…å ±ã¨è©¦é¨“çµæœï¼ˆe-logP, Cv, mvï¼‰ã‚’ã¾ã¨ã‚ã¦è²¼ã‚Šä»˜ã‘ã¦ç™»éŒ²ã§ãã¾ã™ã€‚</li>
                    <li><span class="font-bold">JSONèª­è¾¼:</span> ä»¥å‰ã«ä¿å­˜ã—ãŸ <code>.json</code> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒã—ã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-base text-gray-900 border-l-4 border-green-500 pl-2 mb-2">2. ã‚°ãƒ©ãƒ•ã®æ“ä½œãƒ»ä»£è¡¨æ›²ç·šã®æ±ºå®š</h3>
                <p class="mb-2">ã‚°ãƒ©ãƒ•ä¸Šã®ãƒ—ãƒ­ãƒƒãƒˆç‚¹ã‚’æ“ä½œã—ã¦ã€è¨­è¨ˆæ¡ç”¨å€¤ï¼ˆä»£è¡¨æ›²ç·šï¼‰ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>
                <div class="bg-gray-100 p-3 rounded border border-gray-200">
                    <ul class="list-disc pl-5 space-y-1">
                        <li><span class="font-bold text-blue-600">ä»£è¡¨æ›²ç·šã®è¨­å®š:</span> ãƒ—ãƒ­ãƒƒãƒˆç‚¹ã‚’ <span class="font-bold">å³ã‚¯ãƒªãƒƒã‚¯</span> ã—ã€ã€Œâ˜… ä»£è¡¨æ›²ç·šã«è¨­å®šã™ã‚‹ã€ã‚’é¸æŠã—ã¾ã™ã€‚</li>
                        <li><span class="font-bold text-blue-600">å¹ãå‡ºã—ã®ç§»å‹•:</span> ä»£è¡¨æ›²ç·šã®å¹ãå‡ºã—ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼‰ã¯ã€ãƒã‚¦ã‚¹ã§<span class="font-bold">ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å¥½ããªä½ç½®ã«ç§»å‹•</span>ã§ãã¾ã™ã€‚</li>
                        <li><span class="font-bold text-red-500">è§£é™¤:</span> è§£é™¤ã—ãŸã„ç‚¹ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€ŒÃ— è¨­å®šã‚’è§£é™¤ã™ã‚‹ã€ã‚’é¸æŠã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <p class="mt-2 text-xs text-gray-500">â€» ä»£è¡¨æ›²ç·šã«è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€å¤ªç·šã§å¼·èª¿è¡¨ç¤ºã•ã‚Œã€ã‚°ãƒ©ãƒ•æ¨ªã®è¡¨ã«æ•°å€¤ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚</p>
            </section>

            <section>
                <h3 class="font-bold text-base text-gray-900 border-l-4 border-purple-500 pl-2 mb-2">3. è¡¨ç¤ºã®èª¿æ•´</h3>
                <ul class="list-disc pl-5 space-y-1">
                    <li><span class="font-bold">è»¸ã‚¹ã‚±ãƒ¼ãƒ«ã®å¤‰æ›´:</span> å„ã‚°ãƒ©ãƒ•å³ä¸Šã® <i class="fas fa-cog text-gray-400"></i> ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Xè»¸ãƒ»Yè»¸ã®æœ€å¤§ãƒ»æœ€å°å€¤ã‚’å€‹åˆ¥ã«å›ºå®šã§ãã¾ã™ã€‚</li>
                    <li><span class="font-bold">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:</span> å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä¸‹éƒ¨ã§ã€ç‰¹å®šã®ã€Œå­”ç•ªã€ã‚„ã€ŒåœŸå±¤ã€ã®ã¿ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
                    <li><span class="font-bold">ã‚°ãƒ©ãƒ•ã‚µã‚¤ã‚º:</span> ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ã‚°ãƒ©ãƒ•ã®é«˜ã•ã‚„ãƒ—ãƒ­ãƒƒãƒˆã®å¤§ãã•ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</li>
                </ul>
            </section>
            
            <section>
                <h3 class="font-bold text-base text-gray-900 border-l-4 border-orange-500 pl-2 mb-2">4. ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</h3>
                <p>ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã€ä»£è¡¨æ›²ç·šã®è¨­å®šã€ã‚°ãƒ©ãƒ•ã®è»¸è¨­å®šã‚’å«ã‚ãŸã™ã¹ã¦ã®çŠ¶æ…‹ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
            </section>

        </div>
        
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="flex-shrink-0 p-4 border-t bg-gray-50 flex justify-end">
            <button onclick="closeHelpModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    let globalData = [];
    let filterState = { holes: new Set(), layers: new Set() };
    let chartInstances = [];
    let currentPointSize = 4;
    let specificAxisSettings = {}; 
    
    // ä»£è¡¨æ›²ç·šã®è¨­å®š: { datasetIndex, text, x, y } (x,yã¯ä»»æ„)
    let representativeSettings = {};
    let ctxMenuTarget = { chart: null, datasetIndex: null };

    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç®¡ç†
    let isTableMode = false;

    // ãƒ‰ãƒ©ãƒƒã‚°ç”¨å¤‰æ•°
    let draggingLabel = null; 

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨å¤‰æ•°
    let tempSettingsBackup = null;
    let currentEditingId = null;

    const chartColors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#6366f1', '#84cc16', '#14b8a6'];
    const holeColors = { 'é¡ç”°-No.1': '#ef4444', 'é¡ç”°-No.2': '#3b82f6', 'é¡ç”°-No.3': '#10b981', 'é¡ç”°-No.4': '#f59e0b', 'é¡ç”°-No.5': '#8b5cf6' };
    
    let hotMeta, hotEp, hotCv, hotMv;

    window.onload = function() {
        addSampleDataInternal();
        initFilters();
        refreshView();
        document.addEventListener('click', (e) => {
            document.getElementById('contextMenu').classList.add('hidden');
        });

        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç†
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelpModal();
            }
        });
    };

    function addSampleDataInternal() {
         globalData = [
            { id: 1, hole: 'é¡ç”°-No.1', sample: 'S-1', layer: 'Ac2', depth: 'GL-5m', ep: [{x:10,y:2.6}, {x:20,y:2.58}, {x:50,y:2.5}, {x:100,y:2.4}, {x:200,y:2.2}, {x:400,y:1.8}, {x:800,y:1.4}], cv: [{x:10,y:1800}, {x:20,y:1500}, {x:50,y:1200}, {x:100,y:800}, {x:200,y:400}, {x:400,y:200}, {x:800,y:100}], mv: [{x:10,y:0.002}, {x:20,y:0.0015}, {x:50,y:0.001}, {x:100,y:0.0008}, {x:200,y:0.0006}, {x:400,y:0.0004}] },
            { id: 2, hole: 'é¡ç”°-No.1', sample: 'S-2', layer: 'Ac2', depth: 'GL-7m', ep: [{x:10,y:2.3}, {x:20,y:2.25}, {x:50,y:2.1}, {x:100,y:1.9}, {x:200,y:1.7}, {x:400,y:1.4}, {x:800,y:1.1}], cv: [{x:10,y:1600}, {x:20,y:1300}, {x:50,y:1000}, {x:100,y:600}, {x:200,y:300}, {x:400,y:150}, {x:800,y:80}], mv: [{x:10,y:0.0018}, {x:20,y:0.0013}, {x:50,y:0.0009}, {x:100,y:0.0007}, {x:200,y:0.0005}, {x:400,y:0.0003}] }
        ];
    }

    // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
    function openHelpModal() { document.getElementById('helpModal').classList.remove('hidden'); }
    function closeHelpModal() { document.getElementById('helpModal').classList.add('hidden'); }

    // â–¼â–¼â–¼ 200ä»¶å¯¾å¿œä¿®æ­£ç®‡æ‰€ã“ã“ã‹ã‚‰ â–¼â–¼â–¼
    function initGrids() {
        if (hotMeta) return;

        // æœ€å¤§ç™»éŒ²æ•°ã‚’200ã«è¨­å®š
        const MAX_SAMPLES = 200; 

        hotMeta = new Handsontable(document.getElementById('hotMeta'), { 
            data: Array.from({ length: MAX_SAMPLES }, () => [null, null, null, null, null]), 
            colHeaders: ['åœ°ç‚¹å', 'è©¦æ–™å', 'æ·±åº¦(m)', 'åœŸè³ªå', 'åœŸå±¤ç•ªå·(ä»»æ„)'], 
            columns: [{type:'text'}, {type:'text'}, {type:'text'}, {type:'text'}, {type:'text'}], 
            colWidths: [120, 100, 80, 80, 80], 
            rowHeaders: true, 
            stretchH: 'all', 
            contextMenu: true, 
            manualColumnResize: true, 
            licenseKey: 'non-commercial-and-evaluation' 
        });

        const createResultSettings = (xLabel, yLabel) => {
            let cols = [], headers = [];
            // ãƒ«ãƒ¼ãƒ—ã‚’200å›ã«è¨­å®š
            for(let i=1; i<=MAX_SAMPLES; i++) { 
                headers.push(`${xLabel}<br><span style="font-size:0.7em;color:#666">No.${i}</span>`); 
                headers.push(`${yLabel}<br><span style="font-size:0.7em;color:#666">No.${i}</span>`); 
                cols.push({type: 'numeric', numericFormat: {pattern: '0,0.00'}}); 
                cols.push({type: 'numeric', numericFormat: {pattern: '0.0000'}}); 
            }
            return { headers, cols };
        };
        const epSet = createResultSettings('P', 'e'), cvSet = createResultSettings('P_avg', 'Cv'), mvSet = createResultSettings('P_avg', 'mv');
        
        // åˆ—æ•°ã‚’200è©¦æ–™Ã—2åˆ—=400åˆ—ã«è¨­å®š
        const commonOpts = { 
            data: Handsontable.helper.createSpreadsheetData(50, MAX_SAMPLES * 2), 
            rowHeaders: true, 
            colWidths: 60, 
            manualColumnResize: true, 
            contextMenu: true, 
            licenseKey: 'non-commercial-and-evaluation' 
        };

        hotEp = new Handsontable(document.getElementById('hotEp'), { ...commonOpts, colHeaders: epSet.headers, columns: epSet.cols });
        hotCv = new Handsontable(document.getElementById('hotCv'), { ...commonOpts, colHeaders: cvSet.headers, columns: cvSet.cols });
        hotMv = new Handsontable(document.getElementById('hotMv'), { ...commonOpts, colHeaders: mvSet.headers, columns: mvSet.cols });
        
        clearAllGrids();
    }

    function openBatchModal() { const m = document.getElementById('batchModal'); m.classList.remove('hidden'); requestAnimationFrame(() => { initGrids(); [hotMeta, hotEp, hotCv, hotMv].forEach(h => h && h.render()); }); }
    function closeBatchModal() { document.getElementById('batchModal').classList.add('hidden'); }
    function switchTab(t) { ['ep', 'cv', 'mv'].forEach(x => { document.getElementById(`tab-${x}`).className = x===t ? 'tab-active py-2 px-6 text-sm font-medium border-r' : 'tab-inactive py-2 px-6 text-sm font-medium border-r'; document.getElementById(`pane-${x}`).className = x===t ? 'absolute inset-0 p-0 block' : 'absolute inset-0 p-0 hidden'; }); if(t==='ep') hotEp.render(); if(t==='cv') hotCv.render(); if(t==='mv') hotMv.render(); }
    
    function clearAllGrids() { 
        const MAX_SAMPLES = 200;
        hotMeta.loadData(Handsontable.helper.createSpreadsheetData(MAX_SAMPLES, 5).map(r => r.map(() => null))); 
        const e = Handsontable.helper.createSpreadsheetData(50, MAX_SAMPLES * 2).map(r => r.map(() => null)); 
        hotEp.loadData(JSON.parse(JSON.stringify(e))); 
        hotCv.loadData(JSON.parse(JSON.stringify(e))); 
        hotMv.loadData(JSON.parse(JSON.stringify(e))); 
    }
    // â–²â–²â–² 200ä»¶å¯¾å¿œä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–²
    
    function registerBatchData() {
        const meta = hotMeta.getData(), ep = hotEp.getData(), cv = hotCv.getData(), mv = hotMv.getData();
        let c = 0;
        for(let r=0; r<meta.length; r++) {
            const h = meta[r][0], s = meta[r][1], l = meta[r][3]; if(!h) continue; 
            const ext = (g) => { const arr=[]; for(let i=0; i<g.length; i++) { const x=parseFloat(g[i][r*2]), y=parseFloat(g[i][r*2+1]); if(!isNaN(x)&&x>0&&!isNaN(y)) arr.push({x,y}); } return arr; };
            const eD = ext(ep), cD = ext(cv), mD = ext(mv);
            if(eD.length||cD.length||mD.length) { 
                globalData.push({ id: Date.now()+r, hole: h, sample: s||'', layer: l||'Unknown', depth: meta[r][2]?`GL-${meta[r][2]}m`:(meta[r][1]||''), ep:eD, cv:cD, mv:mD }); 
                c++; 
            }
        }
        if(c>0) { alert(`${c}ä»¶ç™»éŒ²`); closeBatchModal(); initFilters(); refreshView(); clearAllGrids(); } else alert('ãƒ‡ãƒ¼ã‚¿ãªã—');
    }

    function initFilters() {
        const h = [...new Set(globalData.map(d => d.hole))].sort(), l = [...new Set(globalData.map(d => d.layer))].sort();
        filterState.holes = new Set(h); filterState.layers = new Set(l);
        renderFilterList('hole', h, filterState.holes); renderFilterList('layer', l, filterState.layers);
    }
    function renderFilterList(type, items, selectedSet) {
        const c = document.getElementById(type + 'FilterList'); c.innerHTML = '';
        items.forEach(i => {
            const div = document.createElement('div'); div.className = "flex items-center";
            const dot = type === 'hole' ? `<span class="w-3 h-3 rounded-full mr-2 inline-block" style="background:${getColorByHash(i)}"></span>` : '';
            div.innerHTML = `<label class="flex items-center cursor-pointer w-full hover:bg-slate-700 p-1 rounded"><input type="checkbox" class="form-checkbox text-blue-500 rounded bg-slate-900 border-slate-600" value="${i}" ${selectedSet.has(i) ? 'checked' : ''} onchange="updateFilter('${type}', '${i}', this.checked)"><span class="ml-2 text-slate-200">${dot}${i}</span></label>`;
            c.appendChild(div);
        });
    }
    function getColorByHash(str) { if(holeColors[str]) return holeColors[str]; let h = 0; for(let i=0; i<str.length; i++) h = str.charCodeAt(i) + ((h<<5)-h); const c = (h & 0x00FFFFFF).toString(16).toUpperCase(); return '#'+("00000".substring(0,6-c.length)+c); }
    function updateFilter(t, v, c) { (c ? filterState[t+'s'].add(v) : filterState[t+'s'].delete(v)); refreshView(); }
    function toggleAllFilters(t, all) { const s = filterState[t+'s']; s.clear(); if(all) (t==='hole'?[...new Set(globalData.map(d=>d.hole))]:[...new Set(globalData.map(d=>d.layer))]).forEach(i=>s.add(i)); renderFilterList(t, t==='hole'?[...new Set(globalData.map(d=>d.hole))]:[...new Set(globalData.map(d=>d.layer))], s); refreshView(); }

    function updateChartHeight(val) {
        document.getElementById('heightValue').innerText = val + 'px';
        const grids = document.querySelectorAll('.chart-grid');
        grids.forEach(g => g.style.height = val + 'px');
        chartInstances.forEach(chart => chart.resize());
    }

    function updatePointSize(val) {
        currentPointSize = parseInt(val);
        document.getElementById('pointSizeValue').innerText = val + 'px';
        chartInstances.forEach(chart => {
            refreshView(); 
        });
    }

    function toggleTableMode(checked) {
        isTableMode = checked;
        refreshView();
    }

    function updateTableVisibility(chartId) {
        const tableId = chartId.replace('chart-', 'table-');
        const tableDiv = document.getElementById(tableId);
        if (!tableDiv) return;

        const repSetting = representativeSettings[chartId];
        
        if (isTableMode && repSetting) {
            tableDiv.classList.remove('hidden');
            renderTableContent(chartId, repSetting.datasetIndex);
            const chart = Chart.getChart(chartId);
            if (chart) chart.resize();
        } else {
            tableDiv.classList.add('hidden');
            const chart = Chart.getChart(chartId);
            if (chart) chart.resize();
        }
    }

    function renderTableContent(chartId, datasetIndex) {
        const tableId = chartId.replace('chart-', 'table-');
        const chart = Chart.getChart(chartId);
        if (!chart) return;
        const dataset = chart.data.datasets[datasetIndex];
        if (!dataset) return;

        const headerDiv = document.getElementById(tableId + '-header');
        headerDiv.innerHTML = `<span class="text-[10px] block text-gray-600 font-normal">æ¡ç”¨æ›²ç·š</span>${dataset.label.split('(')[0]}`;

        const tbody = document.getElementById(tableId + '-body');
        tbody.innerHTML = '';
        dataset.data.forEach(point => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-yellow-50 transition-colors border-b border-gray-600";
            
            let xVal = point.x, yVal = point.y;
            const xStr = xVal >= 100 ? xVal.toFixed(0) : xVal.toFixed(1);
            let yStr = yVal;
            if (chartId.includes('ep')) yStr = yVal.toFixed(3);
            else if (chartId.includes('cv')) yStr = yVal.toFixed(1);
            else if (chartId.includes('mv')) yStr = yVal.toExponential(2);
            
            tr.innerHTML = `<td class="p-1 pr-2 border-r border-gray-600 font-mono text-black">${xStr}</td><td class="p-1 pr-2 font-mono font-bold text-black">${yStr}</td>`;
            tbody.appendChild(tr);
        });
    }

    function refreshView() {
        const container = document.getElementById('chartsContainer'); container.innerHTML = ''; 
        chartInstances.forEach(c => c.destroy()); chartInstances = [];
        const groupMode = document.getElementById('groupSelect').value;
        const filtered = globalData.filter(d => filterState.holes.has(d.hole) && filterState.layers.has(d.layer));
        if (filtered.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 mt-10">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
        
        const groups = {};
        filtered.forEach(d => { const k = groupMode === 'layer' ? d.layer : d.hole; if(!groups[k]) groups[k]=[]; groups[k].push(d); });
        
        const currentHeight = document.getElementById('heightSlider').value;

        Object.keys(groups).sort().forEach(key => {
            const section = document.createElement('div'); section.className = "bg-white rounded-lg shadow p-4 border-l-8 border-blue-600";
            section.innerHTML = `<h3 class="text-2xl font-bold text-white bg-blue-900 inline-block px-4 py-1 rounded mb-4">${key}</h3>`;
            
            const grid = document.createElement('div'); 
            grid.className = "grid grid-cols-1 md:grid-cols-3 gap-4 chart-grid";
            grid.style.height = currentHeight + 'px';

            grid.appendChild(createChartCard(key, 'ep', 'é–“éš™æ¯”', 'e'));
            grid.appendChild(createChartCard(key, 'cv', 'åœ§å¯†ä¿‚æ•°', 'Cv'));
            grid.appendChild(createChartCard(key, 'mv', 'ä½“ç©åœ§ç¸®ä¿‚æ•°', 'mv'));
            
            section.appendChild(grid); container.appendChild(section);
            drawChart(key, 'ep', groups[key], false); 
            drawChart(key, 'cv', groups[key], true); 
            drawChart(key, 'mv', groups[key], true); 
        });
    }

    function createChartCard(groupKey, type, title, symbol) {
        const div = document.createElement('div'); 
        div.className = "relative border border-gray-400 rounded-lg flex flex-col h-full bg-white overflow-hidden shadow-sm"; 
        const canvasId = `chart-${groupKey}-${type}`.replace(/\s/g, '');
        const tableId = `table-${groupKey}-${type}`.replace(/\s/g, '');
        div.innerHTML = `
            <div class="chart-header p-2 flex flex-col items-center justify-center relative h-14 flex-shrink-0 z-10">
                <span class="text-sm font-bold tracking-wider">${title}</span>
                <span class="symbol-text text-lg leading-none">${symbol}</span>
                <button onclick="openAxisSettings('${groupKey}', '${type}')" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <div class="flex-1 min-h-0 relative flex flex-row">
                <div class="flex-1 relative min-w-0">
                    <div class="absolute inset-2"><canvas id="${canvasId}"></canvas></div>
                </div>
                <div id="${tableId}" class="hidden w-48 border-l border-gray-600 bg-white flex flex-col text-xs transition-all duration-300">
                    <div class="p-2 bg-yellow-100 border-b border-gray-600 font-bold text-center text-gray-800" id="${tableId}-header">æ¡ç”¨æ›²ç·š</div>
                    <div class="flex-1 overflow-y-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-gray-100 text-gray-800 sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-1 border-b border-r border-gray-600 text-center w-1/2">P<br>(kN/mÂ²)</th>
                                    <th class="p-1 border-b border-gray-600 text-center w-1/2">${symbol}</th>
                                </tr>
                            </thead>
                            <tbody id="${tableId}-body" class="bg-white text-gray-900"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        return div;
    }

    const generateLogTicks = (min, max) => {
        const ticks = [];
        if (!min || !max) return [];
        const minPow = Math.floor(Math.log10(min));
        const maxPow = Math.ceil(Math.log10(max));
        for (let i = minPow; i <= maxPow; i++) {
            for (let j = 1; j <= 9; j++) {
                const val = j * Math.pow(10, i);
                const cleanVal = parseFloat(val.toPrecision(10));
                if (cleanVal >= min * 0.99 && cleanVal <= max * 1.01) { ticks.push(cleanVal); }
            }
        }
        return ticks;
    };

    function drawChart(groupKey, type, dataList, isLogY) {
        const canvasId = `chart-${groupKey}-${type}`.replace(/\s/g, '');
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        const settings = specificAxisSettings[`${groupKey}-${type}`] || { xMin: null, xMax: null, xStep: null, yMin: null, yMax: null, yStep: null };
        
        const repSetting = representativeSettings[canvasId];
        const hasRep = !!repSetting;

        // Yè»¸ãƒ©ãƒ™ãƒ«ã¨Xè»¸ãƒ©ãƒ™ãƒ«ã®è¨­å®š
        let yAxisLabel = "";
        let xAxisLabel = "å¹³å‡åœ§å¯†åœ§åŠ› PÌ„ (kN/mÂ²)"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        if (type === 'ep') {
            yAxisLabel = "é–“éš™æ¯” e";
            xAxisLabel = "åœ§å¯†åœ§åŠ› P (kN/mÂ²)"; // e-logPã®å ´åˆã®ã¿Pã«å¤‰æ›´
        } else if (type === 'cv') {
            yAxisLabel = "åœ§å¯†ä¿‚æ•° Cv (cmÂ²/d)";
        } else if (type === 'mv') {
            yAxisLabel = "ä½“ç©åœ§ç¸®ä¿‚æ•° mv (mÂ²/kN)";
        }

        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const chart = Chart.getChart(canvasId);
            const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (points.length > 0) {
                const datasetIndex = points[0].datasetIndex;
                ctxMenuTarget = { chart: chart, datasetIndex: datasetIndex, type: type };
                const menu = document.getElementById('contextMenu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.remove('hidden');
            }
        });

        // â˜… ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ã®è¿½åŠ  â˜…
        canvas.addEventListener('mousedown', function(e) {
            const chart = Chart.getChart(canvasId);
            if (!chart || !chart.repBox) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // å½“ãŸã‚Šåˆ¤å®š
            const box = chart.repBox;
            if (mouseX >= box.x && mouseX <= box.x + box.w && 
                mouseY >= box.y && mouseY <= box.y + box.h) {
                draggingLabel = {
                    chartId: canvasId,
                    offsetX: mouseX - box.x,
                    offsetY: mouseY - box.y
                };
                canvas.style.cursor = 'grabbing';
            }
        });

        canvas.addEventListener('mousemove', function(e) {
            const chart = Chart.getChart(canvasId);
            if (!chart) return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
            if (draggingLabel && draggingLabel.chartId === canvasId) {
                // åº§æ¨™æ›´æ–°
                representativeSettings[canvasId].x = mouseX - draggingLabel.offsetX;
                representativeSettings[canvasId].y = mouseY - draggingLabel.offsetY;
                chart.update('none'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§å†æç”»
                return;
            }

            // ãƒ›ãƒãƒ¼åˆ¤å®šï¼ˆã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´ï¼‰
            if (chart.repBox) {
                const box = chart.repBox;
                if (mouseX >= box.x && mouseX <= box.x + box.w && 
                    mouseY >= box.y && mouseY <= box.y + box.h) {
                    canvas.style.cursor = 'grab';
                } else {
                    canvas.style.cursor = 'default';
                }
            }
        });

        canvas.addEventListener('mouseup', function() {
            if (draggingLabel) {
                draggingLabel = null;
                canvas.style.cursor = 'grab';
            }
        });

        canvas.addEventListener('mouseout', function() {
            if (draggingLabel) {
                draggingLabel = null;
                canvas.style.cursor = 'default';
            }
        });

        const datasets = dataList.map((d, i) => {
            const baseColor = chartColors[i % chartColors.length];
            let borderWidth = 1.5;
            let pointRadius = currentPointSize;
            let order = 1;

            const labelText = d.sample ? `${d.hole} [${d.sample}] (${d.depth})` : `${d.hole} (${d.depth})`;

            if (hasRep && repSetting.datasetIndex === i) {
                borderWidth = 4;
                pointRadius = currentPointSize + 2;
                order = 0; 
            } else {
                borderWidth = 1.5;
                pointRadius = currentPointSize;
                order = 10;
            }

            return {
                label: labelText,
                data: d[type],
                borderColor: baseColor, backgroundColor: baseColor,
                originalColor: baseColor, 
                pointRadius: pointRadius, pointHoverRadius: pointRadius + 2, borderWidth: borderWidth,
                fill: false, showLine: true, tension: 0, order: order
            };
        });

        // â˜… ä»£è¡¨æ›²ç·šãƒ—ãƒ©ã‚°ã‚¤ãƒ³ â˜…
        const repCurvePlugin = { id: 'repCurvePlugin', afterDatasetsDraw(chart, args, options) { 
            const ctx = chart.ctx; const chartId = chart.canvas.id; const setting = representativeSettings[chartId];
            if (setting && chart.data.datasets[setting.datasetIndex]) {
                const meta = chart.getDatasetMeta(setting.datasetIndex); if(meta.hidden) return; 
                const points = meta.data; const midIndex = Math.floor(points.length / 2); const point = points[midIndex];
                if (point) {
                    const x = point.x, y = point.y;
                    ctx.font = 'bold 12px Arial'; const textLines = setting.text.split('\n');
                    let maxWidth = 0; textLines.forEach(line => { const m = ctx.measureText(line); if (m.width > maxWidth) maxWidth = m.width; });
                    const lineHeight = 16, padding = 6;
                    const boxWidth = maxWidth + (padding * 2), boxHeight = (textLines.length * lineHeight) + (padding * 2);
                    
                    let boxX, boxY;
                    if (setting.x !== undefined && setting.y !== undefined) {
                        boxX = setting.x;
                        boxY = setting.y;
                    } else {
                        const offset = 40; 
                        boxX = x + offset; 
                        boxY = y - offset - boxHeight;
                        
                        if (boxY < 10) { boxY = y + offset; }
                        if (boxX + boxWidth > chart.width - 10) { boxX = x - offset - boxWidth; }
                        if (boxX < 0) boxX = 10;
                    }

                    let arrowTargetX = x, arrowTargetY = y;

                    ctx.save(); 
                    ctx.beginPath(); 
                    ctx.moveTo(arrowTargetX, arrowTargetY); 
                    
                    let connectX = (boxX > x) ? boxX : boxX + boxWidth; 
                    if (x >= boxX && x <= boxX + boxWidth) connectX = x;

                    let connectY = (boxY > y) ? boxY : boxY + boxHeight; 
                    if (y >= boxY && y <= boxY + boxHeight) connectY = y;

                    ctx.lineTo(connectX, connectY);
                    ctx.strokeStyle = 'black'; ctx.lineWidth = 1.5; ctx.stroke();
                    
                    ctx.beginPath(); ctx.arc(x, y, 3, 0, 2 * Math.PI); ctx.fillStyle = 'black'; ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 200, 0.9)'; ctx.fillRect(boxX, boxY, boxWidth, boxHeight); 
                    ctx.strokeStyle = '#666'; ctx.lineWidth = 1; ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
                    ctx.fillStyle = 'black'; ctx.textBaseline = 'top'; 
                    textLines.forEach((line, idx) => { ctx.fillText(line, boxX + padding, boxY + padding + (idx * lineHeight)); }); 
                    ctx.restore();

                    chart.repBox = { x: boxX, y: boxY, w: boxWidth, h: boxHeight };
                }
            } else {
                chart.repBox = null;
            }
        }};

        const createScaleConfig = (isLog, axisSettings, axisTitle) => {
            const scientificFormatter = (val) => {
                const str = val.toExponential(0).toUpperCase().replace('+', ''); 
                const parts = str.split('E');
                if (parts.length === 2) { const num = parts[0]; let exp = parseInt(parts[1]); const sign = exp >= 0 ? '+' : '-'; exp = Math.abs(exp).toString().padStart(2, '0'); return `${num}E${sign}${exp}`; }
                return str;
            };
            return {
                type: isLog ? 'logarithmic' : 'linear',
                title: { 
                    display: true, 
                    text: axisTitle, 
                    color: '#333',
                    font: { size: 12, weight: 'bold' }
                },
                min: axisSettings.min || undefined, max: axisSettings.max || undefined,
                grid: {
                    color: (ctx) => {
                        // ç·šå½¢(Linear)ã®ã‚°ãƒªãƒƒãƒ‰è‰²è¨­å®šï¼ˆYè»¸ï¼še, Xè»¸ãªã—ï¼‰
                        // ã‚ˆã‚Šæ¿ƒã„ç°è‰² (#94a3b8) ã«å¤‰æ›´
                        if(!isLog) return '#94a3b8'; 
                        
                        const val = ctx.tick.value; if (val === 0) return 'rgba(0,0,0,0)'; 
                        const log10 = Math.log10(val); const isMajor = (Math.abs(log10 - Math.round(log10)) < 1e-9); 
                        // ãƒ­ã‚°(Log)ã®ã‚°ãƒªãƒƒãƒ‰è‰²è¨­å®š
                        // ãƒ¡ã‚¸ãƒ£ãƒ¼: #475569 (æ¿ƒã„slate), ãƒã‚¤ãƒŠãƒ¼: #94a3b8 (ä¸­é–“ã®slate)
                        return isMajor ? '#475569' : '#94a3b8'; 
                    },
                    borderColor: '#000', tickLength: 5
                },
                ticks: {
                    color: '#000', autoSkip: false, maxRotation: 0,
                    stepSize: (!isLog) ? (axisSettings.step || undefined) : undefined,
                    callback: function(value) {
                        if (isLog) {
                            const log10 = Math.log10(value);
                            if (Math.abs(Math.round(log10) - log10) < 1e-9) { if (value < 0.01 || value > 10000) return scientificFormatter(value); return value.toLocaleString(); }
                            return ''; 
                        } else { return parseFloat(value.toFixed(4)); }
                    }
                },
                afterBuildTicks: (axis) => { if (isLog) { const min = axis.min; const max = axis.max; const customTicks = generateLogTicks(min, max); axis.ticks = customTicks.map(v => ({ value: v })); } }
            };
        };

        const chart = new Chart(ctx, {
            type: 'scatter', data: { datasets }, plugins: [repCurvePlugin],
            options: {
                animation: false, responsive: true, maintainAspectRatio: false,
                scales: {
                    // Xè»¸è¨­å®š (e-logPãªã‚‰'åœ§å¯†åœ§åŠ› P'ã€ãã‚Œä»¥å¤–ã¯'å¹³å‡åœ§å¯†åœ§åŠ› P_avg')
                    x: createScaleConfig(true, {min: settings.xMin, max: settings.xMax, step: settings.xStep}, xAxisLabel),
                    // Yè»¸è¨­å®š
                    y: createScaleConfig(isLogY, {min: settings.yMin, max: settings.yMax, step: settings.yStep}, yAxisLabel)
                },
                plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 10 }, color: '#333' } },
                    tooltip: { 
                        filter: function(e) { return !draggingLabel; },
                        callbacks: { label: function(context) { return (context.dataset.label||'') + `: (${context.parsed.x}, ${context.parsed.y})`; } } 
                    }
                }
            }
        });
        chartInstances.push(chart);
        setTimeout(() => { updateTableVisibility(canvasId); }, 0);
    }

    function setRepresentativeCurve() { 
        document.getElementById('contextMenu').classList.add('hidden');
        if (!ctxMenuTarget.chart) return;
        const chart = ctxMenuTarget.chart;
        const chartId = chart.canvas.id;
        
        let defaultText = "ä»£è¡¨æ›²ç·š";
        if (ctxMenuTarget.type === 'cv') {
            const range = prompt("æ­£è¦åœ§å¯†é ˜åŸŸã®Cvå€¤ã®ç¯„å›²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n(ä¾‹: 50ï½80)", "50ï½80");
            if (range === null) return;
            defaultText = `ä»£è¡¨æ›²ç·š\næ­£è¦åœ§å¯†é ˜åŸŸã®Cvã¯\n${range}cm2/dç¨‹åº¦`;
        } else {
            const input = prompt("å¹ãå‡ºã—ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", defaultText);
            if (input === null) return;
            defaultText = input;
        }

        // åˆæœŸä½ç½®ã¯æœªè¨­å®šï¼ˆè‡ªå‹•ï¼‰
        representativeSettings[chartId] = { datasetIndex: ctxMenuTarget.datasetIndex, text: defaultText };

        chart.data.datasets.forEach((dataset, index) => {
            if (index === ctxMenuTarget.datasetIndex) {
                dataset.borderWidth = 4;
                dataset.pointRadius = currentPointSize + 2;
                dataset.order = 0;
            } else {
                dataset.borderWidth = 1.5;
                dataset.pointRadius = currentPointSize;
                dataset.order = 10;
            }
            if(dataset.originalColor) {
                dataset.borderColor = dataset.originalColor;
                dataset.backgroundColor = dataset.originalColor;
            }
        });

        chart.update();
        updateTableVisibility(chartId); 
    }

    function removeRepresentativeCurve() { 
        document.getElementById('contextMenu').classList.add('hidden');
        if (!ctxMenuTarget.chart) return;
        const chart = ctxMenuTarget.chart;
        const chartId = chart.canvas.id;
        
        delete representativeSettings[chartId];

        chart.data.datasets.forEach(dataset => {
            dataset.borderWidth = 1.5;
            dataset.pointRadius = currentPointSize;
            dataset.order = 1;
            if(dataset.originalColor) {
                dataset.borderColor = dataset.originalColor;
                dataset.backgroundColor = dataset.originalColor;
            }
        });

        chart.update();
        updateTableVisibility(chartId);
    }

    function saveData() { 
        const j = JSON.stringify({ data: globalData, rep: representativeSettings, axis: specificAxisSettings }, null, 2); 
        const b = new Blob([j], {type: "application/json"}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "data_v4.6.json"; a.click(); 
    }
    function loadData(input) { 
        const r = new FileReader(); 
        r.onload = e => { 
            try { 
                const j = JSON.parse(e.target.result); 
                if(j.data){ globalData=j.data; representativeSettings=j.rep||{}; specificAxisSettings=j.axis||{}; } else { globalData=j; representativeSettings={}; specificAxisSettings={}; } 
                initFilters(); refreshView(); 
            } catch(z) { alert('ã‚¨ãƒ©ãƒ¼'); } 
        }; 
        r.readAsText(input.files[0]); 
    }

    // --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ---
    let currentEditTarget = null;
    function calculateBestInputStep(maxVal) { if (!maxVal && maxVal !== 0) return 1; const absVal = Math.abs(maxVal); if (absVal === 0) return 1; if (absVal <= 1) return 0.01; if (absVal <= 10) return 0.1; if (absVal >= 100) return 10; return 1; }
    function openAxisSettings(groupKey, type) {
        currentEditTarget = { group: groupKey, type: type };
        document.getElementById('axisModalTitle').innerText = `å¯¾è±¡: ${groupKey} - ${type}`;
        tempSettingsBackup = JSON.parse(JSON.stringify(specificAxisSettings));
        const chartUniqueId = `${groupKey}-${type}`;
        const s = specificAxisSettings[chartUniqueId] || {};
        const canvasId = `chart-${groupKey}-${type}`.replace(/\s/g, '');
        const refChart = Chart.getChart(canvasId);
        let autoVals = { xMin: null, xMax: null, xStep: null, yMin: null, yMax: null, yStep: null };
        if (refChart) {
            const scales = refChart.scales; autoVals.xMin = scales.x.min; autoVals.xMax = scales.x.max; autoVals.yMin = scales.y.min; autoVals.yMax = scales.y.max;
            const calcStep = (scale) => { if (scale.type !== 'linear') return null; const ticks = scale.getTicks(); if (ticks.length >= 2) { return parseFloat(Math.abs(ticks[1].value - ticks[0].value).toPrecision(10)); } return null; };
            autoVals.xStep = calcStep(scales.x); autoVals.yStep = calcStep(scales.y);
        }
        const getVal = (saved, auto) => { if (saved !== null && saved !== undefined && saved !== "") return saved; if (auto !== null && auto !== undefined) return parseFloat(auto.toPrecision(6)); return ""; };
        const xMinInput = document.getElementById('axisXMin'); const xMaxInput = document.getElementById('axisXMax'); const xStepInput = document.getElementById('axisXStep');
        const yMinInput = document.getElementById('axisYMin'); const yMaxInput = document.getElementById('axisYMax'); const yStepInput = document.getElementById('axisYStep');
        xMinInput.value = getVal(s.xMin, autoVals.xMin); xMaxInput.value = getVal(s.xMax, autoVals.xMax); xStepInput.value = getVal(s.xStep, autoVals.xStep);
        yMinInput.value = getVal(s.yMin, autoVals.yMin); yMaxInput.value = getVal(s.yMax, autoVals.yMax); yStepInput.value = getVal(s.yStep, autoVals.yStep);
        const xInputStep = calculateBestInputStep(parseFloat(xMaxInput.value) || 100); const yInputStep = calculateBestInputStep(parseFloat(yMaxInput.value) || 10);
        [xMinInput, xMaxInput, xStepInput].forEach(el => el.step = xInputStep); [yMinInput, yMaxInput, yStepInput].forEach(el => el.step = yInputStep);
        document.getElementById('axisSettingsModal').classList.remove('hidden');
    }
    function previewAxisSettings() {
        if(!currentEditTarget) return;
        const g = (id)=>document.getElementById(id).value; const p=(v)=>v?parseFloat(v):null; 
        const chartUniqueId = `${currentEditTarget.group}-${currentEditTarget.type}`;
        specificAxisSettings[chartUniqueId] = { xMin: p(g('axisXMin')), xMax: p(g('axisXMax')), xStep: p(g('axisXStep')), yMin: p(g('axisYMin')), yMax: p(g('axisYMax')), yStep: p(g('axisYStep')) }; 
        refreshView(); 
    }
    function cancelAxisSettings() { if (tempSettingsBackup) { specificAxisSettings = tempSettingsBackup; tempSettingsBackup = null; refreshView(); } document.getElementById('axisSettingsModal').classList.add('hidden'); currentEditTarget=null; }
    function applyAxisSettings() { tempSettingsBackup = null; document.getElementById('axisSettingsModal').classList.add('hidden'); currentEditTarget=null; }
    function resetAxisSettings() {
         if(!currentEditTarget) return;
         const chartUniqueId = `${currentEditTarget.group}-${currentEditTarget.type}`;
         delete specificAxisSettings[chartUniqueId];
         document.getElementById('axisXMin').value = ""; document.getElementById('axisXMax').value = ""; document.getElementById('axisXStep').value = "";
         document.getElementById('axisYMin').value = ""; document.getElementById('axisYMax').value = ""; document.getElementById('axisYStep').value = "";
         refreshView();
    }

    function openDataListModal() { document.getElementById('dataListModal').classList.remove('hidden'); showListView(); }
    function closeDataListModal() { document.getElementById('dataListModal').classList.add('hidden'); }
    function showListView() { 
        document.getElementById('dataListView').classList.remove('hidden'); document.getElementById('dataEditView').classList.add('hidden'); document.getElementById('btnBackToList').classList.add('hidden'); document.getElementById('btnSaveEdit').classList.add('hidden'); document.getElementById('btnCloseList').classList.remove('hidden');
        const tbody = document.getElementById('dataListTableBody'); tbody.innerHTML = '';
        if (globalData.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
        globalData.forEach(d => {
            const tr = document.createElement('tr'); tr.className = "hover:bg-blue-50 transition-colors border-b";
            const countEp = d.ep ? d.ep.length : 0; const countCv = d.cv ? d.cv.length : 0; const countMv = d.mv ? d.mv.length : 0;
            tr.innerHTML = `<td class="py-2 px-4 font-medium">${d.hole}</td><td class="py-2 px-4">${d.sample||'-'}</td><td class="py-2 px-4">${d.depth}</td><td class="py-2 px-4"><span class="bg-gray-200 px-2 py-0.5 rounded text-xs">${d.layer}</span></td><td class="py-2 px-4 text-center text-xs text-gray-500">e:${countEp}, Cv:${countCv}, mv:${countMv}</td><td class="py-2 px-4 text-center space-x-2"><button onclick="editDataItem(${d.id})" class="text-blue-600 hover:text-blue-800" title="ç·¨é›†"><i class="fas fa-edit"></i></button><button onclick="deleteDataItem(${d.id})" class="text-red-600 hover:text-red-800" title="å‰Šé™¤"><i class="fas fa-trash-alt"></i></button></td>`;
            tbody.appendChild(tr);
        });
    }
    function deleteDataItem(id) { if(!confirm("ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; globalData = globalData.filter(d => d.id !== id); initFilters(); refreshView(); showListView(); }
    function editDataItem(id) { 
        const target = globalData.find(d => d.id === id); if(!target) return;
        currentEditingId = id; 
        document.getElementById('dataListView').classList.add('hidden'); document.getElementById('dataEditView').classList.remove('hidden'); document.getElementById('btnBackToList').classList.remove('hidden'); document.getElementById('btnSaveEdit').classList.remove('hidden'); document.getElementById('btnCloseList').classList.add('hidden');
        document.getElementById('editHole').value = target.hole; 
        document.getElementById('editSample').value = target.sample || ''; 
        document.getElementById('editDepth').value = target.depth; 
        document.getElementById('editLayer').value = target.layer;
        const pointsToText = (arr) => arr ? arr.map(p => `${p.x}, ${p.y}`).join('\n') : "";
        document.getElementById('editEpData').value = pointsToText(target.ep); document.getElementById('editCvData').value = pointsToText(target.cv); document.getElementById('editMvData').value = pointsToText(target.mv);
    }
    function saveEditedData() { 
        const id = currentEditingId; const targetIndex = globalData.findIndex(d => d.id === id); if(targetIndex === -1) return;
        const textToPoints = (text) => text.split('\n').map(l => {const p=l.split(/,|ã€|\t|\s+/); if(p.length<2)return null; const x=parseFloat(p[0]),y=parseFloat(p[1]); return (!isNaN(x)&&!isNaN(y))?{x,y}:null}).filter(p=>p);
        globalData[targetIndex].hole = document.getElementById('editHole').value; 
        globalData[targetIndex].sample = document.getElementById('editSample').value; 
        globalData[targetIndex].depth = document.getElementById('editDepth').value; 
        globalData[targetIndex].layer = document.getElementById('editLayer').value;
        globalData[targetIndex].ep = textToPoints(document.getElementById('editEpData').value); globalData[targetIndex].cv = textToPoints(document.getElementById('editCvData').value); globalData[targetIndex].mv = textToPoints(document.getElementById('editMvData').value);
        alert("ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); initFilters(); refreshView(); showListView();
    }
</script>
</body>
</html>